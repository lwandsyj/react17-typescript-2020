<html><body><div id="cover-image">
<img src="/images/cover_image/OEBPS/images/title_page.jpg" alt="Fullstack Rust"/>
</div>,<h2>Fullstack Rust</h2>

  <p>&#160;</p>

  <h4>Nate Murray</h4>
  <p>&#160;</p>
  <p>This book is for sale at <a href="http://leanpub.com/fullstackrust">http://leanpub.com/fullstackrust</a></p>
  <p>This version was published on 2020-02-18</p>
  <p><img src="/images/publisher-logo/OEBPS/images/leanpub-logo.png" id="publisher-logo" alt="publisher's logo" /></p>
    <p>*&#160;&#160;&#160;*&#160;&#160;&#160;*&#160;&#160;&#160;*&#160;&#160;&#160;*</p>
  <p>This is a <a href="http://leanpub.com">Leanpub</a> book. Leanpub empowers authors and publishers with the Lean Publishing process. <a href="http://leanpub.com/manifesto">Lean Publishing</a> is the act of publishing an in-progress ebook using lightweight tools and many iterations to get reader feedback, pivot until you have the right book and build traction once you do.</p>
  <p>*&#160;&#160;&#160;*&#160;&#160;&#160;*&#160;&#160;&#160;*&#160;&#160;&#160;*</p>

  <p></p>
<div>© 2019 - 2020 Nate Murray</div>,<section class="frontmatter TableOfContents" epub:type="frontmatter toc">
        <h2 id='toc'>Table of Contents</h2>

         <nav xmlns:epub="http://www.idpf.org/2007/ops" epub:type="toc">
           <ol class='toc no-parts'>
  <li>
    <span>&#160;</span>
    <ol>
      <li>
        <a href='/links/chapter00/OEBPS/chap00.xhtml#leanpub-auto-book-revision'>Book Revision</a>
      </li>
      <li>
        <a href='/links/chapter00/OEBPS/chap00.xhtml#leanpub-auto-join-our-discord'>Join Our Discord</a>
      </li>
      <li>
        <a href='/links/chapter00/OEBPS/chap00.xhtml#leanpub-auto-bug-reports'>Bug Reports</a>
      </li>
      <li>
        <a href='/links/chapter00/OEBPS/chap00.xhtml#leanpub-auto-be-notified-of-updates-via-twitter'>Be notified of updates via Twitter</a>
      </li>
      <li>
        <a href='/links/chapter00/OEBPS/chap00.xhtml#leanpub-auto-wed-love-to-hear-from-you'>We’d love to hear from you!</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-introduction'>Introduction</a>
    <ol>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-why-rust'>Why Rust?</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-why-not-rust'>Why not Rust</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-this-books-mission'>This book’s mission</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-setting-expectations-based-on-your-background'>Setting expectations based on your background</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-getting-your-environment-setup'>Getting your environment setup</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-rustup'>Rustup</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-cargo'>Cargo</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-ides-rls-editors'>IDEs, RLS, Editors</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-clippy'>Clippy</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-rustfmt'>Rustfmt</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-documentation'>Documentation</a>
      </li>
      <li>
        <a href='/links/chapter01/OEBPS/chap01.xhtml#leanpub-auto-the-nomicon'>The Nomicon</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter02/OEBPS/chap02.xhtml#leanpub-auto-summary'>Summary</a>
  </li>
  <li>
    <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-making-your-first-rust-app'>Making Your First Rust App</a>
    <ol>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-getting-started'>Getting started</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-binary-vs-library'>Binary vs. library</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-the-generated-project'>The generated project</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-crates'>Crates</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-making-our-crate-a-library'>Making our crate a library</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-trade-offs'>Trade-offs</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-print-a-list-of-numbers'>Print a list of numbers</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-testing-our-code'>Testing our code</a>
      </li>
      <li>
        <a href='/links/chapter03/OEBPS/chap03.xhtml#leanpub-auto-wrapping-up'>Wrapping up</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter04/OEBPS/chap04.xhtml#leanpub-auto-making-a-web-app-with-actix'>Making A Web App With Actix</a>
    <ol>
      <li>
        <a href='/links/chapter04/OEBPS/chap04.xhtml#leanpub-auto-web-ecosystem'>Web Ecosystem</a>
      </li>
      <li>
        <a href='/links/chapter04/OEBPS/chap04.xhtml#leanpub-auto-starting-out'>Starting out</a>
      </li>
      <li>
        <a href='/links/chapter04/OEBPS/chap04.xhtml#leanpub-auto-handling-our-first-request'>Handling our first request</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-adding-state-to-our-web-app'>Adding State to Our Web App</a>
    <ol>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-recap-and-overview'>Recap and overview</a>
      </li>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-adding-state'>Adding state</a>
      </li>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-receiving-input'>Receiving input</a>
      </li>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-custom-error-handling'>Custom error handling</a>
      </li>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-handling-path-variables'>Handling path variables</a>
      </li>
      <li>
        <a href='/links/chapter05/OEBPS/chap05.xhtml#leanpub-auto-wrapping-up-1'>Wrapping up</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-even-more-web'>Even More Web</a>
    <ol>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-crates-to-know'>Crates to know</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-building-a-blog'>Building a blog</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-users'>Users</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-building-the-application'>Building the application</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-examples'>Examples</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-extending-our-application'>Extending our application</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-adding-routes-for-posts'>Adding routes for posts</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-extending-further-comments'>Extending further: comments</a>
      </li>
      <li>
        <a href='/links/chapter06/OEBPS/chap06.xhtml#leanpub-auto-adding-routes-for-comments'>Adding routes for comments</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-examples-1'>Examples</a>
    <ol>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-create-a-post'>Create a post</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-create-a-post-1'>Create a post</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-publish-a-post-1'>Publish a post</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-comment-on-a-post'>Comment on a post</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-list-all-posts'>List all posts</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-see-posts'>See posts</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-publish-other-post'>Publish other post</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-list-all-posts-again'>List all posts again</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-see-users-comments'>See users comments</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-see-post-comments'>See post comments</a>
      </li>
      <li>
        <a href='/links/chapter07/OEBPS/chap07.xhtml#leanpub-auto-wrapping-up-2'>Wrapping up</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-what-is-web-assembly'>What is Web Assembly?</a>
    <ol>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-intro-to-web-assembly'>Intro to Web Assembly</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-rust-in-the-browser'>Rust in the browser</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-the-smallest-wasm-library'>The Smallest Wasm Library</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-working-with-primatives'>Working with primatives</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-working-with-complex-types'>Working with complex types</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-the-real-way-to-write-wasm'>The Real Way to Write Wasm</a>
      </li>
      <li>
        <a href='/links/chapter08/OEBPS/chap08.xhtml#leanpub-auto-other-wasm-topics'>Other Wasm Topics</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-command-line-applications'>Command Line Applications</a>
    <ol>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-initial-setup'>Initial setup</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-making-an-mvp'>Making an MVP</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-recap'>Recap</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-adding-a-configuration-file'>Adding a configuration file</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-adding-sessions'>Adding sessions</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-syntax-highlighting'>Syntax highlighting</a>
      </li>
      <li>
        <a href='/links/chapter09/OEBPS/chap09.xhtml#leanpub-auto-summary-2'>Summary</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-macros'>Macros</a>
    <ol>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-overview'>Overview</a>
      </li>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-declarative-macros'>Declarative Macros</a>
      </li>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-procedural-macros'>Procedural Macros</a>
      </li>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-writing-a-custom-derive'>Writing a custom derive</a>
      </li>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-using-our-custom-derive'>Using our custom derive</a>
      </li>
      <li>
        <a href='/links/chapter10/OEBPS/chap10.xhtml#leanpub-auto-wrapping-up-3'>Wrapping up</a>
      </li>
    </ol>
  </li>
  <li>
    <a href='/links/chapter11/OEBPS/chap11.xhtml#leanpub-auto-changelog'>Changelog</a>
    <ol>
      <li>
        <a href='/links/chapter11/OEBPS/chap11.xhtml#leanpub-auto-revision-4-02-19-2020'>Revision 4 (02-19-2020)</a>
      </li>
      <li>
        <a href='/links/chapter11/OEBPS/chap11.xhtml#leanpub-auto-revision-3-01-29-2020'>Revision 3 (01-29-2020)</a>
      </li>
      <li>
        <a href='/links/chapter11/OEBPS/chap11.xhtml#leanpub-auto-revision-2-11-25-2019'>Revision 2 (11-25-2019)</a>
      </li>
      <li>
        <a href='/links/chapter11/OEBPS/chap11.xhtml#leanpub-auto-revision-1-10-29-2019'>Revision 1 (10-29-2019)</a>
      </li>
    </ol>
  </li>
</ol>

         </nav>

         <nav xmlns:epub="http://www.idpf.org/2007/ops" epub:type="landmarks" id="guide">
            <h2>Guide</h2>
            <ol>
               <li>
                  <a epub:type="bodymatter" href="/links/chapter00/OEBPS/chap00.xhtml">Begin Reading</a>
               </li>
            </ol>
         </nav>
</section>,<div>
<h3 id="leanpub-auto-book-revision">Book Revision</h3>

<p>Revision 4 - First Edition - 2020-02-19</p>

<h3 id="leanpub-auto-join-our-discord">Join Our Discord</h3>

<p>Come chat with other readers of the book in the official newline Discord channel:</p>

<p>Join here: <a href="https://newline.co/discord/rust">https://newline.co/discord/rust</a></p>

<h3 id="leanpub-auto-bug-reports">Bug Reports</h3>

<p>If you’d like to report any bugs, typos, or suggestions just email us at: <strong>us@fullstack.io</strong>.</p>

<h3 id="leanpub-auto-be-notified-of-updates-via-twitter">Be notified of updates via Twitter</h3>

<p>If you’d like to be notified of updates to the book on Twitter, follow us at <a href="https://twitter.com/fullstackio">@fullstackio</a>.</p>

<h3 id="leanpub-auto-wed-love-to-hear-from-you">We’d love to hear from you!</h3>

<p>Did you like the book? Did you find it helpful? We’d love to add your face to our list of testimonials on the website! Email us at: <a href="mailto:us@fullstack.io">us@fullstack.io</a>.</p>


<!-- begin frontmatter -->

<!-- begin mainmatter -->


</div>,<div>
<h2 id="leanpub-auto-summary">Summary</h2>

<p>The history of computing is filled with powerful abstractions that let the machine manage complexity and thus frees cognitive load from our minds to be spent on more productive tasks. We moved from machine code to assembly to high level languages like C. Each step had a cost associated with giving up some explicit control and a benefit of increased expressive power per unit of code written. Some of these layers were strictly better, i.e. the cost was so negligible compared to the benefits as to be ignored today.</p>

<p>These layers of abstractions continued to be built with different cost/benefit trade-offs. Writing programs to solve complex tasks is a challenging endeavor. Some constraints on our programs have dictated which of those layers of abstractions we can use based on the various trade-offs. At some point, it became generally accepted wisdom that memory safety must be traded off against performance and control. If you want performance then you have to be close to the metal and that is necessarily unsafe. If you want safety then you must be willing to sacrifice some runtime performance to get it. There were counter points in small programs, but no one has challenged this status quo when applied to programming in the large. That is, until Rust.</p>

<p>You can have speed, no garbage collection and therefore a low memory footprint, and you can have safety. Rust affirms our worst fears: programming is hard, humans are fallible. But Rust also assuages those fears by having our computer handle the tasks that are hard for humans. The concepts behind Rust are just the natural evolution in our history of layered abstractions. Whether Rust succeeds or not, history will look back at this as a turning point where it no longer became acceptable to give up safety.</p>



</div>,<div>
<h2 id="leanpub-auto-examples-1">Examples</h2>

<h3 id="leanpub-auto-create-a-post">Create a post</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/users/1/posts -d <code class="s1">'{"title":"Frank says hello","body":"Hello friends"\</code>
<code class="s1">}'</code>

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"user_id"</code>: <code class="m">1</code>,
  <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
  <code class="s2">"body"</code>: <code class="s2">"Hello friends"</code>,
  <code class="s2">"published"</code>: <code class="nb">false</code>
<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-create-a-post-1">Create a post</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/users/2/posts -d <code class="s1">'{"title":"Bob is here too","body":"Hello friends, \</code>
<code class="s1">also"}'</code>

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">2</code>,
  <code class="s2">"user_id"</code>: <code class="m">2</code>,
  <code class="s2">"title"</code>: <code class="s2">"Bob is here too"</code>,
  <code class="s2">"body"</code>: <code class="s2">"Hello friends, also"</code>,
  <code class="s2">"published"</code>: <code class="nb">false</code>
<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-publish-a-post-1">Publish a post</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/posts/1/publish

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"user_id"</code>: <code class="m">1</code>,
  <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
  <code class="s2">"body"</code>: <code class="s2">"Hello friends"</code>,
  <code class="s2">"published"</code>: <code class="nb">true</code>
<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-comment-on-a-post">Comment on a post</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/posts/1/comments -d <code class="s1">'{"user_id":2,"body":"Hi Frank, this is your fri\</code>
<code class="s1">end Bob"}'</code>

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"user_id"</code>: <code class="m">2</code>,
  <code class="s2">"post_id"</code>: <code class="m">1</code>,
  <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-list-all-posts">List all posts</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/posts

<code class="o">[</code>
  <code class="o">[</code>
    <code class="o">[</code>
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">1</code>,
        <code class="s2">"user_id"</code>: <code class="m">1</code>,
        <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
        <code class="s2">"body"</code>: <code class="s2">"Hello friends"</code>,
        <code class="s2">"published"</code>: <code class="nb">true</code>
      <code class="o">}</code>,
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">1</code>,
        <code class="s2">"username"</code>: <code class="s2">"Frank"</code>
      <code class="o">}</code>
    <code class="o">]</code>,
    <code class="o">[</code>
      <code class="o">[</code>
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">1</code>,
          <code class="s2">"user_id"</code>: <code class="m">2</code>,
          <code class="s2">"post_id"</code>: <code class="m">1</code>,
          <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
        <code class="o">}</code>,
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">2</code>,
          <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
        <code class="o">}</code>
      <code class="o">]</code>
    <code class="o">]</code>
  <code class="o">]</code>
<code class="o">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-see-posts">See posts</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/users<code class="se">\</code>
/1/posts

<code class="o">[</code>
  <code class="o">[</code>
    <code class="o">{</code>
      <code class="s2">"id"</code>: <code class="m">1</code>,
      <code class="s2">"user_id"</code>: <code class="m">1</code>,
      <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
      <code class="s2">"body"</code>: <code class="s2">"Hello friends"</code>,
      <code class="s2">"published"</code>: <code class="nb">true</code>
    <code class="o">}</code>,
    <code class="o">[</code>
      <code class="o">[</code>
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">1</code>,
          <code class="s2">"user_id"</code>: <code class="m">2</code>,
          <code class="s2">"post_id"</code>: <code class="m">1</code>,
          <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
        <code class="o">}</code>,
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">2</code>,
          <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
        <code class="o">}</code>
      <code class="o">]</code>
    <code class="o">]</code>
  <code class="o">]</code>
<code class="o">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-publish-other-post">Publish other post</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/posts/2/publish

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">2</code>,
  <code class="s2">"user_id"</code>: <code class="m">2</code>,
  <code class="s2">"title"</code>: <code class="s2">"Bob is here too"</code>,
  <code class="s2">"body"</code>: <code class="s2">"Hello friends, also"</code>,
  <code class="s2">"published"</code>: <code class="nb">true</code>
<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-list-all-posts-again">List all posts again</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/posts

<code class="o">[</code>
  <code class="o">[</code>
    <code class="o">[</code>
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">2</code>,
        <code class="s2">"user_id"</code>: <code class="m">2</code>,
        <code class="s2">"title"</code>: <code class="s2">"Bob is here too"</code>,
        <code class="s2">"body"</code>: <code class="s2">"Hello friends, also"</code>,
        <code class="s2">"published"</code>: <code class="nb">true</code>
      <code class="o">}</code>,
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">2</code>,
        <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
      <code class="o">}</code>
    <code class="o">]</code>,
    <code class="o">[</code>

    <code class="o">]</code>
  <code class="o">]</code>,
  <code class="o">[</code>
    <code class="o">[</code>
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">1</code>,
        <code class="s2">"user_id"</code>: <code class="m">1</code>,
        <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
        <code class="s2">"body"</code>: <code class="s2">"Hello friends"</code>,
        <code class="s2">"published"</code>: <code class="nb">true</code>
      <code class="o">}</code>,
      <code class="o">{</code>
        <code class="s2">"id"</code>: <code class="m">1</code>,
        <code class="s2">"username"</code>: <code class="s2">"Frank"</code>
      <code class="o">}</code>
    <code class="o">]</code>,
    <code class="o">[</code>
      <code class="o">[</code>
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">1</code>,
          <code class="s2">"user_id"</code>: <code class="m">2</code>,
          <code class="s2">"post_id"</code>: <code class="m">1</code>,
          <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
        <code class="o">}</code>,
        <code class="o">{</code>
          <code class="s2">"id"</code>: <code class="m">2</code>,
          <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
        <code class="o">}</code>
      <code class="o">]</code>
    <code class="o">]</code>
  <code class="o">]</code>
<code class="o">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-see-users-comments">See users comments</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/users<code class="se">\</code>
/2/comments
<code class="o">[</code>
  <code class="o">[</code>
    <code class="o">{</code>
      <code class="s2">"id"</code>: <code class="m">1</code>,
      <code class="s2">"user_id"</code>: <code class="m">2</code>,
      <code class="s2">"post_id"</code>: <code class="m">1</code>,
      <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
    <code class="o">}</code>,
    <code class="o">{</code>
      <code class="s2">"id"</code>: <code class="m">1</code>,
      <code class="s2">"title"</code>: <code class="s2">"Frank says hello"</code>,
      <code class="s2">"published"</code>: <code class="nb">true</code>
    <code class="o">}</code>
  <code class="o">]</code>
<code class="o">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-see-post-comments">See post comments</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/posts<code class="se">\</code>
/1/comments
<code class="o">[</code>
  <code class="o">[</code>
    <code class="o">{</code>
      <code class="s2">"id"</code>: <code class="m">1</code>,
      <code class="s2">"user_id"</code>: <code class="m">2</code>,
      <code class="s2">"post_id"</code>: <code class="m">1</code>,
      <code class="s2">"body"</code>: <code class="s2">"Hi Frank, this is your friend Bob"</code>
    <code class="o">}</code>,
    <code class="o">{</code>
      <code class="s2">"id"</code>: <code class="m">2</code>,
      <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
    <code class="o">}</code>
  <code class="o">]</code>
<code class="o">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrapping-up-2">Wrapping up</h3>

<p>We built a database-backed web server with interrelated models of varying degrees of complexity. Nearly every web server with a database is a slight extension of the ideas here. The number of models will grow and the queries will get more complex, but the basic ideas are the same.</p>

<p>Hopefully the last few chapters have given you the confidence to build your next web application with Rust. The expressive type system, increasingly vibrant ecosystem, and top-notch performance make Rust a strong contender against any other platform.</p>



</div>,<div>
<h2 id="leanpub-auto-changelog">Changelog</h2>

<h3 id="leanpub-auto-revision-4-02-19-2020">Revision 4 (02-19-2020)</h3>

<ul>
  <li>Added Chapter 7: Macros</li>
  <li>Updates to the intro</li>
  <li>Fixed typos</li>
  <li>Chapter 3: Fixed the <code>messages-actix</code> code</li>
  <li>Updated <code>blog-actix</code> version</li>
  <li>Added <code>builder</code> and <code>builder-test</code> code</li>
</ul>

<h3 id="leanpub-auto-revision-3-01-29-2020">Revision 3 (01-29-2020)</h3>

<p>Pre-release revision 3</p>

<h3 id="leanpub-auto-revision-2-11-25-2019">Revision 2 (11-25-2019)</h3>

<p>Pre-release revision 2</p>

<h3 id="leanpub-auto-revision-1-10-29-2019">Revision 1 (10-29-2019)</h3>

<p>Initial pre-release version of the book</p>

</div>,<div>
<h2 id="leanpub-auto-introduction">Introduction</h2>

<p>There are numerous reasons to be hopeful about the future of computing, one of which is the existence and continued progression of the Rust programming language.</p>

<p>We are currently in the fifth era of programming language evolution. This is an era where languages have been able to take all of the learnings since the 1950s and incorporate the best parts into languages each with its own cohesive vision.</p>

<p>We have specialized languages cropping up for a wide variety of tasks and countless general purpose languages being actively developed and used. There are significant resources in industry to invest in language design and development which compliment the vibrant academic community. With tools like LLVM and the explosion of open source, creating a language has never been easier.</p>

<p>It is in this environment that Rust has been voted the “most loved programming language” in the Stack Overflow Developer Survey every year since 2016. Standing out in this increasingly crowded world of languages is enough of a reason to ask why Rust?</p>

<h3 id="leanpub-auto-why-rust">Why Rust?</h3>

<p>There are a few potential readings of this question: why should I learn Rust, why are others using Rust, why should I choose Rust over language X? These are all relevant, but I want to start with a bit of a philosophical argument for Rust independent of these specific points.</p>

<p>There is a limit to how transformative an experience you can have when learning a language in a similar paradigm to one you already know. Every language and paradigm has an intrinsic style that is forced on you as you try to solve problems.</p>

<p>If you work within that style then your code will flow naturally and the language will feel like it is working with you. On the other hand, if you fight the natural style of the language you will find it hard or impossible to express your ideas.</p>

<p>Moreover, learning and working with a language will teach you ways to be more effective based on how the language guides you based on its natural design. How much you are able to learn is a function of how much your prior experience and mental models cover the new language.</p>

<p>Rust borrows a lot of ideas from other languages and is truly multi-paradigm, meaning you can write mostly functional code or mostly imperative code and still fit nicely within the language. The most unique feature of the language, the borrow checker, is a system that enforces certain invariants which allow you to make certain safety guarantees. Even this is built on prior art found in earlier languages.</p>

<p>All of these good ideas from the world of programming language design combine in a unique way to make Rust a language that truly makes you think about writing code from a novel perspective. It does not matter how much experience you have, learning Rust will forever change the way you write code for the better.</p>

<p>Okay with that philosophical argument out of the way, let’s dig in to some specifics of why Rust is a exciting.</p>

<p>To help guide this discussion, we can break things down into a few broad categories.</p>

<h4 id="leanpub-auto-on-language-comparisons">On language comparisons</h4>

<p>There is no best programming language. Almost every task has a variety of languages which could be the right tool. Every language comes with good parts and bad parts. Evaluating these trade-offs when faced with a particular problem space is an art unto itself. Therefore, nothing in this book is intended to disparage or denigrate any particular alternative language. The primary goal of this book is to faithfully present Rust. That being said, sometimes comparisons with other languages are instructive and are meant to be instructive rather than as fuel in a flame war.</p>

<h4 id="leanpub-auto-language-features">Language features</h4>

<p>There are a lot of features of Rust which make it a great tool for a great number of tasks. Some highlights include:</p>

<ul>
  <li>Performance </li>
  <li>Strong, static, expressive type system</li>
  <li>Great error messages</li>
  <li>Modern generics</li>
  <li>Memory safety</li>
  <li>Fearless concurrency</li>
  <li>Cross platform</li>
  <li>C interoperability</li>
</ul>

<p>Let’s briefly go through some of these which are probably the biggest reasons that Rust gets talked about. </p>

<h5 id="leanpub-auto-performance">Performance</h5>

<p>Rust is exceptionally fast, in the same ballpark as C and C++. For some programs, specifically due to the lack of pointer aliasing, the Rust compiler can sometimes have enough information to optimize code to be faster than what is possible in C without directly writing assembly. For the vast majority of use cases, you should consider Rust to be fast enough.</p>

<p>Often the most obvious way to write a program is also the fastest. Part of this comes from the commitment to zero-cost abstractions, which are summarized by Bjarne Stroustrup, the creator of C++, as:</p>

<blockquote>
  <p>What you don’t use, you don’t pay for. And further: What you do use, you couldn’t hand code any better.</p>
</blockquote>

<p>Most of the abstractions in Rust, for example iterators, are zero-cost by this definition. The most efficient way to traverse a vector of data is to use a for loop which uses an iterator trait. The generated assembly is usually as good as you could hope for had you written it by hand.</p>

<p>The other aspect of performance is memory consumption. Rust does not have a garbage collector so you can use exactly as much memory as is strictly necessary at any given time. Due to the design of the language, you start to think and see every memory allocation. Using less memory is often easier than the converse. The rest of the language is designed around making working without a garbage collector painless.</p>

<h5 id="leanpub-auto-type-system">Type system</h5>

<p>The type system of Rust is influenced by the long lineage of functional programming languages such as ML and Haskell. It is static, nominal, strong, and for the most part inferred. Don’t worry if that didn’t mean anything to you, but if it did then great. You encode the ideas and constraints of your problem with types. You only have to specify types in a few places with the rest able to be inferred. The compiler then checks everything for you so that you get faster feedback about potential problems. Entire classes of bugs are impossible because of static typing. Most things you encounter in practice are expressible in the type system. The compiler then checks everything for you so that you get faster feedback about potential problems. Entire classes of bugs are impossible because of static typing.</p>

<p>A type system is often called expressive if it is easy to encode your ideas. There are some concepts which are impossible to express in static type systems. Rust has powerful abstraction facilities like sum and product types, tuples, generics, etc. which put the type system definitely in the expressive camp.</p>

<h5 id="leanpub-auto-memory-safety">Memory safety</h5>

<p>A language is memory safe if certain classes of bugs related to memory access are not possible. A language can be called memory unsafe if certain bugs are possible. A non-exhaustive list of memory related bugs include: dereferencing null pointers, use-after free, dangling pointers, buffer overflows.</p>

<p>If you have never written code in a memory unsafe language then these might sound like gibberish to you, which is fine. The important point is this class of bugs is a consistent and large source of security vulnerabilities in systems implemented with memory unsafe languages. For example, about <a href="https://www.cvedetails.com/product/47/Linux-Linux-Kernel.html?vendor_id=33">20% of CVEs</a> ever filed against the Linux kernel are due to memory corruption or overflows. Linux is implemented primarily in C, a spectacularly memory unsafe language.</p>

<p>Memory safety bugs are bad for security and reliability. They lead to vulnerabilities and they lead to crashes. If you can rule these out at compile time then you are in a much better state of the world.</p>

<p>Rust is designed to be memory safe, and thus it does not permit null pointers, dangling pointers, or data races in safe code. There are many interacting features which allow this guarantee. The primary one is the unique system of ownership combined with the borrow checker. This is part of the compiler that ensures pieces of data live at least as long as they need to in order to be alive when they are used.</p>

<p>One other feature is the builtin <code>Option</code> type. This is used to replace the concept of null found in many other languages. In some languages, every type is secretly the union of that type with null. This means that you can always end up with bugs where you assume some variable had a value and it actually was inhabited by the dreaded null. Rust disallows this by not having null and instead having a type which can explicitly wrap other types. For example, consider this Rust code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">print_number</code><code class="p">(</code><code class="n">num</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">match</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="nb">Some</code><code class="p">(</code><code class="n">n</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"I see {}!"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">),</code><code class="w"></code>
<code class="w">    </code><code class="nb">None</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"I see nothing!"</code><code class="p">),</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>

<code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="kd">let</code><code class="w"> </code><code class="n">x</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="mi">42</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="kd">let</code><code class="w"> </code><code class="n">y</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">None</code><code class="p">;</code><code class="w"></code>

<code class="w">  </code><code class="n">print_number</code><code class="p">(</code><code class="n">x</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">print_number</code><code class="p">(</code><code class="n">y</code><code class="p">);</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The function <code>print_number</code> must handle the case where <code>num</code> is <code>None</code>, meaning the <code>Option</code> has no value. There are a few different ways to handle that case but you must explicitly do something for that case or else your code will not compile. </p>

<p>The one caveat here is that Rust does allow blocks of code to be marked <code>unsafe</code> and within those blocks it is possible to violate memory safety. Some things are impossible for the compiler to verify are safe and therefore it refuses to do so. It requires you to use <code>unsafe</code> regions of code to ensure that you understand the invariants required to make sure your code truly is safe.</p>

<p>This does not defeat the purpose, rather in isolates the areas of auditability to just those sections of code which are specifically marked. Nothing you do in normal Rust, also called safe Rust, can result in a memory safety violation, unless something in unsafe code did something wrong ahead of you.</p>

<p>As an example, calling C functions from Rust is unsafe. This is because Rust has no way of knowing what the C code is doing, and C is inherently unsafe, therefore the compiler cannot uphold its guarantees if you call out to C. However, can it be safe to call C? Yes, provided you fill in the visibility gap for the compiler with your own logic.</p>

<h5 id="leanpub-auto-fearless-concurrency">Fearless concurrency</h5>

<p>Concurrency in programming means that multiple tasks can be worked on at the same time. This is possible even for a single thread of execution by interleaving the work for different tasks in chunks rather than only working on tasks as entire chunks.</p>

<p>Parallelism in programming means multiple tasks executing at the exact same time. True parallelism requires multiple threads of execution (or the equivalent).</p>

<p>The Rust language describes its facilities for concurrent and parallel computing as fearless concurrency with a bit of conflation of terms. I will continue in this tradition and use concurrency to mean concurrency and/or parallelism.</p>

<p>Most modern, high level languages have chosen how they want to support concurrency and mostly force you down that path. Some more general purpose languages provide the tools to handle concurrency however you see fit. For example, Go is designed around Communicating Sequential Processes (CSP) and therefore concurrency is most easily achieved using channels and goroutines. Python, on the other hand, has libraries for threads, multiprocesses, message passing actors, etc.</p>

<p>Rust is a low-level language by design and therefore provides tools that allow you to use the model of your choice to achieve your particular goals. Therefore, there are facilities for threads but also channels and message passing.</p>

<p>Regardless of what technique you choose to tackle concurrency and/or parallelism, the same ownership model and type system that ensures memory safety also ensures thread safety. This means that it is a compile time error to write to the same memory from different threads without some form of synchronization. The details are less important than the concept that entire classes of problems that are notoriously difficult to debug in other languages are completely eliminated at compile time while, importantly, retaining all of the performance benefits.</p>

<h5 id="leanpub-auto-c-interoperability">C interoperability</h5>

<p>Rust is foremost a systems programming language. That means it is designed for building low level systems with strict performance requirements and reliability constraints. Frequently in this world, C is the glue that binds many disparate systems. Therefore being able to interoperate with C is an absolute necessity to be able to have a serious systems language. Luckily it is straightforward to interact with C both by calling into C from Rust, as well as exposing Rust as a C library.</p>

<p>You might be saying that sounds great but I don’t plan on writing an operating system anytime soon so why should I care? C is also the most common mechanism for making dynamic languages faster. Typically, when parts of your Python or Ruby code are showing performance problems, you can reach for an extension written in C to speed things up. Well, now you can write that extension in Rust and get all of the high level benefits of Rust and still make your Python or Ruby code think it is talking to C. This is also quite an interesting area for interacting with the JVM.</p>

<h4 id="leanpub-auto-ecosystem">Ecosystem</h4>

<p>Software is not constructed in a vacuum, the practice of programming is often a community driven endeavor. Every language has a community whether it actively cultivates it or not. The ecosystem around a language includes the community of people, but also the tooling or lack thereof.</p>

<p>Rust has grown quite a lot in its short life and has gone through some growing pains as a result. However, the community has always been very welcoming and importantly the culture is a first-class citizen. Rust specifically has a community team as part of the governance structure of the language. This goes a long way to helping the language and ecosystem grow and mature.</p>

<p>We will cover much of the useful tooling that exists around Rust in detail below. However, suffice it to say that the tooling around the language is some of the best that exists. There have been a lot of learnings over the past twenty years about how to manage toolchains and dependencies and Rust has incorporated all of this quite well.</p>

<h4 id="leanpub-auto-the-nature-of-programming">The nature of programming</h4>

<p>The systems and applications we are building today are different than 50 years ago, they are even different than 10 years ago. Therefore, it should not be too much of a stretch to say that the tools we use should also be different.</p>

<p>There is an explosion of embedded systems due to what is commonly called the Internet of Things. However, is C still the best tool for that job? Mission critical software that controls real objects that could lead to serious consequences in the case of failure should be using the best tool for the job. Rust is a serious contender in this space. For example, it is easy to turn off dynamic memory allocation while still being able to use a lot of the nice parts of the language.</p>

<p>The other explosion is continuing on the web. We have been in a web revolution for quite a while now, but things have not slowed down. The deficits of JavaScript are well known and have been addressed along quite a few paths. We have many languages which compile to JavaScript but provide nice features like type systems or a functional paradigm. However, there are fundamental performance and security issues with JavaScript regardless of how you generate it. WebAssembly (WASM) is a step in a different direction where we can compile languages like Rust to a format natively executable in the browser.</p>

<h4 id="leanpub-auto-fun">Fun</h4>

<p>Rust is fun to write. You will disagree with this and think I am crazy at some point while you are learning Rust. There is a learning curve which can be distinctly not fun. However, once your mental model starts to shift, you will find yourself having moments of pure joy when your code just works after the compiler gives you the okay.</p>

<h3 id="leanpub-auto-why-not-rust">Why not Rust</h3>

<p>Rust is just another programming language and as such is just another software project. This means it has built up some legacy, it has some hairy parts, and it has some future plans which may or may not ever happen. Some of this means that for any given project, Rust might not be the right tool for the job.</p>

<p>One area in which Rust might not be right is when interfacing with large C++ codebases. It is possible to have C++ talk to C and then have C talk to Rust and vice versa. That is the approach you should take today if possible. However, Rust does not have a stable ABI nor a stable memory model. Hence, it is not directly compatible with C++. You can incrementally replace parts of a system with Rust and you can build new parts in Rust, but plug-and-play interoperability with C++ is not a solved problem.</p>

<p>Furthermore, Rust takes time to learn. Now this is often cited as a reason for sticking with some other language because one is deemed an expert in that language. However, a counter point might be that you are not as much of an expert in that language as you might believe. A further counter point is that it might not matter, the other language might be fundamentally flawed enough that being an expert is irrelevant. Nonetheless, there are times where using the tool you know is the right answer.</p>

<p>The gap between learning Rust and knowing it from using it in anger is a bit bigger than in some other languages. Therefore the learning curve might seem steeper than you are used to. However, this is primarily because what is safe in Rust with the borrow checker helping you can be insane in other languages.</p>

<p>Type systems are amazing. You tell the computer some facts about your problem domain and it continually checks that those things are true and lets you know if you screw up. Yet there are valid programs which are inexpressible in a static type system. This is both theoretically true and actually happens in practice. Moreover, dynamic languages can frequently be more productive for small, isolated tasks. Sometimes the cost of the type system is not worth it.</p>

<h3 id="leanpub-auto-this-books-mission">This book’s mission</h3>

<p>Rust has a great set of documentation around the standard library and has an official <a href="https://doc.rust-lang.org/book/">“book”</a> which is a great place to start if you are looking for another source of material. However, this book has a different focus than a traditional book trying to teach you a language. Our goal is to build realistic applications and explore some of the techniques and tools available in Rust for accomplishing those tasks.</p>

<p>In the process of working through some common scenarios, hopefully you will also be able to learn Rust. There is a gradual ramp up from very simple to more complex programs as we build up our Rust toolbelt. One specific goal is to show places where many people usually stumble and try to support you in finding your own ways over those hurdles. This should empower you when you branch out to your own problems.</p>

<p>This approach has the downside of not necessarily covering every language feature in the same depth or in the same order that you might encounter in a standard programming language introduction. Furthermore, we will explicitly try to take a pragmatic path rather than belabor esoteric details. Those details can be quite interesting and will be there for you when you want to seek them out, but often they get in the way of learning. We will sometimes do things in a less than perfect way as the trade-off is worth the expositional benefit.</p>

<p>Overall the goal is to get you to a state of productivity as quickly as possible. Along the way we will provide pointers to further material if you want to go deeper.</p>

<h3 id="leanpub-auto-setting-expectations-based-on-your-background">Setting expectations based on your background</h3>

<p>A great deal of terminology in the programming language space is built on a base set of shared ideas that have become so entrenched as to be overlooked by most every day developers. There are some lines we have to draw where we lean on some assumed prior knowledge. Thus, if you have never written any code before this might be a challenging book to make it entirely through. If you are willing to take some leaps of faith then you should be able to make it.</p>

<p>First and foremost, absolutely zero Rust background is assumed and every new concept will be explained as it arises.</p>

<p>If you have a background that only includes garbage collected, dynamically typed languages, such as Python, JavaScript, Ruby, PHP, then the biggest hurdle will probably be working with the type system. That being said, you might just find a wondrous joy associated with the tight feedback loop of a compiler telling you all the things you have done wrong. Moreover, the type inference will let you forget about it most of the time. Some of the points around memory safety might seem less exciting to you because all of these languages are also memory safe. The approach to achieving memory safety is different but the end result is the same. Some topics around pointers and references might seem new, but all of these languages leak those concepts and you probably already understand them just in a different form. For example, if you write the following Python:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">def</code> <code class="nf">someFunc</code><code class="p">(</code><code class="n">items</code> <code class="o">=</code> <code class="p">[]):</code>
    <code class="n">items</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">items</code>

<code class="n">a</code> <code class="o">=</code> <code class="n">someFunc</code><code class="p">()</code>
<code class="n">b</code> <code class="o">=</code> <code class="n">someFunc</code><code class="p">()</code>

<code class="n">a</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>

<code class="k">print</code><code class="p">(</code><code class="n">a</code><code class="p">)</code>
<code class="k">print</code><code class="p">(</code><code class="n">b</code><code class="p">)</code>
</pre></div>

</figure>

<p>you will see <code>[1, 1, 2]</code> printed twice. As a diligent Python programmer you know not to use lists as default arguments to functions like this and the reason has to do with values versus references. So even if you don’t explicitly think that you are working with pointers, you definitely do use them all the time. Rust has many high level syntactic features that make it feel surprisingly similar to a dynamic language.</p>

<p>If you have a background in functional programming coming from Haskell or the ML family then a lot will feel quite at home. But, the use of mutability and explicit imperative style might be less of your thing. Rust has great functional programming facilities and the type system borrows a lot from these languages. However, Rust is more geared towards giving you a lot of the same safety benefits of functional programming while still writing imperative code. Shared, mutable state is the root of all evil. Functional programming attacks that problem by doing away with mutability. Rust attacks it by doing away with sharing.</p>

<p>If you are coming from C++ then you are in for an easier road in some ways and a much harder one in others. I focus here on C++ as it is more superficially similar, but many points also apply to C. Much of the syntax and most of the concepts will be familiar to you. However, there are a few new concepts, like lifetimes, and a few things that look the same but are not, like references and move semantics.</p>

<p>There are APIs you will find in Rust which you might find to be highly performant, but laughably dangerous if ported to C++. You are correct. However, the borrow checker can make such APIs safe. For example, would you give a reference to a stack allocated piece of data to another thread? Would you store a reference to part of a string in a heap allocated struct? Both those are invitations to disaster in C++. They are trivial to do correctly in Rust thanks to the borrow checker and can be great for performance. The API you might find normal in C++ may not be expressible in safe Rust. That is, the borrow checker may not allow you to compile code you consider correct. You may in fact be correct. However, this is usually an API which is easy to misuse and is only correct with a significant amount of cognitive burden on you.</p>

<p>Hence, coming from C++ might require the most shift in how you think about structuring programs. You are more likely to “fight the borrow checker” because some of the ways Rust wants you to do things are just plain against your instincts.</p>

<p>Rust has a bit of notoriety for having a steep learning curve, but it is actually mostly about unlearning things from other languages. Therefore, having less experience can work in your favor.</p>

<h3 id="leanpub-auto-getting-your-environment-setup">Getting your environment setup</h3>

<p>This book assumes an installed version of Rust and some associated tooling. The first step in getting setup is to visit the official installation website:</p>

<blockquote>
  <p>https://www.rust-lang.org/tools/install</p>
</blockquote>

<p>You should be able to follow the instructions to get setup via <code>rustup</code>. Rust has a fast release cadence for a programming language with a new version every six week. This means that the particular version as of this writing will be stale by the time you are reading it. However, Rust also puts a strong emphasis on backwards compatibility. Thus, as long as you are using a version of Rust at least as new as when this was written, everything should still work for you. Rust 1.37.0 should be new enough for all the code in this book. Moreover, we are using the 2018 edition exclusively. There is an <a href="https://doc.rust-lang.org/edition-guide/index.html">entire guide</a> dedicated to explaining the editions so we will not cover it in depth here.</p>

<h3 id="leanpub-auto-rustup">Rustup</h3>

<p>The <a href="https://rustup.rs">rustup</a> tool is your one stop shop for managing multiple versions of the Rust compiler on your machine. You can have different versions of the compiler installed next to each other and easily switch back and forth between them. You can install nightly releases to try out new features and then easily switch back to stable for other projects. If you have ever dealt with the absolute madness associated with managing different versions of some languages then you will be delighted at how well <code>rustup</code> just works.</p>

<p>One note, for some reason all of the details of rustup can be found in <a href="https://github.com/rust-lang/rustup">the Github readme</a> for the project. It is pretty easy to use but the command line help frequently fails me.</p>

<h3 id="leanpub-auto-cargo">Cargo</h3>

<p><code>rustc</code> is the Rust compiler, and you can invoke it directly, however you will find this rarely to be necessary as the majority of your time will be spent interacting with Cargo. Cargo is a dependency manager and a build system. You use a manifest to specify details of your code and its dependencies and you can then instruct Cargo to build your code and it will take care of the rest. You can have Cargo manage building for other platforms and for quickly type checking via <code>cargo check</code>. You use it to run tests via <code>cargo test</code> and for countless other tasks.</p>

<p>We will cover code structure later on, but the primary unit is known as a crate. You can depend on other crates and the public repository can be found at <a href="https://crates.io/">crates.io</a>. This is related to Cargo in that there is quite a bit of default work builtin to Cargo for working with crates.io, but it is not absolutely required.</p>

<p>Cargo has <a href="https://doc.rust-lang.org/cargo/guide/">its own guide</a> which is a great source of information when you find yourself wondering how to do something with Cargo. You can also always run <code>cargo help</code> to answer your questions from the command line.</p>

<h3 id="leanpub-auto-ides-rls-editors">IDEs, RLS, Editors</h3>

<p>The editor support story is getting better and is significantly better than it used to be. A project known as the <a href="https://github.com/rust-lang/rls">Rust Language Server</a>(RLS) is designed to provide the backend for any editor to interact with the compiler and a tool called <a href="https://github.com/racer-rust/racer">Racer</a> which provides faster (but less precise) information than the compiler can. This is a project that conforms to the <a href="https://langserver.org/">Language Server Protocol</a>(LSP) so that every editor which can act as a LSP client can work with RLS. There is a reference implementation of an RLS specific frontend for Visual Studio Code, so if you are unsure where to start that might be one to try out.</p>

<p>If you have a favorite editor already, like Vim or Emacs, then there are plugins you can use to make working with Rust more comfortable. Personally, I use Vim and a shell for running commands directly with Cargo. This is mostly so that I can move between environments with minimal change to my workflow, and I have found that Rust is amenable to this style. There are some languages which are very hard to work with without autocomplete and Rust has not been like that for me.</p>

<p>Check out the <a href="https://www.rust-lang.org/tools">official website</a> for an up to date list of tools.</p>

<h3 id="leanpub-auto-clippy">Clippy</h3>

<p>The linter is affectionately named <a href="https://github.com/rust-lang/rust-clippy">Clippy</a>. Cargo supports an awesome feature where you can install subcommands via rustup so that  you can selectively add components to Cargo based on your needs. Clippy can be installed this way by running:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>rustup component add clippy
</pre></div>

</figure>

<p>and then run with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo clippy
</pre></div>

</figure>

<p>It provides a bunch of helpful information and is good to run against your code regularly. There are many ways to configure it both at a project level as well as at particular points in your code. Linters are still an under used tool that end up being a big source of bike shedding on larger teams. However using at least something to catch the most egregious issues is better than nothing.</p>

<h3 id="leanpub-auto-rustfmt">Rustfmt</h3>

<p>Rust has an official code formatter called <a href="https://github.com/rust-lang/rustfmt">rustfmt</a>. This was a project that started life in the community and eventually got official status. However, it is not as seriously official as gofmt for the Go language. You can configure <code>rustfmt</code> based on a couple attributes and there is nothing forcing you to use it. But, you should use it. Automated code formatting is one of the great productivity wins of the past twenty years. Countless engineering hours will no longer be wasted debating the finer points of column widths, tabs versus spaces, etc. Let the formatter do its job and get back to building.</p>

<h3 id="leanpub-auto-documentation">Documentation</h3>

<p>The standard library has <a href="https://doc.rust-lang.org/std/index.html">documentation</a> which you will consult frequently. It is thorough and well-written. I know that typing <code>d</code> into my browser’s address bar and hitting enter will take me to doc.rust-lang.org.</p>

<p>All crates on <a href="https://crates.io">crates.io</a> will automatically have its documentation built and available on <a href="https://docs.rs/">docs.rs</a> which is an amazing tool for the community. Rust has great facilities for including documentation in your code which is why most crates are quite well documented. One excellent feature is the ability to include code samples in your documentation which is actually checked by the compiler. Thus the code examples in the documentation are never out of date</p>

<p>The <a href="https://doc.rust-lang.org/rustdoc/index.html">offical rustdoc book</a> is a great resource for learning about documenting your Rust code.</p>

<h3 id="leanpub-auto-the-nomicon">The Nomicon</h3>

<p>Rust has a safe and an unsafe side. You may one day find yourself wondering more about what goes on over on the mysterious, dark unsafe side. Well look no further than the <a href="https://doc.rust-lang.org/nomicon/">Rustonomicon</a> known colloquially as The Nomicon. This book will give you more guidance about how safe and unsafe interact, what you can and cannot do in unsafe Rust, and most importantly how not to break things when you need to use unsafe. It is highly unusual to need to use unsafe. Even when performance is critical, safe Rust most likely can solve your problem. However, there are instances where you really need to reach for this tool and the Nomicon will be your friend at that time.</p>


</div>,<div>
<h2 id="leanpub-auto-making-your-first-rust-app">Making Your First Rust App</h2>

<h3 id="leanpub-auto-getting-started">Getting started</h3>

<p>We are going to build an application in Rust to get a feel for the language and ecosystem. The first step for all new Rust projects is generating a new project. Let’s create a new project called <code>numbers</code>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new numbers
</pre></div>

</figure>

<p>Cargo is the package manager for Rust. It is used as a command line tool to manage dependencies, compile your code, and make packages for distribution. Running <code>cargo new project_name</code> by default is equivalent to <code>cargo new project_name --bin</code> which generates a <em>binary</em> project. Alternatively, we could have run <code>cargo new project_name --lib</code> to generate a <em>library</em> project.</p>

<h3 id="leanpub-auto-binary-vs-library">Binary vs. library</h3>

<p>A binary project is one which compiles into an executable file. For binary projects, you can execute <code>cargo run</code> at the root of your application to compile and run the executable.</p>

<p>A library project is one which compiles into an artifact which is shareable and can be used as a dependency in other projects. Running <code>cargo run</code> in a library project will produce an error as cargo cannot figure out what executable you want it to run (because one does not exist). Instead, you would run <code>cargo build</code> to build the library.</p>

<p>There are different formats which the Rust compiler can generate based on your configuration settings depending on how you wish to use your library.</p>

<p>The default is to generate an <code>rlib</code> which is a format for use in other Rust projects. This allows your library to have a reduced size for further distribution to other Rust projects while still being able to rely on the standard library and maintain enough information to allow the Rust compiler to type check and link to your code.</p>

<p>Alternative library formats exist for more specialized purposes. For example, the <code>cdylib</code> format is useful for when you want to produce a dynamic library which can be linked with C code. This produces a <code>.so</code>, <code>.dylib</code>, or <code>.dll</code> depending on the target architecture you build for.</p>

<h3 id="leanpub-auto-the-generated-project">The generated project</h3>

<p>Let’s enter the directory for our newly generated Rust project to see what is created:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">cd</code> numbers
</pre></div>

</figure>

<p>The generated structure is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>.
├── Cargo.toml
└── src
    └── main.rs
</pre></div>

</figure>

<p>Rust code organization relies primarily on convention which can be overridden via configuration, but for most use cases the conventions are what you want.</p>

<h4 id="leanpub-auto-mainrs">main.rs</h4>

<p>For a binary project, the entry point is assumed to be located at <code>src/main.rs</code>. Furthermore, inside that file, the Rust compiler looks for a function named <code>main</code> which will be executed when the binary is run. Cargo has generated a <code>main.rs</code> file which contains a simple “Hello, world!” application:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Hello, world!"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">3 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The syntax here says define a function (<code>fn</code>) with the name <code>main</code> which takes zero arguments and returns the empty tuple <code>()</code>.</p>

<aside>
  <p>Leaving off the return type is equivalent to writing <code>-&gt; ()</code> after the argument list of the function. All function calls are expressions which must return a value. The empty tuple <code>()</code> is a marker for no value, which is what a function with no return type implicitly returns.</p>

</aside>

<p>The body of the function calls a macro <code>println</code> which prints its argument <code>"Hello, world!"</code> to standard out followed by a newline.</p>

<aside>
  <p>We will cover macros more later, but for now we will mention a few basics. We know it is a macro invocation and not a normal function call because of the trailing <code>!</code> in the name. Macros are a powerful form of meta-programming in Rust which you will use frequently but probably rarely find the occasion to have to write. Rust implements <code>println</code> as a macro instead of as a regular function because macros can take a variable number of arguments, while a regular function cannot.</p>

</aside>

<p>The syntax of Rust is superficially similar to C++ which we can see as curly braces are used for denoting blocks and statements are semicolon terminated. However, there is quite a bit more to the Rust grammar that we will cover as we go along.</p>

<h4 id="leanpub-auto-carotoml">Caro.toml</h4>

<p>The <code>Cargo.toml</code> file is the manifest file for the project which uses the <a href="https://github.com/toml-lang/toml">TOML</a> format. This is the entry point for describing your project as well as specifying dependencies and configuration. The initial generated file contains the bare essentials for describing your project:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">[package]</code>
<code class="lineno">2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"numbers"</code>
<code class="lineno">3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno">4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;your.name@example.com&gt;"]</code>
<code class="lineno">5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">[dependencies]</code>
</pre></div>

</figure>

<p>The blank section for dependencies is included because nearly every project includes some dependencies. One feature of Rust has been to keep the core language and standard library relatively slim and defer a lot of extra functionality to the community. Therefore relying on third party dependencies is encouraged.</p>

<h3 id="leanpub-auto-crates">Crates</h3>

<p>The primary unit of code organization in Rust is called a crate. Your code exists as a crate which can be distributed to the community via <a href="https://crates.io/">crates.io</a>. Crates in Rust are analogous to gems in Ruby or packages in JavaScript. The registry at crates.io is similar to rubygems.org or npmjs.com as the de facto community repository for distributing and sharing code.</p>

<p>Binary Rust projects are also called crates so they do not solely represent shared library code. Furthermore, a crate can contain both a library and an executable.</p>

<p>It is often difficult to foresee how other’s will want to use your software. A common practice in the Rust community is to create dual library/binary crates even when the primary intention of a project is to produce an executable. This can have positive effects on the API design of your code knowing that it should be suitable for external consumption. The binary part of the crate is typically responsible for argument parsing and configuration, and then calls into the functionality exposed by the library part of the crate. Writing all of your code only as an executable and then trying to extract a library after the fact can be a more difficult process. Moreover, the cost of splitting code into a library is minimal.</p>

<h3 id="leanpub-auto-making-our-crate-a-library">Making our crate a library</h3>

<p>Cargo assumes the entry point for defining a library crate is a file <code>src/lib.rs</code>. Let’s convert our current binary crate into a binary and library crate. First, we create our library entry point:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">say_hello</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Hello, world!"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">3 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>There are two differences to this code from what was in <code>main.rs</code>. First, we changed the name of the function from <code>main</code> to <code>say_hello</code>. This change is more cosmetic than anything (in fact leaving it named <code>main</code> works just fine, <code>main</code> is only special in some contexts).</p>

<p>The second change is the keyword <code>pub</code> before <code>fn</code>. This is a privacy identifier which specifies that this function should be publicly accessible to user’s of our crate. Without the keyword, we could call this function inside of our <code>lib.rs</code> file, but user’s of our crate would not be able to call it. Note that our executable sees the library crate the exact same as someone who included our library as a dependency in their <code>Cargo.toml</code> file. This ensures a proper separation of concerns between code meant to be executed as a binary and the actual functionality of your project.</p>

<p>We can now change our <code>main</code> function to use the functionality exposed by our library:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">numbers</code>::<code class="n">say_hello</code><code class="p">();</code><code class="w"></code>
<code class="lineno">3 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Running this code should result in the same output as before:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo run
   Compiling numbers v0.1.0 <code class="o">(</code>...<code class="o">)</code>
    Finished dev <code class="o">[</code>unoptimized + debuginfo<code class="o">]</code> target<code class="o">(</code>s<code class="o">)</code> in <code class="m">0</code>.53s
     Running <code class="sb">`</code>target/debug/numbers<code class="sb">`</code>
Hello, world!
</pre></div>

</figure>

<p>Let’s unpack this function call syntax a little bit before moving on. Even though our binary exists in the same codebase as our library, we still must refer to the functions in the crate by the name of the crate, <code>numbers</code> in this case.</p>

<p>We wish to call a function named <code>say_hello</code> which exists in the <code>numbers</code> crate. The double colon operator <code>::</code> is used for separating items in the hierarchy of modules. We will cover modules later, but suffice it to say that crates can contain modules, which themselves can contain more modules.</p>

<p>To resolve an item, be it a type or function, you start with the name of the crate, followed by the module path to get to the item, and finally the name of the item. Each part of this path is separated by <code>::</code>. For example, to get a handle to the current thread you can call the function <code>std::thread::current</code>. The crate here is <code>std</code> which is the standard library. Then there is a module called <code>thread</code>. Finally inside the <code>thread</code> module there is an exported function called <code>current</code>.</p>

<p>Items can exist at the top level of a crate (i.e. not nested in any modules), which you refer to simply by the name of the crate, then <code>::</code>, then the name of the item. This is what is happening with <code>numbers::say_hello</code> because <code>say_hello</code> exists at the top level of our <code>numbers</code> crate.</p>

<h3 id="leanpub-auto-trade-offs">Trade-offs</h3>

<p>Two of the big selling points of Rust are performance and reliability. Performance meaning both runtime speed and memory consumption. Reliability here means catching bugs at compile time and preventing certain classes of errors entirely through language design. These goals are often seen as classically at odds with one another. For example, C lives in a world where performance is of utmost importance, but reliability is left as an exercise for the implementor.</p>

<p>Rust has no garbage collector and no runtime in the traditional sense. However, most difficulties of working with manual memory management are taken care of for you by the compiler. Therefore, you will often hear “zero cost” being used to describe certain features or abstractions in the language and standard library. This is meant to imply that neither performance nor reliability has to suffer to achieve a particular goal. You write high level code and the compiler turns it into the same thing as the “best” low level implementation.</p>

<p>However, in practice, what Rust really gives you is the tools to make choices about what trade-offs you want to make. Underlying the design and construction of all software is a series of trade-offs made knowingly or implicitly. Rust pushes more of these trade-offs to the surface which can make the initial learning period seem a bit more daunting especially if you have experience in languages where many trade-offs are implicit.</p>

<p>This will be a topic that permeates this book, but for now we will highlight some of these aspects as we make our <code>numbers</code> crate do something more interesting.</p>

<h3 id="leanpub-auto-print-a-list-of-numbers">Print a list of numbers</h3>

<p>Let’s build an application that creates a list of numbers and then prints each number on a line by itself to standard out. As a first step, let’s just say we want to print the numbers one through five. Therefore, our goal is the following:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo run
<code class="m">1</code>
<code class="m">2</code>
<code class="m">3</code>
<code class="m">4</code>
<code class="m">5</code>
</pre></div>

</figure>

<p>Let’s change our <code>main</code> function to call the yet to be defined library function <code>print</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">numbers</code>::<code class="n">print</code><code class="p">();</code><code class="w"></code>
<code class="lineno">3 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Since we want to print one through five, we can create an array with those numbers and then print them out by looping over that array. Let’s create the function <code>print</code> in <code>lib.rs</code> to do that:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno">3 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">4 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">6 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s unpack this from the inside out. We have already seen the <code>println</code> macro, but here we are using it with a formatted string for the first time. There are two main features of string interpolation in Rust that will take you through most of what you need. The first argument to one of the printing macros (<code>print</code>, <code>println</code>, <code>eprint</code>, <code>eprintln</code>) is a double quoted string which can contain placeholders for variables. The syntax for placeholders to be printed “nicely” is <code>{}</code>, and for debugging purposes is <code>{:?}</code>. The full syntax for these format strings can be found <a href="https://doc.rust-lang.org/std/fmt/">in the official docs</a>.</p>

<p>The “nice” format is possible when a type implements the <code>Display</code> trait. The debugging format is possible when a type implements the <code>Debug</code> trait. Not all types implement <code>Display</code>, but the standard practice is for all public types to implement <code>Debug</code>. So when in doubt, use <code>{:?}</code> to see the value of some variable and it should almost always work.</p>

<aside>
  <p>We will cover traits in detail later, but we will give a crash course here for what is necessary. Traits are part of the type system to mark certain facts about other types. Commonly they are used to define an interface to a particular set of functions that the type in question implements. You can define your own traits as well as implement traits. Whether a type implements a trait must be stated explicitly in code rather than implicitly by satisfying the functional requirements of the trait. This is one of a few differences between Rust traits and Go interfaces.</p>

</aside>

<p>We will see when creating types later that usually you can get a <code>Debug</code> implementation derived for free, but you must implement <code>Display</code> yourself if you want it. Most built-in types implement <code>Display</code>, including integers, so we use the format string <code>"{}"</code> to say expect one variable. Note that the following does not work:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="n">n</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>The first argument to the print macros must be a literal string, it cannot be a variable, even if that variable points to a literal string. Therefore, to print out a variable you need to use the format string <code>"{}"</code> as we are doing. If you forget this the Rust compiler will suggest that as what you probably want to do.</p>

<h4 id="leanpub-auto-iteration">Iteration</h4>

<p>So assuming that <code>n</code> holds an integer from our collection, we are printing it out using the <code>println</code> macro. How does <code>n</code> get bound to the values from our collection? We loop over our collection using a <code>for</code> loop and bind <code>n</code> to each value. The syntax of a <code>for</code> loop is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">for</code><code class="w"> </code><code class="n">variable</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">iterator</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Note that we are calling the method <code>iter</code> on our array. Rust abstracts the idea of iteration into yet another trait, this one called <code>Iterator</code>. We have to call <code>iter</code> here to turn an array into an <code>Iterator</code> because arrays do not automatically coerce into into an <code>Iterator</code>. We shall see shortly that this is not always necessary with other collections.</p>

<p>This is also the first time we are calling a method on an object. Rust types can implement functions that operate on themselves and can therefore be called using this dot syntax. This is syntactic sugar for a direct function call with the receiver object as the first argument. We will cover how these functions are defined when we construct our own types and implement methods on them.</p>

<h4 id="leanpub-auto-defining-array-types">Defining Array Types</h4>

<p>We can move out further now to the definition of our array. Rust borrows many ideas of the ML family of languages so some concepts might be familiar if you have experience in that area. By default variables are immutable. Therefore we declare an immutable variable called <code>numbers</code> which is bound to an array with the numbers we are interested in. Rust infers the type of <code>numbers</code> based on the value we used to initialize the variable. If you want to see the type that is inferred by Rust, a trick is to write:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">numbers</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>after the line that declares the variable <code>numbers</code>. When you try to compile this code, there will be a type mismatch in the assignment which will print out what the compiler expects:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo run
   Compiling numbers v0.1.0 <code class="o">(</code>...<code class="o">)</code>
error<code class="o">[</code>E0308<code class="o">]</code>: mismatched types
 --&gt; src/lib.rs:3:9
  <code class="p">|</code>
<code class="m">3</code> <code class="p">|</code>     <code class="nb">let</code> <code class="o">()</code> <code class="o">=</code> numbers<code class="p">;</code>
  <code class="p">|</code>         ^^ expected array of <code class="m">5</code> elements, found <code class="o">()</code>
  <code class="p">|</code>
  <code class="o">=</code> note: expected <code class="nb">type</code> <code class="sb">`</code><code class="o">[{</code>integer<code class="o">}</code><code class="p">;</code> <code class="m">5</code><code class="o">]</code><code class="sb">`</code>
             found <code class="nb">type</code> <code class="sb">`</code><code class="o">()</code><code class="sb">`</code>

error: aborting due to previous error

For more information about this error, try <code class="sb">`</code>rustc --explain E0308<code class="sb">`</code>.
error: Could not compile <code class="sb">`</code>numbers<code class="sb">`</code>.

To learn more, run the <code class="nb">command</code> again with --verbose.
</pre></div>

</figure>

<p>We see that the compiler inferred a type of <code>[{integer}; 5]</code> for <code>numbers</code>. Arrays in Rust are a homogeneous container (all elements have the same type) with a fixed size. This allows it to be stack allocated. The ability to ensure data is stack allocated rather than heap allocated is one of the areas in which Rust allows you to decide what trade-offs you want to make. On the other hand, because an array has a fixed size that must be known at compile time it is not useful for data which might need to grow or shrink or contain an unknown numbers of items. For this we have the <code>Vec</code> type which we will return to shortly.</p>

<p>You can also see that the compiler infers the type of elements of the array to be <code>{integer}</code> which is a placeholder as without any further constraints the specific type of integer is unknown. Rust has twelve integer types which depend on size and whether it is signed or unsigned. The default is <code>i32</code> which means a signed integer that takes 32 bits of space. The equivalent unsigned type is <code>u32</code>. Let’s say we wish our numbers to be <code>u8</code>, that is 8-bit unsigned integers. One way to do this is to specify directly on the numerical constant what type we want:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="k">u8</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
</pre></div>

</figure>

<p>If we do this then the compiler will infer the type <code>[u8; 5]</code> for our array. The other way is to explicitly write out the type of the variable <code>numbers</code>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code>: <code class="p">[</code><code class="kt">u8</code><code class="p">;</code><code class="w"> </code><code class="mi">5</code><code class="p">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
</pre></div>

</figure>

<p>Type annotations are written with a colon after the variable name followed by the type. We see that the size of the array (5) is part of the type. Therefore, even with the same type of elements, say <code>u8</code>, an array with four elements is a different type than an array with five elements.</p>

<h4 id="leanpub-auto-using-stdvecvec">Using std::vec::Vec</h4>

<p>Rust provides a few mechanisms for alleviating some of the limitations of arrays. The first we will talk about is the vector type in the standard library, <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>std::vec::Vec</code></a>. A vector is similar to an array in that it stores a single type of element in a contiguous memory block. However, the memory used by a vector is heap allocated and can therefore grow and shrink at runtime. Let’s convert our library print function to use a vector:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno">3 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">4 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">6 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We are calling another macro <code>vec</code> which this time constructs a vector with the given values. This looks very similar to the array version, but is actually quite different. Vectors own their data elements, they have a length which says how many elements are in the container, and they also have a capacity which could be larger than the length. Changing the capacity can involve quite a bit of work to allocate a new region of memory and move all of the data into that region. Therefore, as you add elements to a vector, the capacity grows by a multiplicative factor to reduce how frequently this process needs to take place. The biggest advantage is that you do not need to know upfront how large the vector needs to be; the length is not part of the type.</p>

<p>The type of a vector is <code>Vec&lt;T&gt;</code> where <code>T</code> is a generic type that represents the types of the elements. Therefore, <code>Vec&lt;i32&gt;</code> and <code>Vec&lt;u8&gt;</code> are different types, but a <code>Vec&lt;u8&gt;</code> with four elements is the same type as one with five elements.</p>

<p>Note also that we are no longer explicitly calling <code>iter</code> on the <code>numbers</code> variable in our for loop preamble. The reason for this is that <code>Vec</code> implements a trait that tells the compiler how to convert it into an iterator in places where that is necessary like in a for loop. Calling <code>iter</code> explicitly would not be an error and would lead to the same running code, but this implicit conversion to an iterator is common in Rust code.</p>

<h4 id="leanpub-auto-function-arguments">Function Arguments</h4>

<p>Let’s abstract our print function into two functions. The entry point will still be print (so we don’t need to change <code>main</code>) which will construct a collection, but it will then use a helper function to actually print the contents of this collection. For now we will go back to using an array for the collection:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="p">[</code><code class="kt">u8</code><code class="p">;</code><code class="w"> </code><code class="mi">5</code><code class="p">])</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is our first function that has input or output. Type inference does not operate on function signatures so you must fully specify the types of all inputs and the output. However, we still are not returning anything so by convention we elide the <code>-&gt; ()</code> return type which is the one exception to the rule of fully specifying the types in function signatures.</p>

<p>The input type of our function <code>output_sequence</code> is our five element array of <code>u8</code> values.</p>

<p>Rust has a few different modes of passing arguments to functions. The biggest distinction being that <strong>Rust differentiates between</strong>:</p>

<ul>
  <li>a function temporarily having access to a variable (borrowing) and</li>
  <li>having <em>ownership</em> of a variable.</li>
</ul>

<p>Another dimension is whether the function can mutate the input.</p>

<p>The default behavior is for a function to take <strong>input by value and hence ownership</strong> of the variable is moved into the function.</p>

<p>The exception to this rule being if the type implements a special trait called <code>Copy</code>, in which case the input is copied into the function and therefore the caller still maintains ownership of the variable. If the element type of an array implements the <code>Copy</code> trait, then the array type also implements the <code>Copy</code> trait.</p>

<p>Suppose we want to use a vector inside <code>print</code> instead, so we change the code to:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="p">[</code><code class="kt">u8</code><code class="p">;</code><code class="w"> </code><code class="mi">5</code><code class="p">])</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>But this won’t work because <code>[u8; 5]</code> and <code>Vec&lt;u8&gt;</code> are two different types. One possible fix is to change the input type to <code>Vec&lt;u8&gt;</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This works for this case. It also let’s us see what happens when passing a non-Copy type to a function. While arrays implement the <code>Copy</code> trait if their elements do, <code>Vec</code> does not. Hence, try adding another call to <code>output_sequence(numbers)</code> after the first one:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">11 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This gives us an error:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">$</code><code class="w"> </code><code class="n">cargo</code><code class="w"> </code><code class="n">run</code><code class="w"></code>
<code class="w">   </code><code class="n">Compiling</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="n">v0</code><code class="p">.</code><code class="mf">1.0</code><code class="w"> </code><code class="p">(...)</code><code class="w"></code>
<code class="n">error</code><code class="p">[</code><code class="n">E0382</code><code class="p">]</code>: <code class="nc">use</code><code class="w"> </code><code class="n">of</code><code class="w"> </code><code class="n">moved</code><code class="w"> </code><code class="n">value</code>: <code class="err">`</code><code class="n">numbers</code><code class="err">`</code><code class="w"></code>
<code class="w"> </code><code class="o">-</code>-&gt; <code class="nc">src</code><code class="o">/</code><code class="n">lib</code><code class="p">.</code><code class="n">rs</code>:<code class="mi">4</code>:<code class="mi">21</code><code class="w"></code>
<code class="w">  </code><code class="o">|</code><code class="w"></code>
<code class="mi">3</code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="o">|</code><code class="w">                     </code><code class="o">-------</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="n">moved</code><code class="w"> </code><code class="n">here</code><code class="w"></code>
<code class="mi">4</code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="n">output_sequence</code><code class="p">(</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="o">|</code><code class="w">                     </code><code class="o">^^^^^^^</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="n">used</code><code class="w"> </code><code class="n">here</code><code class="w"> </code><code class="n">after</code><code class="w"> </code><code class="k">move</code><code class="w"></code>
<code class="w">  </code><code class="o">|</code><code class="w"></code>
<code class="w">  </code><code class="o">=</code><code class="w"> </code><code class="n">note</code>: <code class="nc">move</code><code class="w"> </code><code class="n">occurs</code><code class="w"> </code><code class="n">because</code><code class="w"> </code><code class="err">`</code><code class="n">numbers</code><code class="err">`</code><code class="w"> </code><code class="n">has</code><code class="w"> </code><code class="k">type</code> <code class="err">`</code><code class="n">std</code>::<code class="n">vec</code>::<code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="err">`</code><code class="p">,</code><code class="w"> </code><code class="n">w</code><code class="err">\</code><code class="w"></code>
<code class="n">hich</code><code class="w"> </code><code class="n">does</code><code class="w"> </code><code class="n">not</code><code class="w"> </code><code class="n">implement</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="err">`</code><code class="nb">Copy</code><code class="err">`</code><code class="w"> </code><code class="k">trait</code><code class="w"></code>

<code class="n">error</code>: <code class="nc">aborting</code><code class="w"> </code><code class="n">due</code><code class="w"> </code><code class="n">to</code><code class="w"> </code><code class="n">previous</code><code class="w"> </code><code class="n">error</code><code class="w"></code>

<code class="n">For</code><code class="w"> </code><code class="n">more</code><code class="w"> </code><code class="n">information</code><code class="w"> </code><code class="n">about</code><code class="w"> </code><code class="n">this</code><code class="w"> </code><code class="n">error</code><code class="p">,</code><code class="w"> </code><code class="n">try</code><code class="w"> </code><code class="err">`</code><code class="n">rustc</code><code class="w"> </code><code class="o">--</code><code class="n">explain</code><code class="w"> </code><code class="n">E0382</code><code class="err">`</code><code class="p">.</code><code class="w"></code>
<code class="n">error</code>: <code class="nc">Could</code><code class="w"> </code><code class="n">not</code><code class="w"> </code><code class="n">compile</code><code class="w"> </code><code class="err">`</code><code class="n">numbers</code><code class="err">`</code><code class="p">.</code><code class="w"></code>

<code class="n">To</code><code class="w"> </code><code class="n">learn</code><code class="w"> </code><code class="n">more</code><code class="p">,</code><code class="w"> </code><code class="n">run</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="n">command</code><code class="w"> </code><code class="n">again</code><code class="w"> </code><code class="n">with</code><code class="w"> </code><code class="o">--</code><code class="n">verbose</code><code class="p">.</code><code class="w"></code>
</pre></div>

</figure>

<p>We can see Rust generally has very helpful error messages. The error is that a value was used after it has been moved. The <code>print</code> function no longer owns <code>numbers</code>. The “note” in the error explains why the move happens due to vector not implementing the <code>Copy</code> trait.</p>

<p>Note that in the changes we have made, the body of <code>output_sequence</code> has remained the same (modulo whether we call <code>iter</code> explicitly or not), only the type signature has been changing. This is a hint that maybe there is a way to write a type signature that works for both arrays and vectors. There are again several ways to accomplish this goal.</p>

<h4 id="leanpub-auto-a-type-signature-that-works-for-both-arrays-and-vectors">A type signature that works for both arrays and vectors</h4>

<p>As we have said before, Rust has a lot of power and gives you very fine-grained control over what you want to use or don’t want to use. This can be frustrating when starting out because any time you ask “what is the right way to do this,” you will invariably be met with the dreaded “it depends.” Rather than detail every possible permutation that achieves roughly the same outcome, we are going to focus on the most common idioms. There are certain performance reasons as well as API design decisions that lead to different choices, but those are more exceptional cases than the norm. We will provide pointers to the choices we are making when it matters, but note that due to the scope of the language there is almost always more than one way to do it.</p>

<p>A key type that comes in handy to alleviate some of the limitations of arrays is the <a href="https://doc.rust-lang.org/std/slice/index.html"><code>std::slice</code></a>. Slices are a dynamically sized view into a sequence. Therefore, <strong>you can have a slice which references an array or a vector and treat them the same</strong>. This is a very common abstraction tool used in Rust. This will be more clear by seeing this in action.</p>

<p>Let’s change the signature of <code>output_sequence</code> to take a reference to a slice, and change <code>print</code> to show that it works with both arrays and vectors:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">vector_numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="o">&amp;</code><code class="n">vector_numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">array_numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="o">&amp;</code><code class="n">array_numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 7 </code>
<code class="lineno"> 8 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="kp">&amp;</code><code class="p">[</code><code class="kt">u8</code><code class="p">])</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">12 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>A slice of <code>u8</code> values has type <code>[u8]</code>. This represents a type with an unknown size at compile time. The Rust compilation model does not allow functions to directly take arguments of an unknown size. In order to access this slice of unknown size with something of a known size we use indirection and pass a reference to the slice rather than the slice itself. A reference to a slice of <code>u8</code> values has type <code>&amp;[u8]</code> which has a known size at compile time. This size is known because it is equal to the size of a pointer plus the length of the slice. Note that slices convert automatically into iterators just like vectors so we again do not call <code>iter</code> explicitly in the body of our function. This takes care of the signature of <code>output_sequence</code> however the way we call this function from <code>print</code> has changed as well.</p>

<p>Notice that we have added an <code>&amp;</code> before the variable names that are passed to <code>output_sequence</code>. You can think of this as creating a slice that represents read-only access to the entire sequence for both the vector and array. However, this small change in how we call the function allows us to handle vectors and arrays equally well. Idiomatic Rust takes slices as arguments in most cases where one needs only to read the collection. This is particularly true for strings which we will cover later.</p>

<p>The major difference here is that we are no longer transferring ownership into the function <code>output_sequence</code> instead we are lending read-only access to that function. The data is only borrowed for the duration of the function call. The idea of ownership and borrowing is a core part of the Rust language and is something we will be constantly running into.</p>

<h4 id="leanpub-auto-constructing-a-vector-of-numbers">Constructing A Vector of Numbers</h4>

<p>Let’s make one more change to make this program more flexible. Instead of printing out one through five, let’s take a number as input and print from one up to that value. We could just iterate through integers and print them out as we go along rather than using the <code>output_sequence</code> helper function. However, we are going to construct a vector to show a few more language features.</p>

<p>Let’s create yet another helper function, <code>generate_sequence</code> which takes a limit as input and outputs a vector. Our <code>print</code> function can then just combine these two parts:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">print</code><code class="p">(</code><code class="n">limit</code>: <code class="kt">u8</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">generate_sequence</code><code class="p">(</code><code class="n">limit</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">    </code><code class="n">output_sequence</code><code class="p">(</code><code class="o">&amp;</code><code class="n">numbers</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="k">fn</code> <code class="nf">generate_sequence</code><code class="p">(</code><code class="n">limit</code>: <code class="kt">u8</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="mi">1</code><code class="p">..</code><code class="o">=</code><code class="n">limit</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">        </code><code class="n">numbers</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">numbers</code><code class="w"></code>
<code class="lineno">12 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">13 </code>
<code class="lineno">14 </code><code class="k">fn</code> <code class="nf">output_sequence</code><code class="p">(</code><code class="n">numbers</code>: <code class="kp">&amp;</code><code class="p">[</code><code class="kt">u8</code><code class="p">])</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">n</code><code class="p">);</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">18 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>In <code>print</code> we bind a variable to the result of calling <code>generate_sequence</code> with the <code>limit</code> passed to us as the argument, then we call <code>output_sequence</code> as before passing a reference to a slice backed by the variable we just created.</p>

<p>The new function here takes an input argument, <code>limit</code>, and returns a <code>Vec&lt;u8&gt;</code>. This is our first function returning something.</p>

<aside class="information blurb">
    <p>Again as there are a lot of different ways to do things in Rust, we are going to just show one particular way to construct the vector we desire in order to hit some relevant parts of the language.</p>

</aside>

<p>First we create a new vector with <code>Vec::new()</code>.</p>

<aside class="tip blurb">
    <p>Unlike in some other languages, <code>new</code> is not special but rather has become by convention the name of the function that returns a new instance of a type. You can write a function called <code>new</code> which does something else and it would compile just fine, but it would go against the standard way of doing things.</p>

</aside>

<p>By default a vector created with <code>new</code>, is the same as one created with <code>vec![]</code>, and does not allocate. Therefore, unless you actually put something into a vector it does not use any memory.</p>

<p>In the code above, we see a new keyword being used, <code>mut</code>. Mutability is a property of the variable or reference not of the object itself. Therefore we declare <code>numbers</code> to be a mutable variable that holds an empty vector. This allows us to later call <code>numbers.push(n)</code> because <code>push</code> is a method that requires the receiver to be mutable. Removing the <code>mut</code> from the <code>let</code> binding will result in a compiler error when we try to <code>push</code>.</p>

<p>In order to generate the numbers starting at 1 up to our limit, we use a <code>for</code> loop, but this time the iterator is a <a href="https://doc.rust-lang.org/std/ops/struct.RangeInclusive.html"><code>Range</code></a> object, in particular an <code>InclusiveRange</code>. Ranges can be constructed with using the syntax <code>start..end</code> or <code>start..=end</code>. Both <code>start</code> and <code>end</code> are optional, and if you have neither, i.e. <code>..</code>, then you also cannot have the <code>=</code> sign. By default the range is inclusive on the left (i.e. includes <code>start</code>), and exclusive on the right (i.e. does not include <code>end</code>). The <code>=</code> after the two dots makes it so the range includes the end point. We want the numbers starting at 1 up to <code>limit</code>, including the <code>limit</code>, so we use <code>1..=limit</code>. Ranges are frequently used when creating slices, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">numbers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">];</code><code class="w"></code>
<code class="kd">let</code><code class="w"> </code><code class="n">subset</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">numbers</code><code class="p">[</code><code class="mi">1</code><code class="p">..</code><code class="mi">3</code><code class="p">];</code><code class="w"></code>
</pre></div>

</figure>

<p>Here <code>subset</code> is a slice of length <code>3-1=2</code> which starts at index <code>1</code>, hence it is the slice <code>[2, 3]</code>.</p>

<p>Iterating over this range, we <code>push</code> each value onto the end of our vector which causes heap allocations every time there is not enough capacity to extend the length. Finally, we want to return this vector from our function. The final expression in a function is implicitly returned so there is no need for an explicit <code>return</code> statement. However note the lack of semicolon at the end of the last line of this function. The expression that evaluates to the vector <code>numbers</code> is written without a semicolon and means to return that value. If we had written a semicolon, that would be a statement whose value is <code>()</code> which is not what you want to return. This is a common error so the compiler is smart enough to tell you what to fix, but it is nonetheless an error. You can use a <code>return</code> statement to return early from a function, but using the last expression of the block as the implicit return is idiomatic Rust.</p>

<h4 id="leanpub-auto-a-shorter-version-with-collect">A Shorter Version with collect</h4>

<p>The purpose of writing <code>generate_sequence</code> like this was to demonstrate object construction, mutability, and ranges. Before leaving, let’s look at a very powerful construct that is used throughout real Rust which would be a better approach to generating this vector. We could replace <code>generate_sequence</code> with:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">6 </code><code class="k">fn</code> <code class="nf">generate_sequence</code><code class="p">(</code><code class="n">limit</code>: <code class="kt">u8</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">7 </code><code class="w">    </code><code class="p">(</code><code class="mi">1</code><code class="p">..</code><code class="o">=</code><code class="n">limit</code><code class="p">).</code><code class="n">collect</code><code class="p">()</code><code class="w"></code>
<code class="lineno">8 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Rust has powerful generic programming facilities which allows for the function <code>collect</code> to exist. This function can be used to turn any iterator into basically any collection.</p>

<p>Commonly, one takes a collection like a vector, turns it into an iterator by calling <code>iter</code>, performs transformations on the generic iterator, and then calls <code>collect</code> at the end to get back whatever specific collection one wants to work with. It can also be used to directly turn one collection into another collection, which is what we are doing here by turning a range into a vector.</p>

<p>Collect is a generic function over the return type, so the caller gets to determine what they want. Here because we return the result of calling <code>collect</code> from our function, type inference sees that the return type needs to be a <code>Vec&lt;u8&gt;</code> and therefore ensures that <code>collect</code> generates that collection. While the type inference in Rust is good, it some times cannot figure out what you want when using <code>collect</code>. Therefore, you might find the need to use the syntax <code>collect::&lt;SomeType&gt;()</code> to help the compiler know what you want.</p>

<aside class="information blurb">
    <p>This syntax, <code>::&lt;&gt;</code>, you may see referred to as the “turbofish”.</p>

</aside>

<p>We have changed our exported <code>print</code> function to require an input variable, so we need to update our call in <code>main</code> to pass something in. Let’s pass in <code>5</code> to get the same output as before:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">numbers</code>::<code class="n">print</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code><code class="w"></code>
<code class="lineno">3 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h3 id="leanpub-auto-testing-our-code">Testing our code</h3>

<p>Testing is a large topic and is something we will cover in more detail as we move to larger applications, however let’s write our first test to see how easy it can be in Rust. Add the following to the end of <code>src/lib.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">20 </code><code class="cp">#[test]</code><code class="w"></code>
<code class="lineno">21 </code><code class="k">fn</code> <code class="nf">generate_sequence_should_work</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">generate_sequence</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">    </code><code class="n">assert_eq</code><code class="o">!</code><code class="p">(</code><code class="n">result</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">]);</code><code class="w"></code>
<code class="lineno">24 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our test is just a normal function with a special attribute, <code>#[test]</code>, before it. We will see attributes come up frequently as they are used for a variety of purposes in Rust. They come in two forms <code>#[...]</code> and <code>#![...]</code> which annotate the item they precede. The name of the test comes from the name of the function. Inside of test functions there are a series of macros you can use for asserting facts about your system. We use <code>assert_eq</code> to ensure that the output of our <code>generate_sequence</code> function is what we expect it to be.</p>

<p>We can use <code>cargo</code> to run all of our tests:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo <code class="nb">test</code>
    Finished dev <code class="o">[</code>unoptimized + debuginfo<code class="o">]</code> target<code class="o">(</code>s<code class="o">)</code> in <code class="m">0</code>.43s
     Running target/debug/deps/numbers-f74640eac1a29f6d

running <code class="m">1</code> <code class="nb">test</code>
<code class="nb">test</code> generate_sequence_should_work ... ok

<code class="nb">test</code> result: ok. <code class="m">1</code> passed<code class="p">;</code> <code class="m">0</code> failed<code class="p">;</code> <code class="m">0</code> ignored<code class="p">;</code> <code class="m">0</code> measured<code class="p">;</code> <code class="m">0</code> filtered <code class="se">\</code>
out
</pre></div>

</figure>

<h3 id="leanpub-auto-wrapping-up">Wrapping up</h3>

<p>The Rust language is designed to allow fine grained control over performance and reliability while writing code at a high level of abstraction. The cost is thus learning the abstractions and dealing with the cognitive load of making choices as you design a program. These considerations are important for production quality code as you profile and optimize where you find bottlenecks. However, following the standards of the community will get you the majority of the way to high quality applications.</p>

<p>We will not belabor all of the nuance in the finer points of making every decision along the way. Our goal is to provide a solid foundation upon which you can explore alternatives as necessary by using the standard library documentation.</p>



</div>,<div>
<h2 id="leanpub-auto-making-a-web-app-with-actix">Making A Web App With Actix</h2>

<h3 id="leanpub-auto-web-ecosystem">Web Ecosystem</h3>

<p>One area where Rust stands out is in the building of web servers.</p>

<p>Rust has its origins at Mozilla primarily as a tool for building <strong>a new browser engine</strong>. The existing engine being written in C++ combined with the syntactical similarities encourages the idea the Rust was meant to be a replacement for C++. There is obviously some truth to this, but in many ways this characterization sells Rust’s potential short. While it is capable of being a systems programming language, there are a plethora of language features that make it suitable for innumerable programming tasks, including building web servers.</p>

<p>There are a few different layers to the web programming stack. Primarily we are concerned here with the application layer which is comparable to where Django, Rails, and Express live in Python, Ruby, and NodeJS, respectively.</p>

<p>The ecosystem around web application development in Rust is still quite nascent despite the Rust language hitting 1.0 in 2015. Much of the underlying infrastructure for building concurrent programs took until 2019 to reach a maturity sufficient to be included in the stable version of the standard library. However, most of the ecosystem has coalesced around similar ideas which take advantage of Rust’s particular features.</p>

<p>Before jumping in to building a simple web server, let’s briefly discuss a few of the libraries that make up the web landscape.</p>

<h4 id="leanpub-auto-hyper">Hyper</h4>

<p><a href="https://hyper.rs/">Hyper</a> is a low level HTTP library built on even lower level libraries for building network services. Currently most web frameworks use Hyper internally for handling the actual HTTP requests.</p>

<p>It can be used to build both HTTP clients and servers. However, there is a bit more boilerplate than you might want to write yourself when you want to focus on building an application. Therefore, we will use a library at a higher level of abstraction which still allows us to take advantage of what Hyper offers.</p>

<h4 id="leanpub-auto-actix">Actix</h4>


<div class="figure-wrapper center">
  <figure class="image" style="width: 172px">
    <img src="/images/img000/OEBPS/images/actix_logo.png" alt="Actix" style="width: 100%" />
    <figcaption>Actix</figcaption>
  </figure>
</div>


<p>The <a href="https://actix.rs/">Actix</a> project is actually a group of projects which define an actor system as well as a framework for building web applications. The web framework is aptly named <code>actix-web</code>. It has been built on top of futures and async primitives from the beginning. It also runs on the stable version of the compiler.</p>

<p>It recently hit the 1.0 milestone which should bring some much needed stability to the ecosystem. Additionally, it has been at the top of the <a href="https://www.techempower.com/benchmarks/#section=data-r16&amp;hw=ph&amp;test=plaintext">Tech Empower web framework benchmarks</a>. Even if those are artificial benchmarks, it still points to the performance potential possible.</p>

<p>Actix is the library that we are going to use in this chapter, but before we dive in, let’s look at a few others from a high level.</p>

<h4 id="leanpub-auto-rocket">Rocket</h4>


<div class="figure-wrapper center">
  <figure class="image" style="width: 28px">
    <img src="/images/img001/OEBPS/images/missing.png" alt="Rocket" style="width: 100%" />
    <figcaption>Rocket</figcaption>
  </figure>
</div>


<p><a href="https://rocket.rs/">Rocket</a> is a web framework which is easy to use while maintaining flexibility, speed, and safety. One of the downsides to this is that currently Rocket only works with the nightly compiler. This is mostly because certain compiler features that make the application developer’s life better are not available on stable yet.</p>

<p>Moreover, Rocket intends to move to an async backend once those ideas stabilize in the standard library, but as of version 0.4 the backend is still a synchronous design.</p>

<p>Finally, Rocket has not yet reached 1.0 as there is still a lot of work to do to which might necessitate breaking changes. It is a high quality library which will not likely have much breakage going forward, but there is still some risk which depends on your tolerance.</p>

<h4 id="leanpub-auto-others">Others</h4>

<p>There are several other web frameworks in the Rust ecosystem and but it’s not possible to cover everything here. Some promising libraries that were built up have fallen into an unmaintained state, whereas others are still building up and are explicitly not ready for prime time.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 128px">
    <img src="/images/img002/OEBPS/images/iron_logo.png" alt="Iron" style="width: 100%" />
    <figcaption>Iron</figcaption>
  </figure>
</div>


<p><a href="http://ironframework.io/">Iron</a> is arguably the original Rust web framework. It was actively maintained for quite a while, then was partially abandoned for a while, and then recently resurrected and updated. Iron takes a different approach than the other web frameworks and is more similar to frameworks in other languages.</p>

<p>It is built to have a small, focused core and then provide the rest of its functionality via plugins and middleware. This style is possibly more familiar to web developers coming from other languages, but in the Rust ecosystem, at least currently, this is not the norm.</p>

<p>The core Rust language has an Async Working Group that has an experimental web framework called <a href="https://github.com/rustasync/tide">Tide</a>. They are working out how the async primitives in the standard library can be used to build a web framework that is easy to use and safe. It is explicitly not ready for production, but many of the ideas are similar to what is being done in Actix and Rocket.</p>

<h3 id="leanpub-auto-starting-out">Starting out</h3>

<p>We are going to use <code>actix-web</code> because it works with the stable compiler. A lot of the underlying ideas about how data flows in the system is similar to how Rocket works, so switching between the two should not be a fundamental shift in how the application is built.</p>

<p>So let’s get started with a new project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new messages-actix
</pre></div>

</figure>

<p>We let <code>cargo</code> bootstrap our project as we have done before. The first thing we are going to do is edit our <code>Cargo.toml</code> file to add all of the dependencies that we will use:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">[package]</code>
<code class="lineno"> 2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"messages-actix"</code>
<code class="lineno"> 3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno"> 4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;your.name@example.com&gt;"]</code>
<code class="lineno"> 5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">[dependencies]</code>
<code class="lineno"> 8 </code><code class="na">actix-web</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno"> 9 </code><code class="na">env_logger</code> <code class="o">=</code> <code class="s">"0.6"</code>
<code class="lineno">10 </code><code class="na">serde</code> <code class="o">=</code> <code class="s">{ version = "1.0", features = ["derive"] }</code>
<code class="lineno">11 </code><code class="na">serde_json</code> <code class="o">=</code> <code class="s">"1.0"</code>
</pre></div>

</figure>

<p>We have already talked about our first dependency, <code>actix-web</code>. The second dependency listed, <code>env_logger</code>, will be used to allow us turn on/off the logging features of actix.</p>

<p>We import <code>serde</code> which is the de facto standard way of implementing serialization and deserialization between native Rust types and a variety of formats. The main serde crate takes care of much of the generic machinery, and then outsources the specifics of different formats to other crates. Therefore, to enable marshalling to/from JSON, we bring in the <code>serde_json</code> crate.</p>

<aside class="information blurb">
    <p>The name <code>serde</code> is a portmanteau of <em>ser</em>ialize and <em>de</em>serialize.</p>

</aside>

<p>Dependencies can take a variety of forms depending on the level of configuration desired. The typical format is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>crate_name = "X.Y.Z"
</pre></div>

</figure>

<p>where <code>crate_name</code> is the official name for the crate as published on crates.io and the string value “X.Y.Z” is a <a href="https://github.com/steveklabnik/semver#requirements">semver</a> requirement which is interpreted the same as “^X.Y.Z”. There exists a lot of power in specifying exactly how you want your dependencies to update, but the most common form is <code>crate_name = "X"</code>, where <code>X</code> is the major version that your code is compatible with.</p>

<h4 id="leanpub-auto-getting-the-structure-in-place">Getting the structure in place</h4>

<p>As discussed previously, we will split up our crate into both a library and a binary by putting most of our code in <code>lib.rs</code> or other further modules, and then calling into that library from <code>main.rs</code>. Therefore, let’s get our <code>main.rs</code> file setup once and then all of our changes will be in the library:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">messages_actix</code>::<code class="n">MessageApp</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code>
<code class="lineno">3 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">4 </code><code class="w">    </code><code class="n">std</code>::<code class="n">env</code>::<code class="n">set_var</code><code class="p">(</code><code class="s">"RUST_LOG"</code><code class="p">,</code><code class="w"> </code><code class="s">"actix_web=info"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="n">env_logger</code>::<code class="n">init</code><code class="p">();</code><code class="w"></code>
<code class="lineno">6 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">app</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">MessageApp</code>::<code class="n">new</code><code class="p">(</code><code class="mi">8080</code><code class="p">);</code><code class="w"></code>
<code class="lineno">7 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
<code class="lineno">8 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We will create and export a type called <code>MessageApp</code> which will be the entry point into our library, so our first step is to import this type.</p>

<aside class="information blurb">
    <p>It may be initially confusing that the name of our library as specified in <code>Cargo.toml</code> is <code>messages-actix</code> (with a hyphen), and yet in main we are importing the type <code>MessageApp</code> from the crate <code>messages_actix</code> (with an underscore). Crate names are allowed to contain hyphens and underscores, but identifiers in Rust are not allowed to contain hyphens. Therefore, if you use a crate name with an underscore the compiler knows to look for a crate with a hyphen if one with an underscore cannot be found.</p>

  <p>The community seems to not have completely coalesced on choosing one style for crate names as can be noted by comparing <code>actix-web</code> with <code>serde_json</code>. If you use an underscore in your crate name instead of a hyphen then this translation step is unnecessary.</p>

</aside>

<p>We define the <code>main</code> function which will be entry point for our binary. As of Rust 1.26 it is possible to for the <code>main</code> function to return a <code>Result</code> type. <code>Result</code> is one of the primary error handling primitives that Rust provides. Let’s take a moment to talk about Rust’s facilities for abstraction.</p>

<h4 id="leanpub-auto-aggregate-data-types">Aggregate data types</h4>

<p>The primary mechanisms for creating aggregate data types in Rust are <strong>enums</strong> and <strong>structs</strong>. In theoretical terms, these are aggregates of other types where structs represent product types and enums represent sum types. Enums in Rust can contain data and are therefore related to algebraic data types in functional languages.</p>

<p>We will return to structs once we get to our library code, so let’s focus on enums for the moment by looking at <code>Result</code> as an example. <code>Result</code> is an enum that is defined in the standard library as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">enum</code> <code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">E</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">   </code><code class="nb">Ok</code><code class="p">(</code><code class="n">T</code><code class="p">),</code><code class="w"></code>
<code class="w">   </code><code class="nb">Err</code><code class="p">(</code><code class="n">E</code><code class="p">),</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>There are a lot of new things happening here so we will go through it step by step. Enums represent a type where we enumerate the different possible values that a particular value represents. These are sometimes called tagged unions. The idea is that a value of type <code>Result</code> can be in exactly one of two states: the <code>Ok</code> variant or the <code>Err</code> variant. Enum variants can contain data like we see here, or they can be just a name, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">enum</code> <code class="nc">Color</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">Red</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">Green</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">Blue</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h5 id="leanpub-auto-result">Result</h5>

<p><code>Result</code> is also an example of a generic type because it is parameterized by two type variables <code>T</code> and <code>E</code> which we can see in angle brackets after the name of the type. These generic types are used in the two variants as a way of encapsulating data along with the identity of the variant. Generic types can have restrictions placed on them, but here there are none so <code>T</code> and <code>E</code> can be any type. The names of variants can be referred to just like other items that live within some outer structure using the <code>::</code> operator. Therefore, <code>Result::Ok(true)</code> would construct the <code>Ok</code> variant of the type <code>Result&lt;bool, E&gt;</code> where <code>E</code> would need to be further specified by the context. For our <code>Color</code> enum, we can refer to variants like <code>Color::Red</code> or <code>Color::Green</code>.</p>

<p><code>Result</code> is a special type that is available everywhere in your code because normal Rust code works as if a few things are automatically imported at the top of your file. We will see <code>Result</code> used throughout all of the code we write in Rust because it allows us to handle success and failure cases in a structured and cohesive way. This is one of the tools that replace situations where one might use exceptions in another language.</p>

<p>Going back to our main function, we are returning the type <code>std::io::Result&lt;()&gt;</code>. Within the <code>std::io</code> module there is a type definition:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">type</code> <code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">std</code>::<code class="n">io</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The type <code>std::io::Error</code> is a struct defined in that module for representing errors from I/O operations. The syntax for the type definition above just says to create an alias <code>std::io::Result&lt;T&gt;</code> which uses the standard <code>Result</code> type with the second type parameter (which represents the type inside the error variant) fixed to the one defined in the <code>std::io</code> module. Therefore, <code>std::io::Result&lt;()&gt;</code> is the same as <code>Result&lt;(), std::io::Error&gt;</code>.</p>

<p>A type aliases like this does not create a new type but rather just allows for more convenient syntax. It is very common to see type aliases used to fix some of the generic parameters in a type. In particular, you are likely to see this exact kind of type alias used in many libraries because writing <code>Result&lt;T&gt;</code> is much more convenient than <code>Result&lt;T, some::crate::Error&gt;</code>.</p>

<h5 id="leanpub-auto-ok">Ok</h5>

<p>The <code>Ok</code> variant has type <code>()</code> which is known as the empty tuple which we have seen before. This is commonly used as a marker where you don’t actually care about the value but you need some placeholder type. This <code>Result</code> type basically means that you can tell the difference between a success and a failure, and if there is a failure you will get an error that can tell you what happened, but in the success case there isn’t anything interesting to add besides the fact that there was a success. This pattern is similar to what we see in C with functions that return 0 on success and non-zero on failure where each non-zero value maps to some specific type of failure.</p>

<p>We use this type as the result of main because our web server will be doing I/O operations and as we will see our server returns this type to signify success or failure. Rust will return an error code and print the debug representation of the error if the returned result of main is the error variant, otherwise it will just exit normally. Hence as any data in the <code>Ok</code> variant would go unused anyway, it is natural to use the empty tuple as a marker of success.</p>

<h4 id="leanpub-auto-basic-logging-setup">Basic logging setup</h4>

<p>The first line of our main function sets an environment variable, <code>RUST_LOG</code>, to the value <code>actix_web=info</code>. We do this for convenience in this program so that we don’t have to set the environment variable in our terminal, but normally you would set this in your environment.</p>

<p>Most crates in Rust use the <a href="https://docs.rs/log"><code>log</code></a> crate to allow for a clean separation between log statements and where they are printed. The <code>log</code> crate provides a set of macros that libraries can use to make logging statements at various levels of verbosity. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">do_work</code><code class="p">(</code><code class="n">num</code>: <code class="kt">u32</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"About to do work for num: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">num</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Those logging statements do not actually do anything unless a program is configured with an implementation. We choose to use the implementation provided by the <code>env_logger</code> crate which we turn on with the call to <code>env_logger::init()</code>. There exist a variety of implementations that do things like add colors to the output or send statements to files. We are going to use this simple implementation that just prints statements to standard out based on the settings given in the <code>RUST_LOG</code> environment variable.</p>

<h4 id="leanpub-auto-starting-the-app">Starting the app</h4>

<p>Finally, the last two lines of our main function are where the real work happens.</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">6 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">app</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">MessageApp</code>::<code class="n">new</code><code class="p">(</code><code class="mi">8080</code><code class="p">);</code><code class="w"></code>
<code class="lineno">7 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
</pre></div>

</figure>

<p>We create a new instance of our <code>MessageApp</code> type by calling <code>new</code> with a port number and bind the result to the variable <code>app</code>. Then we call the <code>run</code> method on our app instance. The lack of a semicolon at the end of this line means that our main function returns the result of the <code>run</code> method. Based on the discussion we just had, we therefore know that <code>run</code> must return a <code>Result</code>.</p>

<p>This main function will stay the same from here on, and we will pack all of the functionality into our <code>MessageApp</code> type which need only expose the <code>new</code> and <code>run</code> methods that we use.</p>

<h3 id="leanpub-auto-handling-our-first-request">Handling our first request</h3>

<p>We are going to get all of the infrastructure in place to build and run a web server which can handle HTTP requests. Our first incarnation will just support a get request to one route and will respond with a JSON message.</p>

<p>Let’s get started with our library implementation by creating <code>lib.rs</code> and starting out with some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="cp">#[macro_use]</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">extern</code><code class="w"> </code><code class="k">crate</code><code class="w"> </code><code class="n">actix_web</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">middleware</code><code class="p">,</code><code class="w"> </code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">HttpRequest</code><code class="p">,</code><code class="w"> </code><code class="n">HttpServer</code><code class="p">,</code><code class="w"> </code><code class="nb">Result</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">serde</code>::<code class="n">Serialize</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We are going to use some of the macros exported by <code>actix_web</code> which we could import individually in the 2018 edition of Rust, but for now we will import them via the older <code>#[macro_use]</code> attribute on the <code>extern crate</code> statement.</p>

<p>We import some items from <code>actix_web</code> which will make our code a little less verbose. Note in particular that we import <code>Result</code> which is the type alias of <code>Result</code> that <code>actix_web</code> defines with the error type fixed to its error type. We are going to construct a Rust type that represents the data we want to respond to requests with, so we import <code>Serialize</code> from <code>serde</code> which will allow us to convert that Rust type to JSON data.</p>

<h4 id="leanpub-auto-creating-our-app">Creating our app</h4>

<p>We saw in <code>main</code> that we imported a struct from our library so let’s define that:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">MessageApp</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="n">port</code>: <code class="kt">u16</code><code class="p">,</code><code class="w"></code>
<code class="lineno">27 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is the first time we are creating a struct which is the other primary aggregate data type in Rust besides enums.</p>

<p>Structs have <em>member data</em> which can be of any type. Here we have one member named <code>port</code> of type <code>u16</code>. The <code>pub</code> specifier before the <code>struct</code> keyword means that this type will be publicly exported by our library.</p>

<p>Each member field has its own privacy which is not exported by default. Therefore, even though you can reference instances of type <code>MessageApp</code> outside of our library, you cannot directly access the <code>port</code> field. We can access the <code>port</code> field within the file that defines the type, but otherwise it is hidden.</p>

<aside class="tip blurb">
    <p>Similar to enums, structs can also be generic over the types of data they contain. For example, <code>Vec&lt;T&gt;</code> which we have seen before is actually a struct called <code>Vec</code> which has one generic type parameter.</p>

</aside>

<h4 id="leanpub-auto-adding-behavior-to-our-data">Adding behavior to our data</h4>

<p>Now that we have our struct defined, we can add functionality to it. Rust has a strong separation of data and functionality. We defined the data representation of our struct, but all methods associated with the type are defined elsewhere in what is known as an <code>impl</code> block.</p>

<p>These blocks are used for adding functionality to types as well as for implementing traits. All types that you create (structs, enums, etc.) can have functionality added via an <code>impl</code> block. Let’s work through the <code>impl</code> block for <code>MessageApp</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">29 </code><code class="k">impl</code><code class="w"> </code><code class="n">MessageApp</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">new</code><code class="p">(</code><code class="n">port</code>: <code class="kt">u16</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">        </code><code class="n">MessageApp</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">port</code><code class="w"> </code><code class="p">}</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">33 </code>
<code class="lineno">34 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Starting http server: 127.0.0.1:{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">);</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">        </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">        </code><code class="p">.</code><code class="n">workers</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">        </code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">45 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>A type can have multiple <code>impl</code> blocks associated with it, however typically there is only one main one with others usually only for trait implementations. We will return to traits and their implementation at a future point.</p>

<h5 id="leanpub-auto-self-is-special">Self is special</h5>

<p>The first method that we define is called <code>new</code> which takes a <code>port</code> parameter and returns the special type <code>Self</code>. Inside an <code>impl</code> block <code>Self</code> has special meaning, it refers to the type on which we are defining the implementation. So we could have written the signature of new as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">new</code><code class="p">(</code><code class="n">port</code>: <code class="kt">u16</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">MessageApp</code><code class="w"></code>
</pre></div>

</figure>

<p>However idiomatic Rust code uses <code>Self</code> for such a return type. The name of <code>new</code> is not special, but has become convention as the name of the constructor function for types. Therefore, while you could name your constructors anything you want, <code>new</code> is what others will expect.</p>

<h5 id="leanpub-auto-create-a-messageapp">Create a MessageApp</h5>

<p>The body of our constructor is pretty simple, we just create a <code>MessageApp</code> struct with the data that was passed in. If there is a local variable with the same name and type as a struct field, you can use a shorthand syntax by just writing the variable name in the struct literal. Suppose for example that we wanted to add one to whatever port was passed in to us, then we would have to use the longer syntax:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">MessageApp</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">port</code>: <code class="nc">port</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>To construct a struct we must list each field name followed by a colon followed by the value, unless we can skip the colon and value in the situation described above. Rust allows trailing commas in pretty much every position where a comma could exist in the future and it is standard practice to include them to reduce future diffs when code changes. Again we are returning this newly constructed struct because we do not end this line with a semicolon.</p>

<h4 id="leanpub-auto-instance-methods">Instance methods</h4>

<p>The next method we define is called <code>run</code> which takes the special parameter <code>&amp;self</code> and returns the <code>std::io::Result</code> that we introduced in the previous section.</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">34 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Starting http server: 127.0.0.1:{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">);</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">        </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">        </code><code class="p">.</code><code class="n">workers</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">        </code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
</pre></div>

</figure>

<p>Inside an <code>impl</code> block there are a few different special values which can be the first parameter to functions to signify that those functions are actually instance methods. This is similar to Python where class instance methods explicitly take <code>self</code> as their first parameter, and not taking <code>self</code> implies that the method is actually on the type rather than a particular instance.</p>

<h4 id="leanpub-auto-all-of-the-selfs">All of the selfs</h4>

<p>Due to the semantics around borrowing and mutability, there are four special first parameter values: <code>&amp;self</code>, <code>self</code>, <code>&amp;mut self</code>, and <code>mut self</code>. All of the forms turn a function in a method on an instance of the type. This means that rather than being a function on the type which is called like <code>MessageApp::new</code>, we need to have constructed an instance of the type and then use dot syntax to call the method and set the first parameter.</p>

<p>In our example, we first call <code>new</code> to construct an instance of <code>MessageApp</code> called <code>app</code>, and then we call <code>run</code> as <code>app.run()</code>. It is also possible to make this call explicitly as <code>MessageApp::run(&amp;app)</code> but that is uncommon.</p>

<p>The first form, <code>&amp;self</code>, is the most common form. This means that our method takes an immutable reference to the instance invoking the method. We can read the data inside our type, but we cannot alter it. The calling code also maintains ownership so we are just borrowing the instance.</p>

<p>The second form, <code>self</code>, means that the method consumes <code>self</code> and therefore the instance that the method is being called on has its ownership moved into the method. This form comes usually when we are transforming a type into something else, for example with interfaces that use the builder pattern.</p>

<p>The third form, <code>&amp;mut self</code>, is the mutable version of the first form. This is the second most common thing you will encounter. Our method can read and write the data inside our type, but it does not own the value so this access is only temporary.</p>

<p>Finally the last form, <code>mut self</code>, means that this method consumes <code>self</code> and <code>self</code> is mutable within the method. All parameters to functions can be declared mutable if you wish them to be a mutable binding inside the function, and <code>self</code> is no different. This has its uses, but is not that common.</p>

<h4 id="leanpub-auto-running-our-server">Running our server</h4>

<p>The first line of our <code>run</code> function just prints out that we are starting a server at a particular address and port. The next expression creates a server, binds it to an address, sets the number of workers, and finally starts the server.</p>

<p><code>HttpServer</code> is the type which <code>actix-web</code> exposes to represent something that serves requests. The constructor takes an application factory which is any function that when called returns an application.</p>

<p>We use a closure to define just such a function inline. Closures in Rust can be a little tricky because of the ownership and borrowing semantics. The basic syntax is to declare an argument list between pipes, <code>||</code>, then possibly list the return value, followed by the function body between curly braces.</p>

<aside class="tip blurb">
    <p>Type inference works on closures so we can usually omit types of the arguments and return values.</p>

</aside>

<h4 id="leanpub-auto-understanding-closures">Understanding closures</h4>

<p>The tricky bit is how the closure captures variables from the surrounding environment, so let’s take a closer look at this.</p>

<p>If the keyword <code>move</code> comes before the argument list then any variables from the environment that the closure uses are actually moved into the closure. This means the closure takes ownership of those variables rather than creating references.</p>

<p>This implies that the lifetime of the closure can be longer can its surrounding environment because those variables are moved into the closure. Without the <code>move</code> keyword, variables closed over are actually just references to the surrounding environment.</p>

<p>Here we do not actually use any variables from the surrounding environment so this example would work without the <code>move</code> keyword. However, we will be doing this shortly, so it makes sense to get this out of the way now. Moreover, our intent is for this closure to be entirely owned by the <code>HttpServer</code> and therefore the <code>move</code> signifies intent that <em>the function should not have references to the environment in which it was created</em>.</p>

<p>Closures are a very nice part of Rust, and they can be hard to fully grasp at first, but this complexity buys performance benefits with control in your hands as to exactly what you want to happen.</p>

<p>Take a look at the relevant part of the code again:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">36 </code><code class="w">        </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
</pre></div>

</figure>

<p>Inside the closure, we are construct an <code>App</code> which is the abstraction <code>actix-web</code> defines for representing a collection of routes and their handlers. We use the <code>new</code> method to create an <code>App</code>, and then a couple methods defined on that instance to setup our application.</p>

<p>The <code>wrap</code> function wraps the app with a middleware specified as its only argument. We set the <code>Logger</code> middleware which is provided by actix so that we can see some information about requests as they come in.</p>

<p>Furthermore, we call <code>service(index)</code> to specify that we want to add a service to our app which uses the handler <code>index</code> which we will define below.</p>

<h4 id="leanpub-auto-syntax-for-working-with-results">Syntax for working with Results</h4>

<p>The last new bit of Rust that we find in this method is the <code>?</code> operator after the call to <code>bind</code>. The <code>Result</code> type is quite special in Rust to the point of having special syntax for the common pattern of returning an error early if one occurred or otherwise pulling the value out of the <code>Ok</code> case and continuing on. The function <code>bind</code> returns a <code>Result</code>, by putting the <code>?</code> after the call, we are saying that if the returned <code>Result</code> is the <code>Err</code> variant, then just return early with that value.</p>

<p>Otherwise, take the value out of the <code>Ok</code> variant and continue to call <code>workers(8)</code> on that value. This is a shorthand that makes working with code that might fail much more pleasant. It is functionally equivalent to:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}).</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">));</code><code class="w"></code>
<code class="k">if</code><code class="w"> </code><code class="n">result</code><code class="p">.</code><code class="n">is_err</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">return</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">result</code><code class="p">.</code><code class="n">err</code><code class="p">().</code><code class="n">unwrap</code><code class="p">());</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
<code class="n">result</code><code class="p">.</code><code class="n">unwrap</code><code class="p">().</code><code class="n">workers</code><code class="p">(</code><code class="mi">8</code><code class="p">).</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-creating-our-handler">Creating our handler</h4>

<p>In our code for creating our app we called <code>service(index)</code> in our application factory to specify that we have a function called <code>index</code> which acts as a service for our app. Let’s first decide what we want this handler to do. We are going to look for a particular header in a get request and respond with a message based on the value of that header.</p>

<p>If the header is not present we will respond with a default message. Let’s define the structure of this response:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 7 </code><code class="cp">#[derive(Serialize)]</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">struct</code> <code class="nc">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">message</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We create a struct which will be the Rust representation of our response, one field with the name <code>message</code> with a <code>String</code> value. We then use a special attribute on the struct to derive the <code>Serialize</code> trait which we imported earlier from Serde. Let’s break down these concepts a bit because they come up a lot in Rust.</p>

<h4 id="leanpub-auto-attributes">Attributes</h4>

<p>Attributes are the way of attaching metadata to a variety of things in the language. They can be attached to modules as a whole, structs, functions, and several other constructs. They can attach to the thing they are defined within using the syntax <code>#![...]</code> with a <code>!</code> after the <code>#</code>. For example,</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">some_unused_variable</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="cp">#![allow(unused_variables)]</code><code class="w"></code>
<code class="w">  </code><code class="kd">let</code><code class="w"> </code><code class="n">x</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">();</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>allow</code> attribute is used to turn off a lint warning for the entity that contains the attribute which is the function <code>some_unused_variable</code> in this example.</p>

<p>The other format is to attach to the item following the attribute which is what we see with our struct. The <code>derive</code> attribute is probably the most common attribute you will encounter. It allows you to implement traits for types without having to do any more work provided the type meets the requirements for the trait to be derived. Most structs will at the very least will derive <code>Debug</code> which allows the struct to be printed using the <code>{:?}</code> debug format specifier. Any struct can derive <code>Debug</code> if its constituents implement the <code>Debug</code> trait which all of the builtin types do.</p>

<p><code>Debug</code> is a builtin trait and therefore the attribute to derive it is builtin to the compiler. It is possible to write custom derive logic so that your own traits can be derivable. <code>Serialize</code> is just such a custom derivable trait. Now that we have derived <code>Serialize</code> any instance of our struct can be serialized by serde into the output format of our choice.</p>

<p>Deriving traits is only one use of the attribute system. There are many other attributes builtin to the compiler for doing things like giving inlining hints and conditional compilation for different architectures.</p>

<p>Now that we have a structure for response data, let’s define the handler that will accept requests:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">12 </code><code class="cp">#[get(</code><code class="s">"/"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">13 </code><code class="k">fn</code> <code class="nf">index</code><code class="p">(</code><code class="n">req</code>: <code class="nc">HttpRequest</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">IndexResponse</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">hello</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">req</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">        </code><code class="p">.</code><code class="n">headers</code><code class="p">()</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">        </code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="s">"hello"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">        </code><code class="p">.</code><code class="n">and_then</code><code class="p">(</code><code class="o">|</code><code class="n">v</code><code class="o">|</code><code class="w"> </code><code class="n">v</code><code class="p">.</code><code class="n">to_str</code><code class="p">().</code><code class="n">ok</code><code class="p">())</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">        </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="s">"world"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">web</code>::<code class="n">Json</code><code class="p">(</code><code class="n">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">        </code><code class="n">message</code>: <code class="nc">hello</code><code class="p">.</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="p">}))</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Actix provides a few attributes for colocating routing information with the handler function. This is how we were able to call <code>service(index)</code> without any more information about the type of request or the path. Rocket uses these custom attributes quite heavily for defining the structure of your application. In Actix we can use them like we do here, or we can specify this information in our application factory which we will show in our later handlers. In this case, we define this handler to respond to <code>GET</code> requests at the root path.</p>

<h4 id="leanpub-auto-how-handlers-work-in-rust">How handlers work in Rust</h4>

<p>Most of the work in defining a handler in all of the Rust web ecosystem is centered around defining the input and output types.</p>

<p>There is quite a bit of work that the libraries, with the help of the compiler, can do for us to extract data from requests and respond with proper HTTP responses while letting us write functions that let us focus on the things that matter.</p>

<p>We will see this in later sections, but idiomatic design using the current web frameworks focuses on the type signature explaining what the function uses. The alternative would be handlers that all take a generic request as input and return generic response as output and then the internals of the function need to be introspected to determine what a handler does.</p>

<p>A set of traits are used for defining how data can be extracted from requests, and for defining how data is to be turned into an HTTP response. A lot of these traits are implemented for us by the library and therefore most of the time we just get to say what types we want to receive and what types we want to respond with and the rest seems like magic. However, under the hood, most of the magic is really just a function of the trait system.</p>

<p>Here we see from the signature that we are returning a <code>Result</code> with inner success type of <code>Json&lt;IndexResponse&gt;</code>. The <code>Result</code> implies that this function can fail, if it does we will return an error, but if it succeeds then the response should be a JSON representation of our <code>IndexResponse</code> struct. We also see that we are going to be using something from the <code>HttpRequest</code> within the body of our function.</p>

<p>If we took the request as a parameter but did not actually use it then we would get a compiler warning. It is not dramatic so far in this example, but as you build more complex handlers, focusing on the types can take you quite far in understanding an application at a high level.</p>

<p>Given our type signature, let’s walk through the body of our handler. Suppose we get a request with the header <code>hello: Rust</code>, then we want to respond with the JSON <code>{"message": "Rust"}</code>. If we get a request without a <code>hello</code> header, then we will respond with <code>{"message": "world"}</code>. So the first step is to try to get the value of the <code>hello</code> header:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">req</code><code class="p">.</code><code class="n">headers</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="s">"hello"</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-working-with-options">Working with Options</h4>

<p>This will return an <code>Option&lt;&amp;HeaderValue&gt;</code> where <code>HeaderValue</code> is a type that abstracts the bytes that hold the actually data from the request. <code>Option&lt;T&gt;</code> is an enum in the standard library with two variants: <code>Some(T)</code> and <code>None</code>.</p>

<p>The idea of <code>Option</code> is to represent the possibility of something not always existing and hence replaces the need for the concept of null found in many other programming languages. The major distinction between null in other languages and <code>Option</code> in Rust is that an <code>Option</code> is an explicit type that has a <code>None</code> variant that you must deal with and thus the concept of null cannot inhabit other types.</p>

<p>In many other languages null can be the value of nearly every type of variable. <code>Option</code> is the other main error handling primitive that complements <code>Result</code>. Wherein <code>Result</code> carries an error value, sometimes you either have something or you don’t and in those scenarios <code>Option</code> is the more suitable type to use.</p>

<p>We use the function <code>and_then</code> defined on <code>Option</code> to call a function with the value inside of the option if there is one. In other words, if the header exists, we call our closure with the value, otherwise <code>and_then</code> is a no-op on <code>None</code>. Our closure has to return an <code>Option</code> so that the type in both scenarios matches up. We call <code>to_str</code> on the <code>&amp;HeaderValue</code> which gives us <code>Result&lt;&amp;str, ToStrError&gt;</code> where <code>ToStrError</code> is a specific error that explains why the conversion to a <code>&amp;str</code> failed.</p>

<aside>
  <p>Ownership is an important part of Rust and dealing with strings is no different. The most primitive string type is named <code>str</code> and is known as a string slice. This is a slice in the same sense that <code>[i32]</code> is a slice of signed 32-bit integers. A string slice is a slice of bytes, i.e. it has type <code>[u8]</code> and it also is valid Unicode.</p>

  <p>The <code>str</code> type is almost always encountered as the borrowed variant <code>&amp;str</code> which is a reference to a valid Unicode byte array. The reference means that it points to memory owned by someone else. In particular, static string literals are represented with type <code>&amp;'static str</code> where the notation <code>&amp;'static</code> means a reference to something with a static lifetime. The static lifetime is a special lifetime in Rust which is the entire life of your program. Static strings are compiled into your binary and are therefore owned by the binary. The other type of string has type <code>String</code> which is a heap allocated string, i.e. it is a string you own.</p>

</aside>

<p>As we said before, the closure we pass to <code>and_then</code> needs to return an <code>Option</code>, but <code>to_str</code> returned a <code>Result</code>. Luckily <code>Result</code> has a handy function called <code>ok</code> which takes data from the <code>Ok</code> variant of a <code>Result</code> and puts it inside the <code>Some</code> variant of an <code>Option</code>, otherwise it turns the <code>Err</code> variant of the <code>Result</code> into the <code>None</code> variant of <code>Option</code> and discards the error. This is exactly the behavior we want here as we are going to treat a malformed header value as the same as a missing header value.</p>

<p>Finally, we want our <code>hello</code> variable to just contain a <code>&amp;str</code>, but we have an <code>Option&lt;&amp;str&gt;</code>. We can again use a helper defined on <code>Option</code> called <code>unwrap_or_else</code> which will unwrap and return data inside the <code>Some</code> variant of the <code>Option</code> if it is set, otherwise in the case of the <code>None</code> variant, this function will call the provided function and return the result.</p>

<p>As the first case returns <code>&amp;str</code> by extracting the data out of the <code>Some</code> variant, the closure we pass to <code>unwrap_or_else</code> must also return a <code>&amp;str</code>. In this case we just return <code>"world"</code> directly as this is our default.</p>

<p>Both <code>Result</code> and <code>Option</code> have a variety of helper methods defined on them which allow you to write these functional style pipelines which transform data while still dealing with various failure scenarios.</p>

<p>Frequently if you figure out what type of data you want after applying a transformation you can check the type signatures of the methods on the type that you have, be it <code>Result</code> or <code>Option</code>, to find something that will do what you want. Many of these tools come from the influence of ML style functional programming languages on the design of Rust.</p>

<p>So after all that <code>hello</code> contains a <code>&amp;str</code> which is either the value of the <code>hello</code> header or the literal <code>"world"</code>. Let’s return it. We need to construct an instance of our <code>IndexResponse</code> struct, so the obvious initial attempt might be:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">message</code>: <code class="nc">hello</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>But that will not work. The type of <code>message</code> is <code>String</code> and the type of <code>hello</code> is <code>&amp;str</code>. So we need to convert our borrowed string into an owned string so that we can return the data as a response.</p>

<p>Therefore, we need to call some method that explicitly makes this conversion because it is not free. You will find that all of <code>to_owned()</code>, <code>to_string()</code>, and <code>into()</code> would work to do this conversion and you will also see them all in other Rust code. They each use traits which at the end of the day will execute the same code for this use case.</p>

<p>So which one is right? It depends, but in this case because the intent is to turned a borrowed type into the owned variant <code>to_owned</code> most accurately describes what is happening. The use of <code>to_string</code> can be confusing as we have a string so turning it into a string seems like a weird piece of code. The other option of using <code>into</code> which goes through the <code>Into</code> and <code>From</code> traits would be a reasonable choice if you care about saving four characters for the sake of being slightly less specialized to this particular scenario.</p>

<p>Once we have our struct that can be serialized to JSON we wrap it in the actix-web <code>web::Json</code> type which takes care of doing all the work of properly returning a JSON HTTP response. Finally, we can wrap this response in the <code>Ok</code> variant of <code>Result</code> to signal that the handler succeeded.</p>

<h4 id="leanpub-auto-example-requests">Example requests</h4>

<figure class="code" dir="ltr">
  <figcaption>example</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ curl localhost:8080
<code class="lineno">2 </code><code class="o">{</code><code class="s2">"message"</code>:<code class="s2">"world"</code><code class="o">}</code>
<code class="lineno">3 </code>
<code class="lineno">4 </code>$ curl -H <code class="s2">"hello: actix"</code> localhost:8080
<code class="lineno">5 </code><code class="o">{</code><code class="s2">"message"</code>:<code class="s2">"actix"</code><code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-summary-1">Summary</h4>

<p>We have spent quite a bit of time getting to what is effectively the “Hello, World” of web servers. However, we have learned a lot about Rust to get here. We have learned about the different aggregate data types, structs and enums. We learned about helpful standard library types like <code>Result</code> and <code>Option</code>, and how to work with them to write clean, robust code. We briefly touched on ownership discussing <code>String</code> and <code>&amp;str</code>, this will certainly not be our last time talking about ownership. We also discussed implementing traits for types and how this allows us to add behavior to our data.</p>

<p>In the end we have a web server that can respond to data it receives in a header, but we now have a solid foundation of the language that will let us expand our application as we move on. The next step is adding state to this server, along the way we will learn quite a bit more about the language.</p>



</div>,<div>
<h2 id="leanpub-auto-adding-state-to-our-web-app">Adding State to Our Web App</h2>

<h3 id="leanpub-auto-recap-and-overview">Recap and overview</h3>

<p>We built a basic web server in the previous chapter which is the foundation for this chapter and the next. In this chapter we are going to add some in-memory state to the server. This will require us to explore the concepts of interior mutability, atomic types, as well as other tools which make it safe to share data across threads. The next chapter is focused on state backed by a database which is distinctly different from what we are covering here.</p>

<p>We are going to make the server more complex in this chapter, and sometimes this is exactly what you need to achieve your goals. However you always want to use the right tools for your job, so do not feel like each piece is required for every problem you might be solving.</p>

<h3 id="leanpub-auto-adding-state">Adding state</h3>

<p>We’re going to start with the Actix server we created in the previous chapter, but we are going to make our server slightly more complex by adding state that persists across requests.</p>

<p>First let’s update our set of import statements to bring in some new types that we will use for managing state:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">middleware</code><code class="p">,</code><code class="w"> </code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">HttpServer</code><code class="p">,</code><code class="w"> </code><code class="nb">Result</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">serde</code>::<code class="n">Serialize</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">cell</code>::<code class="n">Cell</code><code class="p">;</code><code class="w"></code>
<code class="lineno">7 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">sync</code>::<code class="n">atomic</code>::<code class="p">{</code><code class="n">AtomicUsize</code><code class="p">,</code><code class="w"> </code><code class="n">Ordering</code><code class="p">};</code><code class="w"></code>
<code class="lineno">8 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">sync</code>::<code class="p">{</code><code class="n">Arc</code><code class="p">,</code><code class="w"> </code><code class="n">Mutex</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>Cell</code> type we will discuss shortly. The group of things we pull in from <code>std::sync::atomic</code> are the tools we need to work with a <code>usize</code> that can be modified atomically and therefore is thread-safe. Finally, we pull in <code>Arc</code> and <code>Mutex</code> from <code>std::sync</code> which are tools we will use to safely share and mutate things that are not atomic across multiple threads.</p>

<p>Actix by default will create a number of workers to enable handling concurrent requests. One piece of state we are going to maintain is a unique <code>usize</code> for each worker. We will create an atomic <code>usize</code> to track this count of workers because it needs to be thread-safe however it only ever needs to increase. This is a good use case for an atomic integer. Let’s define a static variable to hold our server counter atomic:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">10 </code><code class="k">static</code><code class="w"> </code><code class="n">SERVER_COUNTER</code>: <code class="nc">AtomicUsize</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AtomicUsize</code>::<code class="n">new</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-static-versus-const">Static versus const</h4>

<p>There are two things that you will see in Rust code which look similar and which live for the entire lifetime of your program, one is denoted <code>const</code> and the other is denoted <code>static</code>.</p>

<p>Items marked with <code>const</code> are effectively inlined at each site they are used. Therefore references to the same constant do not necessarily point to the same memory address.</p>

<p>On the other hand, <code>static</code> items are not inlined, they have a fixed address as there is only one instance for each value. Hence <code>static</code> must be used for a shared global variable.</p>

<p>It is possible to have <code>static mut</code> variables, but mutable global variables are bad and therefore in order to read/write mutable statics requires the use of the <code>unsafe</code> keyword.</p>

<p>Atomics, on the other hand, can be modified in such a way that we do not need to mark the variable as mutable. The <code>mut</code> keyword is really a marker for the compiler to guarantee that certain memory safety properties are upheld for which atomics are immune.</p>

<p>Both <code>static</code> and <code>const</code> variables must have their types given explicitly, so we write the type <code>AtomicUsize</code> for our variable. The <code>new</code> function on <code>AtomicUsize</code> is marked <code>const</code> which is what allows it to be called in this static context.</p>

<p>Now we can define the struct which will hold the state for our app:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">12 </code><code class="k">struct</code> <code class="nc">AppState</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="n">server_id</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">request_count</code>: <code class="nc">Cell</code><code class="o">&lt;</code><code class="kt">usize</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">messages</code>: <code class="nc">Arc</code><code class="o">&lt;</code><code class="n">Mutex</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;&gt;&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Each worker thread gets its own instance of this state struct. Actix takes an application factory because it will create many instances of the application, and therefore many instances of the state struct. Therefore in order to share information across the different instances we will have to use different mechanisms than we have seen so far.</p>

<h4 id="leanpub-auto-defining-our-state">Defining our state</h4>

<p>The first part of the state will be set from the atomic <code>usize</code> we declared earlier. We will see how this is set when we get to our updated factory function, but for now we can note that this will just be a normal <code>usize</code> that gets set once when this struct is initialized.</p>

<p>The second piece of data will keep track of the number of requests seen by the particular worker that owns this instance of state.</p>

<p>The request count is owned by each worker and changes are not meant to be shared across threads, however we do want to mutate this value within a single request. We cannot just use a normal <code>usize</code> variable because we can only get an immutable reference to the state inside a request handler. Rust has a pattern for mutating a piece of data inside a struct which itself is immutable known as interior mutability.</p>

<p>Two special types enable this, <code>Cell</code> and <code>RefCell</code>. <code>Cell</code> implements interior mutability by moving values in and out of a shared memory location. <code>RefCell</code> implements interior mutability by using borrow checking at runtime to enforce the constraint that only one mutable reference can be live at any given time.</p>

<p>If one tries to mutably borrow a <code>RefCell</code> that is already mutably borrowed the calling thread will panic. As we are dealing with a primitive type as the interior value, namely <code>usize</code>, we can take advantage of <code>Cell</code> copying the value in and out and avoid the overhead of the extra lock associated with a <code>RefCell</code>. <code>Cell</code> and <code>RefCell</code> are not needed that often in everyday Rust, but they are absolutely necessary in some situations so it is useful to be aware of them.</p>

<p>Finally, the last piece of state is going to be a vector of strings that represent messages shared across all of the workers. We want each worker thread to be able to read and write this state, and we want updates to be shared amongst the workers.</p>

<p>In other words, we want shared mutable state, which is typically where bugs happen. Rust provides us with tools that makes writing safe and correct code involving shared mutable state relatively painless. The state we care about is a vector of strings, so we know we want a <code>Vec&lt;String&gt;</code>.</p>

<h4 id="leanpub-auto-sharing-across-threads">Sharing across threads</h4>

<p>We also want to be able to read and write this vector on multiple threads in a way that is safe. We can ensure mutually exclusive access to the vector by creating a <code>Mutex</code> that wraps our vector. <code>Mutex&lt;Vec&lt;String&gt;&gt;</code> is a type that provides an interface for coordinating access to the inner object (<code>Vec&lt;String&gt;</code>) across multiple threads. We will see how this works in the implementation of our handler.</p>

<p>The last piece of the puzzle is that we want to share ownership of this vector. Typically each value in Rust has a single owner, but for this situation we want each thread to be an owner of the data so that the vector lives until the last worker thread exits. The mechanism for this in Rust is to use a reference counted pointer.</p>

<p>There are two variants: <code>Rc</code> and <code>Arc</code>. They both are generic over a type <code>T</code> and provide a reference counted pointer to a value of type <code>T</code> allocated on the heap. Calling <code>clone</code> on an <code>Rc</code> will produce a new pointer to the same value on the heap. When the last <code>Rc</code> pointer to a value is destroyed, the pointed-to value will then be destroyed. The A in <code>Arc</code> stands for atomic as the reference counting mechanism of an <code>Rc</code> is non-atomic and therefore not thread safe.</p>

<p>You cannot share an <code>Rc</code> across threads, but you can share an <code>Arc</code>. Otherwise they are equivalent. <code>Rc&lt;T&gt;</code> uses a trait called <code>Deref</code> to allow you to call the methods of <code>T</code> directly on a value of type <code>Rc&lt;T&gt;</code>. As Rust does not have a garbage collector, it is possible to create memory leaks by creating cycles of reference counted pointers.</p>

<p>There is a non-owning variant called <code>Weak</code> which can be used to break such cycles. This is not an issue for us here, but it is important to be aware of especially if you are coming from a garbage collected language.</p>

<p>Okay, now that we have our state defined, let’s update our handler to use that state. The first step will be to change our response struct to include information from our state:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">18 </code><code class="cp">#[derive(Serialize)]</code><code class="w"></code>
<code class="lineno">19 </code><code class="k">struct</code> <code class="nc">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="n">server_id</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">    </code><code class="n">request_count</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="n">messages</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We will respond with the id of the server that handled this request, the number of requests this server has seen so far, and the vector of messages.</p>

<p>With our desired response defined, let’s change our index handler to do the job:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="cp">#[get(</code><code class="s">"/"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">26 </code><code class="k">fn</code> <code class="nf">index</code><code class="p">(</code><code class="n">state</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">AppState</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">IndexResponse</code><code class="o">&gt;</code><code class="err">\</code><code class="w"></code>
<code class="lineno">27 </code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">request_count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">get</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">request_count</code><code class="p">);</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">ms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">messages</code><code class="p">.</code><code class="n">lock</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">31 </code>
<code class="lineno">32 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">web</code>::<code class="n">Json</code><code class="p">(</code><code class="n">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">        </code><code class="n">server_id</code>: <code class="nc">state</code><code class="p">.</code><code class="n">server_id</code><code class="p">,</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">        </code><code class="n">request_count</code><code class="p">,</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="n">messages</code>: <code class="nc">ms</code><code class="p">.</code><code class="n">clone</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">    </code><code class="p">}))</code><code class="w"></code>
<code class="lineno">37 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-extracting-data-from-requests">Extracting data from requests</h4>

<p>We have updated the signature of our function to take the state as input while still returning a JSON representation of our response struct. It may seem a bit magical to just define the input parameter of our handler to be the state rather than having to figure out how to get that from our server or the request. The mechanism that allows this is a trait called <code>FromRequest</code> and the generic term for this concept is an extractor.</p>

<p>Extractors are types that implement the <code>FromRequest</code> trait which allow types to define how they are constructed from a request. The underlying framework provides many extractors for things like query parameters, form input, and in this case getting the state that the application factory created for the current worker.</p>

<p>This turns out to be a powerful and safe abstraction because the compiler is able to provide a lot of guarantees about what data is and is not available. Any type that implements <code>FromRequest</code> can technically fail to extract said type and thus uses <code>Result</code> in the implementation. You can define your handler to take a <code>Result&lt;T&gt;</code> or an <code>Option&lt;T&gt;</code> for any <code>T</code> that implements <code>FromRequest</code> to be able to handle the failure of extraction in your handler.</p>

<p>We will see below how the <code>AppState</code> gets constructed in the application factory, but for now we can assume that our handler will be called with an instance of <code>web::Data&lt;AppState&gt;</code> which is just a wrapper around our state that handles the <code>FromRequest</code> implementation. This wrapper implements the <code>Deref</code> trait so that we can treat a value of <code>Data&lt;AppState&gt;</code> effectively as if it was a value of <code>AppState</code>.</p>

<p>The first thing we do in our handler is to update the number of requests this server has handled. As the <code>request_count</code> field is a <code>Cell</code>, we have to use the <code>get</code> and <code>set</code> methods on <code>Cell</code> to update the value. We could have used an atomic <code>usize</code> for this variable as well, but we chose to use a <code>Cell</code> to demonstrate how to use it.</p>

<p>The reason that we cannot mutate <code>request_count</code> directly is that our <code>state</code> variable is an immutable reference. There is no way for us to update <code>server_id</code> for example. Hence, we first use <code>get</code> to get the current value inside our cell and then add one to account for the current request. We use <code>set</code> to store this new value back into the <code>Cell</code>.</p>

<h4 id="leanpub-auto-effectively-working-with-locks">Effectively working with locks</h4>

<p>Next we need to get access to our messages vector. Recall that <code>state.messages</code> has type <code>Arc&lt;Mutex&lt;Vec&lt;String&gt;&gt;&gt;</code>. First <code>Arc</code> implements <code>Deref</code> so that when we call a method on <code>state.messages</code> it will automatically get called on the value of type <code>Mutex&lt;Vec&lt;String&gt;&gt;</code>. To get access to the data inside the mutex we call the <code>lock</code> method on the mutex.</p>

<p>The <code>lock</code> method blocks until the underlying operating system mutex is not held by another thread. This method returns a <code>Result</code> wrapped around a <code>MutexGuard</code> which is wrapped around our data. The <code>Result</code> that is returned will be an error only if the mutex is poisoned which basically means a thread paniced while holding the lock and likely your program is in a bad state. We choose to use the <code>unwrap</code> method on <code>Result</code> which pulls data out of the <code>Ok</code> variant, but instead panics on the <code>Err</code> variant. We do this because if we get back an error from <code>lock</code> we don’t really know how to handle that state of the world so also panicing is not a bad option. This might not always be the right choice, but often you will see <code>lock().unwrap()</code> used with mutexes.</p>

<p>The type of the variable we get from <code>state.messages.lock().unwrap()</code> is actually a <code>MutexGuard&lt;Vec&lt;String&gt;&gt;</code>. Again through the magic of <code>Deref</code> you can just treat this as the vector of strings we want.</p>

<p>It is relevant to us because it explains how mutexes work in Rust. RAII (Resource Acquisitions Is Initialization) is a pattern for managing resources which is central to Rust. In particular, when a value goes out of scope, a special method called <code>drop</code> is called by the compiler if the type of the value implements the <code>Drop</code> trait. For a <code>MutexGuard</code>, the mutex is locked when the guard is constructed and the lock is unlocked in the guard’s <code>drop</code> method.</p>

<p>Therefore, the lock is only locked for as long as you have access to the guard. Additionally, you only have access to the data protected by the mutex through the guard. Hence, the data is only accessible while the lock is locked. You don’t have to worry about calling unlock at the right time or ensuring that you actually locked the mutex in all the places that you read or write the vector of messages. All of that is taken care of for you by the compiler.</p>

<h4 id="leanpub-auto-responding-with-data">Responding with data</h4>

<p>Finally, we can construct an instance of our response struct to be serialized and returned as JSON. The one piece to note is that we call <code>ms.clone()</code> for the value we set on the <code>messages</code> field of our response struct. The <code>clone</code> method creates an explicit copy of a value if the type implements the <code>Clone</code> trait.</p>

<p>We cannot just pass the messages vector directly because that would move ownership and that is not what we want to do (nor even possible because it is shared). We want to return a copy of the vector of messages to be serialized. Because this copying might be expensive Rust does not do it implicitly, rather you are required to state that you want it to happen explicitly by calling <code>clone</code>.</p>

<p>For things that can be copied cheaply, there is a separate trait called <code>Copy</code> which will result in implicit copies being created. You can decide what behavior you want for the types you create based on what traits you derive or implement.</p>

<p>Now that our handler is in place, we just need to update the application factory inside our <code>run</code> method to incorporate our state:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">47 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">messages</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Arc</code>::<code class="n">new</code><code class="p">(</code><code class="n">Mutex</code>::<code class="n">new</code><code class="p">(</code><code class="n">vec</code><code class="o">!</code><code class="p">[]));</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Starting http server: 127.0.0.1:{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">);</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">                </code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">AppState</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">                    </code><code class="n">server_id</code>: <code class="nc">SERVER_COUNTER</code><code class="p">.</code><code class="n">fetch_add</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="n">Ordering</code>::<code class="n">Se</code><code class="err">\</code><code class="w"></code>
<code class="lineno">54 </code><code class="n">qCst</code><code class="p">),</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">                    </code><code class="n">request_count</code>: <code class="nc">Cell</code>::<code class="n">new</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">                    </code><code class="n">messages</code>: <code class="nc">messages</code><code class="p">.</code><code class="n">clone</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">                </code><code class="p">})</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">        </code><code class="p">.</code><code class="n">workers</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">        </code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We create the shared messages vector outside of the application factory closure with the line:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">messages</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Arc</code>::<code class="n">new</code><code class="p">(</code><code class="n">Mutex</code>::<code class="n">new</code><code class="p">(</code><code class="n">vec</code><code class="o">!</code><code class="p">[]));</code><code class="w"></code>
</pre></div>

</figure>

<p>We do this so that each worker can actually share the same messages array rather than each of them creating their own vector which would be unconnected from the other workers.</p>

<p>To add state to the application we use the <code>data</code> method on <code>App</code> and pass in the initial value of our state. This is what makes the <code>web::Data&lt;AppState&gt;</code> extractor work.</p>

<h4 id="leanpub-auto-constructing-our-state">Constructing our state</h4>

<p>We have three parts to our state that each get setup differently. First we have the id of the worker which we call <code>server_id</code>. When each of the workers start their instance of the app, this <code>AppState</code> struct will be constructed.</p>

<p>For <code>server_id</code>, we use the global <code>SERVER_COUNTER</code> variable to set the value for the server id. The <code>fetch_add</code> method will atomically add an amount equal to the first argument to the global variable and return whatever value was in the variable prior to the addition. So the first time this is called <code>SERVER_COUNTER</code> will be incremented from zero to one, but the <code>server_id</code> will be set to zero as that was the value in <code>SERVER_COUNTER</code> before <code>fetch_add</code> was called.</p>

<p>The second argument to <code>fetch_add</code> controls how atomic operations synchronize memory across threads. The strongest ordering is <code>SeqCst</code> which stands for sequentially consistent. The best advice is to use <code>SeqCst</code> until you profile your code, find out that this is a hot spot, and then can prove that you are able to use one of the weaker orderings based on your access pattern.</p>

<p>The second piece of data is the <code>request_count</code>. We initialize this value by putting zero inside a <code>Cell</code>. Each thread will own its own <code>Cell</code> so we just construct the cell inside the application factory closure which is executed by the worker thread and therefore has affinity to that thread which is what we desire.</p>

<p>Finally, we clone the <code>Arc</code> value that wraps the shared messages value which means that we create a new pointer to the shared data. We have to use <code>Arc</code> instead of <code>Rc</code> because all of the <code>clone</code> calls are happening on different threads. If you tried to use an <code>Rc</code> here the compiler would give you an error because it can tell you are moving across a thread boundary.</p>

<p>The rest of our run function is exactly the same. In particular, the <code>service(index)</code> call is the same even though we changed the signature of the handler. This is due to some generic programming done by the underlying actix library to deal with handlers with a flexible number of extractor input arguments.</p>

<h4 id="leanpub-auto-example-requests-1">Example requests</h4>

<figure class="code" dir="ltr">
  <figcaption>example</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code>$ curl localhost:8080
<code class="lineno"> 2 </code><code class="o">{</code><code class="s2">"server_id"</code>:0,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 3 </code>
<code class="lineno"> 4 </code>$ curl localhost:8080
<code class="lineno"> 5 </code><code class="o">{</code><code class="s2">"server_id"</code>:1,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code>$ curl localhost:8080
<code class="lineno"> 8 </code><code class="o">{</code><code class="s2">"server_id"</code>:2,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code>$ curl localhost:8080
<code class="lineno">11 </code><code class="o">{</code><code class="s2">"server_id"</code>:3,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-receiving-input">Receiving input</h3>

<p>Our app can now respond with a list of messages stored on the server. However, this is of limited use without a way to actually add messages. Let’s add the ability to post messages which will get added to our list of messages.</p>

<p>First we want to be able to accept JSON data as input, so we will import the <code>Deserialize</code> item from <code>serde</code> so that we can derive the ability to construct structs from JSON data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">serde</code>::<code class="p">{</code><code class="n">Deserialize</code><code class="p">,</code><code class="w"> </code><code class="n">Serialize</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s define our input and output data for the method that accepts data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="cp">#[derive(Deserialize)]</code><code class="w"></code>
<code class="lineno">26 </code><code class="k">struct</code> <code class="nc">PostInput</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="n">message</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">28 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">29 </code>
<code class="lineno">30 </code><code class="cp">#[derive(Serialize)]</code><code class="w"></code>
<code class="lineno">31 </code><code class="k">struct</code> <code class="nc">PostResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="n">server_id</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">    </code><code class="n">request_count</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">    </code><code class="n">message</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">35 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our input will just be of the form <code>{"message": "some data"}</code>, so we create a struct <code>PostInput</code> and derive <code>Deserialize</code>. We will then be able to use Serde to turn JSON data with that format into instances of our struct. Serde has defaults that usually do what you want, but if you wanted to change the name of a field or otherwise customize the input/output format you can use custom attributes on your struct.</p>

<p>The output will be very similar to our <code>IndexResponse</code> in that we will include information about the worker that handled this request, but instead of returning the whole list of messages, we will just echo back the message that was input.</p>

<p>Given our input and output data format, let’s define our handler:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">50 </code><code class="k">fn</code> <code class="nf">post</code><code class="p">(</code><code class="n">msg</code>: <code class="nc">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">PostInput</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><code class="n">state</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">AppState</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Resul</code><code class="err">\</code><code class="w"></code>
<code class="lineno">51 </code><code class="n">t</code><code class="o">&lt;</code><code class="n">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">PostResponse</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">request_count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">get</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">    </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">request_count</code><code class="p">);</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">ms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">messages</code><code class="p">.</code><code class="n">lock</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">    </code><code class="n">ms</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">msg</code><code class="p">.</code><code class="n">message</code><code class="p">.</code><code class="n">clone</code><code class="p">());</code><code class="w"></code>
<code class="lineno">56 </code>
<code class="lineno">57 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">web</code>::<code class="n">Json</code><code class="p">(</code><code class="n">PostResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">        </code><code class="n">server_id</code>: <code class="nc">state</code><code class="p">.</code><code class="n">server_id</code><code class="p">,</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">        </code><code class="n">request_count</code><code class="p">,</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">        </code><code class="n">message</code>: <code class="nc">msg</code><code class="p">.</code><code class="n">message</code><code class="p">.</code><code class="n">clone</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="p">}))</code><code class="w"></code>
<code class="lineno">62 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This handler will handle our posted messages, we chose the name <code>post</code> for the name of the function, but it has nothing to do with the HTTP method used for taking data.</p>

<p>Note that we are not using an attribute to define the method and route as we will construct this service differently in our <code>run</code> method to demonstrate the other style of route configuration.</p>

<p>Looking at our handler’s function signature we see that we expect JSON input data, we will access the state of our app, and we are returning a JSON representation of our <code>PostResponse</code> struct. The <code>web::Json&lt;T&gt;</code> extractor attempts to deserialize the request body using serde into the type specified. If deserialization fails for any reason, an error is returned. This behavior can be customized as we will see later.</p>

<aside class="information blurb">
    <p>Note that we can take in as many request extractors as we need to make our handler do what we want. Technically the library implements the ability to take up to nine extractors, but you can take an arbitrary number by combining them into a tuple rather than having them be separate arguments.</p>

</aside>

<p>Thanks to the extractor doing the hard work of getting the JSON from the request and constructing an instance of <code>PostInput</code>, we know that inside our method we have input data in the format we expect.</p>

<p>Therefore, we can do something similar to our index method except we want to modify our messages vector. We lock the mutex to get access to the vector and then we push this message onto the end. Note that we declare our message vector variable <code>ms</code> to be mutable so that we can call <code>push</code> which is safe because as we are holding the mutex we have exclusive read/write access to the vector.</p>

<p>We have to clone the message as we push it into the vector because this vector owns each element and we only have a borrowed reference to our <code>PostInput</code> data. This also explains why we clone the message when we return it as part of our <code>PostResponse</code>.</p>

<p>We can now update our application factory to define the route leading to our <code>post</code> handler:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 96 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="w">                    </code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/send"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">100 </code><code class="w">                        </code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">web</code>::<code class="n">JsonConfig</code>::<code class="n">default</code><code class="p">().</code><code class="n">limit</code><code class="p">(</code><code class="mi">4096</code><code class="p">))</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">                        </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to</code><code class="p">(</code><code class="n">post</code><code class="p">)),</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">                </code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>service</code> method takes a resource definition. For our <code>index</code> method because we used the special attribute syntax this resource definition is generated for us. For the <code>post</code> handler, we are going to create our own resource. The code is pretty self explanatory.</p>

<p>First we create a resource for the specific path <code>/send</code> with <code>web::resource("/send")</code>.</p>

<p>The <code>data</code> method is used for specifying route specific data or for configuring route specific extractors. We use it here to demonstrate how to configure the JSON extractor for this route by setting a limit on the number of bytes to deserialize to 4096 bytes.</p>

<p>We then declare the route configuration for this resource by passing route data to the <code>route</code> method. There are methods for each HTTP method, so we use <code>web::post()</code> to say that this route requires a <code>POST</code> request.</p>

<p>Finally, <code>to</code> is called with our handler function <code>post</code> to indicate which function to call for this route.</p>

<p>While we are at it, let’s also create a post request that clears out all the messages:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">63 </code><code class="cp">#[post(</code><code class="s">"/clear"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">64 </code><code class="k">fn</code> <code class="nf">clear</code><code class="p">(</code><code class="n">state</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">AppState</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">IndexResponse</code><code class="o">&gt;</code><code class="err">\</code><code class="w"></code>
<code class="lineno">65 </code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">66 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">request_count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">get</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">    </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">request_count</code><code class="p">);</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">ms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">messages</code><code class="p">.</code><code class="n">lock</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">    </code><code class="n">ms</code><code class="p">.</code><code class="n">clear</code><code class="p">();</code><code class="w"></code>
<code class="lineno">70 </code>
<code class="lineno">71 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">web</code>::<code class="n">Json</code><code class="p">(</code><code class="n">IndexResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">        </code><code class="n">server_id</code>: <code class="nc">state</code><code class="p">.</code><code class="n">server_id</code><code class="p">,</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">        </code><code class="n">request_count</code><code class="p">,</code><code class="w"></code>
<code class="lineno">74 </code><code class="w">        </code><code class="n">messages</code>: <code class="nc">vec</code><code class="o">!</code><code class="p">[],</code><code class="w"></code>
<code class="lineno">75 </code><code class="w">    </code><code class="p">}))</code><code class="w"></code>
<code class="lineno">76 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is similar to our index request so we will just repurpose the response type and also return <code>IndexResponse</code> from <code>clear</code>. The implementation follows our <code>post</code> handler, except instead of pushing a new message onto our vector, we mutate it by calling <code>clear</code> to remove all messages.</p>

<p>Lastly we just return an empty vector in our response because we know that we just cleared out our vector.</p>

<p>As we used the attribute syntax to define the route as a post request to <code>/clear</code>, we need only add a service to our app:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">102 </code><code class="w">                </code><code class="p">)</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">clear</code><code class="p">)</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">105 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
<code class="lineno">106 </code><code class="w">        </code><code class="p">.</code><code class="n">workers</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-example-requests-2">Example requests</h4>

<figure class="code" dir="ltr">
  <figcaption>example</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code>$ curl localhost:8080
<code class="lineno"> 2 </code><code class="o">{</code><code class="s2">"server_id"</code>:0,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 3 </code>
<code class="lineno"> 4 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno"> 5 </code><code class="s1">lo"}'</code> localhost:8080/send
<code class="lineno"> 6 </code><code class="o">{</code><code class="s2">"server_id"</code>:1,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello"</code><code class="o">}</code>
<code class="lineno"> 7 </code>
<code class="lineno"> 8 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno"> 9 </code><code class="s1">lo again"}'</code> localhost:8080/send
<code class="lineno">10 </code><code class="o">{</code><code class="s2">"server_id"</code>:2,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello again"</code><code class="o">}</code>
<code class="lineno">11 </code>
<code class="lineno">12 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno">13 </code><code class="s1">lo"}'</code> localhost:8080/send
<code class="lineno">14 </code><code class="o">{</code><code class="s2">"server_id"</code>:3,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello"</code><code class="o">}</code>
<code class="lineno">15 </code>
<code class="lineno">16 </code>$ curl localhost:8080
<code class="lineno">17 </code><code class="o">{</code><code class="s2">"server_id"</code>:4,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[</code><code class="s2">"hello"</code>,<code class="s2">"hello again"</code>,<code class="s2">"hel\</code>
<code class="lineno">18 </code><code class="s2">lo"</code><code class="o">]}</code>
<code class="lineno">19 </code>
<code class="lineno">20 </code>$ curl -X POST localhost:8080/clear
<code class="lineno">21 </code><code class="o">{</code><code class="s2">"server_id"</code>:5,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno">22 </code>
<code class="lineno">23 </code>$ curl localhost:8080
<code class="lineno">24 </code><code class="o">{</code><code class="s2">"server_id"</code>:6,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno">25 </code>
<code class="lineno">26 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno">27 </code><code class="s1">lo after clear"}'</code> localhost:8080/send
<code class="lineno">28 </code><code class="o">{</code><code class="s2">"server_id"</code>:7,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello after clear"</code><code class="o">}</code>
<code class="lineno">29 </code>
<code class="lineno">30 </code>$ curl localhost:8080
<code class="lineno">31 </code><code class="o">{</code><code class="s2">"server_id"</code>:0,<code class="s2">"request_count"</code>:2,<code class="s2">"messages"</code>:<code class="o">[</code><code class="s2">"hello after clear"</code><code class="o">]}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-custom-error-handling">Custom error handling</h3>

<p>We can now post messages to our app and get them back out. But currently if you made a mistake when posting a message and sent data like <code>{"my_message": "hello"}</code>, the app would return a 500. This is not a great user experience. There are a variety of mechanisms for dealing with errors but we are going to focus on this one particular case where we want to custom the error handler associated with the JSON decoding step.</p>

<p>First, let’s add bring in some imports from <code>actix_web</code> that will make dealing with errors less verbose:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="n">error</code>::<code class="p">{</code><code class="n">Error</code><code class="p">,</code><code class="w"> </code><code class="n">InternalError</code><code class="p">,</code><code class="w"> </code><code class="n">JsonPayloadError</code><code class="p">},</code><code class="w"></code>
<code class="lineno">6 </code><code class="w">    </code><code class="n">middleware</code><code class="p">,</code><code class="w"> </code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">HttpRequest</code><code class="p">,</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">HttpServer</code><code class="p">,</code><code class="w"> </code><code class="nb">Result</code><code class="p">,</code><code class="w"></code>
<code class="lineno">7 </code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>Rather than returning a 500 response with no data, we are going to respond with a more appropriate status code along with an error message. As the rest of our functions are returning JSON, we want our error handler to also return JSON. Therefore, let’s define a struct to represent the response from our error handler:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">41 </code><code class="cp">#[derive(Serialize)]</code><code class="w"></code>
<code class="lineno">42 </code><code class="k">struct</code> <code class="nc">PostError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">    </code><code class="n">server_id</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="n">request_count</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="n">error</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">46 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is the same structure as our other responses, but we are going to have an error field with a string that holds a message about what went wrong.</p>

<p>Given the data we want to output, let’s define the handler function that will be called in the case of a JSON error:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 88 </code><code class="k">fn</code> <code class="nf">post_error</code><code class="p">(</code><code class="n">err</code>: <code class="nc">JsonPayloadError</code><code class="p">,</code><code class="w"> </code><code class="n">req</code>: <code class="kp">&amp;</code><code class="nc">HttpRequest</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 89 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">extns</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">req</code><code class="p">.</code><code class="n">extensions</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 90 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">state</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">extns</code><code class="p">.</code><code class="n">get</code>::<code class="o">&lt;</code><code class="n">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">AppState</code><code class="o">&gt;&gt;</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 91 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">request_count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">get</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 92 </code><code class="w">    </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">request_count</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 93 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">post_error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">PostError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 94 </code><code class="w">        </code><code class="n">server_id</code>: <code class="nc">state</code><code class="p">.</code><code class="n">server_id</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 95 </code><code class="w">        </code><code class="n">request_count</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 96 </code><code class="w">        </code><code class="n">error</code>: <code class="nc">format</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">err</code><code class="p">),</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">    </code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">    </code><code class="n">InternalError</code>::<code class="n">from_response</code><code class="p">(</code><code class="n">err</code><code class="p">,</code><code class="w"> </code><code class="n">HttpResponse</code>::<code class="n">BadRequest</code><code class="p">().</code><code class="n">json</code><code class="p">(</code><code class="n">p</code><code class="err">\</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="n">ost_error</code><code class="p">)).</code><code class="n">into</code><code class="p">()</code><code class="w"></code>
<code class="lineno">100 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The type for this handler is defined by the <code>JsonConfig</code> type and is not as flexible as the other handlers that we can define. In particular, the signature of the function has to be exactly this, we cannot use extractors to get different input, and we have to return the <code>Error</code> type from <code>actix_web</code>.</p>

<aside class="information blurb">
    <p>This might change in a future version of the library, but for now this is the required.</p>

</aside>

<p>The first argument is an instance of the enum <code>JsonPayloadError</code> which contains information about what went wrong. The second argument is a reference to the request that led to this error. We still want to access our state because we want to update the request count and get the id of the current worker to return in our response.</p>

<p>We can do this by doing what the state extractor would have done for us and pull our state out of the request’s extensions.</p>

<h4 id="leanpub-auto-generic-return-types">Generic return types</h4>

<p>Actix uses a type safe bag of additional data attached to requests called extensions. The state is just the value inside of the extensions with type <code>web::Data&lt;AppState&gt;</code>.</p>

<p>We get a reference to the extensions by calling the <code>extensions</code> method on the request. The line to pull out the state looks a bit complicated but we can break it down. The extensions have a generic function called <code>get</code> which has the signature:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">get</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"></code>
</pre></div>

</figure>

<p>This is a function that is returns a reference to a type that was previously stored as an extension. It is up to the caller (i.e. us) to say what type we want to get back.</p>

<p>We have to give the compiler some help by putting a type annotation somewhere so that <code>get</code> knows what type we want. We do that by using the <code>::&lt;&gt;</code> turbofish syntax, namely <code>get::&lt;web::Data&lt;AppState&gt;&gt;</code> means call <code>get&lt;T&gt;()</code> with <code>T</code> bound to the type <code>web::Data&lt;AppState&gt;</code>. The implementation has to know how to handle any generic type but for us we just know that we will get back the data we want if it was previously stored, otherwise the <code>Option</code> will be the <code>None</code> variant.</p>

<aside>
  <p>The actual signature of <code>get</code> is <code>fn get&lt;T: 'static&gt;(&amp;self) -&gt; Option&lt;&amp;T&gt;</code> but the <code>'static</code> lifetime bound on the generic type <code>T</code> is not important for the current discussion.</p>

</aside>

<p>For the sack of brevity we call <code>unwrap</code> on the <code>Option</code> we get back to get direct access to our state. We know that if our app is properly configured then we will always get back our state and thus this <code>Option</code> should never be <code>None</code>.</p>

<p>However, it is worth noting that if we did not configure the state properly we would not see this error until runtime when this call to <code>unwrap</code> panics. We could match on the value of the option and handle the <code>None</code> case by returning a fallback error, but that is a future improvement.</p>

<h4 id="leanpub-auto-creating-useful-errors">Creating useful errors</h4>

<p>Once we have the state, we can work with it in the exact same way that we did in our other handlers where the extractor took care of the previous step for us.</p>

<p>We create our <code>PostError</code> struct with the id and request count gathered from the state. We set the error message to be the string representation of the <code>JsonPayloadError</code> that was passed to us. The <code>format</code> macro takes a format string along with the necessary variables to fill in the placeholders and returns an owned <code>String</code>. In this case, we use the format string <code>"{}"</code> to use the <code>Display</code> trait implementation of your error to get a nice message.</p>

<p>This is in contrast to <code>"{:?}"</code> which uses the <code>Debug</code> trait implementation which would not be a nice message. In a real app, you would probably want a more user friendly message than even just displaying this error. One approach would be to match on the different variants of the <code>JsonPayloadError</code> enum and make our own message in the different scenarios.</p>

<p>Finally, we want to construct an <code>Error</code> with our struct turned into JSON. <code>InternalError</code> is a helper provided by actix to wrap any error and turn it into a custom response. So we call the constructor <code>from_response</code>, passing in the <code>JsonPayloadError</code> which gets stored as the cause of the error, and then the second argument is the custom response we want to return.</p>

<p>The <code>HttpResponse</code> struct has a variety of helpers for building responses, one of which is <code>BadRequest</code> which sets the status code to 400 which by the spec means the server is working properly but your request was bad for some reason. This method returns a response builder which has a <code>json</code> method that can take anything that is serializable into JSON and sets it as the response body.</p>

<h4 id="leanpub-auto-interpreting-compiler-errors">Interpreting compiler errors</h4>

<p>That covers the entirety of the final line in our handler except for that call to <code>into()</code> at the end. If you leave off this call you will get a compiler error that ends with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">=</code> note: expected <code class="nb">type</code> <code class="sb">`</code>actix_web::Error<code class="sb">`</code>
           found <code class="nb">type</code> <code class="sb">`</code>actix_web::error::InternalError&lt;actix_web::error<code class="se">\</code>
::JsonPayloadError&gt;<code class="sb">`</code>
</pre></div>

</figure>

<p>This is correct, we are returning an <code>InternalError</code> struct when our function claims to return an <code>Error</code> struct. So we can’t just return that struct directly. However, Rust has a pair of traits <code>std::convert::From</code> and <code>std::convert::Into</code> which define explicit transformations between types. The documentation states that <code>From&lt;T&gt;</code> for <code>U</code> implies <code>Into&lt;U&gt;</code> for <code>T</code> which means that typically only one side of the conversion is implemented.</p>

<p>In particular, libraries usually implement the <code>From</code> trait to define how to construct an instance of their type from other things. Users can then create their own types and call <code>into</code> to hook into the conversion facilities provided by the library.</p>

<p>To make this more concrete, in this case, <code>actix_web::Error</code> implements <code>From&lt;T&gt;</code> for any <code>T</code> which implements the <code>ResponseError</code> trait. As <code>InternalError</code> implements the <code>ReponseError</code> trait, we can explicitly say that we want to convert our <code>InternalError</code> into an <code>Error</code> and let the <code>From</code> implementation of <code>Error</code> take care of what that means.</p>

<p>In order to use our new error handler, we simply declare that we want to use it by calling the <code>error_handler</code> method on the <code>JsonConfig</code> setup in our application factory:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">121 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">                    </code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/send"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">                        </code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">                            </code><code class="n">web</code>::<code class="n">JsonConfig</code>::<code class="n">default</code><code class="p">()</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">                                </code><code class="p">.</code><code class="n">limit</code><code class="p">(</code><code class="mi">4096</code><code class="p">)</code><code class="w"></code>
<code class="lineno">127 </code><code class="w">                                </code><code class="p">.</code><code class="n">error_handler</code><code class="p">(</code><code class="n">post_error</code><code class="p">),</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">                        </code><code class="p">)</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">                        </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to</code><code class="p">(</code><code class="n">post</code><code class="p">)),</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">                </code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>While we are here let’s also update the format of the logger middleware. Near the top of our file let’s define a string constant that specifies our desired log format:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">13 </code><code class="k">const</code><code class="w"> </code><code class="n">LOG_FORMAT</code>: <code class="kp">&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">r#""%r" %s %b "%{User-Agent}i" %D"#</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The details for what is available can be found in the <code>actix_web</code> documentation. This format is similar to the default but removes a few of the less useful pieces of information, and we change the reporting of the time spent processing the request to be in milliseconds by using <code>%D</code>. We are using a raw string because we want to include quotation marks inside our string without having to escape them.</p>

<p>The syntax is the character <code>r</code> followed by zero or more <code>#</code> characters followed by an opening <code>"</code> character. To terminate the string you use a closing <code>"</code> character followed by the same number of <code>#</code> characters you used at the beginning. Here we use one <code>#</code> character, but there are cases where you want to use more, for example if you want to embed <code>"#</code> inside your string.</p>

<p>We then change our middleware specification in our application factory to use this format. We do this by replacing <code>middleware::Logger::default()</code> with:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">120 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">new</code><code class="p">(</code><code class="n">LOG_FORMAT</code><code class="p">))</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-example-requests-3">Example requests</h4>

<figure class="code" dir="ltr">
  <figcaption>example</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"bad": "hello"}\</code>
<code class="lineno"> 2 </code><code class="s1">'</code> localhost:8080/send
<code class="lineno"> 3 </code><code class="o">{</code><code class="s2">"server_id"</code>:0,<code class="s2">"request_count"</code>:1,<code class="s2">"error"</code>:<code class="s2">"Json deserialize error: missi\</code>
<code class="lineno"> 4 </code><code class="s2">ng field `message` at line 1 column 16"</code><code class="o">}</code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code>$ curl localhost:8080
<code class="lineno"> 7 </code><code class="o">{</code><code class="s2">"server_id"</code>:1,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno">10 </code><code class="s1">lo"}'</code> localhost:8080/send
<code class="lineno">11 </code><code class="o">{</code><code class="s2">"server_id"</code>:2,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello"</code><code class="o">}</code>
<code class="lineno">12 </code>
<code class="lineno">13 </code>$ curl localhost:8080
<code class="lineno">14 </code><code class="o">{</code><code class="s2">"server_id"</code>:3,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[</code><code class="s2">"hello"</code><code class="o">]}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-handling-path-variables">Handling path variables</h3>

<p>Before we wrap up, let’s add one more route to our API to show the basics of handling variable paths. Rather than having to get the entire list of messages, let’s add a GET request to <code>/lookup/{index}</code> which will attempt to get only the message at that particular index in our list. First we will define a struct to represent this response:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">101 </code><code class="cp">#[derive(Serialize)]</code><code class="w"></code>
<code class="lineno">102 </code><code class="k">struct</code> <code class="nc">LookupResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">    </code><code class="n">server_id</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">    </code><code class="n">request_count</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">105 </code><code class="w">    </code><code class="n">result</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">106 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The different part of this struct from our previous responses is the <code>result</code> field which has type <code>Option&lt;String&gt;</code>. We use an <code>Option</code> because the lookup might fail if the index happens to be out of bounds of the current vector of messages. The <code>None</code> variant will be serialized to <code>null</code> in JSON, and the <code>Some</code> variant will serialize to just the inner data.</p>

<p>With our desired response defined, let’s create the handler for this lookup operation:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">108 </code><code class="cp">#[get(</code><code class="s">"/lookup/{index}"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">109 </code><code class="k">fn</code> <code class="nf">lookup</code><code class="p">(</code><code class="n">state</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">AppState</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><code class="n">idx</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">usize</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="err">\</code><code class="w"></code>
<code class="lineno">110 </code><code class="n">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">LookupResponse</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">111 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">request_count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">get</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">112 </code><code class="w">    </code><code class="n">state</code><code class="p">.</code><code class="n">request_count</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">request_count</code><code class="p">);</code><code class="w"></code>
<code class="lineno">113 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">ms</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">state</code><code class="p">.</code><code class="n">messages</code><code class="p">.</code><code class="n">lock</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">114 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ms</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="n">idx</code><code class="p">.</code><code class="n">into_inner</code><code class="p">()).</code><code class="n">cloned</code><code class="p">();</code><code class="w"></code>
<code class="lineno">115 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">web</code>::<code class="n">Json</code><code class="p">(</code><code class="n">LookupResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">116 </code><code class="w">        </code><code class="n">server_id</code>: <code class="nc">state</code><code class="p">.</code><code class="n">server_id</code><code class="p">,</code><code class="w"></code>
<code class="lineno">117 </code><code class="w">        </code><code class="n">request_count</code><code class="p">,</code><code class="w"></code>
<code class="lineno">118 </code><code class="w">        </code><code class="n">result</code><code class="p">,</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">    </code><code class="p">}))</code><code class="w"></code>
<code class="lineno">120 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use an attribute to define the route for this handler as a GET request to <code>/lookup/{index}</code>. This syntax says to match the exact path <code>/lookup/</code> and then expect a variable afterwards. The name inside the braces in the attribute defining the route is not actually important for our use case, but can be good documentation.</p>

<p>The signature of our input types has changed to include a <code>web::Path</code> extractor in addition to the <code>Data</code> extractor we use again because we still want to work with the state.</p>

<p>The <code>Path</code> extractor uses the generic type specified, in this case <code>usize</code>, to attempt to deserialize the path segment to this type. If we had multiple path segments, then we would pass a tuple with the different expected types in order to allow for deserialization. You can also pass a custom type that implements Deserialize to handle more complex use cases.</p>

<p>Our implementation of <code>lookup</code> is quite similar to handlers we have seen before, except for:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ms</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="n">idx</code><code class="p">.</code><code class="n">into_inner</code><code class="p">()).</code><code class="n">cloned</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>First we call <code>into_inner</code> on the <code>Path&lt;usize&gt;</code> variable. This converts the <code>Path</code> wrapper into the inner type it is wrapping, in this case a <code>usize</code>. Then, we use that <code>usize</code> variable as the argument to the <code>get</code> method on our vector.</p>

<p>The <code>get</code> method on <code>Vec&lt;T&gt;</code> returns <code>Option&lt;&amp;T&gt;</code>, that is it maybe returns a reference to one of the elements inside the vector. This method does not modify the vector, so it cannot return <code>Option&lt;T&gt;</code> as that would require moving data out of the vector and therefore modifying the vector. As the variable <code>ms</code> was not declared <code>mut</code> we know that we are only ever calling methods which do not mutate the vector.</p>

<p>An <code>Option</code> is returned because the index passed in might be out of bounds so this is a safe way of accessing data in the vector without having to manually check that the index is valid.</p>

<p>Our result variable needs to be of type <code>Option&lt;String&gt;</code>, but we have a variable of type <code>Option&lt;&amp;String&gt;</code>. The <code>Option</code> enum implements a method <code>cloned</code> which converts <code>Option&lt;&amp;T&gt;</code> to <code>Option&lt;T&gt;</code> by cloning the inner data in the <code>Some</code> case, and doing nothing in the <code>None</code> case. This is exactly the behavior we want.</p>

<p>The last piece of the puzzle is to hook the <code>lookup</code> up to our app by declaring it as a service in our application factory:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">150 </code><code class="w">                </code><code class="p">)</code><code class="w"></code>
<code class="lineno">151 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">clear</code><code class="p">)</code><code class="w"></code>
<code class="lineno">152 </code><code class="w">                </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">lookup</code><code class="p">)</code><code class="w"></code>
<code class="lineno">153 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">154 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-example-requests-4">Example requests</h4>

<figure class="code" dir="ltr">
  <figcaption>example</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code>$ curl localhost:8080
<code class="lineno"> 2 </code><code class="o">{</code><code class="s2">"server_id"</code>:0,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[]}</code>
<code class="lineno"> 3 </code>
<code class="lineno"> 4 </code>$ curl localhost:8080/lookup/2
<code class="lineno"> 5 </code><code class="o">{</code><code class="s2">"server_id"</code>:1,<code class="s2">"request_count"</code>:1,<code class="s2">"result"</code>:null<code class="o">}</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno"> 8 </code><code class="s1">lo"}'</code> localhost:8080/send
<code class="lineno"> 9 </code><code class="o">{</code><code class="s2">"server_id"</code>:2,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello"</code><code class="o">}</code>
<code class="lineno">10 </code>
<code class="lineno">11 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "hel\</code>
<code class="lineno">12 </code><code class="s1">lo again"}'</code> localhost:8080/send
<code class="lineno">13 </code><code class="o">{</code><code class="s2">"server_id"</code>:3,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"hello again"</code><code class="o">}</code>
<code class="lineno">14 </code>
<code class="lineno">15 </code>$ curl -X POST -H <code class="s2">"Content-Type: application/json"</code> -d <code class="s1">'{"message": "goo\</code>
<code class="lineno">16 </code><code class="s1">dbye"}'</code> localhost:8080/send
<code class="lineno">17 </code><code class="o">{</code><code class="s2">"server_id"</code>:4,<code class="s2">"request_count"</code>:1,<code class="s2">"message"</code>:<code class="s2">"goodbye"</code><code class="o">}</code>
<code class="lineno">18 </code>
<code class="lineno">19 </code>$ curl localhost:8080
<code class="lineno">20 </code><code class="o">{</code><code class="s2">"server_id"</code>:5,<code class="s2">"request_count"</code>:1,<code class="s2">"messages"</code>:<code class="o">[</code><code class="s2">"hello"</code>,<code class="s2">"hello again"</code>,<code class="s2">"goo\</code>
<code class="lineno">21 </code><code class="s2">dbye"</code><code class="o">]}</code>
<code class="lineno">22 </code>
<code class="lineno">23 </code>$ curl localhost:8080/lookup/2
<code class="lineno">24 </code><code class="o">{</code><code class="s2">"server_id"</code>:6,<code class="s2">"request_count"</code>:1,<code class="s2">"result"</code>:<code class="s2">"goodbye"</code><code class="o">}</code>
<code class="lineno">25 </code>
<code class="lineno">26 </code>$ curl localhost:8080/lookup/0
<code class="lineno">27 </code><code class="o">{</code><code class="s2">"server_id"</code>:7,<code class="s2">"request_count"</code>:1,<code class="s2">"result"</code>:<code class="s2">"hello"</code><code class="o">}</code>
<code class="lineno">28 </code>
<code class="lineno">29 </code>$ curl localhost:8080/lookup/foo
<code class="lineno">30 </code>-&gt; <code class="m">404</code>
<code class="lineno">31 </code>
<code class="lineno">32 </code>$ curl localhost:8080/lookup/99
<code class="lineno">33 </code><code class="o">{</code><code class="s2">"server_id"</code>:1,<code class="s2">"request_count"</code>:2,<code class="s2">"result"</code>:null<code class="o">}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrapping-up-1">Wrapping up</h3>

<p>We added some realistic pieces to our web server: state shared across worker threads, handling structured input data, and variable URL paths. Along the way we learned about interior mutability, sharing ownership via reference counting, and safely sharing data across threads with locks.</p>

<p>Working effectively with multiple threads is often thought of as a dangerous activity. Such an attitude is fully justified in languages where the compiler is not helping you get things correct. This is one reason many languages are built to hide this complexity. Hopefully, after working with locks to share data in this chapter you feel like Rust’s approach is not as hard.</p>



</div>,<div>
<h2 id="leanpub-auto-what-is-web-assembly">What is Web Assembly?</h2>

<h3 id="leanpub-auto-intro-to-web-assembly">Intro to Web Assembly</h3>

<p>Modern web browsers expose a set of APIs related to the user interface and user interactions (DOM, CSS, WebGL, etc.) as well as an execution environment for working with these APIs which executes JavaScript. WebAssembly, abbreviated Wasm, is a type of code which was created to be run inside this browser execution environment as an additional language alongside JavaScript. The purpose is therefore not to replace JavaScript but rather to augment it in situations which have different constraints.</p>

<p>Wasm is a language but as its name implies it is akin to a low level assembly language which is not meant to be written by hand, in contrast with JavaScript. Rather Wasm is intended to be a compilation target for higher level languages. As we will discuss, the strongly typed nature of Wasm along with the low-level memory model, imply that the currently most suitable languages for compiling to Wasm are C++ and Rust.</p>

<p>As part of the specification of Wasm, no web specific assumptions are made, thus although the original intent was to introduce a low level language to the web, the design allows Wasm to be used in a variety of other contexts as well.</p>

<p>The primary goals of Wasm are safety, speed, efficiency, and portability. Wasm is safe as code is validated and executed in a sandboxed environment that guarantees memory safety. JavaScript in the browser is also executed in a sandboxed environment which is part of where the idea comes from. In more traditional contexts, languages that are translated to machine code and run directly on host hardware are harder to secure in this fashion. As Wasm is designed to be translated to machine code it provides near native performance. There are still a few performance penalties to the environment that differentiate Wasm from truly native code, but the gap is continuing to narrow as the platform matures.</p>

<p>The representation of Wasm code is designed so that the process of transmitting, decoding, validating, and compiling is streamable, parallelizable, and efficient. In other words, a binary format was created for Wasm based on all of the learnings from the growth of JavaScript on the web over the past several decades.</p>

<h4 id="leanpub-auto-type-system-1">Type System</h4>

<p>Wasm has four value types, abbreviated <code>valtype</code>:</p>

<ul>
  <li>i32</li>
  <li>i64</li>
  <li>f32</li>
  <li>f64</li>
</ul>

<p>These types represent 32 and 64 bit integers, as well as 32 and 64 bit floating point numbers. These floating point numbers are also known as single and double precision as defined by IEEE 754. The integer types are not signed or unsigned in the spec even. Do not be confused by the fact that the term <code>i32</code> is the Rust syntax for a signed 32 bit integer. As we will see later we can use either unsigned or signed integer types in Rust code, e.g. both <code>i32</code> and <code>u32</code>, with the signedness in Wasm inferred by usage.</p>

<p>Wasm has functions which map a vector of value types to a vector of value types:</p>

<p>
  <code>function = vec(valtype) -&gt; vec(valtype)</code>
</p>

<p>However, the return type vector is currently limited to be of length at most 1. In other words, Wasm functions can take 0 or more arguments and can either return nothing or return a single value. This restriction may be removed in the future.</p>

<h4 id="leanpub-auto-memory">Memory</h4>

<p>Wasm has a linear memory model which is just a contiguous vector of raw bytes. Your code can grow this memory but not shrink it. Data in the memory region is accessed via load and store operations based on an aligned offset from the beginning of the memory region. Access via an offset from the beginning of the region is where the linear name comes from. This memory region is exposed by a Wasm module and can be accessed directly in JavaScript. Sharing memory is dangerous but is the primary way by which JavaScript and Wasm can interact performantly.</p>

<h4 id="leanpub-auto-execution">Execution</h4>

<p>The WebAssembly computational model is based on a stack machine. This means that every operation can be modeled by maybe popping some values off a virtual stack, possibly doing something with these values, and then maybe pushing some values onto this stack. Each possible operation is well-defined in the Wasm specification as to exactly how a specific opcode interacts with the stack. For example, imagine we start with an empty stack and we execute the following operations:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>i64.const 16
<code class="lineno">2 </code>i64.const 2
<code class="lineno">3 </code>i64.div_u
</pre></div>

</figure>

<p>The first operation has two parts, <code>i64.const</code> is an opcode which takes one argument, 16 in this case. Thus, <code>i64.const 16</code> means push the value <code>16</code> as an i64 constant onto the top of the stack. Similarly the second operation pushes <code>2</code> onto the stack leaving our stack to look like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>2
<code class="lineno">2 </code>16
</pre></div>

</figure>

<p>The next operation <code>i64.div_u</code> is defined to pop two values off the top of the stack, perform unsigned division between those two values and push the result back onto the top of the stack. In this case the first number popped off divides the second number popped off, so at the end of this operation the stack contains:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>8
</pre></div>

</figure>

<h3 id="leanpub-auto-rust-in-the-browser">Rust in the browser</h3>

<p>Rust uses the LLVM project as the backend for its compiler. This means that the Rust compiler does all of the Rust specific work necessary to build an intermediate representation (IR) of your code which is understood by LLVM. From that point, LLVM is used to turn that IR into machine code for the particular target of your choosing.</p>

<p>Targets in LLVM can roughly be thought of as architectures, such as <code>x86_64</code> or <code>armv7</code>. Wasm is just another target. Hence, Rust can support Wasm if LLVM supports Wasm, which luckily it does. This is also one of the ways that C++ supports Wasm through the Clang compiler which is part of the LLVM project.</p>

<p>Rust installations are managed with the <code>rustup</code> tool which makes it easy to have different toolchains (nightly, beta, stable) as well as different targets installed simultaneously. The target triple for <code>wasm</code> is <code>wasm32-unknown-unknown</code>. The target triples have the form <code>&lt;arch&gt;-&lt;vendor&gt;-&lt;sys&gt;</code>, for example <code>x86_64-apple-darwin</code> is the default triple for a modern Macbook. The <code>unknown</code> vendor and system mean to use the defaults for the specific architecture. We can install this by running:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>rustup target add wasm32-unknown-unknown
</pre></div>

</figure>

<h3 id="leanpub-auto-the-smallest-wasm-library">The Smallest Wasm Library</h3>

<p>Let’s create a Wasm library that does absolute nothing but generate a Wasm library. We start off by creating a library with Cargo:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new --lib <code class="k">do</code>-nothing
</pre></div>

</figure>

<p>We need to specify that our library will be a C dynamic library as this is the type of compilation format that Wasm uses. Depending on the target architecture this is also how you would build a <code>.so</code> on Linux or <code>.dylib</code> on Mac OS. We do this by adding the <code>lib</code> section to our Cargo.toml:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">[package]</code>
<code class="lineno">2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"do-nothing"</code>
<code class="lineno">3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno">4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@eample.com&gt;"]</code>
<code class="lineno">5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">[lib]</code>
<code class="lineno">8 </code><code class="na">crate-type</code> <code class="o">=</code> <code class="s">["cdylib"]</code>
</pre></div>

</figure>

<p>We can then remove all of the code in <code>src/lib.rs</code> to leave a blank file. This technically is a Wasm library, just with no code. Let’s make a release build for the Wasm target:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo build --target wasm32-unknown-unknown --release
</pre></div>

</figure>

<p>By default, Cargo puts the build artifacts in <code>target/&lt;target-triple&gt;/&lt;mode&gt;/</code> or <code>target/&lt;mode&gt;</code> for the default target, which in this case is <code>target/wasm32-unknown-unknown/release</code>. Inside that directory, we have a <code>do_nothing.wasm</code> file which is our “empty” Wasm module. But how big is it:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>ls -lh target/wasm32-unknown-unknown/release/do_nothing.wasm
-rwxr-xr-x  <code class="m">2</code> led  staff   <code class="m">1</code>.4M Jul  <code class="m">8</code> <code class="m">21</code>:55 target/wasm32-unknown-unkn<code class="se">\</code>
own/release/do_nothing.wasm
</pre></div>

</figure>

<p>1.4M to do nothing! That’s insane! But it turns out it is because the output binary still includes debug symbols.</p>

<p>Stripping out debug symbols can be done with a tool called <code>wasm-strip</code> which is part of the <a href="https://github.com/WebAssembly/wabt">WebAssembly Binary Toolkit (WABT)</a>. The repository includes instructions on how to build that suite of tools. Assuming you have that installed somewhere on your path, we can run it to strip our binary:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>wasm-strip target/wasm32-unknown-unknown/release/do_nothing.wasm
</pre></div>

</figure>

<p>We can then check the size of our new binary:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>ls -lh target/wasm32-unknown-unknown/release/do_nothing.wasm
-rwxr-xr-x  <code class="m">2</code> led  staff   102B Jul  <code class="m">8</code> <code class="m">22</code>:01 target/wasm32-unknown-unkn<code class="se">\</code>
own/release/do_nothing.wasm
</pre></div>

</figure>

<p>A much more reasonable 102 bytes. We can make this better by running one more tool which is to actually optimize the binary, <code>wasm-opt</code> as part of the <a href="https://github.com/WebAssembly/binaryen">Binaryen library</a>. Again this repository has instructions for how to build and install this suite of tools. Running this against our binary requires us to specify a new file to put the output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>wasm-opt -o do_nothing_opt.wasm -Oz target/wasm32-unknown-unknown/relea<code class="se">\</code>
se/do_nothing.wasm
</pre></div>

</figure>

<p>Let’s check the size of this optimized binary:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>ls -lh do_nothing_opt.wasm
-rw-r--r--  <code class="m">1</code> led  staff    71B Jul  <code class="m">8</code> <code class="m">22</code>:04 do_nothing_opt.wasm
</pre></div>

</figure>

<p>We got down to 71 bytes. That is about as good as we can do. It is possible to manually shave a few more bytes off, but for all intents and purposes this is the baseline that we will build up from. This is incredibly small in the JavaScript ecosystem, but we are also not doing anything.</p>

<p>We are not going to spend too much time on optimizing the size of the Wasm binaries in subsequent things that we build, but it is important to use these tools for production use cases lest your binaries become unmanageable. We will point out certain features which dramatically increase binary size, but some of these are necessary for many applications.</p>

<h3 id="leanpub-auto-working-with-primatives">Working with primatives</h3>

<p>We are going to build upon our library that does nothing in small steps to understand how Wasm operates. The first step is to expose a function which only deals with primative values. Let’s create a new library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new --lib <code class="k">do</code>-addition
</pre></div>

</figure>

<p>Again we specify that we want our library to be a <code>cdylib</code> in Cargo.toml:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">[package]</code>
<code class="lineno">2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"do-addition"</code>
<code class="lineno">3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno">4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@example.com&gt;"]</code>
<code class="lineno">5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">[lib]</code>
<code class="lineno">8 </code><code class="na">crate-type</code> <code class="o">=</code> <code class="s">["cdylib"]</code>
</pre></div>

</figure>

<p>We expose a single function <code>add</code> which takes two unsigned integers and returns their sum as an unsigned integer:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="cp">#[no_mangle]</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">pub</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">add</code><code class="p">(</code><code class="n">a</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"> </code><code class="n">b</code>: <code class="kt">u32</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="kt">u32</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">3 </code><code class="w">    </code><code class="n">a</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">b</code><code class="w"></code>
<code class="lineno">4 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>#[no_mangle]</code> attribute tells the Rust compiler that we want the name of our function to be <code>add</code> in the final binary instead of some more complicated name that is auto-generated based on the name and types. Both Rust and C++ use name mangling for managing certain language features that are easier to implement if everything has a unique name. Usually you don’t have to worry about the exact name of your functions in the compiled executable, but because we are exposing a library which will be callable from JavaScript we need to know the actual name we need to call. Without this attribute, we would end up with something like <code>N15do_addition_4a3b56d3add3</code> as the name of the add function.</p>

<p>We also put the modifier <code>extern "C"</code> on the function to say that we want this function to use the right calling conventions that Wasm will understand. Otherwise this is just a simple publicly exposed Rust function.</p>

<p>To make the process of building things easier we show one possible build script which builds our crate and performs all of the optimization steps we talked about in the previous section:</p>

<figure class="code" dir="ltr">
  <figcaption>build.sh</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="ch">#!/bin/bash</code>
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code><code class="nv">WABT_BIN</code><code class="o">=</code><code class="nv">$HOME</code>/Code/wabt/bin
<code class="lineno"> 4 </code><code class="nv">BINARYEN_BIN</code><code class="o">=</code><code class="nv">$HOME</code>/Code/binaryen/bin
<code class="lineno"> 5 </code><code class="nv">TARGET</code><code class="o">=</code>wasm32-unknown-unknown
<code class="lineno"> 6 </code><code class="nv">NAME</code><code class="o">=</code>do_addition
<code class="lineno"> 7 </code><code class="nv">BINARY</code><code class="o">=</code>target/<code class="nv">$TARGET</code>/release/<code class="nv">$NAME</code>.wasm
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code>cargo build --target <code class="nv">$TARGET</code> --release
<code class="lineno">10 </code><code class="nv">$WABT_BIN</code>/wasm-strip <code class="nv">$BINARY</code>
<code class="lineno">11 </code>mkdir -p www
<code class="lineno">12 </code><code class="nv">$BINARYEN_BIN</code>/wasm-opt -o www/<code class="nv">$NAME</code>.wasm -Oz <code class="nv">$BINARY</code>
</pre></div>

</figure>

<p>We then make this script executable:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>chmod +x build.sh
</pre></div>

</figure>

<p>We can then build and optimize our Wasm module with <code>./build.sh</code>. Let’s check the size of our final binary in this first example where we are actually doing something:</p>

<p>$ ls -lh do_addition.wasm
-rw-r–r– 1 led staff 101B Jul 16 22:45 do_addition.wasm</p>

<p>We are up some small number of bytes from our function which did nothing, as expected, but at 101 bytes this is still quite small.</p>

<p>Let’s build up an HTML shell that will host our Wasm module and see our code working. The simplest thing is to have an HTML page which loads our Wasm code, uses it, and prints something to the JavaScript console:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="lineno"> 2 </code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"module"</code><code class="p">&gt;</code>
<code class="lineno"> 3 </code>  <code class="nx">async</code> <code class="kd">function</code> <code class="nx">init</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4 </code>    <code class="kr">const</code> <code class="p">{</code> <code class="nx">instance</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">WebAssembly</code><code class="p">.</code><code class="nx">instantiateStreaming</code><code class="p">(</code>
<code class="lineno"> 5 </code>      <code class="nx">fetch</code><code class="p">(</code><code class="s2">"./do_addition.wasm"</code><code class="p">)</code>
<code class="lineno"> 6 </code>    <code class="p">);</code>
<code class="lineno"> 7 </code>
<code class="lineno"> 8 </code>    <code class="kr">const</code> <code class="nx">answer</code> <code class="o">=</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">exports</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
<code class="lineno"> 9 </code>    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">answer</code><code class="p">);</code>
<code class="lineno">10 </code>  <code class="p">}</code>
<code class="lineno">11 </code>
<code class="lineno">12 </code>  <code class="nx">init</code><code class="p">();</code>
<code class="lineno">13 </code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We must use an <code>async</code> function as all Wasm code must be asynchronously loaded at the time of this writing. Most likely this will remain true going forward. We write a function <code>init</code> which encapsulates the things we want to do and then call that as the last thing we do in our script.</p>

<p>The WebAssembly module in JavaScript exposes APIs for working with Wasm files and types, but the easiest to use is <code>instantiateStreaming</code> which let’s us fetch our Wasm code and turn it into a module which we can interact with from JavaScript. This function returns a result object which contains an <code>instance</code> object and a <code>module</code> object. The module is useful if you want to share the compiled code with other contexts like Web Workers. For our purposes, we just care about the instance as it contains references to all the exported Wasm functions.</p>

<p>Our <code>add</code> function can be found as a property on the exports property of the instance object. Therefore, we can treat <code>instance.exports.add</code> like a JavaScript function which takes two integers and returns an integer, when really it is backed by native machine code generated from Rust.</p>

<p>Opening most browsers with this HTML page will not work because of browser restrictions on loading Wasm from local files. The easiest workaround is to serve your Wasm code and use that server to view your example. If you have Python installed on your system, you can run a simple server with:</p>

<p>&lt;&lt;&lt;<a href="code/intermediate/wasm/do-addition/serve.py">serve.py</a></p>

<p>Note the one change from the simplest Python file server is to explicitly set the MIME type for <code>.wasm</code> files. This makes sure browsers handle these files correctly.</p>

<p>We make this script executable as well:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>chmod +x serve.py
</pre></div>

</figure>

<p>And can then run it to serve our files:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>./serve.py
</pre></div>

</figure>

<p>Navigate to <code>http://localhost:8080/www</code> and look in the console to see Rust running in the browser:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>3
</pre></div>

</figure>

<p>That’s really all there is to it. The Rust compiler knows how to turn your Rust code into the Wasm format. The JavaScript engine in the browser knows how to load Wasm code. And, finally, there is some execution engine in the browser which an execute that Wasm code when called via the JavaScript interface. The one caveat is that the only Rust functions which are valid to expose to Wasm only deal with integers and floating point numbers.</p>

<h3 id="leanpub-auto-working-with-complex-types">Working with complex types</h3>

<p>Being limited to integers and floating point numbers might seem like a pretty severe limitation, but any complex type can be built on top of these primitives with some effort and hopefully help from some tools. In order to understand the tools that make this easy we are first going to go the hard route and manually expose functions that operate on strings. This is not intended for production use, but is to make the tools we will show in the next section less magical.</p>

<p>Let’s start by creating a new Rust library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new --lib hello-raw
</pre></div>

</figure>

<p>Again we make our crate generate a dynamic library:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">[package]</code>
<code class="lineno">2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"hello-raw"</code>
<code class="lineno">3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno">4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@example.com&gt;"]</code>
<code class="lineno">5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">[lib]</code>
<code class="lineno">8 </code><code class="na">crate-type</code> <code class="o">=</code> <code class="s">["cdylib"]</code>
</pre></div>

</figure>

<p>Our goal is to expose the function <code>greet</code> which takes a <code>&amp;str</code> as input and returns a new heap allocated <code>String</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">pub</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">greet</code><code class="p">(</code><code class="n">name</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">String</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"Hello, {}!"</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">)</code><code class="w"></code>
<code class="lineno">6 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Note that we make it public and specify the <code>extern "C"</code> modifier to ensure it has the right calling convention. However we did not specify <code>#[no_mangle]</code> because we are not going to call this directly and therefore we want Rust to mangle the name so that the wrapper that we do expose can use the name <code>greet</code>.</p>

<p>Webassembly does not understand <code>&amp;str</code> or <code>String</code> types, it can just take 0 or more numeric inputs and return a single numeric output. So we have to figure out how to turn <code>&amp;str</code> into 1 or more numeric inputs and <code>String</code> into a single numeric output. There are actually many different ways to do this, each with trade-offs, and we are going to demonstrate one approach.</p>

<p>So let’s instead write a greet function which takes two integers as input and returns one integer:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 8 </code><code class="cp">#[export_name = </code><code class="s">"greet"</code><code class="cp">]</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="k">pub</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">__greet_wrapper</code><code class="p">(</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="n">arg0_ptr</code>: <code class="o">*</code><code class="k">const</code><code class="w"> </code><code class="kt">u8</code><code class="p">,</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">arg0_len</code>: <code class="kt">usize</code><code class="p">,</code><code class="w"></code>
<code class="lineno">12 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="o">*</code><code class="k">mut</code><code class="w"> </code><code class="nb">String</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">arg0</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">unsafe</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">slice</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">std</code>::<code class="n">slice</code>::<code class="n">from_raw_parts</code><code class="p">(</code><code class="n">arg0_ptr</code><code class="p">,</code><code class="w"> </code><code class="n">arg0_len</code><code class="p">);</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">        </code><code class="n">std</code>::<code class="kt">str</code>::<code class="n">from_utf8_unchecked</code><code class="p">(</code><code class="n">slice</code><code class="p">)</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="p">};</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">_ret</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">greet</code><code class="p">(</code><code class="n">arg0</code><code class="p">);</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="nb">Box</code>::<code class="n">into_raw</code><code class="p">(</code><code class="nb">Box</code>::<code class="n">new</code><code class="p">(</code><code class="n">_ret</code><code class="p">))</code><code class="w"></code>
<code class="lineno">19 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>There is a lot going on in this code so we will go through it in detail but first let’s talk at a high level about what is going on. We have turned the string input into a pointer (which is just an integer) to the beginning of where the string lives in memory and the length of the string (also an integer). Inside the function we do some work to turn that input into a <code>&amp;str</code> which we then pass to our original <code>greet</code> function. We then do some work to take the <code>String</code> output of <code>greet</code> and turn it into a pointer which again is just an integer. So we have a function which only uses integer inputs and output but effectively exposes the higher level <code>greet</code> function we wrote that operates on strings.</p>

<p>Let’s get into the details by first discussing the input and output types of our wrapper function. Pointers are not common in most of Rust because you usually use references when sharing data. However, when working across FFI (Foreign Function Interface) boundaries, e.g. when talking to JavaScript, we use pointers directly as they are a concept shared on both sides. We take a pointer to a memory region containing bytes (a u8 value is just one byte) which represents a string and the length of that string. It is the responsibility of the caller to ensure that this pointer is valid and that the length is correct.</p>

<p>The return type is a pointer to a mutable String, i.e. a heap allocated String. Recall that String itself is already on the heap so this is an extra allocation. It is an implicit contract of our function that the caller is responsible for making sure that this pointer gets passed back to Rust at some point to clean up the memory on the heap. By returning a mutable pointer we are effectively saying you own this thing that we created because mutability in Rust comes from being the sole owner of an object. This is the same contract as our original <code>greet</code> function as the caller becomes the owner of the returned String. This concept is just a bit more implicit due to the FFI boundary.</p>

<p>The first step in our function is to take the pointer and length and turn it into a string slice, i.e. a <code>&amp;str</code>. This is inherently an unsafe operation as the compiler has no mechanism to verify that the pointer actually points to useful data or that the length is correct. We use an <code>unsafe</code> block to tell the compiler we know it cannot check this for us but we are guaranteeing that the relevant invariants are satisfied. The standard library provides a function <code>std::slice::from_raw_parts</code> which will give us a <code>&amp;[u8]</code>. This function is marked as unsafe which is why we have to call it inside an unsafe block.</p>

<p>The unsafe keyword does not turn off a lot of the checks the compiler does, but it does allow you to perform operations that it is impossible for it to verify. This definitely can lead to undefined behavior if you violate invariants you presumed to be satisfying.</p>

<p>Given that we have a <code>&amp;[u8]</code> we want to turn this into a <code>&amp;str</code> which is really just a fancy name for a <code>&amp;[u8]</code> which is also valid UTF-8. There are two mechanism for doing this <code>std::str::from_utf8</code> and <code>std::str::from_utf8_unchecked</code>. The former performs validity checks on the input to ensure that the passed in slice really is UTF-8. The latter just says trust me it is valid UTF-8 don’t bother checking. The former returns <code>Result&lt;&amp;str, Utf8Error&gt;</code> while the latter just returns <code>&amp;str</code>. We are therefore adding one more implicit contract to our exposed function, the pointer we get must be to a sequence of bytes, the length must match the length of that sequence, and the sequence of bytes must be valid UTF-8. If any of those are violated then undefined behavior can result.</p>

<p>We could have used the safe conversion method, but it is unclear what we would do in the failure scenario. One possible answer is to throw a JavaScript exception. We have chosen to make the implicit assumption of valid UTF-8 input, but that choice is up to you.</p>

<p>Now that we converted the input parts into a string slice we no longer have to do anything unsafe and can continue in normal, safe Rust. This is the canonical way to use unsafe code in Rust. Keep the block as small as possible to get back into safe Rust quickly. This makes auditing the code and understanding the necessary invariants much more manageable. If you run into strange behavior it is possible to focus your debugging efforts on what is going on in the unsafe blocks. If these are small and contained then at least you have a chance.</p>

<p>We proceed to call our original <code>greet</code> function to get the relevant String back. We then need to somehow give a pointer to this String to the caller and ensure that the underlying memory is not deallocated. We use <code>Box::new</code> to create a new heap allocation to hold the String. Note that the String is already on the heap by its nature, but we create a new heap allocation to own the String because we can keep the String alive if we can keep the <code>Box</code> alive as it becomes the owner of the String. We do this by using the associated function <code>Box::into_raw</code>. This function consumes the <code>Box</code> and returns exactly the raw pointer we want.</p>

<p>The documentation for <code>Box::into_raw</code> is clear that whoever gets this raw pointer is responsible for managing the memory and must do something to ensure the box gets destroyed when it is no longer needed, otherwise you will leak memory. Note that this is not unsafe, leaking memory is not unsafe just undesirable. The Rust compiler makes no guarantees about memory leaks and in fact you need to explicitly “leak” memory this way to accomplish some tasks. We will show later how we handle this and make sure that we clean up after ourselves. But it is important to note the underlying String is kept alive because the Box that owns the String is now owned by whoever called our function.</p>

<p>We will have more Rust to write, but in order to motivate it, let’s turn now to the JavaScript side of things. We also need to write something of a wrapper function in JavaScript as it would not be a nice API to have to figure out how to turn your JavaScript string into a pointer and a length. Rather we want our consumers to call a function with a string and get back a string and not even need be aware that there is Rust running underneath. Let’s write the <code>greet</code> function in JavaScript:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 9 </code>    <code class="kd">function</code> <code class="nx">greet</code><code class="p">(</code><code class="nx">arg0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10 </code>      <code class="kr">const</code> <code class="p">[</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">]</code> <code class="o">=</code> <code class="nx">passStringToWasm</code><code class="p">(</code><code class="nx">arg0</code><code class="p">);</code>
<code class="lineno">11 </code>      <code class="k">try</code> <code class="p">{</code>
<code class="lineno">12 </code>        <code class="kr">const</code> <code class="nx">retptr</code> <code class="o">=</code> <code class="nx">wasm</code><code class="p">.</code><code class="nx">greet</code><code class="p">(</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">);</code>
<code class="lineno">13 </code>        <code class="kr">const</code> <code class="nx">mem</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint32Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">14 </code>        <code class="kr">const</code> <code class="nx">rustptr</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code><code class="p">];</code>
<code class="lineno">15 </code>        <code class="kr">const</code> <code class="nx">rustlen</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code> <code class="o">+</code> <code class="mi">1</code><code class="p">];</code>
<code class="lineno">16 </code>        <code class="kr">const</code> <code class="nx">realRet</code> <code class="o">=</code> <code class="nx">getStringFromWasm</code><code class="p">(</code><code class="nx">rustptr</code><code class="p">,</code> <code class="nx">rustlen</code><code class="p">).</code><code class="nx">slice</code><code class="p">();</code>
<code class="lineno">17 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__boxed_str_free</code><code class="p">(</code><code class="nx">retptr</code><code class="p">);</code>
<code class="lineno">18 </code>        <code class="k">return</code> <code class="nx">realRet</code><code class="p">;</code>
<code class="lineno">19 </code>      <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
<code class="lineno">20 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__free</code><code class="p">(</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">);</code>
<code class="lineno">21 </code>      <code class="p">}</code>
<code class="lineno">22 </code>    <code class="p">}</code>
</pre></div>

</figure>

<p>This is much more complicated that our previous interaction with WebAssembly. The first step is to call a helper function that takes our input argument and turns it into the pointer and length that we can call our Wasm function with. We will define this shortly, but take it for granted for now but do know that this function puts the JavaScript string we took as an argument into the linear memory space shared between JavasScript and Wasm.</p>

<p>We setup a try/finally block to ensure that the string that was just moved into the Wasm memory always gets freed even if something funky happens while we are interacting with our exposed Wasm function. Inside the try block, we first call the greet function that we exposed with the pointer and length we got and declare a local variable to hold the pointer to the String we get back. This pointer points to a chunk of memory inside the Wasm linear memory region.</p>

<p>We can get a handle to the memory region shared with Wasm via the <code>buffer</code> property on the <code>memory</code> property that is exposed on our Wasm instance. The <code>memory</code> property is an instance of a <code>WebAssembly.Memory</code> object. This object can do two things, one is grow the memory region via a <code>grow</code> method, the other is give a handle to the underlying memory via the <code>buffer</code> property.</p>

<p>JavaScript has a variety of typed arrays for exposing an array-like view of an underlying buffer of binary data. We can construct an array which contains unsigned 32-bit integers (exactly what the 32-bit Wasm memory region is) by passing the Wasm buffer into the <code>Uint32Array</code> constructor. This is the fundamental concept for working with the shared memory region between JavaScript and Wasm. You create a typed array with the shared buffer and then read or write to this typed array. Wasm can also read and write this buffer so there be dragons here.</p>

<p>The pointer that is returned from the Wasm function is an offset from the beginning of the memory region, due to the return type and the fact that the array view over the memory buffer has type <code>Uint32</code> we need to do this little bit of arithmetic to get the array index for the pointer to the underlying bytes and the index of the length of the returned String. This works because in Rust a String is just a <code>Vec&lt;u8&gt;</code> and a <code>Vec&lt;u8&gt;</code> is a struct with two fields, the first being roughly a pointer to a buffer of <code>u8</code> values, and the second is a length. So we use that fact here to know that the pointer to the String is really a pointer to a buffer of bytes and a length.</p>

<p>Given a pointer to some bytes and a length, we use another utility function to extract a string from the Wasm memory region into JavaScript. We use <code>slice</code> to make a copy in JavaScript so we can safely tell Rust to free the memory it is currently using for that string. The following line where we call <code>__boxed_str_free</code> tells us that we need to implement this function over in Rust which will take a <code>*mut String</code> and do whatever is necessary to free it. This is how we hold up JavaScript’s end of the bargain to not leak memory.</p>

<p>Finally, we can return the JavaScript string that results from this whole process. No matter what happens in this whole process, if something goes wrong or not, the <code>finally</code> block will execute and free the memory in the Wasm address space associated with the argument. We used <code>passStringToWasm</code> to move the argument into the Wasm memory so we use <code>__free</code> to let it go. Again we see that we need to implement <code>__free</code> in Rust for this to work.</p>

<p>Before returning to Rust, let’s implement the two helpers we need in JavaScript. First, let’s take care of moving a JavaScript string into the Wasm memory region and returning a pointer into that region and a length:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">24 </code>    <code class="kd">function</code> <code class="nx">passStringToWasm</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">25 </code>      <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TextEncoder</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">).</code><code class="nx">encode</code><code class="p">(</code><code class="nx">arg</code><code class="p">);</code>
<code class="lineno">26 </code>      <code class="kr">const</code> <code class="nx">len</code> <code class="o">=</code> <code class="nx">buf</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
<code class="lineno">27 </code>      <code class="kr">const</code> <code class="nx">ptr</code> <code class="o">=</code> <code class="nx">wasm</code><code class="p">.</code><code class="nx">__malloc</code><code class="p">(</code><code class="nx">len</code><code class="p">);</code>
<code class="lineno">28 </code>      <code class="kd">let</code> <code class="nx">array</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint8Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">29 </code>      <code class="nx">array</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">buf</code><code class="p">,</code> <code class="nx">ptr</code><code class="p">);</code>
<code class="lineno">30 </code>      <code class="k">return</code> <code class="p">[</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">len</code><code class="p">];</code>
<code class="lineno">31 </code>    <code class="p">}</code>
</pre></div>

</figure>

<p>JavaScript provides an API for turning a string into a memory buffer via a <code>TextEncoder</code> object. We say that we want the string encoded as UTF-8 to conform to the invariants in our Rust code. We then ask our Wasm instance to allocate memory of this particular size via a call to <code>__malloc</code>. We will need to write this. Finally, we create a <code>Uint8Array</code> with the Wasm memory buffer so that we can set the newly allocated memory to the bytes of our string. We then return the pointer and length which is all that is needed to reference the string in the Wasm memory region.</p>

<p>Lastly, let’s write the function that will get us a JavaScript string out of the Wasm memory region:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">33 </code>    <code class="kd">function</code> <code class="nx">getStringFromWasm</code><code class="p">(</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">len</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">34 </code>      <code class="kr">const</code> <code class="nx">mem</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint8Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">35 </code>      <code class="kr">const</code> <code class="nx">slice</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">ptr</code> <code class="o">+</code> <code class="nx">len</code><code class="p">);</code>
<code class="lineno">36 </code>      <code class="kr">const</code> <code class="nx">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TextDecoder</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">).</code><code class="nx">decode</code><code class="p">(</code><code class="nx">slice</code><code class="p">);</code>
<code class="lineno">37 </code>      <code class="k">return</code> <code class="nx">ret</code><code class="p">;</code>
<code class="lineno">38 </code>    <code class="p">}</code>
</pre></div>

</figure>

<p>This is mostly the reverse process of putting the string into the memory region. We get a <code>Uint8Array</code> view of the Wasm memory and then use <code>slice</code> to copy the bytes into a new typed array specified by the starting and ending points. This <code>slice</code> method on typed arrays is semantically the same as the one on normal JavaScript arrays. Given this array of bytes we use a <code>TextDecoder</code> to turn it into a string, again assuming that the bytes represent a UTF-8 string.</p>

<p>Okay so if we expose <code>__malloc</code>, <code>__free</code>, and <code>__boxed_str_free</code> in our Rust library with the correct semantics then our Wasm module and our JavaScript code will work in concert to properly call a Rust function from JavaScript that takes a string and returns a string.</p>

<p>To support the implementation of memory allocation and deallocation functions, we pull in some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">alloc</code>::<code class="p">{</code><code class="n">alloc</code><code class="p">,</code><code class="w"> </code><code class="n">dealloc</code><code class="p">,</code><code class="w"> </code><code class="n">Layout</code><code class="p">};</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">mem</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s start with the hardest function and get progressively easier. First up then is <code>__malloc</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">21 </code><code class="cp">#[no_mangle]</code><code class="w"></code>
<code class="lineno">22 </code><code class="k">pub</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">__malloc</code><code class="p">(</code><code class="n">size</code>: <code class="kt">usize</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="o">*</code><code class="k">mut</code><code class="w"> </code><code class="kt">u8</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">align</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">mem</code>::<code class="n">align_of</code>::<code class="o">&lt;</code><code class="kt">usize</code><code class="o">&gt;</code><code class="p">();</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">layout</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Layout</code>::<code class="n">from_size_align</code><code class="p">(</code><code class="n">size</code><code class="p">,</code><code class="w"> </code><code class="n">align</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">        </code><code class="k">unsafe</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">layout</code><code class="p">.</code><code class="n">size</code><code class="p">()</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">ptr</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">alloc</code><code class="p">(</code><code class="n">layout</code><code class="p">);</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">ptr</code><code class="p">.</code><code class="n">is_null</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">                    </code><code class="k">return</code><code class="w"> </code><code class="n">ptr</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">                </code><code class="k">return</code><code class="w"> </code><code class="n">align</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="o">*</code><code class="k">mut</code><code class="w"> </code><code class="kt">u8</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">36 </code>
<code class="lineno">37 </code><code class="w">    </code><code class="n">panic</code><code class="o">!</code><code class="p">(</code><code class="s">"malloc failed"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">38 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>First the signature should be expected by now, we want this publicly accessible, we want it to use the “C” calling convention, and we want the name to be <code>__malloc</code> so we specify <code>#[no_mangle]</code>. We take a size as input (we use the byte length of our string) and return a pointer to some allocated bytes of that size.</p>

<p>Although you rarely have to deal with these low level APIs, as Rust is a systems language, it provides the facilities for working with memory layouts and proper alignment. The first thing we do is get the minimum alignment for a <code>usize</code> based on the ABI. We need this to pass to the Layout constructor because in order to allocate memory you need both a size and an alignment. Properly aligning our memory is necessary for a variety of reasons but suffice it to say that Rust takes care of this for us.</p>

<p>The next thing we do is generate a memory layout for the particular size and alignment. This can fail and return an error if the alignment is bad (zero or not a power of two) or if size is too big, otherwise this should succeed. Given our layout, we can then proceed to actually allocating memory. If the resulting size of the layout is not positive then we don’t need to allocate anything (and if fact calling alloc with a zero sized Layout could lead to undefined behavior depending on the architecture). In this case we just cast the alignment to the right type and return it as that is about all we can do.</p>

<p>Otherwise we have a real region of memory we need to allocate so we use the <code>alloc</code> function provided by the standard library. It is possible to customize the allocator used, but by default a standard one is used per platform. This is how the interaction with the allocator is exposed regardless. We get back a pointer from <code>alloc</code> which is the location of our newly allocated region of memory of the size and alignment specified by our layout. We only return this pointer if it is not null. A null pointer returned from <code>alloc</code> most likely means you are out of memory.</p>

<p>If we make it to the end of this function without having already returned something it means either the Layout failed to build or we are probably out of memory. There are a variety of things you could do in this scenario, calling panic is a reasonable one.</p>

<aside>
  <p>If you use any method that can panic in your Rust code, even if you definitely never panic, your Wasm module will increase quite a bit in size because of extra code related to panics. There are non-panicing alternatives to a lot of methods and there are other things you can do in these scenarios. It is possible to configure your code so that you are not allowed to panic, notably by using <code>no_std</code> which means disallowing anything from the <code>std</code> module, but that can be extreme (although necessary in some environments).</p>

</aside>

<p>Okay, we can allocate memory in the Wasm address space via an exposed function in Rust, let’s take care of deallocating memory:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">40 </code><code class="cp">#[no_mangle]</code><code class="w"></code>
<code class="lineno">41 </code><code class="k">pub</code><code class="w"> </code><code class="k">unsafe</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">__free</code><code class="p">(</code><code class="n">ptr</code>: <code class="o">*</code><code class="k">mut</code><code class="w"> </code><code class="kt">u8</code><code class="p">,</code><code class="w"> </code><code class="n">size</code>: <code class="kt">usize</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">size</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">        </code><code class="k">return</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">align</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">mem</code>::<code class="n">align_of</code>::<code class="o">&lt;</code><code class="kt">usize</code><code class="o">&gt;</code><code class="p">();</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">layout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Layout</code>::<code class="n">from_size_align_unchecked</code><code class="p">(</code><code class="n">size</code><code class="p">,</code><code class="w"> </code><code class="n">align</code><code class="p">);</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">    </code><code class="n">dealloc</code><code class="p">(</code><code class="n">ptr</code><code class="p">,</code><code class="w"> </code><code class="n">layout</code><code class="p">);</code><code class="w"></code>
<code class="lineno">48 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We take a pointer to the memory region we want to deallocate and the size of that region. If the size is zero then there is nothing to do. Otherwise we do the reverse of allocation, we get an alignment, use that to get a Layout, and then pass the pointer and the layout to <code>dealloc</code>. Note that our entire function is marked as <code>unsafe</code> as part of the signature rather than putting an unsafe block inside the function.</p>

<p>You can either expose a “safe” function which might do unsafe things internally, or you can say calling a function is inherently unsafe. The distinction is meant to imply who is responsible for the invariants. If you expose a safe function then you are responsible for making your invariants clear and usually handling the cases where they are not upheld. If you mark a function as unsafe, you are still responsible for making your invariants clear but you are saying that it is the responsibility of the caller to handle the bad cases. The exact lines are sometimes blurry. Should our greet wrapper function be unsafe rather than just using unsafe internally? Possibly, but we theoretically control the JavaScript code that is calling it and therefore think we can maintain the invariants.</p>

<p>Lastly, we need to implement <code>__boxed_str_free</code> to prevent leaking the String we return:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">50 </code><code class="cp">#[no_mangle]</code><code class="w"></code>
<code class="lineno">51 </code><code class="k">pub</code><code class="w"> </code><code class="k">unsafe</code><code class="w"> </code><code class="k">extern</code><code class="w"> </code><code class="s">"C"</code><code class="w"> </code><code class="k">fn</code> <code class="nf">__boxed_str_free</code><code class="p">(</code><code class="n">ptr</code>: <code class="o">*</code><code class="k">mut</code><code class="w"> </code><code class="nb">String</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">_b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Box</code>::<code class="n">from_raw</code><code class="p">(</code><code class="n">ptr</code><code class="p">);</code><code class="w"></code>
<code class="lineno">53 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We mark this function as unsafe for the same reason as <code>__free</code>. <code>Box::from_raw</code> is an unsafe function which takes a raw pointer and constructs a box from it. By creating this box and putting it into a local variable we ensure that the <code>Box</code> will be dropped at the end of the function body. When the Box is dropped, as it is the sole owner of the String, the String will also be dropped. The input type being <code>*mut String</code> is sufficient to tell Rust the right code to execute to drop both the Box and the String as this drives the type inference of <code>from_raw</code>.</p>

<p>With all of that out of the way, we can add the code to exercise our Wasm code from JavaScript:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">40 </code>    <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">greet</code><code class="p">(</code><code class="s2">"Rust"</code><code class="p">);</code>
<code class="lineno">41 </code>    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
</pre></div>

</figure>

<p>The full code listing for the JavaScript side is here which includes instantiating the Wasm module:</p>

<figure class="code" dir="ltr">
  <figcaption>www/index.html</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="lineno"> 2 </code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"module"</code><code class="p">&gt;</code>
<code class="lineno"> 3 </code>  <code class="nx">async</code> <code class="kd">function</code> <code class="nx">init</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4 </code>    <code class="kr">const</code> <code class="p">{</code> <code class="nx">instance</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">WebAssembly</code><code class="p">.</code><code class="nx">instantiateStreaming</code><code class="p">(</code>
<code class="lineno"> 5 </code>      <code class="nx">fetch</code><code class="p">(</code><code class="s2">"./hello_raw.wasm"</code><code class="p">)</code>
<code class="lineno"> 6 </code>    <code class="p">);</code>
<code class="lineno"> 7 </code>    <code class="kr">const</code> <code class="nx">wasm</code> <code class="o">=</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">exports</code><code class="p">;</code>
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code>    <code class="kd">function</code> <code class="nx">greet</code><code class="p">(</code><code class="nx">arg0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10 </code>      <code class="kr">const</code> <code class="p">[</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">]</code> <code class="o">=</code> <code class="nx">passStringToWasm</code><code class="p">(</code><code class="nx">arg0</code><code class="p">);</code>
<code class="lineno">11 </code>      <code class="k">try</code> <code class="p">{</code>
<code class="lineno">12 </code>        <code class="kr">const</code> <code class="nx">retptr</code> <code class="o">=</code> <code class="nx">wasm</code><code class="p">.</code><code class="nx">greet</code><code class="p">(</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">);</code>
<code class="lineno">13 </code>        <code class="kr">const</code> <code class="nx">mem</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint32Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">14 </code>        <code class="kr">const</code> <code class="nx">rustptr</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code><code class="p">];</code>
<code class="lineno">15 </code>        <code class="kr">const</code> <code class="nx">rustlen</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code> <code class="o">+</code> <code class="mi">1</code><code class="p">];</code>
<code class="lineno">16 </code>        <code class="kr">const</code> <code class="nx">realRet</code> <code class="o">=</code> <code class="nx">getStringFromWasm</code><code class="p">(</code><code class="nx">rustptr</code><code class="p">,</code> <code class="nx">rustlen</code><code class="p">).</code><code class="nx">slice</code><code class="p">();</code>
<code class="lineno">17 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__boxed_str_free</code><code class="p">(</code><code class="nx">retptr</code><code class="p">);</code>
<code class="lineno">18 </code>        <code class="k">return</code> <code class="nx">realRet</code><code class="p">;</code>
<code class="lineno">19 </code>      <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
<code class="lineno">20 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__free</code><code class="p">(</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">);</code>
<code class="lineno">21 </code>      <code class="p">}</code>
<code class="lineno">22 </code>    <code class="p">}</code>
<code class="lineno">23 </code>
<code class="lineno">24 </code>    <code class="kd">function</code> <code class="nx">passStringToWasm</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">25 </code>      <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TextEncoder</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">).</code><code class="nx">encode</code><code class="p">(</code><code class="nx">arg</code><code class="p">);</code>
<code class="lineno">26 </code>      <code class="kr">const</code> <code class="nx">len</code> <code class="o">=</code> <code class="nx">buf</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
<code class="lineno">27 </code>      <code class="kr">const</code> <code class="nx">ptr</code> <code class="o">=</code> <code class="nx">wasm</code><code class="p">.</code><code class="nx">__malloc</code><code class="p">(</code><code class="nx">len</code><code class="p">);</code>
<code class="lineno">28 </code>      <code class="kd">let</code> <code class="nx">array</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint8Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">29 </code>      <code class="nx">array</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">buf</code><code class="p">,</code> <code class="nx">ptr</code><code class="p">);</code>
<code class="lineno">30 </code>      <code class="k">return</code> <code class="p">[</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">len</code><code class="p">];</code>
<code class="lineno">31 </code>    <code class="p">}</code>
<code class="lineno">32 </code>
<code class="lineno">33 </code>    <code class="kd">function</code> <code class="nx">getStringFromWasm</code><code class="p">(</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">len</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">34 </code>      <code class="kr">const</code> <code class="nx">mem</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Uint8Array</code><code class="p">(</code><code class="nx">wasm</code><code class="p">.</code><code class="nx">memory</code><code class="p">.</code><code class="nx">buffer</code><code class="p">);</code>
<code class="lineno">35 </code>      <code class="kr">const</code> <code class="nx">slice</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="nx">ptr</code><code class="p">,</code> <code class="nx">ptr</code> <code class="o">+</code> <code class="nx">len</code><code class="p">);</code>
<code class="lineno">36 </code>      <code class="kr">const</code> <code class="nx">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TextDecoder</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">).</code><code class="nx">decode</code><code class="p">(</code><code class="nx">slice</code><code class="p">);</code>
<code class="lineno">37 </code>      <code class="k">return</code> <code class="nx">ret</code><code class="p">;</code>
<code class="lineno">38 </code>    <code class="p">}</code>
<code class="lineno">39 </code>
<code class="lineno">40 </code>    <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">greet</code><code class="p">(</code><code class="s2">"Rust"</code><code class="p">);</code>
<code class="lineno">41 </code>    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
<code class="lineno">42 </code>  <code class="p">}</code>
<code class="lineno">43 </code>
<code class="lineno">44 </code>  <code class="nx">init</code><code class="p">();</code>
<code class="lineno">45 </code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Similarly to the last section, we create a build script to handle creating the Wasm module:</p>

<figure class="code" dir="ltr">
  <figcaption>build.sh</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="ch">#!/bin/bash</code>
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code><code class="nv">WABT_BIN</code><code class="o">=</code><code class="nv">$HOME</code>/Code/wabt/bin
<code class="lineno"> 4 </code><code class="nv">BINARYEN_BIN</code><code class="o">=</code><code class="nv">$HOME</code>/Code/binaryen/bin
<code class="lineno"> 5 </code><code class="nv">TARGET</code><code class="o">=</code>wasm32-unknown-unknown
<code class="lineno"> 6 </code><code class="nv">NAME</code><code class="o">=</code>hello_raw
<code class="lineno"> 7 </code><code class="nv">BINARY</code><code class="o">=</code>target/<code class="nv">$TARGET</code>/release/<code class="nv">$NAME</code>.wasm
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code>cargo build --target <code class="nv">$TARGET</code> --release
<code class="lineno">10 </code><code class="nv">$WABT_BIN</code>/wasm-strip <code class="nv">$BINARY</code>
<code class="lineno">11 </code>mkdir -p www
<code class="lineno">12 </code><code class="nv">$BINARYEN_BIN</code>/wasm-opt -o www/<code class="nv">$NAME</code>.wasm -Oz <code class="nv">$BINARY</code>
</pre></div>

</figure>

<p>Again we make it executable:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>chmod +x build.sh
</pre></div>

</figure>

<p>We also need a server so we repeat the same Python server for convenience:</p>

<p>&lt;&lt;&lt;<a href="code/intermediate/wasm/hello-raw/serve.py">serve.py</a></p>

<p>We want to make it executable so that we can run it directly:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>chmod +x serve.py
</pre></div>

</figure>

<p>Run the server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>./serve.py
</pre></div>

</figure>

<p>Navigate to <code>http://localhost:8080/www</code> and look in the console to see:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>Hello, Rust!
</pre></div>

</figure>

<h3 id="leanpub-auto-the-real-way-to-write-wasm">The Real Way to Write Wasm</h3>

<p>Rust has been at the forefront of the development of WebAssembly and therefore there is a solid set of tools available for automating much of the tedious glue that we saw is necessary for working with complex types. The majority of the heavy lifting is done by the <a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a> crate and CLI. Built on top of wasm-bindgen is the <a href="https://rustwasm.github.io/docs/wasm-pack/introduction.html">wasm-pack</a> tool. This is a build tool which automates the process of exposing your Wasm module as an NPM module. The wasm-pack documentation has examples and templates for getting up and running with Wasm in the browser and in NodeJS environments. We are going to replicate our simple greet function but this time rely on these tools to do the work.</p>

<p>The first step is to install the <a href="https://rustwasm.github.io/wasm-pack/installer/">wasm-pack</a> CLI. This will be needed later on but is good to get out of the way because you may hit snags based on what is on your system. Currently, wasm-pack uses npm under the hood to handle certain tasks so you will need it installed as well.</p>

<p>Let’s create a Rust library to hold our Wasm code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cargo new --lib hello-bindgen
</pre></div>

</figure>

<p>As before we need to set our crate type to be a dynamic library, but now we are also going to be adding a dependency on the wasm-bindgen crate:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">[package]</code>
<code class="lineno"> 2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"hello-bindgen"</code>
<code class="lineno"> 3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno"> 4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@example.com&gt;"]</code>
<code class="lineno"> 5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">[lib]</code>
<code class="lineno"> 8 </code><code class="na">crate-type</code> <code class="o">=</code> <code class="s">["cdylib"]</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="k">[dependencies]</code>
<code class="lineno">11 </code><code class="na">wasm-bindgen</code><code class="o">=</code><code class="s">"^0.2"</code>
</pre></div>

</figure>

<p>Next we are going to write the greet function as before but this time we are going to use wasm-bindgen to help:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">wasm_bindgen</code>::<code class="n">prelude</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code>
<code class="lineno">3 </code><code class="cp">#[wasm_bindgen]</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">greet</code><code class="p">(</code><code class="n">name</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">String</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"Hello, {}!"</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">)</code><code class="w"></code>
<code class="lineno">6 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We import the items in the wasm-bindgen prelude so that the generated code has what it needs to work with. Then getting your code exposed to JavaScript is as simple as adding the <code>wasm_bindgen</code> attribute. Our greet function needs to be public to be exposed, but otherwise this is all the code we need to write.</p>

<p>Now we can use wasm-pack to build a JavaScript package that contains our compiled Wasm code with one simple command:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>wasm-pack build
</pre></div>

</figure>

<p>This will produce output in the <code>pkg</code> directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>hello-bindgen/pkg/
├── hello_bindgen.d.ts
├── hello_bindgen.js
├── hello_bindgen_bg.d.ts
├── hello_bindgen_bg.wasm
└── package.json
</pre></div>

</figure>

<p>This is a JavaScript package which can be used like any other but internally it uses Wasm. The easiest way to see that our function was exported as expected is to look at the generated TypeScript definition file:</p>

<figure class="code" dir="ltr">
  <figcaption>pkg/hello_bindgen.d.ts</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="cm">/* tslint:disable */</code>
<code class="lineno">2 </code><code class="cm">/**</code>
<code class="lineno">3 </code><code class="cm">* @param {string} name </code>
<code class="lineno">4 </code><code class="cm">* @returns {string} </code>
<code class="lineno">5 </code><code class="cm">*/</code>
<code class="lineno">6 </code><code class="kr">export</code> <code class="kd">function</code> <code class="nx">greet</code><code class="p">(</code><code class="nx">name</code>: <code class="kt">string</code><code class="p">)</code><code class="o">:</code> <code class="kt">string</code><code class="p">;</code>
</pre></div>

</figure>

<p>Now we need to have a JavaScript project that uses our package. We can use npm to create an application based on the wasm-app template:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>npm init wasm-app hello-bindgen-app
</pre></div>

</figure>

<p>This step is unnecessary if you are using the Wasm package in an existing JavaScript application, but for our purposes this is the most expedient path. We modify the package.json file to make our Wasm package a dependency:</p>

<figure class="code" dir="ltr">
  <figcaption>hello-bindgen-app/package.json</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">29 </code>  <code class="s2">"dependencies"</code><code class="err">:</code> <code class="p">{</code>
<code class="lineno">30 </code>    <code class="nt">"hello-bindgen"</code><code class="p">:</code> <code class="s2">"file:../pkg"</code>
<code class="lineno">31 </code>  <code class="p">}</code><code class="err">,</code>
<code class="lineno">32 </code>  <code class="s2">"devDependencies"</code><code class="err">:</code> <code class="p">{</code>
<code class="lineno">33 </code>    <code class="nt">"webpack"</code><code class="p">:</code> <code class="s2">"^4.29.3"</code><code class="p">,</code>
<code class="lineno">34 </code>    <code class="nt">"webpack-cli"</code><code class="p">:</code> <code class="s2">"^3.1.0"</code><code class="p">,</code>
<code class="lineno">35 </code>    <code class="nt">"webpack-dev-server"</code><code class="p">:</code> <code class="s2">"^3.1.5"</code><code class="p">,</code>
<code class="lineno">36 </code>    <code class="nt">"copy-webpack-plugin"</code><code class="p">:</code> <code class="s2">"^5.0.0"</code>
<code class="lineno">37 </code>  <code class="p">}</code>
</pre></div>

</figure>

<p>Then we edit index.js to load our package and call the greet function:</p>

<figure class="code" dir="ltr">
  <figcaption>hello-bindgen-app/index.js</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">wasm</code> <code class="nx">from</code> <code class="s2">"hello-bindgen"</code><code class="p">;</code>
<code class="lineno">2 </code>
<code class="lineno">3 </code><code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">wasm</code><code class="p">.</code><code class="nx">greet</code><code class="p">(</code><code class="s2">"Rust"</code><code class="p">);</code>
<code class="lineno">4 </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
</pre></div>

</figure>

<p>We need to use npm to install the dependencies needed to package and serve our code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>npm install
</pre></div>

</figure>

<p>Finally, we can use the bundled webpack dev server to view our code by running the start script that comes with the template we used:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>npm start
</pre></div>

</figure>

<p>Again we can navigate to <code>http://localhost:8080</code> and look in the console to see:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>Hello, Rust!
</pre></div>

</figure>

<h4 id="leanpub-auto-what-just-happened">What just happened?</h4>

<p>The wasm-bindgen crate generates some Rust code based on where you put the attribute. We annotated a function so the crate will generate a wrapper function that handles marshalling the complex data types, <code>&amp;str</code> and <code>String</code> in this case, into integers that Wasm can handle. Note that we did not say <code>extern "C"</code> on our greet function which is by design. As in our manual example, the actual greet function that is exposed ends up being a wrapper which calls into our original greet function which will get a mangled name.</p>

<p>You can put the <code>wasm_bindgen</code> attribute on structs, <code>impl</code> blocks, and a variety of other Rust items to expose them to JavaScript. The <a href="https://rustwasm.github.io/docs/wasm-bindgen/">wasm-bindgen docs</a> are a great source for understanding what and how things are exposed and what options you have.</p>

<p>The next step is that wasm-pack uses the wasm-bindgen CLI to generate JavaScript wrapper code based on items annotated with the <code>wasm_bindgen</code> attribute. The JavaScript glue code requires you to run an extra step outside of the normal Rust build process. The internals of the code generated by wasm-bindgen on the Rust side means that you really want to use wasm-bindgen to generate the JavaScript wrappers for you as well.</p>

<p>All of the generated code, either in Rust via the attribute, or in JavaScript via the CLI, is quite similar to what we did by hand in the previous section. For example, check out the generated JavaScript wrapper in <code>pkg/hello_bindgen.js</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>pkg/hello_bindgen.js</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 91 </code><code class="cm">/**</code>
<code class="lineno"> 92 </code><code class="cm">* @param {string} name</code>
<code class="lineno"> 93 </code><code class="cm">* @returns {string}</code>
<code class="lineno"> 94 </code><code class="cm">*/</code>
<code class="lineno"> 95 </code><code class="kr">export</code> <code class="kd">function</code> <code class="nx">greet</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 96 </code>    <code class="kr">const</code> <code class="nx">ptr0</code> <code class="o">=</code> <code class="nx">passStringToWasm</code><code class="p">(</code><code class="nx">name</code><code class="p">);</code>
<code class="lineno"> 97 </code>    <code class="kr">const</code> <code class="nx">len0</code> <code class="o">=</code> <code class="nx">WASM_VECTOR_LEN</code><code class="p">;</code>
<code class="lineno"> 98 </code>    <code class="kr">const</code> <code class="nx">retptr</code> <code class="o">=</code> <code class="nx">globalArgumentPtr</code><code class="p">();</code>
<code class="lineno"> 99 </code>    <code class="k">try</code> <code class="p">{</code>
<code class="lineno">100 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">greet</code><code class="p">(</code><code class="nx">retptr</code><code class="p">,</code> <code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code><code class="p">);</code>
<code class="lineno">101 </code>        <code class="kr">const</code> <code class="nx">mem</code> <code class="o">=</code> <code class="nx">getUint32Memory</code><code class="p">();</code>
<code class="lineno">102 </code>        <code class="kr">const</code> <code class="nx">rustptr</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code><code class="p">];</code>
<code class="lineno">103 </code>        <code class="kr">const</code> <code class="nx">rustlen</code> <code class="o">=</code> <code class="nx">mem</code><code class="p">[</code><code class="nx">retptr</code> <code class="o">/</code> <code class="mi">4</code> <code class="o">+</code> <code class="mi">1</code><code class="p">];</code>
<code class="lineno">104 </code>
<code class="lineno">105 </code>        <code class="kr">const</code> <code class="nx">realRet</code> <code class="o">=</code> <code class="nx">getStringFromWasm</code><code class="p">(</code><code class="nx">rustptr</code><code class="p">,</code> <code class="nx">rustlen</code><code class="p">).</code><code class="nx">slice</code><code class="p">();</code>
<code class="lineno">106 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__wbindgen_free</code><code class="p">(</code><code class="nx">rustptr</code><code class="p">,</code> <code class="nx">rustlen</code> <code class="o">*</code> <code class="mi">1</code><code class="p">);</code>
<code class="lineno">107 </code>        <code class="k">return</code> <code class="nx">realRet</code><code class="p">;</code>
<code class="lineno">108 </code>
<code class="lineno">109 </code>
<code class="lineno">110 </code>    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
<code class="lineno">111 </code>        <code class="nx">wasm</code><code class="p">.</code><code class="nx">__wbindgen_free</code><code class="p">(</code><code class="nx">ptr0</code><code class="p">,</code> <code class="nx">len0</code> <code class="o">*</code> <code class="mi">1</code><code class="p">);</code>
<code class="lineno">112 </code>
<code class="lineno">113 </code>    <code class="p">}</code>
<code class="lineno">114 </code>
<code class="lineno">115 </code><code class="p">}</code>
</pre></div>

</figure>

<p>This should look very familiar. Note that wasm-bindgen uses a slightly more complicated wrapper on the Rust side which requires a different calling convention in Wasm. In particular, note that the greet function takes a return pointer as the first argument and does not return anything. However both approaches achieve the same goal.</p>

<h3 id="leanpub-auto-other-wasm-topics">Other Wasm Topics</h3>

<p>WebAssembly is a broad topic with an increasing surface area. We will try to cover at a high level many of the common questions that arise when people first encounter Wasm.</p>

<h4 id="leanpub-auto-the-dom-and-friends">The DOM and friends</h4>

<p>As part of the wasm-bindgen project, there is the <a href="https://rustwasm.github.io/wasm-bindgen/api/web_sys/">web_sys</a> crate which exposes a large number of raw Web APIs. Manipulating the DOM is one thing that is possible using this crate.</p>

<h4 id="leanpub-auto-threads">Threads</h4>

<p>There is a <a href="https://github.com/WebAssembly/threads">proposal</a> to add threads to WebAssembly. As part of this proposal there are also ideas about atomics and other concepts necessary to make shared linear memory across threads manageable. There is a good summary <a href="https://rustwasm.github.io/2018/10/24/multithreading-rust-and-wasm.html">blog post</a> by Alex Crichton which breaks down a lot of the exciting details.</p>

<h4 id="leanpub-auto-webassembly-system-interface-wasi">WebAssembly System Interface (WASI)</h4>

<p>WebAssembly derives its security features from only having access to what it is explicitly given. That is, Wasm can be compiled to machine code but it cannot do things like open arbitrary sockets unless the system explicitly passes an instance the capability to do so. Today this is done via the JavaScript APIs available to Wasm code running in the browser. But there is an effort to run Wasm outside of the browser.</p>

<p>Outside the browser there is a real system to deal with. This leads to the question of portability of Wasm code across different systems that might want to execute the code. It also begs the question about how to handle safely support system calls like <code>open</code> for opening a file.</p>

<p>Wasm is an assembly language for a logical machine which can therefore be implemented virtually on any number of platforms. The WebAssembly System Interface, or WASI, is an attempt to standardize the system calls that Wasm knows about so that different implementations can build to a spec and therefore abstract the underlying operating system from the assembly language. This is being designed with portability and security as the paramount concerns. It is still in early days but it is a very exciting proposition.</p>



</div>,<div>
<h2 id="leanpub-auto-macros">Macros</h2>

<h3 id="leanpub-auto-overview">Overview</h3>

<p>Writing code that generates code is known as metaprogramming. Some languages have no native support for this, while others accomplish it textual substitution, and still others have the ability to operate on syntax as data. This last concept comes from Lisp and is called a macro. In short, a macro is a thing which takes code as input and produces code as output. Rust has a set of macro features depending on what you are trying to accomplish and how much work you want to undertake. These are:</p>

<ul>
  <li>declarative macros</li>
  <li>procedural custom derive macros</li>
  <li>procedural attribute macros</li>
  <li>procedural function-like macros</li>
</ul>

<p>Macros serve to reduce the amount of code you need to write, but it is important to understand that anything you can do with a macro you could have done by hand. There is nothing magic going on in the world of macros even if it sometimes feels otherwise. That is not to understate the enormous power of metaprogramming. Generating code can be a significant multiplier to your productivity and is absolutely the right tool for some jobs.</p>

<p>But, as always, with great power comes great responsibility. Code that generates code can be hard to understand, hard to change, and hard to debug. Frequently macros are not the right tool to reach for. If you can get away with using a function or some other abstraction mechanism for reducing repetition, then you should almost certainly use that instead of a macro.</p>

<p>There are two primary reasons to reach for a macro. The first is if you want a function with a variable number of arguments. The second reason is if you want to do something that must happen at compile time, like implement a trait. It is impossible to write a normal function that does either of these in regular Rust, but both can be accomplished with macros.</p>

<p>We are going to cover declarative macros in a limited fashion as they are the less powerful but better documented type of macros. If you can accomplish your task easily with a declarative macro, then fantastic. However, they can get hairy very quickly. Moreover, as we will see, the more powerful procedural macros are actually closer to writing regular Rust and are therefore more approachable for bigger problems.</p>

<h3 id="leanpub-auto-declarative-macros">Declarative Macros</h3>

<p>The name of this type of macro comes from the fact that the language used to implement these is a declarative style language inspired by Scheme. You can think of it as being similar to a big <code>match</code> statement where the conditions are matching on syntactic constructs and the result is the code you want to generate.</p>

<p>Rather than explain all the syntax and go through a bunch of boilerplate, let’s first just write a macro that is similar to something you have seen before. Suppose the standard library did not come with the <code>vec!</code> macro. We find ourselves writing code like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"></code>
<code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code><code class="w"></code>
<code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
<code class="kd">let</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">v</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>This starts to get tedious and it requires that weird <code>let v = v;</code> line to get an immutable binding to our vector after we are done filling it up. We could have instead put the creation code in a block such as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code><code class="w"></code>
<code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>In some ways that is a little better, but we still have a lot of repetition going on. Can we instead write some function that does this for us? That would look like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">make_vector</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>This implies this signature:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">make_vector</code><code class="p">(</code><code class="n">x0</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"> </code><code class="n">x1</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"> </code><code class="n">x2</code>: <code class="kt">i32</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="w"></code>
</pre></div>

</figure>

<p>That would work if we only wanted to create three elements vectors of type <code>i32</code>. It is easy to make the type more general by using a generic:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">make_vector</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="n">x0</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">x1</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">x2</code>: <code class="nc">T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"></code>
</pre></div>

</figure>

<p>But can we extend this to an arbitrary number of elements? Rust does not support functions with a variable number of arguments, commonly called variadic functions. There is no way to write a function in Rust that takes an unknown number of arguments. We could write out many similar functions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">make_vector_1</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="n">x0</code>: <code class="nc">T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">fn</code> <code class="nf">make_vector_2</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="n">x0</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">x1</code>: <code class="nc">T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">fn</code> <code class="nf">make_vector_3</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="n">x0</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">x1</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">x2</code>: <code class="nc">T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"></code>
<code class="p">...</code><code class="w"></code>
</pre></div>

</figure>

<p>Depending on your use case, like if you are constantly making only one size vector but you do it in a lot of places, then maybe that could work. But this certainly does not scale. Enter macros which execute at compile time and are therefore not bound by the same constraints as the rest of the Rust language.</p>

<p>Let’s implement this as a macro called <code>myvec</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="n">macro_rules</code><code class="o">!</code><code class="w"> </code><code class="n">myvec</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="p">(</code><code class="cp">$($x</code>:<code class="nc">expr</code><code class="p">),</code><code class="o">*</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">({</code><code class="w"></code>
<code class="lineno">3 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">4 </code><code class="w">        </code><code class="cp">$(</code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="cp">$x</code><code class="p">);)</code><code class="o">*</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">        </code><code class="n">v</code><code class="w"></code>
<code class="lineno">6 </code><code class="w">    </code><code class="p">});</code><code class="w"></code>
<code class="lineno">7 </code><code class="w">    </code><code class="p">(</code><code class="cp">$($x</code>:<code class="nc">expr</code><code class="p">,)</code><code class="o">*</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">(</code><code class="n">myvec</code><code class="o">!</code><code class="p">[</code><code class="cp">$($x</code><code class="p">),</code><code class="o">*</code><code class="p">])</code><code class="w"></code>
<code class="lineno">8 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The syntax for creating a macro is to invoke a macro called <code>macro_rules</code> (very meta) with the name of your new macro, <code>myvec</code> in this case, without the exclamation point, followed by braces to denote the body of the macro.</p>

<p>The body of a macro is just a series of rules with the left side of an arrow, <code>=&gt;</code>, indicating what pattern to match, and the right side specifying what code to generate. The patterns are checked in order from top to bottom, so they move from more specific to more general so that the specific patterns get a chance to match.</p>

<p>We have two possible match arms, let’s start by explaining the first one. <code>($($:expr),*)</code> The outer set of parentheses exists to denote the entire pattern. Inside we see <code>$($x:expr),*</code> which can be broken down into two parts. The inside <code>$x:expr</code> means to match a Rust expression and bind it to the variable <code>$x</code>. The outer part <code>$(...),*</code> means to match zero or more comma separated things inside the parentheses. So the total pattern means to match zero or more comma separated expressions, with each expression bound to the variable <code>$x</code>. We will see how that is possible to bind multiple expressions to a single name when we get to the right hand side.</p>

<p>The right hand side is surrounded by parentheses as well which signifies encloses the entirety of the code to generate. We then also have curly braces surrounding our code, these mean to literally generate a set of curly braces around our code so that we are actually outputting a block. If you did not have these then the macro would expand to just the literal lines of code. Sometimes that is what you want, but for us as we are going to use this macro as the right hand side of an assignment, we want it to expand to a single expression.</p>

<p>The macro definition grammar is a bit wild. As our first example of this, the outer parentheses can actually be any balanced bracket, i.e. <code>()</code>, <code>[]</code>, or <code>{}</code> are all acceptable in that position. So sometimes you might see <code>($($x:expr),*) =&gt; {{ ... }}</code> which still means to generate a single block, as the outer braces is just there so that the compiler knows where the right hand side begins and ends.</p>

<p>Then the rest of the right hand side looks just like the example code that we are replacing, except for the funky bit in middle. We are creating a vector, doing what looks kinda like our push, and then returning that vector. On the right hand side of a match inside a macro definition the syntax <code>$(...)*</code> means to repeat the code inside the parentheses for each repetition captured in the match arm. Within those parentheses the expression that we captured will be substituted directly for <code>$x</code>. It is in this way of expanding a repetition on the right that we get access to each of the repeated captures on the left.</p>

<p>The code inside that repetition <code>v.push($x);</code> is exactly what we were using before if you mentally replace <code>$x</code> with the different expressions that we pass to our macro.</p>

<p>From just what we have covered so far, we can understand that:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">myvec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">];</code><code class="w"></code>
</pre></div>

</figure>

<p>will expand to</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="w">  </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
<code class="w">  </code><code class="n">v</code><code class="w"></code>
<code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>which is exactly the code we saw earlier in our motivation to write this macro. What about if we wrote:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">myvec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,];</code><code class="w"></code>
</pre></div>

</figure>

<p>Note the trailing comma after the <code>3</code>. This is where the second match arm comes in. It turns out that the syntax in the first match arm <code>($(...),*)</code> implies matching a repetition of what is inside <code>$(...)</code> exactly separated by commas, i.e. without a trailing comma. Without the second part of our macro, having a trailing comma would be a syntax error as the first arm does not match and it is an error to have a macro without any arms that match.</p>

<p>Our second pattern <code>$($x:expr,)*</code> with the comma inside the repetition, <code>$(...)*</code>, means that we expect to see expressions followed by commas. This arm therefore only matches if we explicitly do have a trailing comma.</p>

<p>We use the right hand side to convert the trailing comma version to the version without a trailing comma and then rely on our previous pattern to match. We do this by recursively calling our macro and expanding <code>$($x:expr,)*</code> to <code>$($x),*</code>. Moving the comma from inside the repetition to outside means to take it from a list of expressions each followed by a comma to a list of expressions separated by commas.</p>

<p>With this little syntactic trampoline we get a macro which supports optional trailing commas. Rust generally supports trailing commas so your macros should too. It is a bit unfortunate that you need to go through this hoop for all macros to support both styles. Further, it is reasonable to feel like this syntax is weird and really not like the rest of Rust. You are correct. This declarative style of macro will probably be deprecated at some point in a future Rust version.</p>

<h4 id="leanpub-auto-expanding-a-macro">Expanding a macro</h4>

<p>Sometimes you think your macro is not quite working how you expect but you can’t quite tell why. It would be great if you could see what the macro expands into to see if the generated code is what you expect. Look no further than the <a href="https://github.com/dtolnay/cargo-expand">cargo expand</a> command. There are installation instructions on the Github repo for the project, but the short story is <code>cargo install cargo-expand</code> should allow you to then run <code>cargo expand</code> from the root of a crate to see all macros expanded out. This works for all types of macros including procedural macros which we will cover later.</p>

<p>You must have a nightly toolchain installed for the expansion to work. You just need it installed, you don’t have to be using it directly, the command will find it as needed as long as you have it installed. This can be accomplished using <code>rustup</code>.</p>

<p>Consider the following code in our <code>main.rs</code> that includes the <code>myvec</code> macro definition:</p>

<figure class="code" dir="ltr">
  <figcaption>main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">10 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">myvec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,];</code><code class="w"></code>
<code class="lineno">12 </code>
<code class="lineno">13 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">aa</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">,];</code><code class="w"></code>
<code class="lineno">14 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We can run <code>cargo expand</code> from the root of this crate to see:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#![feature(prelude_import)]</code><code class="w"></code>
<code class="cp">#[prelude_import]</code><code class="w"></code>
<code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">prelude</code>::<code class="n">v1</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="cp">#[macro_use]</code><code class="w"></code>
<code class="k">extern</code><code class="w"> </code><code class="k">crate</code><code class="w"> </code><code class="n">std</code><code class="p">;</code><code class="w"></code>
<code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="w">        </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"></code>
<code class="w">        </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code><code class="w"></code>
<code class="w">        </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code><code class="w"></code>
<code class="w">        </code><code class="n">v</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="mi">4</code><code class="p">);</code><code class="w"></code>
<code class="w">        </code><code class="n">v</code><code class="w"></code>
<code class="w">    </code><code class="p">};</code><code class="w"></code>
<code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">aa</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&lt;</code><code class="p">[</code><code class="n">_</code><code class="p">]</code><code class="o">&gt;</code>::<code class="n">into_vec</code><code class="p">(</code><code class="k">box</code><code class="w"> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">4</code><code class="p">]);</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We see our macro expands out to exactly what we expect based on walking through the code. For comparison we also include a call to the <code>vec!</code> macro which is in the standard library. This expands to calling an inherent method on the slice type that gets passed syntax for a boxed slice literal slice.</p>

<p>If you keep digging through the source you can eventually work out the entire implementation at play here. It only uses normal functions so there are no more macros hidden by this function call. This approach is technically more performant than what we are doing at the expense of a little clarity.</p>

<h4 id="leanpub-auto-more-information">More information</h4>

<p>The <a href="https://doc.rust-lang.org/1.30.0/reference/macros-by-example.html">Rust reference</a> has a section on “macros by example” which covers the grammar of this type of macro in more detail. In particular, besides expressions, you can match most of the other parts of Rust syntax like statements and types. There is also a good explanation for matching multiple related repeated items and how you can sort out that repetition.</p>

<p>For a more complex example, see <a href="https://blog.cloudflare.com/writing-complex-macros-in-rust-reverse-polish-notation/">this blog post</a> which provides an example of computing expressions in reverse polish notation at compile time using a declarative macro.</p>

<h3 id="leanpub-auto-procedural-macros">Procedural Macros</h3>

<p>Declarative macros were the original type of macro that one could write in stable Rust, but for a long time procedural macros were used internally in the compiler as well as in an unstable form with the nightly toolchain. As of Rust 1.30 this type of macro became available on stable.</p>

<p>There are three types of procedural macros:</p>

<ul>
  <li>Custom derive</li>
  <li>Attribute-like</li>
  <li>Function-like</li>
</ul>

<p>It is easier to see examples of these than to try to explain them theoretically. </p>

<h4 id="leanpub-auto-custom-derive">Custom derive</h4>

<p>First, custom derive means that you can create define a trait <code>MyCoolTrait</code> and write a macro that allows the following code to work:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(MyCoolTrait)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">SomeStruct</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>These means that <code>SomeStruct</code> will implement <code>MyCoolTrait</code> automatically by having the implementation generated at compile time. This works by sending the syntax of the item the derive is placed on to some code that you write which in turn returns new syntax which will be added to the source alongside the item. We will see an example of this when we write our own custom derive later.</p>

<h4 id="leanpub-auto-attribute-like">Attribute-like</h4>

<p>Attributes are the annotations on items inside the syntax <code>#[...]</code>. For example, <code>#[derive(Debug)]</code> is an attribute, it is the derive attribute which takes arguments. Unlike the custom derive macros which allow us to define how arguments to the derive attribute operator, we can instead create new attributes. One example we saw when working on building a web server was defining route information:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[get(</code><code class="s">"/lookup/{index}"</code><code class="cp">)]</code><code class="w"></code>
<code class="k">fn</code> <code class="nf">lookup</code><code class="p">(...)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>get</code> attribute is custom and is implemented via a procedural macro. This type of macro is a function that takes the arguments to the attribute as raw syntax as well as the item it is being defined on as syntax and then generates code. Attributes can go in a lot of different places, a lot more than where the derive attribute is valid, so these are a pretty powerful mechanism for extending the Rust syntax.</p>

<h4 id="leanpub-auto-function-like">Function-like</h4>

<p>This type of procedural macro is maybe less obvious as you might expect something like the following:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">sql</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">sql</code><code class="o">!</code><code class="p">(</code><code class="n">SELECT</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">FROM</code><code class="w"> </code><code class="n">users</code><code class="w"> </code><code class="n">WHERE</code><code class="w"> </code><code class="n">id</code><code class="o">=</code><code class="mi">4</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>This is a form of function-like procedural macro, however function-like macros are not currently stable in expression or statement position. It is expected that this will stabilize at some not too distant point in the future, but as of Rust 1.40 we still do not have this feature.</p>

<p>However, using the <a href="https://github.com/dtolnay/proc-macro-hack">proc-macro-hack</a> crate you can get function-like procedural macros in expression and statement positions. This is a hack because it requires creating a couple extra crates to get everything working.</p>

<p>The type of function-like procedural macro that you can do on stable today looks like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">gen_object</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">class</code><code class="w"> </code><code class="n">Foo</code>: <code class="nc">SomeThing</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">x</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">y</code>: <code class="nc">RefCell</code><code class="o">&lt;</code><code class="kt">i16</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>

<code class="w">  </code><code class="k">impl</code><code class="w"> </code><code class="n">Foo</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="p">...</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This means that <code>gen_object</code> takes all of the subsequent syntax as input and then generates new code to replace it.</p>

<p>We will concentrate on one type of procedural macro although the others use similar techniques so doing one should inform you quite a bit about all types of procedural macros.</p>

<h3 id="leanpub-auto-writing-a-custom-derive">Writing a custom derive</h3>

<p>Our goal for the remainder of this chapter is to implement a procedural macro that can be used as an argument to the derive attribute. The most important step in writing a macro is to know that you need one.</p>

<p>Primarily this happens when you find yourself writing repetitive, tedious code. You almost certainly need to write that code first however. If you jump straight to a macro, you are going to have a bad time when you try to figure out what exactly you want to generate. This is similar to our <code>myvec!</code> declarative macro above, where we first wrote out the code by hand for a particular example that we wanted to replace.</p>

<h4 id="leanpub-auto-motivation">Motivation</h4>

<p>The builder pattern is one of the classic “Gang of Four” design patterns that is typically thought of in the context of object-oriented code. However, it has a place elsewhere, and can be quite useful in some problem domains. The pattern separates construction from the actual representation of an object.</p>

<p>So instead of writing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">Item</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">b</code>: <code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">c</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>

<code class="kd">let</code><code class="w"> </code><code class="n">item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Item</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">a</code>: <code class="mi">42</code><code class="p">,</code><code class="w"> </code><code class="n">b</code>: <code class="nb">None</code><code class="p">,</code><code class="w"> </code><code class="n">c</code>: <code class="nb">String</code>::<code class="n">new</code><code class="p">(</code><code class="s">"foobar"</code><code class="p">)</code><code class="w"> </code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>we would write</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ItemBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">a</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">c</code><code class="p">(</code><code class="s">"foobar"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>We might not actually know the internal representation of <code>Item</code>, we just know the API of <code>ItemBuilder</code> and understand that we will get an <code>Item</code> after we call <code>build</code>. It is possible to provide some niceties like being able to pass a <code>&amp;str</code> to the method for <code>c</code> instead of having to create the <code>String</code> explicitly, and using a default <code>None</code> value for <code>b</code> if it is not otherwise specified.</p>

<p>You might want to keep the internal representation of your struct hidden and therefore not expose the fields for direct construction, but you also want to make constructing an object easy. We have used builders in other chapters, for example when building a network request with the <code>reqwest</code> library, we use a <code>RequestBuilder</code>.</p>

<p>Some advanced uses of the builder pattern in Rust are to implement a form of what is sometimes called the typestate pattern. Specifically, as it is possible to return different types from each method, we can ensure that certain constraints are satisfied at compile-time. An example is best to illustrate this, although we will keep things a bit contrived to focus on the design pattern.</p>

<p>Suppose we want to build a network request:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">url</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We require the URL to be set before the body but the token can be set at any time if it is set at all. We can only build a request if we have both a URL and a body. We start with a <code>RequestBuilder</code>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">RequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The entry point for our API is <code>RequestBuilder::new()</code>, then we only provide the methods which are valid to call. In particular, there is no <code>body</code> method because the body must be set after the URL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">impl</code><code class="w"> </code><code class="n">RequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">new</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">RequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">token</code>: <code class="nb">None</code> <code class="p">}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>

<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">token</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">token</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">token</code><code class="p">);</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>

<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">url</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">url</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">RequestWithUrlBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">RequestWithUrlBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">      </code><code class="n">url</code><code class="p">,</code><code class="w"></code>
<code class="w">      </code><code class="n">token</code>: <code class="nc">self</code><code class="p">.</code><code class="n">token</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We change the return type after the URL method because this moves us into a different conceptual state. This state is one where we know we have a URL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">RequestWithUrlBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">url</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Again we implement only the methods which are valid to be called in this state:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">impl</code><code class="w"> </code><code class="n">RequestWithUrlBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">token</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">token</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">token</code><code class="p">);</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>

<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">body</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">body</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">FullRequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">FullRequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">      </code><code class="n">url</code>: <code class="nc">self</code><code class="p">.</code><code class="n">url</code><code class="p">,</code><code class="w"></code>
<code class="w">      </code><code class="n">body</code><code class="p">,</code><code class="w"></code>
<code class="w">      </code><code class="n">token</code>: <code class="nc">self</code><code class="p">.</code><code class="n">token</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We move states to one with a known <code>url</code> and <code>body</code> by changing types again:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">FullRequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">url</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Finally, we can expose a <code>build</code> method which will get us the final request type we are trying to produce:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">impl</code><code class="w"> </code><code class="n">FullRequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">token</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">token</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">token</code><code class="p">);</code><code class="w"></code>
<code class="w">    </code><code class="bp">self</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>

<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">build</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">      </code><code class="n">url</code>: <code class="nc">self</code><code class="p">.</code><code class="n">url</code><code class="p">,</code><code class="w"></code>
<code class="w">      </code><code class="n">body</code>: <code class="nc">self</code><code class="p">.</code><code class="n">body</code><code class="p">,</code><code class="w"></code>
<code class="w">      </code><code class="n">token</code>: <code class="nc">self</code><code class="p">.</code><code class="n">token</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Given this API, we can build a request:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">req</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">RequestBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">url</code><code class="p">(</code><code class="s">"www.example.com"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">body</code><code class="p">(</code><code class="s">"foobar"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>and we can build one with a token:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">let</code><code class="w"> </code><code class="n">req</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">RequestBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">url</code><code class="p">(</code><code class="s">"www.example.com"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">token</code><code class="p">(</code><code class="s">"abc123"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">body</code><code class="p">(</code><code class="s">"foobar"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>Importantly, the following are compile-time errors:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">RequestBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">body</code><code class="p">(</code><code class="s">"foo"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">url</code><code class="p">(</code><code class="s">"www.example.com"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>

<code class="n">RequestBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">url</code><code class="p">(</code><code class="s">"www.example.com"</code><code class="p">)</code><code class="w"></code>
<code class="w">    </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>This pattern is pretty simple in this context, but it is merely a specific example of a much broader technique of embedding logic into the type system.</p>

<p>However, this type of complex builder is not needed that often. Frequently, you just have many structs with many default fields and just need builders for each. In this case it is annoying to have to write basically the same code for each struct you want a builder for. It would be nice if you could just “derive” all of the builder code from the definition of your struct.</p>

<h4 id="leanpub-auto-initial-setup-1">Initial setup</h4>

<p>We are writing a procedural macro and as of today this requires its own standalone crate. This crate has a specific type which the compiler treats specially to get all this to work. Therefore, let’s get started by having cargo create a new crate for us:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>cargo new builder
</pre></div>

</figure>

<p>We will add some dependencies to our manifest and also specify under the <code>lib</code> key that we are a <code>proc-macro</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">[package]</code>
<code class="lineno"> 2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"builder"</code>
<code class="lineno"> 3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno"> 4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;your.name@example.com&gt;"]</code>
<code class="lineno"> 5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">[lib]</code>
<code class="lineno"> 8 </code><code class="na">proc-macro</code> <code class="o">=</code> <code class="s">true</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="k">[dependencies]</code>
<code class="lineno">11 </code><code class="na">proc-macro2</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">12 </code><code class="na">quote</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">13 </code><code class="na">syn</code> <code class="o">=</code> <code class="s">{ version = "1.0", features = ["full"]}</code>
</pre></div>

</figure>

<p>The one <code>proc-macro = true</code> line is what tells the compiler to inject a specific dependency into your crate and also that your procedural macros that are exported can actually be used by other crates.</p>

<p>The compiler automatically exposes a library called <code>proc-macro</code> to your code as if it was a crate that you depend on. This is a bit quirky and has some negative consequences. Primarily the downside is that code that uses <code>proc-macro</code> can only execute in procedural macro contexts. This means that you cannot use tools for understanding Rust syntax in normal code unless it does not depend on <code>proc-macro</code>. Furthermore, you cannot unit test the <code>proc-macro</code> code.</p>

<p>A separate crate <code>proc-macro2</code> was created to fix these problems. The foundational crates for parsing Rust syntax, <code>syn</code>, and generating Rust syntax, <code>quote</code>, are written against the <code>proc-macro2</code> crate. Our basic plan is to write a macro with these tools, and then write some tiny amount of code to shuttle back and forth between the builtin <code>proc-macro</code> crate and <code>proc-macro2</code>.</p>

<h4 id="leanpub-auto-building-the-scaffold">Building the scaffold</h4>

<p>Looking at the source of many popular procedural macro crates you might be surprised to discover they are often implemented as a single <code>lib.rs</code> file. This is not necessary, nor universal, but it often is the case because procedural macros tend to have very specific and limited scope.</p>

<p>You might want to ask if your macro really needs to be doing everything you have it doing if you find yourself breaking things up too much. On the other hand, if you are building something like <a href="https://serde.rs/">serde</a> then you can benefit quite a bit from modularity.</p>

<p>Our macro will not have much configuration or other extra bits so a single <code>lib.rs</code> file works quite well. Let’s get started with the imports that will make our lives easier:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">extern</code><code class="w"> </code><code class="k">crate</code><code class="w"> </code><code class="n">proc_macro</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">proc_macro</code>::<code class="n">TokenStream</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">quote</code>::<code class="n">quote</code><code class="p">;</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fmt</code><code class="p">;</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parenthesized</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parse</code>::<code class="nb">Result</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="n">SynResult</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The first line might be a surprise as the 2018 edition did away with the need for <code>extern crate</code> declarations. However, as of this writing because <code>proc_macro</code> is a builtin crate, you must still use the <code>extern crate</code> syntax. This is because the compiler looks in your manifest to resolve crate references but you can’t put <code>proc_macro</code> as a normal dependency in the manifest because it isn’t normal. Now you don’t have to use <code>extern crate</code> with <code>std</code> but <code>proc_macro</code> did not get that special treatment. There is an unused <code>meta</code> crate that is automatically included that might replace <code>proc_macro</code> in the future, but not today.</p>

<p>Let’s write the public interface to our library:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 9 </code><code class="cp">#[proc_macro_derive(Builder, attributes(builder))]</code><code class="w"></code>
<code class="lineno">10 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">builder_derive</code><code class="p">(</code><code class="n">input</code>: <code class="nc">TokenStream</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">TokenStream</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">ast</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parse</code><code class="p">(</code><code class="n">input</code><code class="p">).</code><code class="n">expect</code><code class="p">(</code><code class="s">"Could not parse type to derive \</code>
<code class="lineno">12 </code><code class="s">Builder for"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">13 </code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">impl_builder_macro</code><code class="p">(</code><code class="n">ast</code><code class="p">)</code><code class="w"></code>
<code class="lineno">15 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is the entirety of what is exported by our library. Before turning to the overall structure of this function and what the attribute means, let’s look at the implementation. We call <code>syn::parse</code> to turn the input into a data structure representing the AST (Abstract Syntax Tree) of the item we are defined on. We then pass that to our real implementation, <code>impl_builder_macro</code> which we will get to later. The type signature of <code>impl_builder_macro</code> along with type inference is what tells <code>syn::parse</code> what type to turn our input into.</p>

<p>Here and throughout this chapter, the <a href="https://docs.rs/syn/1.0/syn/index.html">docs for the syn
crate</a> will be an invaluable resource. The it can be a bit daunting to try to figure out what types are possible as parts of the syntax as you tear it down and build it back up. The docs are very thorough and can help give you a grasp on the complexity of Rust syntax.</p>

<p>This is the highest level of protection against syntax errors as we use <code>expect</code> to panic if we can’t parse the input. It is common to panic or use the <code>compile_error</code> macro in procedural macros. This is because the code is executing at compile time so causing a panic is sometimes the only thing you can do to stop the compilation process when you cannot proceed. This is not runtime code so some of the normal rules do not apply.</p>

<p>As a further note along this line, we are operating very early in the compilation process. This is before type checking and before a lot of other compiler passes. We only have very basic information at the syntax level, we have no semantic information. For example, this means there is no way to say do something special if a type implements a trait. You are only give the literal tokens that make up the syntax of the source code. You can do a lot with this, but remember that this is nowhere near as much information as the full compilation process works with.</p>

<p>Let’s break down the function a little bit more by looking at the <code>proc_macro_derive</code> attribute. This attribute takes the name of the derive as the first argument which is <code>Builder</code> in our case. This makes it so we can write:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The second argument to <code>proc_macro_derive</code> is optional and defines helper attributes. The syntax here is to write <code>attributes(...)</code> with a comma separated list of attributes that we want to define inside the parentheses. We are defining a single attribute, <code>builder</code>, so that we can write:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="cp">#[builder]</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="n">x</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We are going to use a slightly more complicated form of that attribute when we get around to defining how we will handle it. But to cover the general case here, attributes can take arguments if you want them to or not. So you might also see:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="cp">#[builder(foo, bar=32)]</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="n">x</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>It is up to the implementation of the macro to decide what the attribute means and whether arguments mean anything. We will get the raw syntax and have to decide what to do with it. It might not be immediately obvious but even though we are declaring the name of an attribute here, all macros get access to all attributes. Therefore, other macros will see our attributes, they typically just choose to ignore them. You have to declare them like this to inform the compiler that such an attribute is not a syntax error.</p>

<p>The function <code>builder_derive</code> has the signature <code>(TokenStream) -&gt; TokenStream</code> which is the form that every custom derive must implement. The input is the item that the derive is defined on and the return value is appended to the module or block where that item is defined. In other words,</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="cp">#[builder(foo, bar=32)]</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="n">x</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>effectively becomes</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">Request</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="n">x</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="p">...</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>

<code class="c1">// output from builder_derive(...) as syntax</code>
</pre></div>

</figure>

<p>Custom attribute macros have a signature of <code>(TokenStream, TokenStream) -&gt; TokenStream</code> where the first argument is the arguments to the attribute itself and the second attribute is the item the attribute is on. The return value replaces the item with an arbitrary number of items. For example,</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[get(</code><code class="s">"/"</code><code class="cp">)]</code><code class="w"></code>
<code class="k">fn</code> <code class="nf">foobar</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>means that there is a procedural macro that defines a function <code>get</code> which will receive the token stream representing <code>("/")</code> as its first argument, and the token stream representing <code>fn foobar() {}</code> as its second argument. The token stream output from that function will replace all of that code.</p>

<p>Function-like procedural macros have the same signature as a derive macro, <code>(TokenStream) -&gt; TokenStream</code>, where the input is the entirety of the macro invocation, but instead of getting appended to the module the token stream that is returned replaces the input at the same location in the source.</p>

<p>Besides using different attributes to mark the exported function that is about all the extra information you need to know to implement these other types of procedural macros after we work our way through a custom derive.</p>

<p>Let’s get back to our implementation by writing the <code>impl_builder_macro</code> function we referenced earlier:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">16 </code><code class="k">fn</code> <code class="nf">impl_builder_macro</code><code class="p">(</code><code class="n">ty</code>: <code class="nc">syn</code>::<code class="n">DeriveInput</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">TokenStream</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">parse_builder_information</code><code class="p">(</code><code class="n">ty</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">info</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">info</code><code class="p">.</code><code class="n">into</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">        </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">to_compile_errors</code><code class="p">(</code><code class="n">e</code><code class="p">).</code><code class="n">into</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">21 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The point of this function is to move into the world of <code>proc_macro2</code> by passing the <code>syn</code> input into a function which only operates in this other world. We then use an <code>into</code> implementation of a type we will write soon to convert back into the <code>proc_macro</code> world which we then use to return the expected <code>TokenStream</code> back up. Note that the <code>proc_macro2::TokenStream</code> type implements the <code>Into</code> trait to get a <code>proc_macro::TokenStream</code> so we expect to get <code>proc_macro2::TokenStream</code> values that we just need to call <code>into</code> on.</p>

<h4 id="leanpub-auto-friendly-error-handling">Friendly error handling</h4>

<p>We are also converting to the more standard style of using result style error propagation by handling the transformation of an error into something that the procedural macro system can work with. We do that by writing the <code>to_compile_errors</code> function that we will see next:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">23 </code><code class="k">fn</code> <code class="nf">to_compile_errors</code><code class="p">(</code><code class="n">errors</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">proc_macro2</code>::<code class="n">TokenStre</code><code class="err">\</code><code class="w"></code>
<code class="lineno">24 </code><code class="n">am</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">compile_errors</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">errors</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="n">syn</code>::<code class="n">Error</code>::<code class="n">to_compile_error</code><code class="err">\</code><code class="w"></code>
<code class="lineno">26 </code><code class="p">);</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="err">#</code><code class="p">(</code><code class="err">#</code><code class="n">compile_errors</code><code class="p">)</code><code class="o">*</code><code class="w"> </code><code class="p">}</code><code class="w"></code>
<code class="lineno">28 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We assume that our errors come as a vector of <code>syn::Error</code>s which are the expected type of errors we will encounter. That is, we are going to mostly be running into syntax errors. One nice feature of <code>syn</code> is the associated function <code>syn::Error::to_compile_error</code> which converts the error type into a nice diagnostic error which the compiler will understand when returned as a token stream.</p>

<p>This is our first place where we are actually generating code. The <code>quote!</code> macro uses a syntax similar to the <code>macro_rules</code> macro for generating code, except it interpolates variables using the syntax <code>#variable</code>. This interpolation requires the variable to implement the <code>ToTokens</code> trait.</p>

<p>In our case we are interpolating the <code>compile_errors</code> variable. However this variable is an iterator. Therefore, like in declarative macros, we use the <code>#(...)*</code> syntax to generate code for each element in the <code>compile_errors</code> iterator.</p>

<p>The output of the <code>quote!</code> macro is the interpolated syntax as a <code>proc_macro2::TokenStream</code>. The inside of the macro in this case is just an interpolation, but it can be arbitrary Rust syntax. We will see this more later, but one nicety of procedural macros is that you can just write normal Rust with some interpolations rather than the more complicated syntax construction of a declarative macro.</p>

<p>As our error function expects a vector of errors we declare a type alias to make the corresponding Result type easier to write:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">28 </code><code class="k">type</code> <code class="nc">MultiResult</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">std</code>::<code class="n">result</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Error</code><code class="o">&gt;&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Furthermore, we define a struct to make working with a vector of errors a little easier:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">52 </code><code class="cp">#[derive(Debug, Default)]</code><code class="w"></code>
<code class="lineno">53 </code><code class="k">struct</code> <code class="nc">SyntaxErrors</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">    </code><code class="n">inner</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">55 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The advantage of doing this is to implement the following helper functions:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">57 </code><code class="k">impl</code><code class="w"> </code><code class="n">SyntaxErrors</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">add</code><code class="o">&lt;</code><code class="n">D</code><code class="p">,</code><code class="w"> </code><code class="n">T</code><code class="o">&gt;</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">tts</code>: <code class="nc">T</code><code class="p">,</code><code class="w"> </code><code class="n">description</code>: <code class="nc">D</code><code class="p">)</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">    </code><code class="k">where</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">        </code><code class="n">D</code>: <code class="nc">fmt</code>::<code class="n">Display</code><code class="p">,</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">        </code><code class="n">T</code>: <code class="nc">quote</code>::<code class="n">ToTokens</code><code class="p">,</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">    </code><code class="p">{</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">inner</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">syn</code>::<code class="n">Error</code>::<code class="n">new_spanned</code><code class="p">(</code><code class="n">tts</code><code class="p">,</code><code class="w"> </code><code class="n">description</code><code class="p">));</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">65 </code>
<code class="lineno">66 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">extend</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">errors</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">inner</code><code class="p">.</code><code class="n">extend</code><code class="p">(</code><code class="n">errors</code><code class="p">);</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">69 </code>
<code class="lineno">70 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">finish</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">MultiResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">71 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">inner</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">            </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">74 </code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="bp">self</code><code class="p">.</code><code class="n">inner</code><code class="p">)</code><code class="w"></code>
<code class="lineno">75 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">76 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">77 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We create an <code>add</code> method which appends a single error to our vector. This uses generic types to accept anything that can be turned into tokens along with anything that can be nicely printed as the description. The <code>new_spanned</code> function uses the token trees, <code>tts</code>, input to capture source information to information the compiler where to draw errors when printing the error out.</p>

<p>A span in the Rust compiler is effectively a region of source code. You can think of it as a start and end position used to draw the arrows and lines in the compiler error messages. It can get more complicated than that as you might know if you have ever seen the nice diagrams that come out with borrow checker errors. But for our purposes you can think of it has a region of source code. Each piece of syntax defines a span so usually you can bootstrap a span if you have some input tokens.</p>

<p>Getting this right is sometimes a bit of an art and can really make your macro maddeningly hard to use or delightful. The goal is to inform the compiler as much as possible as to what syntax is causing the problem and to describe as best as you can how to fix it. The worst scenario is when the error just points at <code>#[derive(Builder)]</code> and has some opaque message.</p>

<p>The <code>extend</code> method is self-explanatory. The <code>finish</code> method consumes this wrapper struct to return a value of our <code>MultiResult</code>. The consequence of this is that you can use the <code>?</code> operator after calling finish to report as many errors as you can diagnose at once. This is another nice feature for your users. It is great if you can discover multiple errors at once so they can fix them all rather than having to fix one only to find out there are more lurking under the covers. Sometimes it is not possible or desirable to find all errors up front, but when you can you should. This vector of errors makes it possible.</p>

<h4 id="leanpub-auto-getting-into-the-parser">Getting into the parser</h4>

<p>Okay, we have our error infrastructure in place. Now we can write our next helper function which takes the <code>syn</code> input and returns a result with our builder code or a vector of errors:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">30 </code><code class="k">fn</code> <code class="nf">parse_builder_information</code><code class="p">(</code><code class="n">ty</code>: <code class="nc">syn</code>::<code class="n">DeriveInput</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">MultiResult</code><code class="o">&lt;</code><code class="n">Build</code><code class="err">\</code><code class="w"></code>
<code class="lineno">31 </code><code class="n">erInfo</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">spanned</code>::<code class="n">Spanned</code><code class="p">;</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Data</code><code class="p">;</code><code class="w"></code>
<code class="lineno">34 </code>
<code class="lineno">35 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">span</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ty</code><code class="p">.</code><code class="n">span</code><code class="p">();</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">syn</code>::<code class="n">DeriveInput</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">        </code><code class="n">ident</code><code class="p">,</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="n">generics</code><code class="p">,</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">        </code><code class="n">data</code><code class="p">,</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="n">attrs</code><code class="p">,</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">        </code><code class="p">..</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ty</code><code class="p">;</code><code class="w"></code>
<code class="lineno">43 </code>
<code class="lineno">44 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">data</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">        </code><code class="n">Data</code>::<code class="n">Struct</code><code class="p">(</code><code class="n">struct_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">parse_builder_struct</code><code class="p">(</code><code class="n">struct_</code><code class="p">,</code><code class="w"> </code><code class="n">ident</code><code class="p">,</code><code class="w"> </code><code class="n">g</code><code class="err">\</code><code class="w"></code>
<code class="lineno">46 </code><code class="n">enerics</code><code class="p">,</code><code class="w"> </code><code class="n">attrs</code><code class="p">,</code><code class="w"> </code><code class="n">span</code><code class="p">),</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="n">syn</code>::<code class="n">Error</code>::<code class="n">new</code><code class="p">(</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">            </code><code class="n">span</code><code class="p">,</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">            </code><code class="s">"Can only derive `Builder` for a struct"</code><code class="p">,</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="p">)]),</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">52 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The first line brings the <code>Spanned</code> trait into scope so that we can call the <code>span</code> method on our input. We destructure the <code>syn::DeriveInput</code> type into the specific constituent parts that we care about. Specifically, we match the data field against the <code>syn::Data</code> enum to see if the item we are defined on is a struct.</p>

<p>The entire purpose of this function is to ensure that we are being derived on a struct and not on an enum or any other possible item. If we are not being derived on a struct then we create an error and stop here. Otherwise, we pass the pieces of data that we have gathered on to yet another helper function.</p>

<p>Let’s turn now to the <code>BuilderInfo</code> type we see in our type signature:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">79 </code><code class="k">struct</code> <code class="nc">BuilderInfo</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">80 </code><code class="w">    </code><code class="n">name</code>: <code class="nc">syn</code>::<code class="n">Ident</code><code class="p">,</code><code class="w"></code>
<code class="lineno">81 </code><code class="w">    </code><code class="n">generics</code>: <code class="nc">syn</code>::<code class="n">Generics</code><code class="p">,</code><code class="w"></code>
<code class="lineno">82 </code><code class="w">    </code><code class="n">fields</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Ident</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Type</code><code class="p">,</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">BuilderAttribute</code><code class="o">&gt;</code><code class="p">)</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">83 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is all of the information we need from the parsed AST to be able to generate the code we want. We have the name of the type as an <code>syn::Ident</code>, we have the declaration of any generics from the type, and lastly we have a vector of fields. We will get to <code>BuilderAttribute</code> next, but as an example consider:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Item</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">where</code><code class="w"></code>
<code class="w">  </code><code class="n">T</code>: <code class="nb">Default</code>
<code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">b</code>: <code class="nc">T</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="cp">#[builder(required)]</code><code class="w"></code>
<code class="w">  </code><code class="n">c</code>: <code class="nc">U</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Here name is <code>Item</code>, the generics field captures <code>&lt;T, U&gt; where T: Default</code>, and fields contains <code>a: u32</code>, <code>b: T</code>, and <code>#[builder(required)] c: U</code>. Each of those are wrapped in a suitable data structure that both captures this syntax as well as information about where it lives in the source. The fields vector contains a tuple of identifier, type, and attributes so for example <code>a: u32</code> would be something like <code>(Some(a), u32, vec![])</code>. We will see how this exactly plays out later, but this should give you an idea of what this structure holds.</p>

<h4 id="leanpub-auto-handling-attributes">Handling attributes</h4>

<p>We turn now to <code>BuilderAttribute</code> which is an enum defining all of the attributes we support. We are only going to support one variant but this should elucidate how you can manage multiple attributes.</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">247 </code><code class="k">enum</code> <code class="nc">BuilderAttribute</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">248 </code><code class="w">    </code><code class="n">Required</code><code class="p">(</code><code class="n">proc_macro2</code>::<code class="n">TokenStream</code><code class="p">),</code><code class="w"></code>
<code class="lineno">249 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is going to capture the attribute:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[builder(required)]</code><code class="w"></code>
</pre></div>

</figure>

<p>The meaning of this attribute is to specify that a field must be set as part of the build process and therefore a default value should not be used. For simplicity, we are going to enforce this by causing a panic if the field is not set. For fields not marked required, we will assume the type of the field implements the <code>Default</code> trait. For a different use case you might want to flip this assumption and make everything required and only make things default if they are explicitly marked. Or you could do something more complicated that combines these two extremes.</p>

<p>As we said we only have one attribute that we care about, but we are going to go through the trouble of handling a list of attributes for explanatory purposes. Thus, we define <code>BuilderAttributeBody</code> to be a collection of <code>BuilderAttribute</code>s. We then implement the <code>Parse</code> trait from <code>syn</code> for this type. Implementing this trait is how to work custom logic into the work that <code>syn</code> does.</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">268 </code><code class="k">struct</code> <code class="nc">BuilderAttributeBody</code><code class="p">(</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">BuilderAttribute</code><code class="o">&gt;</code><code class="p">);</code><code class="w"></code>
<code class="lineno">269 </code>
<code class="lineno">270 </code><code class="k">impl</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parse</code>::<code class="n">Parse</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">BuilderAttributeBody</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">271 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">parse</code><code class="p">(</code><code class="n">input</code>: <code class="nc">syn</code>::<code class="n">parse</code>::<code class="n">ParseStream</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">SynResult</code><code class="o">&lt;</code><code class="n">Self</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">272 </code><code class="w">        </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">punctuated</code>::<code class="n">Punctuated</code><code class="p">;</code><code class="w"></code>
<code class="lineno">273 </code><code class="w">        </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">token</code>::<code class="n">Comma</code><code class="p">;</code><code class="w"></code>
<code class="lineno">274 </code>
<code class="lineno">275 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">inside</code><code class="p">;</code><code class="w"></code>
<code class="lineno">276 </code><code class="w">        </code><code class="n">parenthesized</code><code class="o">!</code><code class="p">(</code><code class="n">inside</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">input</code><code class="p">);</code><code class="w"></code>
<code class="lineno">277 </code>
<code class="lineno">278 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">parse_comma_list</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Punctuated</code>::<code class="o">&lt;</code><code class="n">BuilderAttribute</code><code class="p">,</code><code class="w"> </code><code class="n">Comma</code><code class="o">&gt;</code>::<code class="n">p</code><code class="err">\</code><code class="w"></code>
<code class="lineno">279 </code><code class="n">arse_terminated</code><code class="p">;</code><code class="w"></code>
<code class="lineno">280 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">list</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_comma_list</code><code class="p">(</code><code class="o">&amp;</code><code class="n">inside</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">281 </code>
<code class="lineno">282 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">BuilderAttributeBody</code><code class="p">(</code><code class="w"></code>
<code class="lineno">283 </code><code class="w">            </code><code class="n">list</code><code class="p">.</code><code class="n">into_pairs</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">into_value</code><code class="p">()).</code><code class="n">collect</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">284 </code><code class="w">        </code><code class="p">))</code><code class="w"></code>
<code class="lineno">285 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">286 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The purpose of our implementation of <code>parse</code> is to remove the parentheses from <code>#[builder(...)]</code> so that <code>BuilderAttribute</code> only has to deal with the tokens inside. We also deal with the logic of a comma separated list here.</p>

<p>The <code>parenthesized!(inside in input)</code> means to take the <code>ParseStream</code> in <code>input</code>, remove the parentheses from the outside and store the inner tokens in <code>inside</code>. This is a macro defined in <code>syn</code> for this very common scenario. There are similar parser macros for removing curly braces (<code>braced!</code>) and square brackets (<code>bracketed!</code>).</p>

<p>The next step is to parse a sequence of <code>BuilderAttribute</code> types separated by commas allowing an optional trailing comma. The <code>Punctuated&lt;T,P&gt;</code> type is used to handle this very common case of a list of <code>T</code> separated by <code>P</code>. We use <code>parse_terminated</code> which allows trailing punctuation. If you do not want to accept trailing punctuation, then you can use <code>parse_separated_nonempty</code>. Comparing this to the declarative macro method of handling this is a good example of how different procedural and declarative macros are. We are writing real Rust code here and using types and traits to drive our implementation. This is in contrast to the Scheme style pattern matching of declarative macros.</p>

<p>The final work that needs to be done is to extract the <code>BuilderAttribute</code> types from this punctuated list. We do that by using the <code>into_pairs</code> method on <code>Punctuated</code> which returns an iterator of <code>Pair&lt;BuilderAttribute, Comma&gt;</code> and then for each of these we just call <code>into_value</code> to get the <code>BuilderAttribute</code> out. Finally, we call <code>collect</code> on the iterator to turn it into the vector that our return type expects.</p>

<p>This might seem a bit confusing, it again helps to read the docs for the <code>syn</code> crate for the <code>Punctuated</code> type. It is the only way that any of this can make sense. The common parsing tasks have specialized functions available so it is best to start there to hopefully find what you are looking for.</p>

<p>Okay, now we can turn to implementing the <code>Parse</code> trait for <code>BuilderAttribute</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">251 </code><code class="k">impl</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parse</code>::<code class="n">Parse</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">BuilderAttribute</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">252 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">parse</code><code class="p">(</code><code class="n">input</code>: <code class="nc">syn</code>::<code class="n">parse</code>::<code class="n">ParseStream</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">SynResult</code><code class="o">&lt;</code><code class="n">Self</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">253 </code><code class="w">        </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Ident</code><code class="p">;</code><code class="w"></code>
<code class="lineno">254 </code>
<code class="lineno">255 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">input_tts</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">input</code><code class="p">.</code><code class="n">cursor</code><code class="p">().</code><code class="n">token_stream</code><code class="p">();</code><code class="w"></code>
<code class="lineno">256 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">name</code>: <code class="nc">Ident</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">input</code><code class="p">.</code><code class="n">parse</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">257 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="s">"required"</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">258 </code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">BuilderAttribute</code>::<code class="n">Required</code><code class="p">(</code><code class="n">input_tts</code><code class="p">))</code><code class="w"></code>
<code class="lineno">259 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">260 </code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">syn</code>::<code class="n">Error</code>::<code class="n">new</code><code class="p">(</code><code class="w"></code>
<code class="lineno">261 </code><code class="w">                </code><code class="n">name</code><code class="p">.</code><code class="n">span</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">262 </code><code class="w">                </code><code class="s">"expected `required`"</code><code class="p">,</code><code class="w"></code>
<code class="lineno">263 </code><code class="w">            </code><code class="p">))</code><code class="w"></code>
<code class="lineno">264 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">265 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">266 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The spirit here is quite simple, but the mechanics are little cumbersome. We want to check if the attribute is literally <code>required</code>, if so then we return a success, otherwise we declare a failure. We call methods from <code>syn</code> to turn the <code>input</code> into an <code>Ident</code> which is the only thing we expect to find. If this step fails then we will return an error because of the <code>?</code> operator. We then compare this <code>Ident</code> to <code>"required"</code>. If we get a match, then we wrap the input token stream inside our enum variant. Otherwise we use the location of the <code>Ident</code> that we did parse to generate an error saying that we got something unexpected.</p>

<p>With all of these parse functions in place, we can write a helper to go from a vector of <code>syn::Attribute</code>s to our desired type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">219 </code><code class="k">fn</code> <code class="nf">attributes_from_syn</code><code class="p">(</code><code class="n">attrs</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Attribute</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">MultiResult</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">B</code><code class="err">\</code><code class="w"></code>
<code class="lineno">220 </code><code class="n">uilderAttribute</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">221 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">parse2</code><code class="p">;</code><code class="w"></code>
<code class="lineno">222 </code>
<code class="lineno">223 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">ours</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">224 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">errs</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">225 </code>
<code class="lineno">226 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">parsed_attrs</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">attrs</code><code class="p">.</code><code class="n">into_iter</code><code class="p">().</code><code class="n">filter_map</code><code class="p">(</code><code class="o">|</code><code class="n">attr</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">227 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">attr</code><code class="p">.</code><code class="n">path</code><code class="p">.</code><code class="n">is_ident</code><code class="p">(</code><code class="s">"builder"</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">228 </code><code class="w">            </code><code class="nb">Some</code><code class="p">(</code><code class="n">parse2</code>::<code class="o">&lt;</code><code class="n">BuilderAttributeBody</code><code class="o">&gt;</code><code class="p">(</code><code class="n">attr</code><code class="p">.</code><code class="n">tokens</code><code class="p">).</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">body</code><code class="o">|</code><code class="err">\</code><code class="w"></code>
<code class="lineno">229 </code><code class="w"> </code><code class="n">body</code><code class="p">.</code><code class="mi">0</code><code class="p">))</code><code class="w"></code>
<code class="lineno">230 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">231 </code><code class="w">            </code><code class="nb">None</code><code class="w"></code>
<code class="lineno">232 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">233 </code><code class="w">    </code><code class="p">});</code><code class="w"></code>
<code class="lineno">234 </code>
<code class="lineno">235 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">attr</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">parsed_attrs</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">236 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">attr</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">237 </code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">v</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">ours</code><code class="p">.</code><code class="n">extend</code><code class="p">(</code><code class="n">v</code><code class="p">),</code><code class="w"></code>
<code class="lineno">238 </code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">errs</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">239 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">240 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">241 </code>
<code class="lineno">242 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">errs</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">243 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">ours</code><code class="p">)</code><code class="w"></code>
<code class="lineno">244 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">245 </code><code class="w">        </code><code class="nb">Err</code><code class="p">(</code><code class="n">errs</code><code class="p">)</code><code class="w"></code>
<code class="lineno">246 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">247 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is really just some boilerplate around the parsing functions we just wrote. We define a vector of attributes to return and a vector of errors. We will only return one of these in the end, but it depends on what we see along the way.</p>

<p>The <code>Iterator</code> trait has many useful methods, <code>filter_map</code> which we use here is a way to both map over an iterator and remove some unwanted items at the same time. The closure passed to <code>filter_map</code> returns an <code>Option&lt;T&gt;</code>. The resulting iterator will “unwrap” the values that are <code>Some(T)</code> to just be a <code>T</code> and will not include the <code>None</code> values. Due to how <code>Option</code> implements <code>IntoIterator</code>, you can also use <code>flat_map</code> here for the same effect, but <code>filter_map</code> is more descriptive as to what we are trying to accomplish.</p>

<p>We take the attributes we are passed as input, we ignore any that are not the <code>builder</code> attribute, and ones that do match we parse into our specialized types. The <code>parse2</code> function is for parsing <code>proc_macro2</code> types but is otherwise the same as <code>parse</code> for <code>proc_macro</code> types. Suppose we have:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[something(else), builder(required)]</code><code class="w"></code>
</pre></div>

</figure>

<p>We would then be iterating over <code>something(else)</code> and <code>builder(required)</code>. The first thing we would see is an <code>attr.path</code> of <code>something</code> which is not <code>builder</code> so we return <code>None</code> for that attribute which effectively excludes it from the <code>parsed_attrs</code> result. The next thing we see has a path that matches <code>builder</code> so we take then tokens of the attribute which is <code>(required)</code> and we parse that into a <code>BuilderAttributeBody</code> which relies on our <code>Parse</code> trait implementation from earlier. Once we have that we call <code>map(|body| body.0)</code> which is because the <code>Parse</code> trait returns a <code>Result</code> so we have to deal with getting inside the <code>Ok</code> variant to pull the <code>Vec&lt;BuilderAttribute&gt;</code> out of the tuple struct wrapper we put around it.</p>

<p>We had to do it this way because we could not implement <code>Parse</code> on <code>Vec&lt;BuilderAttribute&gt;</code> directly as we do not own <code>Vec</code> nor <code>Parse</code>. Rust trait implementation rules require that you either own the trait or own the type (where own means is defined within the crate with the trait implementation). We do own our tuple struct so we can implement <code>Parse</code>. But then to get what we want out we have to do this little map trick to pull the vector out.</p>

<p>The rest of the function is straight forward. We iterate over the <code>parsed_attrs</code> and accumulate the good and bad parts. Then if we encountered no errors we can return our good result, otherwise we return the errors.</p>

<h4 id="leanpub-auto-finishing-up-the-parsing">Finishing up the parsing</h4>

<p>Now we can turn to the real meat of our parsing. Let’s start with the signature:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">167 </code><code class="k">fn</code> <code class="nf">parse_builder_struct</code><code class="p">(</code><code class="w"></code>
<code class="lineno">168 </code><code class="w">    </code><code class="n">struct_</code>: <code class="nc">syn</code>::<code class="n">DataStruct</code><code class="p">,</code><code class="w"></code>
<code class="lineno">169 </code><code class="w">    </code><code class="n">name</code>: <code class="nc">syn</code>::<code class="n">Ident</code><code class="p">,</code><code class="w"></code>
<code class="lineno">170 </code><code class="w">    </code><code class="n">generics</code>: <code class="nc">syn</code>::<code class="n">Generics</code><code class="p">,</code><code class="w"></code>
<code class="lineno">171 </code><code class="w">    </code><code class="n">attrs</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">syn</code>::<code class="n">Attribute</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">172 </code><code class="w">    </code><code class="n">span</code>: <code class="nc">proc_macro2</code>::<code class="n">Span</code><code class="p">,</code><code class="w"></code>
<code class="lineno">173 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">MultiResult</code><code class="o">&lt;</code><code class="n">BuilderInfo</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>We already dealt with ensuring that we are getting derived on a struct so we know that we have a <code>syn::DataStruct</code> to work with. The rest of the input was pulled out of the parsed input because it is the only things we need to eventually define a <code>BuilderInfo</code> struct. The point of this function is to deal with all of the various error cases that might occur so that we know if we end up with a <code>BuilderInfo</code> struct that everything is legit for doing code generation.</p>

<p>The first step is to check the attributes defined on the struct itself to see if anyone tried to use a <code>builder</code> attribute there:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">174 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Fields</code><code class="p">;</code><code class="w"></code>
<code class="lineno">175 </code>
<code class="lineno">176 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">errors</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">SyntaxErrors</code>::<code class="n">default</code><code class="p">();</code><code class="w"></code>
<code class="lineno">177 </code>
<code class="lineno">178 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">attr</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">attributes_from_syn</code><code class="p">(</code><code class="n">attrs</code><code class="p">)</code><code class="o">?</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">179 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">attr</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">180 </code><code class="w">            </code><code class="n">BuilderAttribute</code>::<code class="n">Required</code><code class="p">(</code><code class="n">tts</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">181 </code><code class="w">                </code><code class="n">errors</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">tts</code><code class="p">,</code><code class="w"> </code><code class="s">"required is only valid on a field"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">182 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">183 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">184 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We do not support <code>#[builder(required)]</code> on the entire struct so we add an error to our collection of errors if we see one. We do not return early here as we want to keep parsing and collecting errors if there are more that we can find.</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">186 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">fields</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="n">struct_</code><code class="p">.</code><code class="n">fields</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">187 </code><code class="w">        </code><code class="n">Fields</code>::<code class="n">Named</code><code class="p">(</code><code class="n">fields</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">fields</code><code class="p">,</code><code class="w"></code>
<code class="lineno">188 </code><code class="w">        </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">189 </code><code class="w">            </code><code class="n">errors</code><code class="p">.</code><code class="n">extend</code><code class="p">(</code><code class="n">vec</code><code class="o">!</code><code class="p">[</code><code class="n">syn</code>::<code class="n">Error</code>::<code class="n">new</code><code class="p">(</code><code class="w"></code>
<code class="lineno">190 </code><code class="w">                </code><code class="n">span</code><code class="p">,</code><code class="w"></code>
<code class="lineno">191 </code><code class="w">                </code><code class="s">"only named fields are supported"</code><code class="p">,</code><code class="w"></code>
<code class="lineno">192 </code><code class="w">            </code><code class="p">)]);</code><code class="w"></code>
<code class="lineno">193 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">errors</code><code class="w"></code>
<code class="lineno">194 </code><code class="w">                </code><code class="p">.</code><code class="n">finish</code><code class="p">()</code><code class="w"></code>
<code class="lineno">195 </code><code class="w">                </code><code class="p">.</code><code class="n">expect_err</code><code class="p">(</code><code class="s">"just added an error so there should be one\</code>
<code class="lineno">196 </code><code class="s">"</code><code class="p">));</code><code class="w"></code>
<code class="lineno">197 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">198 </code><code class="w">    </code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>Our next step is to get a handle on the fields defined on the struct. You can define unnamed struct fields if you are defining a tuple struct, for instance</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">Foo</code><code class="p">(</code><code class="nb">String</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>has one unnamed field. We do not support that type of struct. We therefore look for named fields and pull out the inner data, otherwise we add an error and then return all the errors we have gathered so far. We do not go any further looking for errors because without named fields there is not much we can do.</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">198 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">fields</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fields</code><code class="w"></code>
<code class="lineno">199 </code><code class="w">        </code><code class="p">.</code><code class="n">named</code><code class="w"></code>
<code class="lineno">200 </code><code class="w">        </code><code class="p">.</code><code class="n">into_iter</code><code class="p">()</code><code class="w"></code>
<code class="lineno">201 </code><code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">f</code><code class="o">|</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="n">attributes_from_syn</code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="n">attrs</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">202 </code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">attrs</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="n">ident</code><code class="p">,</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="n">ty</code><code class="p">,</code><code class="w"> </code><code class="n">attrs</code><code class="p">),</code><code class="w"></code>
<code class="lineno">203 </code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">204 </code><code class="w">                </code><code class="n">errors</code><code class="p">.</code><code class="n">extend</code><code class="p">(</code><code class="n">e</code><code class="p">);</code><code class="w"></code>
<code class="lineno">205 </code><code class="w">                </code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="n">ident</code><code class="p">,</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="n">ty</code><code class="p">,</code><code class="w"> </code><code class="n">vec</code><code class="o">!</code><code class="p">[])</code><code class="w"></code>
<code class="lineno">206 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">207 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">208 </code><code class="w">        </code><code class="p">.</code><code class="n">collect</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<p>For each of our named fields, we need to extract the identifier, type, and attributes. We do this by iterating over the fields and then using methods on the field type to get the information we want. We use our previously defined <code>attributes_from_syn</code> to extract attribute information. Note that we will look at the attributes for every field so we have the potential to accumulate multiple errors depending on the input.</p>

<p>Finally, we return our errors if we encountered any, or we return a successful result containing our <code>BuilderInfo</code> struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">210 </code><code class="w">    </code><code class="n">errors</code><code class="p">.</code><code class="n">finish</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">211 </code>
<code class="lineno">212 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">BuilderInfo</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">213 </code><code class="w">        </code><code class="n">name</code><code class="p">,</code><code class="w"></code>
<code class="lineno">214 </code><code class="w">        </code><code class="n">generics</code><code class="p">,</code><code class="w"></code>
<code class="lineno">215 </code><code class="w">        </code><code class="n">fields</code><code class="p">,</code><code class="w"></code>
<code class="lineno">216 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">217 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-generating-code">Generating code</h4>

<p>All of the work so far has been on the parsing side of the macro. We rely very heavily on <code>syn</code> to do the hard work of parsing Rust syntax but it still takes quite a bit of code to extract the necessary information out of the extensive information that is available to us. But now we are done parsing in the sense that we can move forward under the assumption of a well defined <code>BuilderInfo</code> struct that we just need to generate code for.</p>

<p>Our first step is to get an implementation of <code>Into&lt;TokenStream&gt;</code> for <code>BuilderInfo</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">85 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">BuilderInfo</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">TokenStream</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">86 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">other</code>: <code class="nc">BuilderInfo</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">TokenStream</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">87 </code><code class="w">        </code><code class="n">other</code><code class="p">.</code><code class="n">generate_builder</code><code class="p">().</code><code class="n">into</code><code class="p">()</code><code class="w"></code>
<code class="lineno">88 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">89 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>As we have seen before we choose to implement <code>From&lt;BuilderInfo&gt;</code> for <code>TokenStream</code> rather than implementing <code>Into</code> directly and then rely on the automatic reflexive implementation. This is just yet another indirection to a helper method <code>generate_builder</code> defined on <code>BuilderInfo</code>. This is a stylistic choice, but it can be useful to keep your trait implementations slim and keep the logic that really works with the internals of your struct inside an <code>impl</code> block for the struct itself.</p>

<p>The other advantage here is that, as we will see shortly, <code>generate_builder</code> can operate only in terms of <code>proc_macro2</code> types and this trait encapsulates the <code>proc_macro2</code> to <code>proc_macro</code> dance using another call to <code>into</code>.</p>

<p>Let’s get started with our code generation by getting the preamble out of the way:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">91 </code><code class="k">impl</code><code class="w"> </code><code class="n">BuilderInfo</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">92 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">generate_builder</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">proc_macro2</code>::<code class="n">TokenStream</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>We are inside the <code>impl</code> block for our type and we are writing a function which consumes the struct to return a <code>proc_macro2::TokenStream</code>. There is nothing else happening after this function so there is no reason not to consume self here.</p>

<p>The structure of the implementation of this function is a little bit inside-out so it might help to go through quickly to the end and then come back to clarify. This is because we create variables that hold bits of code which then get interpolated into the final code.</p>

<p>First, we build the code for the setters:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 93 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">gen_typ</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Ident</code>::<code class="n">new</code><code class="p">(</code><code class="s">"__Builder_T"</code><code class="p">,</code><code class="w"> </code><code class="n">proc_macro2</code>::<code class="n">Span</code>:<code class="err">\</code><code class="w"></code>
<code class="lineno"> 94 </code>:<code class="nc">call_site</code><code class="p">());</code><code class="w"></code>
<code class="lineno"> 95 </code>
<code class="lineno"> 96 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">setters</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">fields</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code class="w"> </code><code class="n">t</code><code class="p">,</code><code class="w"> </code><code class="n">_</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">            </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">                </code><code class="k">fn</code> <code class="err">#</code><code class="n">n</code><code class="o">&lt;</code><code class="err">#</code><code class="n">gen_typ</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="err">#</code><code class="n">t</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="err">#</code><code class="n">gen_typ</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">S</code><code class="err">\</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="n">elf</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">100 </code><code class="w">                    </code><code class="bp">self</code><code class="p">.</code><code class="err">#</code><code class="n">n</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">                    </code><code class="bp">self</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">        </code><code class="p">});</code><code class="w"></code>
</pre></div>

</figure>

<p>For each field we create a function that can be used to set the value for that field. The <code>quote!</code> macro allows us to write normal Rust code and interpolate variables in scope with <code>#variable</code>. So it is easiest to understand the generated code by looking at an example. If we have a field like <code>field_name: U</code>, then this code creates the following code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">fn</code> <code class="nf">field_name</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="err">\</code><code class="w"></code>
<code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="bp">self</code><code class="p">.</code><code class="n">field_name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">  </code><code class="bp">self</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The one weird thing here is that we create an identifier <code>__Builder_T</code> which we use as our generic type variable. This gets into the concept of macro hygiene which can be a complicated topic. The basic problem we are trying to work around is suppose we used <code>T</code> as the type variable but <code>T</code> was already defined to be something in the surrounding code.</p>

<p>One type of hygiene would allow that and would treat those two <code>T</code> types has different because they were created in different contexts. However that does not allow you create identifiers that you want to be able to be referred to outside of your macro.</p>

<p>A different type of hygiene makes identifiers that you create be the same as if they were part of the source where the macro is called. This is sometimes called unhygienic. This means your created identifiers can be used by regular code. However this also means they can accidentally conflict. You must specify the type of hygiene you are opting into when creating an identifier by passing a <code>syn::Span</code> to the constructor of an identifier. We use <code>call_site</code> hygiene here to show what it is. This is the type that would otherwise conflict with an existing name, but it is also the type we have to use later. We therefore use <code>__Builder_T</code> as it is highly unlikely this will conflict with an existing type. You could alternatively use <code>def_site</code> hygiene here to avoid this.</p>

<p>The next thing we create are the fields on the builder struct itself:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">104 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">builder_fields</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">fields</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code class="w"> </code><code class="n">t</code><code class="p">,</code><code class="w"> </code><code class="n">_</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">105 </code><code class="w">            </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">106 </code><code class="w">                </code><code class="err">#</code><code class="n">n</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="err">#</code><code class="n">t</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">107 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">108 </code><code class="w">        </code><code class="p">});</code><code class="w"></code>
</pre></div>

</figure>

<p>The builder struct holds the state as we are in the process of building up the data. We choose to implement this by having an optional field for each field in our target struct. That is, if we have the struct:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cp">#[derive(Builder)]</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">Item</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">b</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>then we will have a builder struct like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">struct</code> <code class="nc">ItemBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">a</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">  </code><code class="n">b</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This code takes the field <code>a: u32</code> and generates the field:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">a</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
</pre></div>

</figure>

<p>It is just that snippet of that we are generating. Obviously this makes no sense without being inside a larger struct definition, but we need this individual pieces to be able to build up that larger structure.</p>

<p>The next thing we build is a default field for each field:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">110 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">builder_defaults</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">fields</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code class="w"> </code><code class="n">_</code><code class="p">,</code><code class="w"> </code><code class="n">_</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">111 </code><code class="w">            </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">112 </code><code class="w">                </code><code class="err">#</code><code class="n">n</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="lineno">113 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">114 </code><code class="w">        </code><code class="p">});</code><code class="w"></code>
</pre></div>

</figure>

<p>This will be used to implement <code>Default</code> for our builder struct which we will do by setting every field to <code>None</code>.</p>

<p>The next piece is the code for each field in our build function:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">116 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">builder_build</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">fields</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code class="w"> </code><code class="n">_t</code><code class="p">,</code><code class="w"> </code><code class="n">a</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">117 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">a</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">118 </code><code class="w">                </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">                    </code><code class="err">#</code><code class="n">n</code>: <code class="nc">self</code><code class="p">.</code><code class="err">#</code><code class="n">n</code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">),</code><code class="w"></code>
<code class="lineno">120 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">121 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">                </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">                    </code><code class="err">#</code><code class="n">n</code>: <code class="nc">self</code><code class="p">.</code><code class="err">#</code><code class="n">n</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">        </code><code class="p">});</code><code class="w"></code>
</pre></div>

</figure>

<p>We know that our attribute vector will either be empty or have one element. If it has one element then the field is required, otherwise it might never be set. In the case that it is not required we use <code>Default::default</code> to fill in the value. Therefore, if a field does not implement <code>Default</code> it must be marked required. We use <code>unwrap</code> on the option for required field which will cause a runtime panic if build is called when a required field is not set. We leave it up to you to extend this to more complex error handling scenarios. Again we are just defining a snippet of the whole which makes no sense without being inside something larger. That is, this code takes a field such as <code>a: u32</code> and generates:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">a</code>: <code class="nc">self</code><code class="p">.</code><code class="n">a</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"></code>
</pre></div>

</figure>

<p>The last pieces we need before putting everything together are the name of the builder and the generics information:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">128 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">name</code><code class="p">;</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">impl_generics</code><code class="p">,</code><code class="w"> </code><code class="n">ty_generics</code><code class="p">,</code><code class="w"> </code><code class="n">maybe_where</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">generics</code><code class="p">.</code><code class="n">s</code><code class="err">\</code><code class="w"></code>
<code class="lineno">130 </code><code class="n">plit_for_impl</code><code class="p">();</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">builder_name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">syn</code>::<code class="n">Ident</code>::<code class="n">new</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"{}Builder"</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">),</code><code class="err">\</code><code class="w"></code>
<code class="lineno">132 </code><code class="w"> </code><code class="n">name</code><code class="p">.</code><code class="n">span</code><code class="p">());</code><code class="w"></code>
</pre></div>

</figure>

<p>We take the <code>name</code> which is the identifier of the struct, that is for</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>#[derive(Builder)]
<code class="lineno">2 </code>struct Item {
<code class="lineno">3 </code>  ...
<code class="lineno">4 </code>}
</pre></div>

</figure>

<p>the name is <code>Item</code> and we construct an identifier <code>ItemBuilder</code> which has hygiene as if it was in the same context as where <code>Item</code> is defined. This is so that code that uses <code>Item</code> can use <code>ItemBuilder</code> as if it was hand-written in the same place.</p>

<p>The function <code>split_for_impl</code> on the generics type is defined exactly to give you the pieces of the generic information you need so that they can be interpolated as you generate code. The generics defined on a struct need to be put in different places when you define a trait for that struct.</p>

<p>We can finally output the code which defines our builder struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">131 </code><code class="w">        </code><code class="n">quote</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">            </code><code class="k">impl</code><code class="w"> </code><code class="err">#</code><code class="n">impl_generics</code><code class="w"> </code><code class="err">#</code><code class="n">name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="err">#</code><code class="n">maybe_where</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">133 </code><code class="w">                </code><code class="k">fn</code> <code class="nf">builder</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="err">#</code><code class="n">builder_name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">134 </code><code class="w">                    </code><code class="err">#</code><code class="n">builder_name</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">137 </code>
<code class="lineno">138 </code><code class="w">            </code><code class="k">impl</code><code class="w"> </code><code class="err">#</code><code class="n">impl_generics</code><code class="w"> </code><code class="nb">Default</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="err">#</code><code class="n">builder_name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="err">\</code><code class="w"></code>
<code class="lineno">139 </code><code class="err">#</code><code class="n">maybe_where</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">140 </code><code class="w">                </code><code class="k">fn</code> <code class="nf">default</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">141 </code><code class="w">                    </code><code class="err">#</code><code class="n">builder_name</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">142 </code><code class="w">                        </code><code class="err">#</code><code class="p">(</code><code class="err">#</code><code class="n">builder_defaults</code><code class="p">)</code><code class="o">*</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">                    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">144 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">145 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">146 </code>
<code class="lineno">147 </code><code class="w">            </code><code class="k">struct</code> <code class="err">#</code><code class="n">builder_name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="err">#</code><code class="n">maybe_where</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">148 </code><code class="w">                </code><code class="err">#</code><code class="p">(</code><code class="err">#</code><code class="n">builder_fields</code><code class="p">)</code><code class="o">*</code><code class="w"></code>
<code class="lineno">149 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">150 </code>
<code class="lineno">151 </code><code class="w">            </code><code class="k">impl</code><code class="w"> </code><code class="err">#</code><code class="n">impl_generics</code><code class="w"> </code><code class="err">#</code><code class="n">builder_name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="err">#</code><code class="n">maybe_where</code><code class="err">\</code><code class="w"></code>
<code class="lineno">152 </code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">153 </code><code class="w">                </code><code class="k">fn</code> <code class="nf">new</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">154 </code><code class="w">                    </code><code class="nb">Default</code>::<code class="n">default</code><code class="p">()</code><code class="w"></code>
<code class="lineno">155 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">156 </code>
<code class="lineno">157 </code><code class="w">                </code><code class="err">#</code><code class="p">(</code><code class="err">#</code><code class="n">setters</code><code class="p">)</code><code class="o">*</code><code class="w"></code>
<code class="lineno">158 </code>
<code class="lineno">159 </code><code class="w">                </code><code class="k">fn</code> <code class="nf">build</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="err">#</code><code class="n">name</code><code class="w"> </code><code class="err">#</code><code class="n">ty_generics</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">160 </code><code class="w">                    </code><code class="err">#</code><code class="n">name</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">161 </code><code class="w">                        </code><code class="err">#</code><code class="p">(</code><code class="err">#</code><code class="n">builder_build</code><code class="p">)</code><code class="o">*</code><code class="w"></code>
<code class="lineno">162 </code><code class="w">                    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">163 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">164 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">165 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">166 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">167 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The first part of this code adds an <code>impl</code> block for our struct which defines a function <code>builder</code> which returns an instance of our builder. If your struct already has a <code>builder</code> method then this will be a compiler error. This is one of the nice things in Rust about being able to define multiple <code>impl</code> blocks for the same item. Even if you have an <code>impl</code> for your struct, we can create another one and it just adds our functions.</p>

<p>The next part of this code implements <code>Default</code> for our builder. It does this by creating a struct literal by interpolating the iterator of fields defined by <code>builder_defaults</code> using the <code>#(...)*</code> syntax we saw earlier.</p>

<p>Then we create the struct itself again using the repetition syntax <code>#(builder_fields)*</code> to interpolate the fields we defined earlier into the struct definition.</p>

<p>Finally, we create an <code>impl</code> block for the builder struct which defines <code>new</code> to return <code>Default::default</code>, interpolates all of the setter functions, and then defines a <code>build </code>function which consumes the builder and constructs an instance of the struct we are trying to build. This uses <code>builder_build</code> fields we created above.</p>

<p>If we squint and ignore all of the noise from the <code>#</code> characters and imagine the <code>#(...)*</code> as multiple values the structure of the code should hopefully look like what you expect. If not then it might help to come back here after we go through a full example of using this derive and the code it generates.</p>

<h3 id="leanpub-auto-using-our-custom-derive">Using our custom derive</h3>

<p>Let’s take this bad boy for a spin. Create a new crate with whatever name you like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>cargo new builder-test
</pre></div>

</figure>

<p>We edit our manifest to depend on our procedural macro crate:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">[package]</code>
<code class="lineno">2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"builder-test"</code>
<code class="lineno">3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno">4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;your.name@example.com&gt;"]</code>
<code class="lineno">5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno">6 </code>
<code class="lineno">7 </code><code class="k">[dependencies]</code>
<code class="lineno">8 </code><code class="na">builder</code> <code class="o">=</code> <code class="s">{ path = "../builder", version = "0.1.0" }</code>
</pre></div>

</figure>

<p>I created this test crate in a sibling directory to the macro crate so that we can use this simple <code>path</code> specifier to rely on the local crate that we just created. The path is relative to the <code>Cargo.toml</code> file which is why it requires going up one level.</p>

<p>Let’s put some code in <code>main.rs</code> to get started:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">use</code><code class="w"> </code><code class="n">builder</code>::<code class="n">Builder</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code><code class="cp">#[derive(Debug)]</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="k">struct</code> <code class="nc">X</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="cp">#[derive(Debug, Builder)]</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="k">struct</code> <code class="nc">Item</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">where</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">T</code>: <code class="nb">Default</code><code class="p">,</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">{</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">a</code>: <code class="kt">u32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">b</code>: <code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="n">c</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="cp">#[builder(required)]</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">d</code>: <code class="nc">X</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="n">e</code>: <code class="nc">T</code><code class="p">,</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="cp">#[builder(required)]</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">f</code>: <code class="nc">U</code><code class="p">,</code><code class="w"></code>
<code class="lineno">19 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We import the <code>Builder</code> macro from our crate and then define a couple structs to work with. We are just trying to stretch some of the complexity we handled by introducing generics and the <code>X</code> and <code>U</code> types which specifically do not implement <code>Default</code>.</p>

<p>Then in our <code>main</code> function, we can build some <code>Item</code> structs using the generated code:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">21 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">item</code>: <code class="nc">Item</code><code class="o">&lt;</code><code class="kt">i32</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Item</code>::<code class="n">builder</code><code class="p">()</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="p">.</code><code class="n">a</code><code class="p">(</code><code class="mi">42</code><code class="k">u32</code><code class="p">)</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">        </code><code class="p">.</code><code class="n">b</code><code class="p">(</code><code class="s">"hello"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">        </code><code class="p">.</code><code class="n">c</code><code class="p">(</code><code class="s">"boom"</code><code class="p">.</code><code class="n">to_owned</code><code class="p">())</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">        </code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="n">X</code><code class="w"> </code><code class="p">{})</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="p">.</code><code class="n">e</code><code class="p">(</code><code class="mi">42</code><code class="k">i32</code><code class="p">)</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="p">.</code><code class="n">f</code><code class="p">(</code><code class="s">"hello"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">        </code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
<code class="lineno">30 </code>
<code class="lineno">31 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{:#?}"</code><code class="p">,</code><code class="w"> </code><code class="n">item</code><code class="p">);</code><code class="w"></code>
<code class="lineno">32 </code>
<code class="lineno">33 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">item2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Item</code>::<code class="o">&lt;</code><code class="kt">u32</code><code class="p">,</code><code class="w"> </code><code class="kt">u64</code><code class="o">&gt;</code>::<code class="n">builder</code><code class="p">().</code><code class="n">b</code><code class="p">(</code><code class="nb">None</code><code class="p">).</code><code class="n">d</code><code class="p">(</code><code class="n">X</code><code class="w"> </code><code class="p">{}).</code><code class="n">f</code><code class="p">(</code><code class="mi">99</code><code class="k">u64</code><code class="p">).</code><code class="n">bu</code><code class="err">\</code><code class="w"></code>
<code class="lineno">34 </code><code class="n">ild</code><code class="p">();</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{:#?}"</code><code class="p">,</code><code class="w"> </code><code class="n">item2</code><code class="p">);</code><code class="w"></code>
<code class="lineno">36 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If we <code>cargo run</code> everything should compile and you should see the two items printed out. That at least means the builder works as intended.</p>

<p>To understand the generated code we can use <code>cargo expand</code> again to see what is happening. This will produce quite a bit of output, but the relevant bits for us are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">impl</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"> </code><code class="n">Item</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">where</code><code class="w"></code>
<code class="w">    </code><code class="n">T</code>: <code class="nb">Default</code><code class="p">,</code><code class="w"></code>
<code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">builder</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">ItemBuilder</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="n">ItemBuilder</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
<code class="k">impl</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"> </code><code class="nb">Default</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">ItemBuilder</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">where</code><code class="w"></code>
<code class="w">    </code><code class="n">T</code>: <code class="nb">Default</code><code class="p">,</code><code class="w"></code>
<code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">default</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="n">ItemBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">            </code><code class="n">a</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">            </code><code class="n">b</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">            </code><code class="n">c</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">            </code><code class="n">d</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">            </code><code class="n">e</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">            </code><code class="n">f</code>: <code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
<code class="k">struct</code> <code class="nc">ItemBuilder</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">where</code><code class="w"></code>
<code class="w">    </code><code class="n">T</code>: <code class="nb">Default</code><code class="p">,</code><code class="w"></code>
<code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="n">a</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">b</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="o">&gt;&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">c</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">d</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">X</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">e</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="n">f</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
<code class="k">impl</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"> </code><code class="n">ItemBuilder</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"></code>
<code class="k">where</code><code class="w"></code>
<code class="w">    </code><code class="n">T</code>: <code class="nb">Default</code><code class="p">,</code><code class="w"></code>
<code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">new</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="nb">Default</code>::<code class="n">default</code><code class="p">()</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">a</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="kt">u32</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">b</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="o">&gt;&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Buil</code><code class="err">\</code><code class="w"></code>
<code class="n">der_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">c</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="err">\</code><code class="w"></code>
<code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">c</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">d</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="n">X</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">d</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">e</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">e</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">f</code><code class="o">&lt;</code><code class="n">__Builder_T</code>: <code class="nb">Into</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">val</code>: <code class="nc">__Builder_T</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">f</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">val</code><code class="p">.</code><code class="n">into</code><code class="p">());</code><code class="w"></code>
<code class="w">        </code><code class="bp">self</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">build</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Item</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">U</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="n">Item</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">            </code><code class="n">a</code>: <code class="nc">self</code><code class="p">.</code><code class="n">a</code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">),</code><code class="w"></code>
<code class="w">            </code><code class="n">b</code>: <code class="nc">self</code><code class="p">.</code><code class="n">b</code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">),</code><code class="w"></code>
<code class="w">            </code><code class="n">c</code>: <code class="nc">self</code><code class="p">.</code><code class="n">c</code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">),</code><code class="w"></code>
<code class="w">            </code><code class="n">d</code>: <code class="nc">self</code><code class="p">.</code><code class="n">d</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"></code>
<code class="w">            </code><code class="n">e</code>: <code class="nc">self</code><code class="p">.</code><code class="n">e</code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">),</code><code class="w"></code>
<code class="w">            </code><code class="n">f</code>: <code class="nc">self</code><code class="p">.</code><code class="n">f</code><code class="p">.</code><code class="n">unwrap</code><code class="p">(),</code><code class="w"></code>
<code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Comparing this to the code to generate the code should clarify what each of the parts is doing.</p>

<h3 id="leanpub-auto-wrapping-up-3">Wrapping up</h3>

<p>Macros are a powerful and incredibly useful language feature. Quite a bit of the positive ergonomics of using Rust comes from the ability to automatically derive traits. Hopefully you have quite a bit more insight into how this is done and how you can accomplish this if needed.</p>

<p>Macros are more than just for deriving traits and they can be a nice way to simplify many repetitive programming tasks. However, they can also be confusing, brittle, and overly complex for many tasks. Therefore, try not to use them, but know they are in your back pocket when you really need to reach for them.</p>



</div>,<div>
<h2 id="leanpub-auto-even-more-web">Even More Web</h2>

<h3 id="leanpub-auto-crates-to-know">Crates to know</h3>

<p>The vibrant Rust ecosystem makes building complex applications in Rust much easier. This ecosystem continues to grow so that even if something is currently missing, chances a new crate is on the horizon that will solve your problem. And if not, you can help the community by writing a crate yourself.</p>

<p>We will expand our understanding of building a web application by adding persistence via a SQL database. There are a few tools for working with SQL in Rust, from directly accessing the database via wrappers around C libraries to full blown Object Relational Mapping (ORM) libraries. We will take somewhat of a middle-ground approach and use the <a href="https://diesel.rs">Diesel</a> crate.</p>

<h4 id="leanpub-auto-diesel">Diesel</h4>

<p>Diesel is both an ORM and a query builder with a focus on compile time safety, performance, and productivity. It has quickly becoming the standard tool for interacting with databases in Rust.</p>

<p>Rust has a powerful type system which can be used to provide guarantees that rule out a wide variety of errors that would otherwise occur at runtime. Diesel has built abstractions that eliminate incorrect database interactions by using the type system to encode information about what is in the database and what your queries represent. Moreover, these abstractions are zero-cost in the common cases which allows Diesel to provide this safety with the same or better performance than C.</p>

<p>The crate currently supports three backends: PostgreSQL, MySQL, and Sqlite. Switching between databases is not completely free as certain features are not supported by all backends. However, the primary interaction between your code and the database is in Rust rather than SQL, so much of the interactions with Diesel are database agnostic. For managing common database administration tasks like migrations, Diesel provides a command line interface (CLI) which we will show how to use.</p>

<p>The <a href="http://diesel.rs/guides/getting-started/">Diesel getting started</a> is a great resource for an overview of how Diesel works and what it can do.</p>

<h3 id="leanpub-auto-building-a-blog">Building a blog</h3>

<p>We are going to build a JSON API around a database that represents a blog. In order to capture most of the complexity of working with a database we will have a few models with some relationships. Namely, our models will be:</p>

<ul>
  <li>Users</li>
  <li>Posts</li>
  <li>Comments</li>
</ul>

<p>A Post will have one User as an author. Posts can have many Comments where each Comment also has a User as author. This provides enough opportunity for demonstrating database interactions without getting overwhelmed by too many details.</p>

<p>We will start out by getting all of the necessary infrastructure in place to support Users. This will involve putting a few abstractions in place that are overkill for a single model, however they will pay dividends when we subsequently add Posts and Comments.</p>

<p>As we have already gone through quite a bit of details related to Actix and building an API, the focus here will be more on the new parts related to working with persistence. Therefore some of the details of working with <code>actix-web</code> will be assumed.</p>

<h4 id="leanpub-auto-getting-setup">Getting setup</h4>

<p>Let’s get started like with all Rust projects and have Cargo generate a new project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo new blog-actix
</pre></div>

</figure>

<p>Our first step will be editing our manifest to specify the dependencies that we are going to need:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">[package]</code>
<code class="lineno"> 2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"blog-actix"</code>
<code class="lineno"> 3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno"> 4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@example.com&gt;"]</code>
<code class="lineno"> 5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">[dependencies]</code>
<code class="lineno"> 8 </code><code class="na">actix-web</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="na">env_logger</code> <code class="o">=</code> <code class="s">"0.6"</code>
<code class="lineno">11 </code><code class="na">futures</code> <code class="o">=</code> <code class="s">"0.1"</code>
<code class="lineno">12 </code><code class="na">serde</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">13 </code><code class="na">serde_json</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">14 </code><code class="na">serde_derive</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">15 </code>
<code class="lineno">16 </code><code class="na">diesel</code> <code class="o">=</code> <code class="s">{ version = "^1.1.0", features = ["sqlite", "r2d2"] }</code>
<code class="lineno">17 </code><code class="na">dotenv</code> <code class="o">=</code> <code class="s">"0.10"</code>
</pre></div>

</figure>

<p>The new dependencies beyond what we have previously used with <code>actix-web</code> are <code>diesel</code>, and <code>dotenv</code>. The <code>diesel</code> dependency we have already discussed, but there is a bit of a new twist here.</p>

<p>Cargo supports the concept of features which allow crates to specify groups of functionality that you can select when you depend on a crate. This is typically used for conditionally including transitive dependencies and conditional compilation to either include or exclude code based on what you do or don’t need. Good crates allow you to pick and choose only what you want to minimize compilation times and binary sizes. The Rust compiler can do some work to remove code that is unused in your final binary but using features is one way to ensure this happens and make it explicitly what you are using.</p>

<p>One thing Diesel uses features for is to specify what backend you want to use. For our purposes we are going to use Sqlite. As an embedded file based database we will be able to work with persistence without having to setup the external dependency of a database server. We will be clear as to what parts of this code depend on this database choice.</p>

<p>The other feature of Diesel that we are specifying, <code>r2d2</code>, adds the <code>r2d2</code> generic database connection pool crate as a dependency of Diesel and turns on some functionality. Any reasonable production system will use a connection pool for interacting with a database, the reasons are best described in the <code>r2d2</code> documentation:</p>

<blockquote>
  <p>Opening a new database connection every time one is needed is both inefficient and can lead to resource exhaustion under high traffic conditions. A connection pool maintains a set of open connections to a database, handing them out for repeated use.</p>
</blockquote>

<p>Finally, we include <code>dotenv</code> as a dependency which is a tool for managing environment variables. By default Dotenv looks for a file named <code>.env</code> in the current directory which lists environment variables to load. As we will need it later, let’s create this file with one variable <code>DATABASE_URL</code> with a file URL to a file in the current directory which will hold our Sqlite database:</p>

<p>&lt;&lt;<a href="code/intermediate/blog-actix/.env">.env</a></p>

<h4 id="leanpub-auto-installing-the-diesel-cli">Installing the Diesel CLI</h4>

<p>As we previously mentioned, Diesel has a CLI for managing common database tasks. Cargo has the ability to install binary crates on your system via the <code>cargo install</code> command. Therefore, we can install the Diesel CLI with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ cargo install diesel_cli --no-default-features --features sqlite
</pre></div>

</figure>

<p>By default this installs a binary at <code>~/.cargo/bin</code> but it is possible to configure this.</p>

<p>As we mentioned Diesel uses features for turning on and off certain functionality. Crates that use features typically have a default set that is turned on if you otherwise do not specify anything. It is possible to turn off this default behavior via the command line argument <code>--no-default-features</code>, and for the CLI we do this because the default is to include support for all three database backends. This will cause errors running CLI commands if you do not have some of the necessary components installed. So we turn off the default and then turn on only Sqlite support via <code>--features sqlite</code>.</p>

<h4 id="leanpub-auto-migrations">Migrations</h4>

<p>The Diesel CLI binary is named <code>diesel</code>, so we can setup our project for working with Diesel by running the setup command:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel setup
</pre></div>

</figure>

<p>By default this assumes the existence of an environment variable named <code>DATABASE_URL</code> or a <code>.env</code> file with this variable defined. It is possible to pass this manual to each CLI command, but using one of the aforementioned methods is much more convenient. This is one reason we created the <code>.env</code> file above.</p>

<p>This will create a migrations directory as well as a <code>diesel.toml</code> file. If you are using Postgres this command will also create a migration that creates a SQL function for working with timestamps. This does not happen for other backends.</p>

<p>Diesel manages migrations using a directory called <code>migrations</code> with a subdirectory for each migration. The name of the subdirectories are a timestamp prefix followed by a name. Within each migration directory are two self-explanatory files: <code>up.sql</code> and <code>down.sql</code>. Diesel uses SQL for migrations rather than a custom DSL. Therefore changing databases requires rewriting most of your migrations.</p>

<h4 id="leanpub-auto-running-migrations">Running migrations</h4>

<p>The primary use for the CLI is managing migrations which uses the <code>migration</code> command with further subcommands. To see all migrations and whether they have been applied we use the <code>list</code> subcommand:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration list
</pre></div>

</figure>

<p>To run all pending migrations we use the <code>run</code> subcommand:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration run
</pre></div>

</figure>

<p>You can get help for <code>diesel</code> in general by calling <code>diesel --help</code> or for a particular command by passing <code>--help</code> with that command, i.e.:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration --help
</pre></div>

</figure>

<h4 id="leanpub-auto-schema">Schema</h4>

<p>So you manage your database using the Diesel CLI and a set of migration files written in SQL. But all of that operates outside of Rust. To connect your database to Rust, Diesel uses a schema file that is a code representation of your database. Running the migrations also modifies this code representation at <code>src/schema.rs</code>. The name of this file and whether this happens can be controlled via settings in <code>diesel.toml</code>, but the default is usually what you want.</p>

<h3 id="leanpub-auto-users">Users</h3>

<p>Let’s get started creating our application which will support managing users. We are not going to get into the weeds of authentication or authorization, rather our focus will be on manipulating persisted data via a JSON API.</p>

<h4 id="leanpub-auto-create-users-migration">Create users migration</h4>

<p>The first step is to add a migration that will create the database table <code>users</code> to hold our users:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration generate create_users
</pre></div>

</figure>

<p>This creates a directory <code>migrations/YYYY-MM-DD-HHMMSS_create_users</code> with two empty files. In <code>up.sql</code> let’s put the SQL for creating our <code>users</code> table:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-025732_create_users/up.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">users</code> <code class="p">(</code>
<code class="lineno">2 </code>  <code class="n">id</code> <code class="nb">INTEGER</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
<code class="lineno">3 </code>  <code class="n">username</code> <code class="nb">VARCHAR</code> <code class="k">NOT</code> <code class="k">NULL</code>
<code class="lineno">4 </code><code class="p">)</code>
</pre></div>

</figure>

<p>Each user has an <code>id</code> which will be the primary key for fetching users as well as the key used for referencing users in other tables. We also require each user to have a <code>username</code> which is a string. You can get arbitrarily creative here depending on your domain, but for simplicity we only have these two columns.</p>

<p>This syntax is specific to the Sqlite backend so this it should be clear why all migrations could need to be rewritten if you decide to use a different backend. For example, some databases allow you restrict the size of <code>VARCHAR</code> columns which might be a reasonable thing to do for a username, but Sqlite does not actually enforce any limit you happen to write.</p>

<p>The corresponding <code>down.sql</code> file should perform whatever transformations are necessary to undue what happens in <code>up.sql</code>. In this case as the up migration is creating a table, we can drop the table in our down migration:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-025732_create_users/down.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">users</code>
</pre></div>

</figure>

<p>You can do whatever you want in <code>up</code> and <code>down</code>, but for your own sanity, the schema should be the same before running the migration and after running up followed by down. That is down should revert the schema to the prior state. As some migrations will update data in the database it is not necessarily true that the data in the database is preserved by running up followed by down. The reversibility of migrations is typically only a statement about the schema, but the exact semantics are up to you.</p>

<h4 id="leanpub-auto-make-username-unique">Make username unique</h4>

<p>We create yet another migration, this time to add an index to our users table. We do this to ensure that usernames are unique in our system and that we can lookup users by their username quickly. First we have diesel create the files for us with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration generate index_username
</pre></div>

</figure>

<p>Then we add the code to create the index to <code>up.sql</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-025922_index_username/up.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">CREATE</code> <code class="k">UNIQUE</code> <code class="k">INDEX</code> <code class="n">username_unique_idx</code> <code class="k">ON</code> <code class="n">users</code> <code class="p">(</code><code class="n">username</code><code class="p">)</code>
</pre></div>

</figure>

<p>Again this is Sqlite syntax, although all backends have a similar syntax for this operation. The important part of this index is the <code>UNIQUE</code> keyword. This let’s us rely on the database for the enforcement of unique usernames rather than introducing racy code that tries to manage this at the application layer.</p>

<p>As before, we want our down migration to reverse what we did in up, so we drop the index in <code>down.sql</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-025922_index_username/down.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">DROP</code> <code class="k">INDEX</code> <code class="n">username_unique_idx</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-schema-1">Schema</h4>

<p>We run our migrations via the Diesel CLI with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>diesel migration run
</pre></div>

</figure>

<p>Once this runs successfully two things will be true. First, the database file at <code>blog.db</code> will be in the state after running all of our up migrations. You can verify this by opening the Sqlite shell:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>sqlite3 blog.db
</pre></div>

</figure>

<p>and dumping the schema:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">sqlite</code><code class="o">&gt;</code> <code class="p">.</code><code class="k">schema</code>
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">__diesel_schema_migrations</code> <code class="p">(</code>
  <code class="k">version</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">run_on</code> <code class="k">TIMESTAMP</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="k">CURRENT_TIMESTAMP</code>
<code class="p">);</code>
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">users</code> <code class="p">(</code>
  <code class="n">id</code> <code class="nb">INTEGER</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">username</code> <code class="nb">VARCHAR</code> <code class="k">NOT</code> <code class="k">NULL</code>
<code class="p">);</code>
<code class="k">CREATE</code> <code class="k">UNIQUE</code> <code class="k">INDEX</code> <code class="n">username_unique_idx</code> <code class="k">ON</code> <code class="n">users</code> <code class="p">(</code><code class="n">username</code><code class="p">);</code>
</pre></div>

</figure>

<p>Note that the <code>__diesel_schema_migrations</code> table is automatically created by Diesel and it is how the CLI knows which migrations have or have not run.</p>

<p>The second thing that happens is the file <code>src/schema.rs</code> is updated with Rust code which Diesel uses to understand the state of your database. This file should look like:</p>

<figure class="code" dir="ltr">
  <figcaption>src/schema.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">2 </code><code class="w">    </code><code class="n">users</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">3 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno">4 </code><code class="w">        </code><code class="n">username</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno">5 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">6 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>It doesn’t look like much because of the magic of the macros that Diesel provides. Here only the <code>table!</code> macro is used, but there are a few more that we will encounter as our data model evolves.</p>

<h3 id="leanpub-auto-building-the-application">Building the application</h3>

<p>With the database taken care of for the moment, we turn now to our actual application. We are going to build out the scaffolding which supports users and also will be easily extensible later on.</p>

<h4 id="leanpub-auto-main">Main</h4>

<p>As we have done before, we are going to split our application into a small <code>main.rs</code>, which is the binary entry point, and keep everything else in a library which our main can call in to. So without further ado, let’s add the following to <code>main.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">use</code><code class="w"> </code><code class="n">dotenv</code>::<code class="n">dotenv</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">env</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 3 </code>
<code class="lineno"> 4 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="w">    </code><code class="n">dotenv</code><code class="p">().</code><code class="n">ok</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="n">env</code>::<code class="n">set_var</code><code class="p">(</code><code class="s">"RUST_LOG"</code><code class="p">,</code><code class="w"> </code><code class="s">"actix_web=info"</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="n">env_logger</code>::<code class="n">init</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">database_url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">env</code>::<code class="n">var</code><code class="p">(</code><code class="s">"DATABASE_URL"</code><code class="p">).</code><code class="n">expect</code><code class="p">(</code><code class="s">"DATABASE_URL mu\</code>
<code class="lineno">10 </code><code class="s">st be set"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">app</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">blog_actix</code>::<code class="n">Blog</code>::<code class="n">new</code><code class="p">(</code><code class="mi">8998</code><code class="p">);</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">run</code><code class="p">(</code><code class="n">database_url</code><code class="p">)</code><code class="w"></code>
<code class="lineno">13 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Everything here we have seen in our simpler web applications except the interaction with <code>dotenv</code>. Calling <code>dotenv().ok()</code> sets environment variables based on the contents of the <code>.env</code> file in the current directory and ignores any error that might result. Dotenv only sets environment variables from that file if they are not already set so you can always override the file by setting the variable directly in your environment before running the program.</p>

<p>As we have a <code>.env</code> file with <code>DATABASE_URL</code> defined we will end up with that environment variable set so our call to <code>env::var("DATABASE_URL")</code> will succeed. We pass this URL to the <code>run</code> call of our app which kicks off everything.</p>

<h4 id="leanpub-auto-setting-up-our-library">Setting up our library</h4>

<p>Let’s turn to our library entry point which we have seen needs to export the <code>Blog</code> struct that we call from our main function. As is standard we start with some import statements to make our subsequent code easier to work with:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="cp">#[macro_use]</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">extern</code><code class="w"> </code><code class="k">crate</code><code class="w"> </code><code class="n">diesel</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="cp">#[macro_use]</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">extern</code><code class="w"> </code><code class="k">crate</code><code class="w"> </code><code class="n">serde_derive</code><code class="p">;</code><code class="w"></code>
<code class="lineno">5 </code>
<code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">middleware</code><code class="p">,</code><code class="w"> </code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">HttpServer</code><code class="p">};</code><code class="w"></code>
<code class="lineno">7 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">prelude</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="lineno">8 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">r2d2</code>::<code class="p">{</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">ConnectionManager</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>Working with Diesel requires some macros to be in scope which is why we have the <code>macro_use</code> attribute on the <code>extern crate diesel</code> item. We also want to derive the <code>Serialize</code> and <code>Deserialize</code> traits from Serde for working with JSON so we bring those macros in to scope. The <code>actix_web</code> use statement is just bringing some items into scope to make our code more readable.</p>

<p>Diesel has a prelude which includes common types and functions which you almost always need while working with your database and the standard practice is to use the <code>*</code> import to bring all of the things exported in the prelude into scope as there is very little chance of a conflict.</p>

<p>As we discussed previously <code>r2d2</code> is a connection pooling library that Diesel provides an interface to because we turned that feature on in our manifest.</p>

<p>The next thing we do for code readability is to create a type alias for our pool of database connections:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">15 </code><code class="k">type</code> <code class="nc">Pool</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">r2d2</code>::<code class="n">Pool</code><code class="o">&lt;</code><code class="n">ConnectionManager</code><code class="o">&lt;</code><code class="n">SqliteConnection</code><code class="o">&gt;&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>This is common practice as the exact details of this type are not usually relevant where we are using it, rather just the fact that it is a connection pool. Overusing type aliases can sometimes lead to more confusing code, but underusing them can also lead to noisy code. When to use one is a bit of art and style, but it makes a lot of sense here.</p>

<h5 id="leanpub-auto-modules-and-code-organization">Modules and code organization</h5>

<p>In previous chapters we have had all of our library code in <code>src/lib.rs</code> partially out of convenience and partially because the cost of spreading code across multiple files was higher than the benefit. Here we are going to be spreading our code out into multiple modules that together form our library. Each one has a clear purpose and the separation makes it easier to scale the codebase.</p>

<p>Rust has a module system to organize code within a crate for readability and ease of reuse as well as to control privacy of items. You can declare modules within a file with the <code>mod</code> keyword followed by a name, followed by curly braces to contain the code for the module:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">mod</code> <code class="nn">a_module</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">fn</code> <code class="nf">some_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">  </code><code class="k">fn</code> <code class="nf">hidden_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>

<code class="w">  </code><code class="k">mod</code> <code class="nn">inner_module</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">inner_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">inner_hidden_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>

<code class="k">fn</code> <code class="nf">do_things</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="n">a_module</code>::<code class="n">some_function</code><code class="p">();</code><code class="w"></code>
<code class="w">  </code><code class="n">a_module</code>::<code class="n">inner_module</code>::<code class="n">inner_function</code><code class="p">();</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This code will not compile however. By default all items in Rust are private, so it is not possible to refer to any of the items inside <code>a_module</code> from outside because the lack of privacy specifier implies they are private. If we want the above code to compile, we would need to expose the functions to the outside. There are some technicalities to specifying privacy that allows you to make very fine grained judgements about how public an item actual is. We will show this through some examples as necessary, but otherwise it is not strictly necessary to know until you need it. The simplest fix to the above modules is to use the <code>pub</code> keyword to expose the items we want to expose:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">mod</code> <code class="nn">a_module</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">some_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">  </code><code class="k">fn</code> <code class="nf">hidden_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>

<code class="w">  </code><code class="k">pub</code><code class="w"> </code><code class="k">mod</code> <code class="nn">inner_module</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">inner_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">    </code><code class="k">fn</code> <code class="nf">inner_hidden_function</code><code class="p">()</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="w">  </code><code class="p">}</code><code class="w"></code>
<code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We can also spread modules over files and directories which helps with file size and makes working with large projects much easier. Instead of declaring a module inline, you can simply refer to it via:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">mod</code> <code class="nn">a_module</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The language then expects to find a file <code>a_module.rs</code> or a file <code>mod.rs</code> inside a directory with the name of the module, i.e. <code>a_module/mod.rs</code>. Prior to the 2018 edition of Rust, if you wanted to have submodules of a module then you were required to use the directory plus <code>mod.rs</code> file method. In current Rust, you can have submodules within a directory and still have a file with the module name at the same level as the directory. In other words, our example above in modern Rust can have this form:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>src/
├── a_module
│   └── inner_module.rs
├── a_module.rs
└── lib.rs
</pre></div>

</figure>

<p>Or it can have this form (which was the only form prior to the 2018 edition):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>src/
├── a_module
│   ├── inner_module.rs
│   └── mod.rs
└── lib.rs
</pre></div>

</figure>

<p>There is a bit of flexibility even beyond this depending on the structure of the rest of the library around this, but this is what you will find most often in practice. We mention the <code>mod.rs</code> style as you will see it in other codebases that existed prior to the 2018 edition and did not migrate completely to the new style. It is not the recommended style any longer.</p>

<p>Returning back to our library, we specify the modules that make up our crate in <code>src/lib.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">10 </code><code class="k">mod</code> <code class="nn">errors</code><code class="p">;</code><code class="w"></code>
<code class="lineno">11 </code><code class="k">mod</code> <code class="nn">models</code><code class="p">;</code><code class="w"></code>
<code class="lineno">12 </code><code class="k">mod</code> <code class="nn">routes</code><code class="p">;</code><code class="w"></code>
<code class="lineno">13 </code><code class="k">mod</code> <code class="nn">schema</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We will have to create files and/or directories for these in order for this to compile, but we get these out of the way so they are part of the library. If you create a file in <code>src</code> but do not include it in the root module which is represented by <code>src/lib.rs</code> then that file will be completely ignored by Cargo and will not be part of your library. Therefore in order to actually make these modules part of our library we must include them in our root module.</p>

<p>Note also that these are all private. We currently are not exposing the existence of these modules to outside user’s of our library. The decision to separate the code into modules is thus purely for the internal code structure and has not external impact.</p>

<p>The four modules we define are:</p>

<ul>
  <li>errors
    <ul>
      <li>code for working with various failure scenarios</li>
    </ul>
  </li>
  <li>models
    <ul>
      <li>code to define the Rust representation of our data model as represented by our database</li>
    </ul>
  </li>
  <li>routes
    <ul>
      <li>code for defining the handlers that will make up the functions that get called by the framework in response to web requests</li>
    </ul>
  </li>
  <li>schema
    <ul>
      <li>this is autogenerated by Diesel as we have mentioned before</li>
    </ul>
  </li>
</ul>

<p>The <code>src/schema.rs</code> file that we discussed previously now makes sense as a module that is part of our library which can be made available by including it here at the root. The macros used in that file are one of the reasons we imported them at the top of this file.</p>

<h5 id="leanpub-auto-application-struct">Application struct</h5>

<p>We turn now to the <code>Blog</code> struct that we expose publicly and which we use from our main. This follows a very similar structure to the other applications we have developed. First we define a struct to hold some configuration data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">17 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Blog</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">port</code>: <code class="kt">u16</code><code class="p">,</code><code class="w"></code>
<code class="lineno">19 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>For this again we only store the port that we are going to bind to. Then we create our implementation to add some functionality to our struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">21 </code><code class="k">impl</code><code class="w"> </code><code class="n">Blog</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">new</code><code class="p">(</code><code class="n">port</code>: <code class="kt">u16</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="n">Blog</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">port</code><code class="w"> </code><code class="p">}</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">25 </code>
<code class="lineno">26 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">run</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">database_url</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">std</code>::<code class="n">io</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">manager</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ConnectionManager</code>::<code class="o">&lt;</code><code class="n">SqliteConnection</code><code class="o">&gt;</code>::<code class="n">new</code><code class="p">(</code><code class="n">databa</code><code class="err">\</code><code class="w"></code>
<code class="lineno">28 </code><code class="n">se_url</code><code class="p">);</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">pool</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">r2d2</code>::<code class="n">Pool</code>::<code class="n">builder</code><code class="p">()</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">            </code><code class="p">.</code><code class="n">build</code><code class="p">(</code><code class="n">manager</code><code class="p">)</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">            </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="s">"Failed to create pool."</code><code class="p">);</code><code class="w"></code>
<code class="lineno">32 </code>
<code class="lineno">33 </code><code class="w">        </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"Starting http server: 127.0.0.1:{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">);</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">        </code><code class="n">HttpServer</code>::<code class="n">new</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">                </code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">pool</code><code class="p">.</code><code class="n">clone</code><code class="p">())</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">                </code><code class="p">.</code><code class="n">configure</code><code class="p">(</code><code class="n">routes</code>::<code class="n">users</code>::<code class="n">configure</code><code class="p">)</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="p">.</code><code class="n">bind</code><code class="p">((</code><code class="s">"127.0.0.1"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">port</code><code class="p">))</code><code class="o">?</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">        </code><code class="p">.</code><code class="n">run</code><code class="p">()</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">43 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>In our <code>run</code> method we take a String representation of a database URL as input which we use to construct a pool of database connections. The <code>ConnectionManager</code> type is generic over the underlying connection which we specify as <code>SqliteConnection</code>. The <code>SqliteConnection</code> type is imported as part of the Diesel prelude because we turned the Sqlite feature on. We then use the <code>r2d2</code> factory method to construct a connection pool and store it in the <code>pool</code> variable.</p>

<p>Similar to our previous chapter where we created an app with state, we are going to follow the same pattern except here the type of the state is a connection pool. As the closure that gets passed to <code>HttpServer::new</code> is a factory we have to clone our <code>pool</code> so that each worker will have access to the same shared pool. It is an implementation detail but the <code>Pool</code> type is just an <code>Arc</code> around a struct that manages connections so calling clone on the pool is the same as calling clone on an <code>Arc</code>, exactly how we managed state before.</p>

<p>The only other new piece here is the call to <code>configure</code> to set up the routes for users. We are passing a function to configure <code>routes::users::configure</code> which tells us that our <code>routes</code> module needs to publicly expose a submodule called <code>users</code>, and that submodule needs to publicly expose a function called <code>configure</code>. In the previous chapters we constructed all of our routes directly inside this factory function. Here we are using the configure method on <code>App</code> which takes one argument which satisfies the trait bound <code>FnOnce(&amp;mut ServiceConfig)</code> which basically means a function that takes one argument of type <code>&amp;mut ServiceConfig</code> and which we are only guaranteed that it is okay to call it once. When we get to the <code>users</code> module inside the <code>routes</code> module we will see how the <code>configure</code> method does the work of defining routes and handlers.</p>

<p>The choice to centralize this routing or to spread it out to separate modules is a matter of preference. There are trade-offs to both approaches, so although we demonstrate one style in this chapter, what you end up using will depend on your actual system.</p>

<p>We now take each of the modules that we previously declared in order to round out our library.</p>

<h4 id="leanpub-auto-errors">Errors</h4>

<p>The first module we are going to deal with is the <code>errors</code> module. We define our own error type which unifies our notion of error states across different parts of the application. This encapsulates the different types of errors that can happen so we can explicitly handle those scenarios and can avoid generic 500 errors as much as possible. We also use this type to translate errors from other libraries to our own domain specific error type.</p>

<p>We create a new file at <code>src/errors.rs</code> which corresponds to the <code>mod errors;</code> statement in our root module. Let’s first add some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="n">error</code>::<code class="n">BlockingError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="n">web</code>::<code class="n">HttpResponse</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">result</code>::<code class="n">DatabaseErrorKind</code>::<code class="n">UniqueViolation</code><code class="p">;</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">result</code>::<code class="n">Error</code>::<code class="p">{</code><code class="n">DatabaseError</code><code class="p">,</code><code class="w"> </code><code class="n">NotFound</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fmt</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We are going to translate some <code>actix_web</code>errors and some <code>diesel</code> errors to our own custom type, so we bring in some types to reduce the amount of noise when refering to those errors. We are also going to describe how our error type can be converted into an HTTP response so we pull in parts of <code>actix_web</code> that are convenient for that purpose. Finally, we bring in the <code>std::fmt</code> module because we are going to implement a trait from within that module for our error type.</p>

<p>There are multiple ways of representing errors in Rust including a number of crates that make the definition of an error type easier. However, we are going to take the straightforward route of creating an <code>enum</code> for our error type. In this context encountering an error means we enter one of a small number of states where we want to return an error code and a message instead of continuing to process the request. This is a natural use case for an enumerated type. We define the type as:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 7 </code><code class="cp">#[derive(Debug)]</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code> <code class="nc">AppError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">RecordAlreadyExists</code><code class="p">,</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="n">RecordNotFound</code><code class="p">,</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">DatabaseError</code><code class="p">(</code><code class="n">diesel</code>::<code class="n">result</code>::<code class="n">Error</code><code class="p">),</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">OperationCanceled</code><code class="p">,</code><code class="w"></code>
<code class="lineno">13 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>These are the only error states that we going to explicitly handle. As you build up your application and rely on more libraries that could fail you can add variants to this type to capture those errors if you want to deal with them this way. It is also possible to handle errors directly and not use this machinery which will allow us to return early with a custom status code and message.</p>

<p>The first two variants relate to errors returned from Diesel that we convert into easier to work with variants. We also have a catch-all <code>DatabaseError</code> for other Diesel errors that we don’t specifically handle. We use a tuple struct to capture the underlying Diesel error for later use. Finally, <code>OperationCanceled</code> is related to a <code>actix_web</code> error having to do with an async operation which we will explain later.</p>

<p>First we will implement the <code>fmt::Display</code> trait for our type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">15 </code><code class="k">impl</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Display</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">AppError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">fmt</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">f</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Formatter</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">fmt</code>::<code class="nb">Result</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">RecordAlreadyExists</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"This record vio\</code>
<code class="lineno">19 </code><code class="s">lates a unique constraint"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">RecordNotFound</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"This record does not\</code>
<code class="lineno">21 </code><code class="s"> exist"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">DatabaseError</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Database error: {:\</code>
<code class="lineno">23 </code><code class="s">?}"</code><code class="p">,</code><code class="w"> </code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">OperationCanceled</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"The running opera\</code>
<code class="lineno">25 </code><code class="s">tion was canceled"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">28 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We automatically implemented the <code>Debug</code> trait with the <code>derive</code> attribute on our struct which allows us to format instances of our type with the debug string formatter: <code>{:?}</code>. Implementing <code>Display</code> let’s us print our type with <code>{}</code>. We must implement this trait because a different trait we want to implement requires <code>Debug</code> and <code>Display</code> to be implemented.</p>

<p>The implementation is pretty straightforward and most implementations of <code>Display</code> look like this. The macro <code>write!</code> is like <code>println!</code> except the first argument is a “Writer” and it returns a <code>Result</code> in the case of an error. The <code>println!</code> macro can panic in certain error scenarios rather than returning a <code>Result</code>. The <code>&amp;mut fmt::Formatter</code> argument implements a trait that makes it a “Writer” so typically you just use <code>write!(f, ...)</code> and fill in the <code>...</code> with whatever you want to represent your type when it is formatted using <code>{}</code>.</p>

<h5 id="leanpub-auto-from-and-into">From and Into</h5>

<p>Rust usually does not implicit convert one type to another, but there is a mechanism for telling Rust how to convert between types which you can opt in to. There are two related traits: <code>From</code> and <code>Into</code>. You must explicitly implement one of these traits to be able to take advantage of some automatic type conversions. The other trait you do not implement can be derived as the two traits are, in a sense, inverses of each other. In the standard library and most code you will encounter only <code>From</code> is implemented and then <code>Into</code> is automatically satisfied for free.</p>

<p>One place that uses <code>From</code> is the <code>?</code> operator for early returning the <code>Err</code> variant of a <code>Result</code>. That is if the error that would be returned is type <code>X</code> and the expected return type is <code>Y</code> then you can still use the <code>?</code> operator if <code>Y</code> implements <code>From&lt;X&gt;</code>.</p>

<p>We are going to use this trait with our <code>AppError</code> type by implementing <code>From&lt;X&gt;</code> for a couple different values of <code>X</code> so that the <code>?</code> operator works without having to explicitly convert errors. The first conversion we are going to implement is for database errors:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">26 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">diesel</code>::<code class="n">result</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">AppError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">e</code>: <code class="nc">diesel</code>::<code class="n">result</code>::<code class="n">Error</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">e</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">            </code><code class="n">DatabaseError</code><code class="p">(</code><code class="n">UniqueViolation</code><code class="p">,</code><code class="w"> </code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">AppError</code>::<code class="n">RecordAlread</code><code class="err">\</code><code class="w"></code>
<code class="lineno">30 </code><code class="n">yExists</code><code class="p">,</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">            </code><code class="n">NotFound</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">AppError</code>::<code class="n">RecordNotFound</code><code class="p">,</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">AppError</code>::<code class="n">DatabaseError</code><code class="p">(</code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">35 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>So <code>From&lt;diesel::result::Error&gt; for AppError</code> means that you will be given an instance of <code>diesel::result::Error</code> and are expected to return an instance of <code>AppError</code>. We match on the Diesel error to handle the two specific cases we care about.</p>

<p>We see here the types that we imported from Diesel, in particular, when a unique constraint is violated at the database level, Diesel will convert this into a <code>DatabaseError(UniqueViolation, _)</code> where the <code>_</code> represents more data that we don’t care about. We just care that whatever query we executed resulted in this specific type of error. We convert that to our <code>RecordAlreadyExists</code> variant as we will only get unique constraint violations when we try to insert a record that already exists based on what we have defined to be unique. Specifically, we have set a unique constraint on username so trying to insert two users with the same username will result in this <code>RecordAlreadyExists</code> error being created.</p>

<p>The second case is when we try to get a record from the database that does not exist. Diesel will return a <code>NotFound</code> error which we just turn into our variant with basically the same name.</p>

<p>Finally, the catch all case in the match statement means Diesel encountered an error other than these two and the only thing we know how to do is call it a <code>DatabaseError</code> and capture the underlying error if we maybe want to do something with it later. This is useful for debugging.</p>

<p>The encapsulation here means that we do not have to have any code destructing Diesel errors anywhere else in our code. We can just convert any Diesel error into our <code>AppError</code> and then only deal with that type in our code. This layer of abstraction allows us to reduce the surface area of necessary changes if we decide to change how we handle database errors across the entire application.</p>

<p>The next type we want to convert into our custom type is <code>BlockingError&lt;AppError&gt;</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">36 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">BlockingError</code><code class="o">&lt;</code><code class="n">AppError</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">AppError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">e</code>: <code class="nc">BlockingError</code><code class="o">&lt;</code><code class="n">AppError</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">e</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">            </code><code class="n">BlockingError</code>::<code class="n">Error</code><code class="p">(</code><code class="n">inner</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">inner</code><code class="p">,</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">            </code><code class="n">BlockingError</code>::<code class="n">Canceled</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">AppError</code>::<code class="n">OperationCanceled</code><code class="p">,</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">43 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p><code>BlockingError&lt;T&gt;</code> is an actix web specific error that we will encounter when we get to the implementation of our handlers. We use this From` to do what is clearly a simple conversion lest we have to include code like this in every handler. Our handlers will return futures but we must use blocking code to interact with the database. Therefore our handlers will run blocking code which can either succeed or can fail because the future was canceled or the underlying blocking code returned an error.</p>

<h5 id="leanpub-auto-errors-as-responses">Errors as responses</h5>

<p>The main advantage of creating our own error type is that we define how to turn an instance of <code>AppError</code> into an HTTP response and therefore automatically get nice error responses by just returning an error from a handler. As we are writing a JSON API, let’s create a struct to represent a JSON error response:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">45 </code><code class="cp">#[derive(Debug, Serialize)]</code><code class="w"></code>
<code class="lineno">46 </code><code class="k">struct</code> <code class="nc">ErrorResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">    </code><code class="n">err</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">48 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>JSON APIs should return JSON content or nothing as their error. Some APIs strangely return HTML data when errors occur because their framework does this by default. Don’t write an API like that. We instead will return an object with one key <code>err</code> and a string value. You can make your own decision about how much or little information to return as part of an erroneous request.</p>

<p>Actix web defines a trait <code>ResponseError</code> which allows you to specify how the type inside a <code>Err</code> variant of a <code>Result</code> gets turned into a response. Let’s implement it for <code>AppError</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">50 </code><code class="k">impl</code><code class="w"> </code><code class="n">actix_web</code>::<code class="n">ResponseError</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">AppError</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">error_response</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HttpResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">err</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">);</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">RecordAlreadyExists</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">HttpResponse</code>::<code class="n">BadRequest</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">            </code><code class="n">AppError</code>::<code class="n">RecordNotFound</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">HttpResponse</code>::<code class="n">NotFound</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">HttpResponse</code>::<code class="n">InternalServerError</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">        </code><code class="p">};</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">        </code><code class="n">builder</code><code class="p">.</code><code class="n">json</code><code class="p">(</code><code class="n">ErrorResponse</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">err</code><code class="w"> </code><code class="p">})</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">60 </code>
<code class="lineno">61 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">render_response</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HttpResponse</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">        </code><code class="bp">self</code><code class="p">.</code><code class="n">error_response</code><code class="p">()</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">64 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This trait is why we implemented <code>Display</code> for our error. First <code>ResponseError</code> has the trait bound <code>Debug + Display</code> which means that in order to implement <code>ResponseError</code> for your type, your type must also implement <code>Debug</code> and <code>Display</code>.</p>

<p>The trait requires <code>error_response</code> to be implemented which we do by matching on our error and setting useful response codes to the cases we care about and 500 otherwise, and then using the <code>Display</code> formatting to create an error message to return as JSON.</p>

<p>The trait also has a method <code>render_response</code> which has a default implementation, but the default overrides the content type and data which is not what we want. So we instead just implement this method to return the same thing as our <code>error_response</code> method which is what we want. When we get to our handler implementations we will see where this is called.</p>

<h4 id="leanpub-auto-models">Models</h4>

<p>The next module we are going to implement will be our layer that contains the interactions with the database. We will define the Rust representations of our data model as well as functions for how to get those objects from the database. To get started we pull in some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">AppError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">schema</code>::<code class="p">{</code><code class="n">users</code><code class="p">};</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">prelude</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>As we are going to be working with the database we pull in the Diesel prelude and we also bring in the <code>users</code> item from the autogenerated schema. We shall see how this is used to refer to different parts of the <code>users</code> database table.</p>

<p>In order to make our lives easier we are going to define our own <code>Result</code> type which will be an alias for <code>Result</code> in the standard library with the error type fixed as our <code>AppError</code> type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">5 </code><code class="k">type</code> <code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">std</code>::<code class="n">result</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>This way we can just return <code>Result&lt;T&gt;</code> and not have to writen <code>AppError</code> everywhere because throughout this module all errors will be of the <code>AppError</code> type so it is just noisy to have to write it everywhere.</p>

<h5 id="leanpub-auto-user-struct">User struct</h5>

<p>We need a Rust struct to represent a user in the database. We create the struct just like any other:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 7 </code><code class="cp">#[derive(Queryable, Identifiable, Serialize, Debug, PartialEq)]</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">User</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">username</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">11 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our users have <code>id</code>s which are <code>i32</code> because that maps to the database integer type and a <code>username</code> which is a <code>String</code> because the database column is a <code>VARCHAR</code>. We have seen the <code>Serialize</code>, <code>Debug</code>, and <code>PartialEq</code> trait derives before so we will not belabor those here, but <code>Queryable</code> and <code>Identifiable</code> are new.</p>

<p><code>Queryable</code> is a trait that indicates this struct can be constructed from a database query. From the Diesel docs:</p>

<blockquote>
  <p>Diesel represents the return type of a query as a tuple. The purpose of this trait is to convert from a tuple of Rust values that have been deserialized into your struct</p>
</blockquote>

<p>So basically by deriving this trait we can automatically get a <code>User</code> struct from queries of the <code>users</code> table.</p>

<p><code>Identifiable</code> is a trait that indicates that this struct represents a single row in a database table. It assumes a primary key named <code>id</code> but you can configure the derive attribute if you want to change the name of the primary key. It is required for associations which we will use later.</p>

<h5 id="leanpub-auto-create-user">Create User</h5>

<p>We have our model defined, let’s get into actually talking to the database to create a user:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">13 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">create_user</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"> </code><code class="n">username</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">U</code><code class="err">\</code><code class="w"></code>
<code class="lineno">14 </code><code class="n">ser</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">conn</code><code class="p">.</code><code class="n">transaction</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">        </code><code class="n">diesel</code>::<code class="n">insert_into</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">            </code><code class="p">.</code><code class="n">values</code><code class="p">((</code><code class="n">users</code>::<code class="n">username</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">username</code><code class="p">),))</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">            </code><code class="p">.</code><code class="n">execute</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="w">        </code><code class="n">users</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">            </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">))</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">26 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our function takes a SqliteConnection and a username string and returns either a User or an error. This function does not have to worry about where to get a database connection it simply assumes one and this let’s us then interact with the database.</p>

<p>This code is slightly more complex because we are using Sqlite instead of a backend that supports a <code>RETURNING</code> clause. Sqlite does not support getting the <code>id</code> of a just inserted row as part of the insert statement. Instead we have to do another query to actually get the data back out to build a <code>User</code> struct. Because of this we run both queries inside a transaction to ensure that the logic of fetching the most recently inserted user actually returns the user that we just inserted. There are other approaches we could take to achieve the same end.</p>

<p>The connection type supports a method <code>transaction</code> which takes a closure. The closure must return a <code>Result</code>. If the <code>Result</code> is the error variant then the transaction is rolled back and the error result is returned. If instead we have the <code>Ok</code> variant then the transaction is committed and the successful result is returned.</p>

<p>Our first Diesel statement involves inserting a user with the supplied username into the <code>users</code> table. The nice thing about Diesel is that the code for doing this is readable and mostly self explanatory. The imported <code>users</code> item from the schema has an item for each column on the table as well as an item for the table as a whole, i.e. <code>users::table</code>. There is a lot of machinery going on in the background to ensure that the types are correct based on what the database represents. Each database column has a unique type so you catch at compile time if you tried to insert the wrong type into a column rather than at runtime.</p>

<p>The <code>execute</code> method on the query builder returns a <code>Result</code> with the error being the Diesel specific error type. We can use the <code>?</code> operator here and return a <code>Result</code> with our <code>AppError</code> error type because of our <code>From</code> implementation in our errors module.</p>

<p>The second statement inside the transaction is fetching a single user from the database. We create a query where we order by descending <code>id</code> to get the most recently inserted row. As this is inside a transaction this select will execute logically after the insertion and therefore this will be the user we just inserted. We specify with the <code>select</code> method what columns we want in a tuple, in this case <code>id</code> and <code>username</code>. The <code>first</code> method tells Diesel to do a <code>LIMIT 1</code> and expect a single result. This therefore returns a <code>Result</code> with the successful variant being the resulting record or a not found error. The return type of our function is what gives Diesel enough information to convert the tuple that is returned into our <code>User</code> struct in addition to the fact that we derived <code>Queryable</code>.</p>

<p>Finally we call <code>map_err(Into::into)</code> which is a bit of a magical incantation. As we cannot use the <code>?</code> operator here to return our <code>Result</code> we have to explicitly convert the Diesel error type to our <code>AppError</code> to match the function signature. Rust does not automatically do this type conversion, however we can still use the type signature to help us. <code>map_err</code> is a method on <code>Result</code> which transforms the error variant with the supplied function and returns the success variant as is. We can pass the function <code>Into::into</code> to <code>map_err</code> and this uses the function signature to determine what to transform the error into. Furthermore, we can use <code>Into</code> here because we implemented <code>From</code> and <code>Into</code> gets implemented automatically.</p>

<h5 id="leanpub-auto-fetching-a-user">Fetching a user</h5>

<p>We can create users but this is not so fun unless we can also fetch a user from the database. We have two ways to identify a user: by <code>id</code> and by username. Rather than write two different functions for these use cases we are going to write one function which takes an enum that encapsulates which key to use for looking up the user. To this end, let’s define an enum representing this key:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">27 </code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code> <code class="nc">UserKey</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">    </code><code class="n">Username</code><code class="p">(</code><code class="o">&amp;</code><code class="na">'a</code><code class="w"> </code><code class="kt">str</code><code class="p">),</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="n">ID</code><code class="p">(</code><code class="kt">i32</code><code class="p">),</code><code class="w"></code>
<code class="lineno">30 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our enum is either an <code>ID</code> which holds an <code>i32</code> for looking up by the primary key or a <code>Username</code> which holds a reference to a string. We have seen the <code>'static</code> lifetime before but this is our first instance of a generic lifetime for a type we are creating.</p>

<p>As a referesher, lifetimes of references in Rust are checked by the compiler to ensure that the data referenced outlives the reference to it. In other words, the concept of lifetimes guarantees that we will not try to access memory after it has been deallocated while still being able to have access to data that we do not own. Lifetimes live in the same space as generic types and can be thought of as a kind of type. Here our type <code>UserKey&lt;'a&gt;</code> specifies that it has one generic lifetime parameter named <code>'a</code>. We need to specify this generic parameter so that we can give a definite lifetime to the string reference inside our <code>Username</code> variant.</p>

<p>Any composite type with a reference inside must declare a lifetime on that reference otherwise there is no way for the compiler to make any guarantees about the liveness of the underlying data. It is possible to use the special lifetime <code>'static</code> and not make our enum generic but that would force us to only be able to use static strings.</p>

<p>A different approach would be to declare the <code>Username</code> variant as <code>Username(String)</code>. This would most likely be just fine in this instance even if it resulted in an extra heap allocation (which depending on where we get the username from may or may not be required). However, making that decision at each juncture can lead to death by a thousand allocations. Instead, Rust gives you the tools to avoid the extra allocation while maintaining memory safety by ensuring that our reference is alive for at least as long as necessary.</p>

<p>Newcomers to Rust often use <code>String</code> and <code>clone</code> in many places that are unnecessary with just a bit of extra work after having been scarred by the borrow checker early on. Do not have a fear of heap allocations, but if you take a little extra time you might be surprised how many you can avoid by working with the compiler.</p>

<p>Now that we have a notion of a key to lookup a user by, we can write our function to actually get the user:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">32 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">find_user</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"> </code><code class="n">key</code>: <code class="nc">UserKey</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Resu</code><code class="err">\</code><code class="w"></code>
<code class="lineno">33 </code><code class="n">lt</code><code class="o">&lt;</code><code class="n">User</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="n">UserKey</code>::<code class="n">Username</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">users</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">            </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">users</code>::<code class="n">username</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">name</code><code class="p">))</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">))</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code>::<code class="o">&lt;</code><code class="n">User</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="n">AppError</code>::<code class="n">from</code><code class="p">),</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="n">UserKey</code>::<code class="n">ID</code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">users</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">            </code><code class="p">.</code><code class="n">find</code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">))</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code>::<code class="o">&lt;</code><code class="n">User</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">),</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">46 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We match on our key to decide which query to run. If we have a username then we do a filter by username equal to the value passed in. If we have an <code>id</code>, then we can use the special <code>find</code> function which attempts to find a single record based on the primary key for that table. Both queries use <code>first</code> to execute the query which as we said before either returns one instance of the type we are trying to return or returns a not found error.</p>

<h4 id="leanpub-auto-routes">Routes</h4>

<p>Finally we are ready to get to our functions for handling requests by building out our third module, routes. This module is different than the rest in that it will have submodules. We create a <code>src/routes.rs</code> file which will be the entry point for the module, and then submodules will live inside a directory named <code>routes</code>.</p>

<p>Let’s get some preliminaries out of the way for the base <code>routes</code> module before moving on to the <code>users</code> submodule. First, some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">AppError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="n">HttpResponse</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we declare the users submodule:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">pub</code><code class="p">(</code><code class="k">super</code><code class="p">)</code><code class="w"> </code><code class="k">mod</code> <code class="nn">users</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>This is similar to what we saw in the root module where we declared our other modules, e.g. <code>mod routes;</code>, however we also have the funny looking <code>pub(super)</code>.</p>

<p>You can declare an item as public with <code>pub</code> then it can be accessed externally from any module that can access all of the item’s parent modules. If you want to restrict the visibility of an item to a specific scope then you can use one of <code>pub(in path)</code>, <code>pub(crate)</code>, <code>pub(super)</code>, or <code>pub(self)</code>, where <code>path</code> is a given module path. The visibility you choose depends on if and how you want an item to be exposed above the current module.</p>

<p>The module above <code>routes</code> is our root module at <code>src/lib.rs</code>. We want that module to be able to refer to the <code>users</code> module. However we do not want say our <code>models</code> module to be able to refer to the <code>users</code> module. So we restrict the visibility of the <code>users</code> module to only the module one step up in the hierarchy.</p>

<p>There is quite a bit of power in the Rust module system and for a long time it caused some confusion. The current system has been reworked to address some of that confusion. When you write a library it is important to decide what you really want to expose and be able to hide the rest as implementation details. Rust gives quite a bit of flexibilty in this regard and it is one of the features that makes growing Rust codebases more manageable.</p>

<aside>
  <p><code>pub(self)</code> is equivalent to nothing at all, i.e. <code>pub(self) mod foo</code> is the same as <code>mod foo</code> which is actually private. Why? The answer lies in macros that can generate code with visibility specifiers. If a macro outputs code like <code>pub($arg)</code> where <code>$arg</code> is an input argument, you might want to specify that the item should be private, so passing <code>self</code> as the argument achieves that goal.</p>

</aside>

<p>The last part of our base routes module is a generic function which we will use to eliminate some repetitive code in our handlers:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 6 </code><code class="k">fn</code> <code class="nf">convert</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">E</code><code class="o">&gt;</code><code class="p">(</code><code class="n">res</code>: <code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">E</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="k">where</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="n">T</code>: <code class="nc">serde</code>::<code class="n">Serialize</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">AppError</code>: <code class="nb">From</code><code class="o">&lt;</code><code class="n">E</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">10 </code><code class="p">{</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">res</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">d</code><code class="o">|</code><code class="w"> </code><code class="n">HttpResponse</code>::<code class="nb">Ok</code><code class="p">().</code><code class="n">json</code><code class="p">(</code><code class="n">d</code><code class="p">))</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">13 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This function takes some generic result and returns another result with fixed types which will end up being nice to return from our handler functions. We turn the success variant into a successful HTTP response with the data serialized as JSON. The error variant is turned into our <code>AppError</code> type which due to the work we did earlier can be returned from a handler and will result in a proper response with the relevant status code and JSON error message.</p>

<p>Now we can’t just serialize any type into JSON nor can we convert any type to our <code>AppError</code>. We put trait bounds on the generic parameters to specify that we can only accept input arguments if the success variant is a type that can be serialized to JSON, i.e. <code>T: serde::Serialize</code>, and we can get an <code>AppError</code> from the error variant, i.e. <code>AppError: From&lt;E&gt;</code>. The syntax using the <code>where</code> after the function signature is sometimes necessary for complex trait bounds and is always possible to use. The other format of trait bound is directly in the specification of the names of the generic parameters between the name of the function and the opening parenthesis.</p>

<p>Given those trait bounds the implementation is pretty simple. We take the result and call map which operates only on the success variant and builds a response. The <code>json</code> method on the response builder just requires that the argument passed can be serialized with Serde which is true given our bound. We chain with this call the invocation of <code>map_err</code> which operates only on the error variant. Here we rely on our <code>From</code> implementation and that definition of <code>Into::into</code> and this works because of the trait bound and the specified return type.</p>

<h4 id="leanpub-auto-routes-for-a-user">Routes for a user</h4>

<p>Let’s create our user module at <code>src/routes/users.rs</code> to fill in the module specified in our base routes module. First, as usual, some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">AppError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">routes</code>::<code class="n">convert</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="p">{</code><code class="n">models</code><code class="p">,</code><code class="w"> </code><code class="n">Pool</code><code class="p">};</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">futures</code>::<code class="n">Future</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Note that our <code>convert</code> function in the routes module was not public but we are using it here. Private items are visible to the module they are defined in as well as all descendants.</p>

<h5 id="leanpub-auto-create-a-user">Create a user</h5>

<p>Our first handler is going to take a username as input and attempt to create a user. As we have seen before, we create a struct to represent the input data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">13 </code><code class="cp">#[derive(Debug, Serialize, Deserialize)]</code><code class="w"></code>
<code class="lineno">14 </code><code class="k">struct</code> <code class="nc">UserInput</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">username</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>As we derive <code>Deserialize</code> we will be able to accept this type as a JSON post body. We are now in place to write our handler:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">18 </code><code class="k">fn</code> <code class="nf">create_user</code><code class="p">(</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="n">item</code>: <code class="nc">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">UserInput</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">username</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">item</code><code class="p">.</code><code class="n">into_inner</code><code class="p">().</code><code class="n">username</code><code class="p">;</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">        </code><code class="n">models</code>::<code class="n">create_user</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">username</code><code class="p">.</code><code class="n">as_str</code><code class="p">())</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">28 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We need the input data as the JSON body of the request and we need a handle to our database pool which we put inside our application state back in our application factory. The return type is new so let’s unpack it.</p>

<p><code>Future&lt;Item, Error&gt;</code> is a future in the traditional sense, an object that represents a computation which can be queried for a result or an error. This is a standard approach to writing asynchronous code where you return immediately some value that represents a computation rather than doing the computation before returning. Eventually the future resolves to a result or an error when the computation completes. Actix web is designed to work with both synchronous and asynchronous handlers, but so far we have only used the synchronous ones.</p>

<p>The syntax <code>impl Future</code> means that we are going to return some type that implements the <code>Future</code> trait, but we are not telling you exactly what that type is. This gives us some flexibilty and is necessary for some types which are hard (or impossible) to write.</p>

<p>As <code>Future</code> is a generic trait, we must fix the <code>Item</code> and <code>Error</code> types that are otherwise generic so that the return type is fully specified. The <code>Item</code> is the type that the future resolves to in a successful case. The <code>Error</code> is self explanatory. We want to return an <code>HttpResponse</code> in the successful case and our <code>AppError</code> in the other case.</p>

<p>Given all of the pieces we have built to get here, the handler itself is pretty straightforward. We get a connection to the database out of the pool. We get the username from the input data. Given those two values we can use our <code>create_user</code> function in the <code>models</code> module to do the work. But what is <code>web::block</code>?</p>

<p>Diesel is synchronous, it does not directly support futures for interacting with the database. Therefore we use <code>web::block</code> which executes a blocking function on a thread pool and returns a future that resolves to the result of the function execution.</p>

<p>Finally, we can use our <code>convert</code> function to turn the result of the call to <code>models::create_user</code> into the response we desire. Note that here we see why we implemented <code>From&lt;BlockingError&lt;AppError&gt;&gt;</code> for our <code>AppError</code> type. The <code>map_err</code> function inside <code>convert</code> relies on that <code>From</code> implementation.</p>

<h5 id="leanpub-auto-find-a-user">Find a user</h5>

<p>We have two ways to find a user, by username or by id. Let’s create a handler called <code>find_user</code> which implements the lookup by username:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">30 </code><code class="k">fn</code> <code class="nf">find_user</code><code class="p">(</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">    </code><code class="n">name</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">33 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">name</code><code class="p">.</code><code class="n">into_inner</code><code class="p">();</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">models</code>::<code class="n">UserKey</code>::<code class="n">Username</code><code class="p">(</code><code class="n">name</code><code class="p">.</code><code class="n">as_str</code><code class="p">());</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="n">models</code>::<code class="n">find_user</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">)</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">41 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The structure is pretty similar to our previous handler. This will be a GET request so we expect the username to be a string in the path. We have to create a <code>UserKey::Username</code> and then call our <code>models::find_user</code> function to do the work. The rest of the handler structure is the same as before.</p>

<p>Let’s create <code>get_user</code> which does the lookup by id:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">43 </code><code class="k">fn</code> <code class="nf">get_user</code><code class="p">(</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="n">user_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">46 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">id</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">user_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">();</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">models</code>::<code class="n">UserKey</code>::<code class="n">ID</code><code class="p">(</code><code class="n">id</code><code class="p">);</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">        </code><code class="n">models</code>::<code class="n">find_user</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">)</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">54 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is basically the same thing except we expect an <code>i32</code> in the path instead of a string and we create the other variant of the <code>UserKey</code> enum.</p>

<h4 id="leanpub-auto-wiring-the-routes-up">Wiring the routes up</h4>

<p>Recall the configuration of our app inside the application factory in <code>src/lib.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">34 </code><code class="w">            </code><code class="n">App</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">                </code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">pool</code><code class="p">.</code><code class="n">clone</code><code class="p">())</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">                </code><code class="p">.</code><code class="n">wrap</code><code class="p">(</code><code class="n">middleware</code>::<code class="n">Logger</code>::<code class="n">default</code><code class="p">())</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">                </code><code class="p">.</code><code class="n">configure</code><code class="p">(</code><code class="n">routes</code>::<code class="n">users</code>::<code class="n">configure</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>We call <code>configure</code> on the application builder with <code>routes::users::configure</code>. Let’s define that function to get our user routes all hooked up:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/users.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 7 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">configure</code><code class="p">(</code><code class="n">cfg</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">web</code>::<code class="n">ServiceConfig</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="n">cfg</code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/users"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">crea</code><code class="err">\</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="n">te_user</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">        </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/users/find/{name}"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="n">t</code><code class="err">\</code><code class="w"></code>
<code class="lineno">11 </code><code class="n">o_async</code><code class="p">(</code><code class="n">find_user</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">        </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/users/{id}"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="n">to_async</code><code class="err">\</code><code class="w"></code>
<code class="lineno">13 </code><code class="p">(</code><code class="n">get_user</code><code class="p">)));</code><code class="w"></code>
<code class="lineno">14 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The signature of this function is specified by Actix web. The only parameter is a mutable reference to a service configuration object. We saw in our earlier apps that we can create services that map URLs to routes which have methods and handlers. The object passed to us here allows for that exact same style of configuration.</p>

<p>We define three routes:</p>

<ul>
  <li>POST <code>/users</code> which calls <code>create_user</code>
</li>
  <li>GET <code>/users/find/{name}</code> which calls <code>find_user</code>
</li>
  <li>GET <code>/users/{id}</code> which calls <code>get_user</code>
</li>
</ul>

<p>We use <code>to_async</code> to specify the handlers here because our handlers return futures rather than <code>to</code> that we used before with synchronous handlers.</p>

<h3 id="leanpub-auto-examples">Examples</h3>

<p>We can test things out by running <code>cargo run</code> in one terminal and then using <code>curl</code> to try the endpoints that we just created.</p>

<h4 id="leanpub-auto-create-a-new-user">Create a new user</h4>

<p>The most basic functionality is posting JSON data to create a new user:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/users -d <code class="s1">'{"username":"Frank"}'</code>

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"username"</code>: <code class="s2">"Frank"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-create-another-new-user">Create another new user</h4>

<p>We can create yet another user and see that the auto incrementing ids in our database do what we expect:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/users -d <code class="s1">'{"username":"Bob"}'</code>

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">2</code>,
  <code class="s2">"username"</code>: <code class="s2">"Bob"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-create-a-new-user-already-exists">Create a new user already exists</h4>

<p>Let’s see all of our error handling working by trying to create a user with a duplicate username:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> -X POST http://localhost:89<code class="se">\</code>
<code class="m">98</code>/users -d <code class="s1">'{"username":"Bob"}'</code>

<code class="o">{</code>
  <code class="s2">"err"</code>: <code class="s2">"This record violates a unique constraint"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-lookup-user-by-name">Lookup user by name</h4>

<p>The next handler we created was to lookup a user by their username:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/users<code class="se">\</code>
/find/Frank

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"username"</code>: <code class="s2">"Frank"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-lookup-user-by-primary-key">Lookup user by primary key</h4>

<p>We should also be able to get a user by primary key:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/users<code class="se">\</code>
/1

<code class="o">{</code>
  <code class="s2">"id"</code>: <code class="m">1</code>,
  <code class="s2">"username"</code>: <code class="s2">"Frank"</code>
<code class="o">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-lookup-user-by-name-that-doesnt-exist">Lookup user by name that doesn’t exist</h4>

<p>Again we can see our error handling working by trying to find a user that we did not create:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>curl -s -H <code class="s1">'Content-Type: application/json'</code> http://localhost:8998/users<code class="se">\</code>
/find/Steve

<code class="o">{</code>
  <code class="s2">"err"</code>: <code class="s2">"This record does not exist"</code>
<code class="o">}</code>
</pre></div>

</figure>

<p>Note that you can add the <code>-v</code> flag to Curl to see that status code for this response is 404 as a consequence of our implementation of <code>ResponseError</code> for <code>AppError</code>.</p>

<h3 id="leanpub-auto-extending-our-application">Extending our application</h3>

<p>We have built quite a lot of parts that allows us to post some JSON data to create a user record and fetch users by username or primary key. With those pieces in place we can now easily add posts and comments. Posts are going to be our next step.</p>

<h4 id="leanpub-auto-extending-the-data-model">Extending the data model</h4>

<p>The first step in adding a new data model is to modify our schema to support the new model. Let’s get Diesel to generate a migration for us:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration generate create_posts
</pre></div>

</figure>

<p>We can then add the necessary SQL for creating a posts table to <code>up.sql</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-030252_create_posts/up.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">posts</code> <code class="p">(</code>
<code class="lineno">2 </code>  <code class="n">id</code> <code class="nb">INTEGER</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
<code class="lineno">3 </code>  <code class="n">user_id</code> <code class="nb">INTEGER</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">REFERENCES</code> <code class="n">users</code> <code class="p">(</code><code class="n">id</code><code class="p">),</code>
<code class="lineno">4 </code>  <code class="n">title</code> <code class="nb">VARCHAR</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
<code class="lineno">5 </code>  <code class="n">body</code> <code class="nb">TEXT</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
<code class="lineno">6 </code>  <code class="n">published</code> <code class="nb">BOOLEAN</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="mi">0</code>
<code class="lineno">7 </code><code class="p">)</code>
</pre></div>

</figure>

<p>Posts have a title and a body and a boolean specifying whether they are published or not. They also have a reference to a user which represents the author of the post. This syntax is particular to Sqlite so if you are using a different database this will have to change.</p>

<p>We also need to include the reverse of this migration in the corresponding <code>down.sql</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-030252_create_posts/down.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">posts</code>
</pre></div>

</figure>

<p>Let’s have Diesel run the migrations with <code>diesel migration run</code>. This command will modify the schema of the database as well as update our schema module to:</p>

<figure class="code" dir="ltr">
  <figcaption>src/schema.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="n">posts</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="w">        </code><code class="n">user_id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="w">        </code><code class="n">title</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="w">        </code><code class="n">body</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">        </code><code class="n">published</code><code class="w"> </code>-&gt; <code class="nc">Bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">10 </code>
<code class="lineno">11 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">users</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">        </code><code class="n">username</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">16 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">17 </code>
<code class="lineno">18 </code><code class="n">joinable</code><code class="o">!</code><code class="p">(</code><code class="n">posts</code><code class="w"> </code>-&gt; <code class="nc">users</code><code class="w"> </code><code class="p">(</code><code class="n">user_id</code><code class="p">));</code><code class="w"></code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="n">allow_tables_to_appear_in_same_query</code><code class="o">!</code><code class="p">(</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">    </code><code class="n">posts</code><code class="p">,</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="n">users</code><code class="p">,</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>The users table stays the same and the posts table appears as we would expect, however there are some new bits. First we see the <code>joinable!</code> macro which says sets up the necessary Rust types to allow posts and users to be joined. This is inferred from the database schema because of the foreign key specification in our migration, i.e. <code>REFERENCES users (id)</code>.</p>

<p>There are debates about foreign key constraints in the database for certain data models and access patterns, but most of the time you want to let the database do what it is good at and enforce those invariants. Moreover, you get the automatic relationship mapping in Diesel if you specify the relationship at the database level.</p>

<p>The other new piece is the macro <code>allow_tables_to_appear_in_same_query!</code>. This is because we have more than one table now. It generates code that allows types from different tables to be mixed in the same query which is necessary for doing joins and sub-selects. It is not really necessary to understand the details of these macros to work with Diesel as it does the right thing most of the time. In exceptional circumstances you can consult the Diesel docs to find out more about the schema definitions.</p>

<h4 id="leanpub-auto-post-model">Post model</h4>

<p>We are going to expand on our models module. An alternative approach could be to split the models module into submodules for each model type similar to how we split routes into submodules. Where to draw these organizational lines is a matter of preference. For the models we decide on the single module approach because it makes working with the relationships between models a little bit simpler.</p>

<p>Our first step is to import posts from the generated schema:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">schema</code>::<code class="n">posts</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we can introduce a struct that represents one post row in the database:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">15 </code><code class="cp">#[derive(Queryable, Associations, Identifiable, Serialize, Debug)]</code><code class="w"></code>
<code class="lineno">16 </code><code class="cp">#[belongs_to(User)]</code><code class="w"></code>
<code class="lineno">17 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Post</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">title</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">published</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Our database schema is directly translated to Rust types where each field is a column of the appropriate type. Note that the not null constraints we specified in our migration on each column is why we use types directly rather than wrapping them in <code>Option</code>. If we allowed nulls for some column then the type would have to be optional in Rust. We have also seen all of the traits that we are deriving before except for <code>Associations</code>, and the <code>belongs_to</code> attribute is new as well.</p>

<p>The concept of an association in Diesel is always from child to parent, i.e. there is no “has many” like in other ORMs. Declaring the association between two records requires the <code>belongs_to</code> attribute on the child and specifies the name of the struct that represents the parent. The <code>belongs_to</code> attribute accepts a <code>foreign_key</code> argument if the relevant foreign key is different from <code>table_name_id</code>. Both the parent and child must implement the <code>Identifiable</code> trait which we satisfy by deriving it. Finally, in addition to the <code>belongs_to</code> annotation, the struct also needs to derive <code>Associations</code>. Deriving this trait uses the information in <code>belongs_to</code> to generate the relevant code to make joins possible.</p>

<h5 id="leanpub-auto-creating-a-post">Creating a post</h5>

<p>Let’s now write the functions to work with posts in the database starting with creating one:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">49 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">create_post</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"> </code><code class="n">user</code>: <code class="kp">&amp;</code><code class="nc">User</code><code class="p">,</code><code class="w"> </code><code class="n">title</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">b</code><code class="err">\</code><code class="w"></code>
<code class="lineno">50 </code><code class="n">ody</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">Post</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="n">conn</code><code class="p">.</code><code class="n">transaction</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">        </code><code class="n">diesel</code>::<code class="n">insert_into</code><code class="p">(</code><code class="n">posts</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">            </code><code class="p">.</code><code class="n">values</code><code class="p">((</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">                </code><code class="n">posts</code>::<code class="n">user_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">user</code><code class="p">.</code><code class="n">id</code><code class="p">),</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">                </code><code class="n">posts</code>::<code class="n">title</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">title</code><code class="p">),</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">                </code><code class="n">posts</code>::<code class="n">body</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">body</code><code class="p">),</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">            </code><code class="p">))</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">            </code><code class="p">.</code><code class="n">execute</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">59 </code>
<code class="lineno">60 </code><code class="w">        </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">            </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">)</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">65 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">66 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We need a connection to the database and all of the relevant fields. We require a <code>User</code> object here which is a matter of choice. Instead we could have accepted a <code>user_id</code> directly. By default we set the post to be unpublished based on our schema, so we don’t take a published parameter. The code for inserting into the posts table and then fetching the post is very similar to that for a user. Again the use of a transaction is a limitation of Sqlite not supporting a way to return data from an insert statement.</p>

<p>One difference here is the use of <code>select(posts::all_columns)</code> which is a shorthand that Diesel provides so that we do not have to write out a tuple with each column explicitly listed. Depending on the struct you are serializing to you may or may not be able to use this. If you always want a subset of columns it can be useful to write your own helper to represent a tuple of that subset.</p>

<h5 id="leanpub-auto-publish-a-post">Publish a post</h5>

<p>As we stated our create method uses the database default for the published column and therefore in order to set published to true we need to update the database row for a particular post. Let’s create a function that takes the id of a post and sets the value of published to true:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">67 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">publish_post</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"> </code><code class="n">post_id</code>: <code class="kt">i32</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">Po</code><code class="err">\</code><code class="w"></code>
<code class="lineno">68 </code><code class="n">st</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">    </code><code class="n">conn</code><code class="p">.</code><code class="n">transaction</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">70 </code><code class="w">        </code><code class="n">diesel</code>::<code class="n">update</code><code class="p">(</code><code class="n">posts</code>::<code class="n">table</code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">post_id</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">71 </code><code class="w">            </code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">posts</code>::<code class="n">published</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="kc">true</code><code class="p">))</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">            </code><code class="p">.</code><code class="n">execute</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">73 </code>
<code class="lineno">74 </code><code class="w">        </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">75 </code><code class="w">            </code><code class="p">.</code><code class="n">find</code><code class="p">(</code><code class="n">post_id</code><code class="p">)</code><code class="w"></code>
<code class="lineno">76 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">)</code><code class="w"></code>
<code class="lineno">77 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">78 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">79 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">80 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is our first instance of updating an existing row in the database. Issuing an update to the database uses the aptly named <code>update</code> function from Diesel. The argument to update can be a table, a filtered table (which is what we use here), or a reference to a struct that implements the <code>Identifiable</code> trait. If you pass just a table then the update applies to all rows of that table which is typically not what you want.</p>

<p>In this case we wish to only update the row with <code>id</code> equal to the <code>post_id</code> passed in as an argument. We are only updating a single column so we pass one expression to the <code>set</code> method, but if you want to update multiple columns you can pass a tuple to <code>set</code> instead.</p>

<aside>
  <p>Diesel also has a trait called <code>AsChangeset</code> which you can derive which allows you to take a value like <code>post</code> and call <code>diesel::update(...).set(&amp;post)</code> to set all of the fields (except the primary key) on the struct based on the current state of that struct. See the <a href="https://diesel.rs/guides/all-about-updates/">Diesel update guide</a>) for more information.</p>

</aside>

<h5 id="leanpub-auto-retrieve-posts">Retrieve posts</h5>

<p>We are going to implement two different ways of retrieving posts. One to get all published posts and the other to get only those posts written by a particular user. First, let’s get all posts:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">124 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">all_posts</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">    </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">        </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">127 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">posts</code>::<code class="n">published</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="kc">true</code><code class="p">))</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">132 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The return type of this function is a list of tuples where the first element is a post and the second element is the author. Diesel is built around queries that have this flat result structure. You might be used to other ORMs where a post object would have an author field which contains an embedded user object. In most uses of Diesel you will find tuples being used to represent related models rather than hierarchical structs.</p>

<p>We order the posts based on their id as this will make them newest first. Clearly a more robust model would include timestamps that we could sort by, but the idea is similar. We also select only those posts which have been published.</p>

<p>For each post we want to fetch all of the data about the post as well as data about the author. Hence we are finally getting to see a query involving multiple tables. To accomplish this we need to join with the users table. We can use <code>inner_join</code> with just the name of the table and Diesel will figure out how to perform the join based on the association attributes we put on the <code>Post</code> model. The argument to <code>select</code> is a tuple with two elements both of which are tuples representing the columns we want to fetch. We then tell <code>load</code> the type to coerce these columns into and Diesel takes care of the rest.</p>

<p>The second way we are going to retrieve posts is only those authored by a particular user:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">134 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">user_posts</code><code class="p">(</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">    </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">    </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">137 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Post</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">138 </code><code class="w">    </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">139 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">posts</code>::<code class="n">user_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">user_id</code><code class="p">))</code><code class="w"></code>
<code class="lineno">140 </code><code class="w">        </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">141 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">)</code><code class="w"></code>
<code class="lineno">142 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="n">Post</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">144 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have a choice here whether to take a <code>User</code> struct or just a <code>user_id</code> as input. If we chose the <code>User</code> struct route, this would require doing a database fetch somewhere else to reify the struct just to pull the id off inside this function. However that could be a design you want to adopt depending on how you want to handle the case of a <code>user_id</code> that does not exist. We choose the straight <code>user_id</code> method here which will just result in an empty set of posts if the user does not exist.</p>

<p>As the author is the same for all of these posts we only return a vector of posts rather than the tuple of our previous function. Other than that this function is much like our other fetching functions.</p>

<h3 id="leanpub-auto-adding-routes-for-posts">Adding routes for posts</h3>

<p>With the data model in place and the necessary functions written for interacting with the database, we now can expose this functionality as part of our API by building the necessary routes. First, we declare and export the soon to be written <code>posts</code> module within our <code>routes</code> module:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">5 </code><code class="k">pub</code><code class="p">(</code><code class="k">super</code><code class="p">)</code><code class="w"> </code><code class="k">mod</code> <code class="nn">posts</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we create the <code>routes/posts.rs</code> file to contain the code for our post routes. We start off with the same imports as our <code>routes::users</code> module:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">AppError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">routes</code>::<code class="n">convert</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="p">{</code><code class="n">models</code><code class="p">,</code><code class="w"> </code><code class="n">Pool</code><code class="p">};</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">prelude</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="n">futures</code>::<code class="n">Future</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-creating-a-post-1">Creating a post</h4>

<p>Our first task will be to create a post. As we have done before we create a struct to represent the JSON input data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">18 </code><code class="cp">#[derive(Debug, Serialize, Deserialize)]</code><code class="w"></code>
<code class="lineno">19 </code><code class="k">struct</code> <code class="nc">PostInput</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="n">title</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">    </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">22 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We only need to get the title and body of the Post as the rest of the information will be inferred from the URL or will take on a default value. Let’s next write the handler function for adding a post:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">24 </code><code class="k">fn</code> <code class="nf">add_post</code><code class="p">(</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="n">user_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="n">post</code>: <code class="nc">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">PostInput</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">28 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">models</code>::<code class="n">UserKey</code>::<code class="n">ID</code><code class="p">(</code><code class="n">user_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">());</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">        </code><code class="n">models</code>::<code class="n">find_user</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">).</code><code class="n">and_then</code><code class="p">(</code><code class="o">|</code><code class="n">user</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">post</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">post</code><code class="p">.</code><code class="n">into_inner</code><code class="p">();</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">title</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">post</code><code class="p">.</code><code class="n">title</code><code class="p">;</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">body</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">post</code><code class="p">.</code><code class="n">body</code><code class="p">;</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">            </code><code class="n">models</code>::<code class="n">create_post</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">user</code><code class="p">,</code><code class="w"> </code><code class="n">title</code><code class="p">.</code><code class="n">as_str</code><code class="p">(),</code><code class="w"> </code><code class="n">body</code><code class="p">.</code><code class="n">as_st</code><code class="err">\</code><code class="w"></code>
<code class="lineno">37 </code><code class="n">r</code><code class="p">())</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="p">})</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">41 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We will structure the URL so that the relevant <code>user_id</code> for the author will be part of the path. We take that path as input as well as the post as JSON and the database pool. This is much like our previous handlers so we will focus only on the unique bits here. We wrote our <code>create_post</code> function to take a user struct as input rather than just a plain id, therefore we need to convert the id we take as input into a <code>User</code> before we can use it. We do that so the error that results from a missing user happens first before we even try to create a post.</p>

<p>We use the <code>and_then</code> method on <code>Result</code> to continue on to creating a post only in the case where we actually found a user. This way we handle all of the different errors without having a mess of conditionals. We again build on all of the model code we wrote earlier so that the process of creating the post is mostly just plumbing the different parts together. In the end we again use our <code>convert</code> function to map the result into our expected form.</p>

<h4 id="leanpub-auto-publishing-a-post">Publishing a post</h4>

<p>The process of publishing a post in our API is quite simple, we just need a <code>post_id</code> in the path and can then rely on the model code we wrote earlier:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">42 </code><code class="k">fn</code> <code class="nf">publish_post</code><code class="p">(</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">    </code><code class="n">post_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">45 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">        </code><code class="n">models</code>::<code class="n">publish_post</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">post_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">())</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">51 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-fetching-posts">Fetching posts</h4>

<p>We can fetch posts either given a <code>user_id</code> or just fetch them all. In the first case we expect to find the id in the path:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">53 </code><code class="k">fn</code> <code class="nf">user_posts</code><code class="p">(</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">    </code><code class="n">user_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">56 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">        </code><code class="n">models</code>::<code class="n">user_posts</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">user_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">())</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">62 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>In the second case, we do not need any extra input to find all posts:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">64 </code><code class="k">fn</code> <code class="nf">all_posts</code><code class="p">(</code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="err">\</code><code class="w"></code>
<code class="lineno">65 </code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">66 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">        </code><code class="n">models</code>::<code class="n">all_posts</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">70 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">71 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-wiring-up-our-routes">Wiring up our routes</h4>

<p>As we did for users, we are going to export a <code>configure</code> function which modifies an input configuration to add the relevant routes for posts:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/posts.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 8 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">configure</code><code class="p">(</code><code class="n">cfg</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">web</code>::<code class="n">ServiceConfig</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">cfg</code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">        </code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/users/{id}/posts"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">            </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">add_post</code><code class="p">))</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">            </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">user_posts</code><code class="p">)),</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="p">)</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/posts"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">all_post</code><code class="err">\</code><code class="w"></code>
<code class="lineno">15 </code><code class="n">s</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/posts/{id}/publish"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to_</code><code class="err">\</code><code class="w"></code>
<code class="lineno">17 </code><code class="n">async</code><code class="p">(</code><code class="n">publish_post</code><code class="p">)));</code><code class="w"></code>
<code class="lineno">18 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We add the four routes for the handlers we just wrote. Note that the path <code>/users/{id}/posts</code> accepts both a <code>POST</code> and a <code>GET</code> request which route to our <code>add_post</code> and <code>user_posts</code> handlers, respectively. Otherwise this is analogous to our configuration of the users routes.</p>

<p>Finally, we add a call to <code>configure</code> inside our application factory to actually add these routes to our app:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">38 </code><code class="w">                </code><code class="p">.</code><code class="n">configure</code><code class="p">(</code><code class="n">routes</code>::<code class="n">posts</code>::<code class="n">configure</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<h3 id="leanpub-auto-extending-further-comments">Extending further: comments</h3>

<p>The last piece of our puzzle is going to be adding comments. A comment will reference a user which represents the author of the comment and a post which is what the comment is commenting on. Adding this model is quite similar to adding posts so although we are going to show all of the necessary code changes, we will only explicate the elements which are novel</p>

<h4 id="leanpub-auto-modifying-the-model">Modifying the model</h4>

<p>Let’s generate our migration:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>diesel migration generate create_comments
</pre></div>

</figure>

<p>In our <code>up.sql</code> we create a table for comments, the difference here being that comments will have foreign keys to both users and posts:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-031136_create_comments/up.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">comments</code> <code class="p">(</code>
<code class="lineno">2 </code>  <code class="n">id</code> <code class="nb">INTEGER</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
<code class="lineno">3 </code>  <code class="n">user_id</code> <code class="nb">INTEGER</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">REFERENCES</code> <code class="n">users</code> <code class="p">(</code><code class="n">id</code><code class="p">),</code>
<code class="lineno">4 </code>  <code class="n">post_id</code> <code class="nb">INTEGER</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">REFERENCES</code> <code class="n">posts</code> <code class="p">(</code><code class="n">id</code><code class="p">),</code>
<code class="lineno">5 </code>  <code class="n">body</code> <code class="nb">TEXT</code> <code class="k">NOT</code> <code class="k">NULL</code>
<code class="lineno">6 </code><code class="p">)</code>
</pre></div>

</figure>

<p>The <code>down.sql</code> just drops the table as we have seen before:</p>

<figure class="code" dir="ltr">
  <figcaption>migrations/2019-04-30-031136_create_comments/down.sql</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">comments</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-generated-schema">Generated schema</h4>

<p>After running these migrations, we get our final schema:</p>

<figure class="code" dir="ltr">
  <figcaption>src/schema.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="w">    </code><code class="n">comments</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="w">        </code><code class="n">user_id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="w">        </code><code class="n">post_id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="w">        </code><code class="n">body</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">posts</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">        </code><code class="n">user_id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">        </code><code class="n">title</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">        </code><code class="n">body</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">        </code><code class="n">published</code><code class="w"> </code>-&gt; <code class="nc">Bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">18 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="n">table</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">    </code><code class="n">users</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">        </code><code class="n">id</code><code class="w"> </code>-&gt; <code class="nc">Integer</code><code class="p">,</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="n">username</code><code class="w"> </code>-&gt; <code class="nc">Text</code><code class="p">,</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">25 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">26 </code>
<code class="lineno">27 </code><code class="n">joinable</code><code class="o">!</code><code class="p">(</code><code class="n">comments</code><code class="w"> </code>-&gt; <code class="nc">posts</code><code class="w"> </code><code class="p">(</code><code class="n">post_id</code><code class="p">));</code><code class="w"></code>
<code class="lineno">28 </code><code class="n">joinable</code><code class="o">!</code><code class="p">(</code><code class="n">comments</code><code class="w"> </code>-&gt; <code class="nc">users</code><code class="w"> </code><code class="p">(</code><code class="n">user_id</code><code class="p">));</code><code class="w"></code>
<code class="lineno">29 </code><code class="n">joinable</code><code class="o">!</code><code class="p">(</code><code class="n">posts</code><code class="w"> </code>-&gt; <code class="nc">users</code><code class="w"> </code><code class="p">(</code><code class="n">user_id</code><code class="p">));</code><code class="w"></code>
<code class="lineno">30 </code>
<code class="lineno">31 </code><code class="n">allow_tables_to_appear_in_same_query</code><code class="o">!</code><code class="p">(</code><code class="n">comments</code><code class="p">,</code><code class="w"> </code><code class="n">posts</code><code class="p">,</code><code class="w"> </code><code class="n">users</code><code class="p">,);</code><code class="w"></code>
</pre></div>

</figure>

<p>The changes here from the previous schema are what we should expect by now. We have a table for comments and the relevant <code>joinable!</code> calls based on the foreign keys.</p>

<h4 id="leanpub-auto-comment-model">Comment model</h4>

<p>Like for our other models, we add the import of the Diesel generated comments item from the schema:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">schema</code>::<code class="n">comments</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s then create a struct to represent one row in the comments table:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="cp">#[derive(Queryable, Identifiable, Associations, Serialize, Debug)]</code><code class="w"></code>
<code class="lineno">26 </code><code class="cp">#[belongs_to(User)]</code><code class="w"></code>
<code class="lineno">27 </code><code class="cp">#[belongs_to(Post)]</code><code class="w"></code>
<code class="lineno">28 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Comment</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">post_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">33 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is quite similar to our <code>Post</code> struct except we have an extra <code>belongs_to</code> attribute for the <code>User</code> association.</p>

<h4 id="leanpub-auto-creating-a-comment">Creating a comment</h4>

<p>We choose to take the <code>user_id</code> and <code>post_id</code> directly for convenience here as we create a function for creating a comment:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 81 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">create_comment</code><code class="p">(</code><code class="w"></code>
<code class="lineno"> 82 </code><code class="w">    </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 83 </code><code class="w">    </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 84 </code><code class="w">    </code><code class="n">post_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 85 </code><code class="w">    </code><code class="n">body</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 86 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">Comment</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 87 </code><code class="w">    </code><code class="n">conn</code><code class="p">.</code><code class="n">transaction</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 88 </code><code class="w">        </code><code class="n">diesel</code>::<code class="n">insert_into</code><code class="p">(</code><code class="n">comments</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno"> 89 </code><code class="w">            </code><code class="p">.</code><code class="n">values</code><code class="p">((</code><code class="w"></code>
<code class="lineno"> 90 </code><code class="w">                </code><code class="n">comments</code>::<code class="n">user_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">user_id</code><code class="p">),</code><code class="w"></code>
<code class="lineno"> 91 </code><code class="w">                </code><code class="n">comments</code>::<code class="n">post_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">post_id</code><code class="p">),</code><code class="w"></code>
<code class="lineno"> 92 </code><code class="w">                </code><code class="n">comments</code>::<code class="n">body</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">body</code><code class="p">),</code><code class="w"></code>
<code class="lineno"> 93 </code><code class="w">            </code><code class="p">))</code><code class="w"></code>
<code class="lineno"> 94 </code><code class="w">            </code><code class="p">.</code><code class="n">execute</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 95 </code>
<code class="lineno"> 96 </code><code class="w">        </code><code class="n">comments</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">            </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">comments</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">            </code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">comments</code>::<code class="n">all_columns</code><code class="p">)</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="w">            </code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">100 </code><code class="w">            </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">102 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The function here follows the same pattern as we have seen before for creating other models with again the transaction to support returning the newly created <code>Comment</code> struct due to the constraints of Sqlite.</p>

<h4 id="leanpub-auto-getting-comments-on-a-post">Getting comments on a post</h4>

<p>Let’s write a function that takes a <code>post_id</code> and fetches all the comments on that post:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">161 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">post_comments</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"> </code><code class="n">post_id</code>: <code class="kt">i32</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">V</code><code class="err">\</code><code class="w"></code>
<code class="lineno">162 </code><code class="n">ec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">163 </code><code class="w">    </code><code class="n">comments</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">164 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">comments</code>::<code class="n">post_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">post_id</code><code class="p">))</code><code class="w"></code>
<code class="lineno">165 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">166 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">comments</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">167 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">168 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">169 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>As the post is known we do not need to return the post with the comment, but we do want to return the user who made the comment. This looks quite similar to our function for fetching all posts where we join with the users table and select the relevant data.</p>

<aside>
  <p>This is a point of API design with a REST-like system where you can decide how much or how little to include in your responses. This is a much larger topic than we can cover, but note that although we are making one choice, each application will need to consider their own trade-offs.</p>

</aside>

<h4 id="leanpub-auto-getting-all-comments-by-a-user">Getting all comments by a user</h4>

<p>We are going to fetch all comments made by a particular user, but just fetching the comments alone would be lacking some important information, notably information about the post the comment is on. So we want to fetch the post for each comment, but we don’t want to fetch all of the post data because that would be too much. Instead we are going to make a new struct to represent a subset of the post data that we want to fetch alongside each comment. Let’s start with the struct for our post:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">170 </code><code class="cp">#[derive(Queryable, Serialize, Debug)]</code><code class="w"></code>
<code class="lineno">171 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">PostWithComment</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">172 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">173 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">title</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">174 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">published</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">175 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have just enough data to identify the post and give some context but we don’t fetch the entire body. We note that this derives <code>Queryable</code> but not <code>Identifiable</code>. This struct can be constructed from a query but it does not represent an entire row in a table.</p>

<p>Now let’s right our function to get the comments for a particular user:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">177 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">user_comments</code><code class="p">(</code><code class="w"></code>
<code class="lineno">178 </code><code class="w">    </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"></code>
<code class="lineno">179 </code><code class="w">    </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">180 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">PostWithComment</code><code class="p">)</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">181 </code><code class="w">    </code><code class="n">comments</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">182 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">comments</code>::<code class="n">user_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">user_id</code><code class="p">))</code><code class="w"></code>
<code class="lineno">183 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">posts</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">184 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="w"></code>
<code class="lineno">185 </code><code class="w">            </code><code class="n">comments</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"></code>
<code class="lineno">186 </code><code class="w">            </code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">posts</code>::<code class="n">title</code><code class="p">,</code><code class="w"> </code><code class="n">posts</code>::<code class="n">published</code><code class="p">),</code><code class="w"></code>
<code class="lineno">187 </code><code class="w">        </code><code class="p">))</code><code class="w"></code>
<code class="lineno">188 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">PostWithComment</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="w"></code>
<code class="lineno">189 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="nb">Into</code>::<code class="n">into</code><code class="p">)</code><code class="w"></code>
<code class="lineno">190 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We filter based on the passed in <code>user_id</code> and then join with the posts data to get the extra information about the posts. We use the select method to narrow down which columns from the posts table we need to construct our <code>PostWithComment</code> struct and then load a tuple which results in getting the return type we want which is a vector of tuples where each element is a comment and some data about that post the comment is on.</p>

<p>This method is similar to all comments for a particular post except it is the other association. For that method as the user is a small object we just fetch entire user structs, but one would probably want to restrict that output as well as the user model grows.</p>

<h4 id="leanpub-auto-including-comments-in-our-post-fetching-functions">Including comments in our post fetching functions</h4>

<p>Now that we have comments as a model, we are going to go back and edit our two methods for fetching posts and incorporate comments into the results.</p>

<p>We start with the method for fetching all posts. The change in implementation of this function is driven by the change in the return type inside the <code>Result</code> from:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="w"></code>
</pre></div>

</figure>

<p>to:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">((</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">),</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">)</code><code class="o">&gt;</code><code class="w"></code>
</pre></div>

</figure>

<p>That is, instead of fetching a tuple of post and author, we want to get the post, author, and a vector of comments where we include the author of the comment alongside the comment itself. Looking at the type of each element of the vector by itself can help clarify what is going on:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">((</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">),</code><code class="w"> </code><code class="n">Comments</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>where</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">type</code> <code class="nc">Comments</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Once you have a good sense for what we are trying to obtain, the code for accomplishing this will make more sense. Let’s jump into it:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">124 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">all_posts</code><code class="p">(</code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">((</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">),</code><code class="w"> </code><code class="err">\</code><code class="w"></code>
<code class="lineno">125 </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">)</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">query</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">127 </code><code class="w">        </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">posts</code>::<code class="n">published</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="kc">true</code><code class="p">))</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">)));</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">posts_with_user</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">query</code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">posts</code><code class="p">,</code><code class="w"> </code><code class="n">post_users</code><code class="p">)</code>: <code class="p">(</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">_</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">posts_with_user</code><code class="p">.</code><code class="n">into_it</code><code class="err">\</code><code class="w"></code>
<code class="lineno">133 </code><code class="n">er</code><code class="p">().</code><code class="n">unzip</code><code class="p">();</code><code class="w"></code>
<code class="lineno">134 </code>
<code class="lineno">135 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">comments</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Comment</code>::<code class="n">belonging_to</code><code class="p">(</code><code class="o">&amp;</code><code class="n">posts</code><code class="p">)</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">137 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">comments</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">138 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="w"></code>
<code class="lineno">139 </code><code class="w">        </code><code class="p">.</code><code class="n">grouped_by</code><code class="p">(</code><code class="o">&amp;</code><code class="n">posts</code><code class="p">);</code><code class="w"></code>
<code class="lineno">140 </code>
<code class="lineno">141 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">posts</code><code class="p">.</code><code class="n">into_iter</code><code class="p">().</code><code class="n">zip</code><code class="p">(</code><code class="n">post_users</code><code class="p">).</code><code class="n">zip</code><code class="p">(</code><code class="n">comments</code><code class="p">).</code><code class="n">collect</code><code class="p">())</code><code class="w"></code>
<code class="lineno">142 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We first perform the same query as before which gets all posts and their corresponding authors and set this as <code>posts_with_user</code>. We then use the <code>unzip</code> method on <code>std::iter::Iterator</code> which turns an iterator of pairs into a pair of iterators. In this case we turn <code>Vec&lt;(Post, User)&gt;</code> into <code>(Vec&lt;Post&gt;, Vec&lt;User&gt;)</code>. We can then fetch all of the comments that belong to those posts by passing a reference to that vector to <code>belonging_to</code> which we get from deriving <code>Associations</code> on <code>Comment</code>.</p>

<p>To associate the comments into chunks indexed by the posts we use the <code>grouped_by</code> method provided by Diesel. Note this does not generate a <code>GROUP BY</code> statement in SQL rather it is just operating on the data structures in memory of already loaded data. In the end this transforms a <code>Vec&lt;(Comment, User)&gt;</code> into <code>Vec&lt;Vec&lt;(Comment, User)&gt;&gt;</code>.</p>

<p>Finally, we can use the <code>zip</code> method on iterator to take all of these vectors and combine them into the output format we were looking for. <code>posts.into_iter().zip(post_users)</code> just turns <code>(Vec&lt;Post&gt;, Vec&lt;User&gt;)</code> back into <code>Vec&lt;(Post, User)&gt;</code>. The final <code>zip(comments)</code> takes <code>Vec&lt;(Post, User)&gt;</code> and <code>Vec&lt;Vec&lt;(Comment, User)&gt;&gt;</code> and puts them together into a single vector of our desired return type.</p>

<p>With this in place, modifying the posts for a particular user to include comments is a straightforward exercise in the same vein:</p>

<figure class="code" dir="ltr">
  <figcaption>src/models.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">142 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">user_posts</code><code class="p">(</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">    </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="p">,</code><code class="w"></code>
<code class="lineno">144 </code><code class="w">    </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">145 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Post</code><code class="p">,</code><code class="w"> </code><code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">)</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">146 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">posts</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">posts</code>::<code class="n">table</code><code class="w"></code>
<code class="lineno">147 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="n">posts</code>::<code class="n">user_id</code><code class="p">.</code><code class="n">eq</code><code class="p">(</code><code class="n">user_id</code><code class="p">))</code><code class="w"></code>
<code class="lineno">148 </code><code class="w">        </code><code class="p">.</code><code class="n">order</code><code class="p">(</code><code class="n">posts</code>::<code class="n">id</code><code class="p">.</code><code class="n">desc</code><code class="p">())</code><code class="w"></code>
<code class="lineno">149 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">posts</code>::<code class="n">all_columns</code><code class="p">)</code><code class="w"></code>
<code class="lineno">150 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="n">Post</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">151 </code>
<code class="lineno">152 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">comments</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Comment</code>::<code class="n">belonging_to</code><code class="p">(</code><code class="o">&amp;</code><code class="n">posts</code><code class="p">)</code><code class="w"></code>
<code class="lineno">153 </code><code class="w">        </code><code class="p">.</code><code class="n">inner_join</code><code class="p">(</code><code class="n">users</code>::<code class="n">table</code><code class="p">)</code><code class="w"></code>
<code class="lineno">154 </code><code class="w">        </code><code class="p">.</code><code class="n">select</code><code class="p">((</code><code class="n">comments</code>::<code class="n">all_columns</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="n">users</code>::<code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">users</code>::<code class="n">username</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">155 </code><code class="w">        </code><code class="p">.</code><code class="n">load</code>::<code class="o">&lt;</code><code class="p">(</code><code class="n">Comment</code><code class="p">,</code><code class="w"> </code><code class="n">User</code><code class="p">)</code><code class="o">&gt;</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="o">?</code><code class="w"></code>
<code class="lineno">156 </code><code class="w">        </code><code class="p">.</code><code class="n">grouped_by</code><code class="p">(</code><code class="o">&amp;</code><code class="n">posts</code><code class="p">);</code><code class="w"></code>
<code class="lineno">157 </code>
<code class="lineno">158 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">posts</code><code class="p">.</code><code class="n">into_iter</code><code class="p">().</code><code class="n">zip</code><code class="p">(</code><code class="n">comments</code><code class="p">).</code><code class="n">collect</code><code class="p">())</code><code class="w"></code>
<code class="lineno">159 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h3 id="leanpub-auto-adding-routes-for-comments">Adding routes for comments</h3>

<p>We have our model in place so now we turn to the handlers for our routes. First we declare and export our comments route module:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">pub</code><code class="p">(</code><code class="k">super</code><code class="p">)</code><code class="w"> </code><code class="k">mod</code> <code class="nn">comments</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We bring in the same imports that we have in our other routes modules:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">AppError</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">routes</code>::<code class="n">convert</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="p">{</code><code class="n">models</code><code class="p">,</code><code class="w"> </code><code class="n">Pool</code><code class="p">};</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">actix_web</code>::<code class="p">{</code><code class="n">web</code><code class="p">,</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">};</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">diesel</code>::<code class="n">prelude</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="n">futures</code>::<code class="n">Future</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-creating-a-comment-1">Creating a comment</h4>

<p>As in our other cases, we need a struct to represent the JSON input for a comment:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">17 </code><code class="cp">#[derive(Debug, Serialize, Deserialize)]</code><code class="w"></code>
<code class="lineno">18 </code><code class="k">struct</code> <code class="nc">CommentInput</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="n">user_id</code>: <code class="kt">i32</code><code class="p">,</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="n">body</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>With that in place, we can create a handler for adding a comment:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">23 </code><code class="k">fn</code> <code class="nf">add_comment</code><code class="p">(</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="n">post_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="n">comment</code>: <code class="nc">web</code>::<code class="n">Json</code><code class="o">&lt;</code><code class="n">CommentInput</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">27 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">comment</code><code class="p">.</code><code class="n">into_inner</code><code class="p">();</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">user_id</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">data</code><code class="p">.</code><code class="n">user_id</code><code class="p">;</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">body</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">data</code><code class="p">.</code><code class="n">body</code><code class="p">;</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">        </code><code class="n">models</code>::<code class="n">create_comment</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">user_id</code><code class="p">,</code><code class="w"> </code><code class="n">post_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">(),</code><code class="w"> </code><code class="n">bod</code><code class="err">\</code><code class="w"></code>
<code class="lineno">34 </code><code class="n">y</code><code class="p">.</code><code class="n">as_str</code><code class="p">())</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">37 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We take just the id of the post as input in the path and as our model function for creating a comment just takes the post id as input we can call our function directly.</p>

<p>Again this is a design decision and we went this route here to show the opposite approach as we did for creating a post. In that function we fetched the user before creating the post, here we just try to create the comment given whatever post id we are given. If the database has foreign key constraints then passing a bad post id will result in an error at the database level. If the database does not support those constraints or you do not specify them then this would be a source of bugs if you did not otherwise validate the input. The design is up to you.</p>

<h4 id="leanpub-auto-getting-all-comments-on-a-post">Getting all comments on a post</h4>

<p>We can build on our previous functions to create a simple handler for getting all comments for a particular post:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">38 </code><code class="k">fn</code> <code class="nf">post_comments</code><code class="p">(</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="n">post_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">41 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">        </code><code class="n">models</code>::<code class="n">post_comments</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">post_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">())</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">47 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-getting-all-comments-by-a-user-1">Getting all comments by a user</h4>

<p>Similarly, given a user we can fetch all of their comments:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">49 </code><code class="k">fn</code> <code class="nf">user_comments</code><code class="p">(</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">    </code><code class="n">user_id</code>: <code class="nc">web</code>::<code class="n">Path</code><code class="o">&lt;</code><code class="kt">i32</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="n">pool</code>: <code class="nc">web</code>::<code class="n">Data</code><code class="o">&lt;</code><code class="n">Pool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">52 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">impl</code><code class="w"> </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Item</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpResponse</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">AppError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">    </code><code class="n">web</code>::<code class="n">block</code><code class="p">(</code><code class="k">move</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">conn</code>: <code class="kp">&amp;</code><code class="nc">SqliteConnection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">pool</code><code class="p">.</code><code class="n">get</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">        </code><code class="n">models</code>::<code class="n">user_comments</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code class="w"> </code><code class="n">user_id</code><code class="p">.</code><code class="n">into_inner</code><code class="p">())</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">    </code><code class="p">.</code><code class="n">then</code><code class="p">(</code><code class="n">convert</code><code class="p">)</code><code class="w"></code>
<code class="lineno">58 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-wiring-the-routes-up-1">Wiring the routes up</h4>

<p>Finally, as we did for users and posts, we expose a configure function to connect our handlers to routes:</p>

<figure class="code" dir="ltr">
  <figcaption>src/routes/comments.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 8 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">configure</code><code class="p">(</code><code class="n">cfg</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">web</code>::<code class="n">ServiceConfig</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">cfg</code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/users/{id}/comments"</code><code class="p">).</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="err">\</code><code class="w"></code>
<code class="lineno">10 </code><code class="n">to_async</code><code class="p">(</code><code class="n">user_comments</code><code class="p">)))</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">        </code><code class="p">.</code><code class="n">service</code><code class="p">(</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">            </code><code class="n">web</code>::<code class="n">resource</code><code class="p">(</code><code class="s">"/posts/{id}/comments"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">                </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">post</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">add_comment</code><code class="p">))</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">                </code><code class="p">.</code><code class="n">route</code><code class="p">(</code><code class="n">web</code>::<code class="n">get</code><code class="p">().</code><code class="n">to_async</code><code class="p">(</code><code class="n">post_comments</code><code class="p">)),</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">        </code><code class="p">);</code><code class="w"></code>
<code class="lineno">16 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Moreover, we add the call to <code>configure</code> for comments to our application factory:</p>

<figure class="code" dir="ltr">
  <figcaption>src/lib.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">39 </code><code class="w">                </code><code class="p">.</code><code class="n">configure</code><code class="p">(</code><code class="n">routes</code>::<code class="n">comments</code>::<code class="n">configure</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>


</div>,<div>
<h2 id="leanpub-auto-command-line-applications">Command Line Applications</h2>

<p>Many command line applications that we use every day were written long ago when the dominate high level language was C. Ever since there have been improvements made to these fundamental programs as well as attempts to replace them. One niche where Rust fits nicely is in building these command line applications.</p>

<p>One example is <a href="https://blog.burntsushi.net/ripgrep/">ripgrep</a> which can replace grep for many use cases, is faster, and provides a lot of nice extra features. Rust is a big part of the success story of <code>ripgrep</code>.</p>

<p>One feature that is becoming increasingly more important is the ability to support multiple platforms without the need for parallel codebases or ugly hacks. Mac and Linux support have gotten much closer over the years, but Windows is still a much harder target to hit for a wide variety of languages. This is one area that Go has worked quite well at addressing and Rust also shines here as well.</p>

<p>Building command line utilities can greatly simplify your life if you spend a lot of time in the terminal. Sometimes stitching together awk, Perl, and Bash for the third time starts to make you wonder if there is a better way. Before Rust’s ecosystem got to the current state it might have made sense to reach for Python or Ruby with their plethora of libraries to build a simple command line tool. But we are now at a point where you can have performance, safety, and a ton of great features by putting together crates out in the wild.</p>

<h3 id="leanpub-auto-initial-setup">Initial setup</h3>

<p>Let’s walk through building a simple command line application for making HTTP requests. This has sufficiently complexity to be interesting, but not too much so that we can focus on the Rust parts of the problem rather than the details of this particular application.</p>

<p>We are going to build something like <code>cURL</code> with a few extra features, so let’s create a new project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>cargo new hurl
</pre></div>

</figure>

<h3 id="leanpub-auto-making-an-mvp">Making an MVP</h3>

<p>We are going to walk through quite a bit of code before we get to a runnable version of our application. This is just to get us to an MVP with a few simple features. After that we will expand our feature set with some nice things that curl is missing.</p>

<h4 id="leanpub-auto-basic-feature-set">Basic feature set</h4>

<p>We want to support some basic use cases. In all scenarios we want to:</p>

<ul>
  <li>Parse the response if it is JSON</li>
  <li>Print out information about the request including headers</li>
  <li>Print out the response as nicely as possible</li>
</ul>

<p>Let’s go through a few simple motivating examples:</p>

<ul>
  <li>Make a GET request to <code>example.com</code>
</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ hurl example.com
</pre></div>

</figure>

<p>Here we see that the default is to make a GET request as no other method is given and no data is being sent.</p>

<ul>
  <li>Make a POST request to example.com with a JSON object <code>{"foo":"bar"}</code> as the data:</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ hurl example.com <code class="nv">foo</code><code class="o">=</code>bar
</pre></div>

</figure>

<p>Here we see the default when data is being sent is to make a POST request. Also, the default is to make a request using JSON rather than a form.</p>

<ul>
  <li>Make a PUT request to example.com using HTTPS, set the <code>X-API-TOKEN</code> header to <code>abc123</code>, and upload a file named <code>foo.txt</code> with the form field name <code>info</code>:</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ hurl -s -f PUT example.com X-API-TOKEN:abc123 info@foo.txt
</pre></div>

</figure>

<p>We see the <code>-s</code> for <code>--secure</code> option used to turn on HTTPS and <code>-f</code> option used to turn on sending as a form. We want headers to be specified with a colon separating the name from the value and files to be uploaded by using <code>@</code> between the form field name and the path to the file on disk.</p>

<ul>
  <li>Make a form POST request to example.com, use <code>bob</code> as the username for basic authentication, set the query parameter of <code>foo</code> equal to <code>bar</code>, and set the form field <code>option</code> equal to <code>all</code>:</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ hurl -f -a bob POST example.com <code class="nv">foo</code><code class="o">==</code>bar <code class="nv">option</code><code class="o">=</code>all
</pre></div>

</figure>

<p>In this last example, before making the request, the user should be prompted for their password which should be used for the basic authentication scheme.</p>

<h4 id="leanpub-auto-building-the-features">Building the features</h4>

<p>First things first, we need to add dependencies to our manifest:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">[package]</code>
<code class="lineno"> 2 </code><code class="na">name</code> <code class="o">=</code> <code class="s">"hurl"</code>
<code class="lineno"> 3 </code><code class="na">version</code> <code class="o">=</code> <code class="s">"0.1.0"</code>
<code class="lineno"> 4 </code><code class="na">authors</code> <code class="o">=</code> <code class="s">["Your Name &lt;you@example.com&gt;"]</code>
<code class="lineno"> 5 </code><code class="na">edition</code> <code class="o">=</code> <code class="s">"2018"</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="k">[dependencies]</code>
<code class="lineno"> 8 </code><code class="na">structopt</code> <code class="o">=</code> <code class="s">"0.3"</code>
<code class="lineno"> 9 </code><code class="na">heck</code> <code class="o">=</code> <code class="s">"0.3"</code>
<code class="lineno">10 </code><code class="na">log</code> <code class="o">=</code> <code class="s">"0.4"</code>
<code class="lineno">11 </code><code class="na">pretty_env_logger</code> <code class="o">=</code> <code class="s">"0.3"</code>
<code class="lineno">12 </code><code class="na">serde</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">13 </code><code class="na">serde_json</code> <code class="o">=</code> <code class="s">"1.0"</code>
<code class="lineno">14 </code><code class="na">reqwest</code> <code class="o">=</code> <code class="s">"0.9.20"</code>
<code class="lineno">15 </code><code class="na">rpassword</code> <code class="o">=</code> <code class="s">"4.0"</code>
</pre></div>

</figure>

<p>Whoa that is a lot of dependencies. It is easiest to get most of these out of the way now as working them in after the fact makes things overly complicated. We will get to each of these in detail as we use them, but the quick overview of each is:</p>

<ul>
  <li>
<code>structopt</code> - command line argument parsing, and much more.</li>
  <li>
<code>heck</code> - converting strings to different cases (e.g. snake_case, camelCase).</li>
  <li>
<code>log</code> - logging facade for outputting verbose information.</li>
  <li>
<code>pretty_env_logger</code> - logging implementation that works with <code>log</code>.</li>
  <li>
<code>serde</code> - (de)serialization of data.</li>
  <li>
<code>serde_json</code> - <code>serde</code> for JSON data.</li>
  <li>
<code>reqwest</code> - HTTP client.</li>
  <li>
<code>rpassword</code> - ask a user for a password without echoing it to the terminal.</li>
</ul>

<p>We are going to walk through building this application by going file by file as we build out the necessary bits.</p>

<h4 id="leanpub-auto-the-main-entry-point-mainrs">The main entry point: main.rs</h4>

<p>As we are building a binary application, we will need some code in <code>main.rs</code> to kick things off. As the functionality here will not be used in a library, and is in fact mostly building on other libraries, we will forgo the advice of creating a separate library that we call into and instead work directly in <code>main.rs</code>.</p>

<p>Let’s bring in some imports to get started:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">structopt</code>::<code class="n">StructOpt</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">heck</code>::<code class="n">TitleCase</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">log</code>::<code class="n">trace</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>structopt</code> crate defines a trait <code>StructOpt</code> and a custom derive which allows you to derive that trait for a type you create. These two pieces together create a system for declaratively specifying how your application takes input from the command line.</p>

<p>Underlying <code>structopt</code> is another crate called <code>clap</code>. You can, and many people do, build a command line application directly by interacting with the <code>clap</code> crate. However, <code>structopt</code> abstracts a lot of those details away, as it is mostly boilerplate, and instead allows you to focus on describing your options using the type system.</p>

<p>If this sounds too abstract at the moment, bear with me, as it will all become clear shortly. Nonetheless, we need to import the trait as we will use that functionality in our main function.</p>

<p>We import <code>TitleCase</code> which is also a trait from the <code>heck</code> crate so that we can convert strings into their title cased equivalents. For example, <code>this_string</code> would be converted to <code>ThisString</code>. We could write this logic ourselves, but why bother to worry about all the edge cases when a high quality crate already exists for this purpose.</p>

<p>Finally, the import of the <code>trace</code> macro from the <code>log</code> crate is to enable us to leverage the <code>log</code> crate’s nice features to implement a form of verbose logging. Logging in Rust has largely concentrated on the abstraction provided by the <code>log</code> crate.</p>

<p>When you write a library or other tool that wants to generate logs, you use the macros in the <code>log</code> crate to write those messages at various verbosity levels. When you are creating an application where you want to enable seeing these different log messages, you bring in a separate crate (or write some extra code yourself) which provides the concrete implementation of how those macros get turned into output. It is possible to have an implementation that writes everything to a file, or that only turns on some verbosity levels, or that writes to the terminal with pretty colors.</p>

<p>As we are creating a binary, we depend on a concrete implementation of the logging functionality, but for actually generating the messages we just need the macros defined in the <code>log</code> crate.</p>

<p>As part of building this application, we are going to split up the functionality into different modules. We define those modules here that we will soon write so they become part of our application:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">5 </code><code class="k">mod</code> <code class="nn">app</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code><code class="k">mod</code> <code class="nn">client</code><code class="p">;</code><code class="w"></code>
<code class="lineno">7 </code><code class="k">mod</code> <code class="nn">errors</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>As you should recall, this tells the compiler to look for files (or directories) with those names and to insert that code here with the appropriate scoping.</p>

<p>We next use a <code>use</code> statement to bring our to be written error type into scope to make our type signatures easier to write:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">9 </code><code class="k">use</code><code class="w"> </code><code class="n">errors</code>::<code class="n">HurlResult</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>One feature we want to support is pretty printing JSON responses. An aspect of pretty printing that can be quite handy is making sure that the keys are sorted. JSON objects do not have a well-defined order so we are free to print them anyway we want. There is an argument that we should faithfully represent the result based on the order of the bytes from the server. However, we are writing our own tool and are therefore free to make decisions such as this. Thus, let’s create a type alias that we will be able to use with serde to get an ordered JSON object:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">11 </code><code class="k">type</code> <code class="nc">OrderedJson</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">std</code>::<code class="n">collections</code>::<code class="n">BTreeMap</code><code class="o">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">Value</code><code class="err">\</code><code class="w"></code>
<code class="lineno">12 </code><code class="o">&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Rust has multiple hash map implementations in the standard library, one in particular is the <code>BTreeMap</code> which stores entires sorted by the key. In this case, we expect our response to have string keys and arbitrary JSON values. This type alias is not doing any work, but we will see how we use it with serde to get the result we are looking for.</p>

<p>We are going to practice a little speculative programming here by writing a main function with code for things that do not yet exist. Given that structure, we then just have to make those things exist and we will be done. Without further ado, our main function:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">13 </code><code class="k">fn</code> <code class="nf">main</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">app</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code>::<code class="n">App</code>::<code class="n">from_args</code><code class="p">();</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">validate</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">16 </code>
<code class="lineno">17 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">level</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">log_level</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">        </code><code class="n">std</code>::<code class="n">env</code>::<code class="n">set_var</code><code class="p">(</code><code class="s">"RUST_LOG"</code><code class="p">,</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"hurl={}"</code><code class="p">,</code><code class="w"> </code><code class="n">level</code><code class="p">));</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">        </code><code class="n">pretty_env_logger</code>::<code class="n">init</code><code class="p">();</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">21 </code>
<code class="lineno">22 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">cmd</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="k">ref</code><code class="w"> </code><code class="n">method</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform_method</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="n">resp</code><code class="p">)</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="nb">None</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">url</code><code class="p">.</code><code class="n">take</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">any</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">is_data</code><code class="p">());</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">method</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">POST</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">GET</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">            </code><code class="p">};</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">url</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">paramet</code><code class="err">\</code><code class="w"></code>
<code class="lineno">36 </code><code class="n">ers</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="n">resp</code><code class="p">)</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">40 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>First, we return a Result, in particular our custom <code>HurlResult</code> with a success type of <code>()</code> meaning we only have a meaningful value to report for errors, and that the <code>Ok</code> case just means everything worked. This shows that the <code>HurlResult</code> type we need to write is generic over the success type as we have seen other result type aliases before.</p>

<p>The first line of our function uses a call to <code>from_args</code> which is defined on the <code>StructOpt</code> trait. Therefore, we need a struct called <code>App</code> in the <code>app</code> module which implements this trait. This does all of the command line argument parsing including exiting if something can’t be parsed as well as printing a help message when necessary.</p>

<p>We then have a call to <code>validate</code> which uses the <code>?</code> operator to exit early if this function fails. This is not part of the argument parsing that <code>StructOpt</code> does. Rather, this is for handling certain constraints on the arguments that <code>StructOpt</code> is unable to enforce. We will see what this is when we get to defining <code>App</code>, but it just shows that sometimes we need workarounds even if a crate does almost everything we need.</p>

<p>There are two further sections. The first uses the <code>log_level</code> method on our app to get a value to setup logging. The <code>pretty_env_logger</code> crate uses environment variables to configure what to print, so we explicitly set the <code>RUST_LOG</code> environment variable based on the value we get. The format is <code>RUST_LOG=binary_name=level</code> where <code>binary_name</code> is not surprisingly the name of your binary and <code>level</code> is one of the five level values that <code>log</code> defines: <code>trace</code>, <code>debug</code>, <code>info</code>, <code>warn</code>, and <code>error</code>. After setting the environment variable, we call <code>pretty_env_logger::init()</code> to actually hook this logging implementation into our use of the macros from the <code>log</code> crate.</p>

<p>The second piece is the heart of our application. We use the <code>cmd</code> (short for command), property on our app to direct what type of request to make. There are two cases, either we got a command which specifies the HTTP verb to use, in that case we use the client module to make the request and then call a <code>handle_response</code> function with the result.</p>

<p>If we did not get a command, i.e. <code>app.cmd</code> matches <code>None</code>, then we are in the default case where we just got a URL. In this case, we make a GET request if we do not have any data arguments, otherwise we make a POST request. We also call a method on the client module to make this request and pipe through to the same <code>handle_response</code> function.</p>

<p>So in either case we end up with a response from our client module that we need to handle. Let’s turn to that handler function:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">41 </code><code class="k">fn</code> <code class="nf">handle_response</code><code class="p">(</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">resp</code>: <code class="nc">reqwest</code>::<code class="n">Response</code><code class="p">,</code><code class="w"></code>
<code class="lineno">43 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>First, the signature. We expect a response as input, which in this case is just the <code>Response</code> type from the <code>reqwest</code> crate, and we return our result type.</p>

<p>The purpose of our tool is to print useful information to standard output and therefore “handling” the response means doing that printing. First, we are going to build up a string based on the metadata about the response. Then we will turn to printing the body.</p>

<p>Our first useful piece of data is the status code of the response as well as the version of HTTP that was used to communicate said response.</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">44 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">status</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">resp</code><code class="p">.</code><code class="n">status</code><code class="p">();</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">s</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">        </code><code class="s">"{:?} {} {}</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">        </code><code class="n">resp</code><code class="p">.</code><code class="n">version</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">        </code><code class="n">status</code><code class="p">.</code><code class="n">as_u16</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="n">status</code><code class="p">.</code><code class="n">canonical_reason</code><code class="p">().</code><code class="n">unwrap_or</code><code class="p">(</code><code class="s">"Unknown"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">    </code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>The string <code>s</code> is going to be our buffer that we use for building up the output. We start out by using <code>format!</code> to create a <code>String</code> based on the version stored in the response, the status code, and the description of that status. Example results for this string are “HTTP/1.1 200 OK” or “HTTP/1.1 403 Forbidden”. We use the <code>Debug</code> output of <code>resp.version()</code> because that is defined to be what we want to show. Sometimes <code>Display</code> is not defined or <code>Debug</code> is what you want to see so don’t always think of <code>{:?}</code> as strictly for debugging.</p>

<p>Next up we want to show the headers from the response. We are going to gather them into a vector which we will combine into a string after the fact.</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">51 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">headers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">)</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">resp</code><code class="p">.</code><code class="n">headers</code><code class="p">().</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">nice_key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">key</code><code class="p">.</code><code class="n">as_str</code><code class="p">().</code><code class="n">to_title_case</code><code class="p">().</code><code class="n">replace</code><code class="p">(</code><code class="sc">' '</code><code class="p">,</code><code class="w"> </code><code class="s">"-"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">        </code><code class="n">headers</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">            </code><code class="s">"{}: {}"</code><code class="p">,</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">            </code><code class="n">nice_key</code><code class="p">,</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">            </code><code class="n">value</code><code class="p">.</code><code class="n">to_str</code><code class="p">().</code><code class="n">unwrap_or</code><code class="p">(</code><code class="s">"BAD HEADER VALUE"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">        </code><code class="p">));</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The response type has a <code>headers</code> function which returns a reference to a <code>Header</code> type that gives us access to the headers. We have to explicitly turn it into an iterator by calling the <code>iter</code> so that we can process each key/value pair. We are again using the <code>format!</code> macro to construct a string for each header.</p>

<p>We create a nice to read key by transforming the raw key in the header map into a consistent style. The <code>to_title_case</code> method is available because we imported the <code>TitleCase</code> trait from <code>heck</code>.</p>

<p>We expect the value to have a string representation, but in case that fails we use a quick and dirty “BAD HEADER VALUE” replacement. We do not want to fail the entire response printing if one header value cannot be printed correctly. Luckily we can use the <code>unwrap_or</code> method to easily handle this case.</p>

<p>One special exception is content length. The reqwest crate does not treat content length as a normal header value and instead provides a <code>content_length</code> function on the response type to get this value. Let’s use this function to get a content length to add to your list of headers:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">60 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">resp</code><code class="p">.</code><code class="n">text</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">content_length</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="n">resp</code><code class="p">.</code><code class="n">content_length</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="n">len</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">len</code><code class="p">,</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">        </code><code class="nb">None</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">result</code><code class="p">.</code><code class="n">len</code><code class="p">()</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="kt">u64</code><code class="p">,</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">    </code><code class="p">};</code><code class="w"></code>
<code class="lineno">65 </code><code class="w">    </code><code class="n">headers</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"Content-Length: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">content_length</code><code class="p">));</code><code class="w"></code>
</pre></div>

</figure>

<p>There is one bit of complication, this function returns an <code>Option</code> and thus we have to deal with computing a value if this function returns <code>None</code>. We accomplish this by getting the <code>text</code> of the response and computing a length.</p>

<p>As far as I can tell, reqwest behaves this way because of compression. The content length of the response is not necessarily the same as the content length that is given in the response header because the actually response body could be compressed. After decompressing the body, we end up with a different length. The library returns <code>None</code> in this case to signal that if you want to compute an accurate content length, you have to do it yourself.</p>

<p>This leads to the question of what do you want to show in this case? The length given in the response header or the length of the decompressed body? We choose the length of the decompressed body as that is more inline with a user’s expectations. </p>

<p>Now that we have all of our headers, we can put it together with our status string and print our first piece of information. </p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">66 </code><code class="w">    </code><code class="n">headers</code><code class="p">.</code><code class="n">sort</code><code class="p">();</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">    </code><code class="n">s</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="o">&amp;</code><code class="p">(</code><code class="o">&amp;</code><code class="n">headers</code><code class="p">[..]).</code><code class="n">join</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">));</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">s</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>We put the headers into a vector so that we can sort by the name of the header here. This makes it easier to find headers in the output. We then use the <code>join</code> method on string slices to turn the list of headers into a newline separated string. As <code>join</code> is not a method on <code>Vec</code>, we have to use <code>&amp;headers[..]</code> to get a reference to a slice of type <code>&amp;[String]</code>. We then turn the output of that function from <code>String</code> to <code>&amp;str</code> with the extra <code>&amp;</code> at the beginning. This allows us to pass the result to <code>push_str</code> which appends onto our already constructed status string <code>s</code>. Finally we print the whole thing out.</p>

<p>Finally, we want to print out the body of the response. We already stored the raw text of the response in the variable <code>result</code> which we used for computing content length. One nicety we want to provide is pretty printing JSON results if the result is JSON. Therefore, we try to parse the body into JSON and then pretty print if that works, otherwise we just print the raw body.</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">70 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">result_json</code>: <code class="nc">serde_json</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="n">OrderedJson</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">from</code><code class="err">\</code><code class="w"></code>
<code class="lineno">71 </code><code class="n">_str</code><code class="p">(</code><code class="o">&amp;</code><code class="n">result</code><code class="p">);</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">result_json</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">result_value</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">74 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">result_str</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">to_string_pretty</code><code class="p">(</code><code class="o">&amp;</code><code class="n">result_value</code><code class="err">\</code><code class="w"></code>
<code class="lineno">75 </code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">76 </code><code class="w">            </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">result_str</code><code class="p">);</code><code class="w"></code>
<code class="lineno">77 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">78 </code><code class="w">        </code><code class="nb">Err</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">79 </code><code class="w">            </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Failed to parse result to JSON: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">e</code><code class="p">);</code><code class="w"></code>
<code class="lineno">80 </code><code class="w">            </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">result</code><code class="p">);</code><code class="w"></code>
<code class="lineno">81 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">82 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">83 </code>
<code class="lineno">84 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"></code>
<code class="lineno">85 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Note here that as we are specifying the type of <code>result_json</code> as <code>serde_json::Result&lt;OrderedJson&gt;</code> the actually representation of the JSON will be ordered by the keys if it is correctly parsed. This is because of our type alias for <code>OrderedJson</code> telling serde that it should use a BTreeMap as the container for the top level JSON object.</p>

<h4 id="leanpub-auto-the-application-module">The application module</h4>

<p>We already wrote code that depends on the existence of an <code>app</code> module, so let’s make that real by creating <code>src/app.rs</code> and getting started with some imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">log</code>::<code class="p">{</code><code class="n">debug</code><code class="p">,</code><code class="w"> </code><code class="n">trace</code><code class="p">};</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">convert</code>::<code class="n">TryFrom</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">structopt</code>::<code class="n">StructOpt</code><code class="p">;</code><code class="w"></code>
<code class="lineno">4 </code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="p">{</code><code class="n">Error</code><code class="p">,</code><code class="w"> </code><code class="n">HurlResult</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>This module is the core of how we interact with the user via command line arguments. The <code>App</code> struct is both the data that configures what we will do as well as the majority of the code we need to write to handle getting that data. This is because of the <code>StructOpt</code> custom derive macro which we take advantage of.</p>

<p>The <code>structopt</code> crate is built on the <code>clap</code> crate. You may also see people using <code>Clap</code> to create command line applications. We are doing the same thing, but writing significantly less code by using a form of declarative programming. We are going to build up a large struct definition in pieces and explain as we go, but in the end we will have almost everything we need to build a full featured command line application.</p>

<p>Our first step is to declare our struct with the name <code>App</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 7 </code><code class="sd">/// A command line HTTP client</code>
<code class="lineno"> 8 </code><code class="cp">#[derive(StructOpt, Debug)]</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="cp">#[structopt(name = </code><code class="s">"hurl"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">10 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">App</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>Comments that start with three slashes, <code>///</code>, are known as doc comments. They are treated specially by the compiler and used for auto-generating crate documentation. Notice that we put such a comment on top of the derives for our struct which will associate that comment with the struct as a whole.</p>

<p>We derive <code>Debug</code> which is normal and we have seen before, but the magic happens by deriving <code>StructOpt</code>. This is a type of macro known as a custom derive which means that code in the <code>structopt</code> crate will be given our struct definition as input and  will output code which will then be included in our crate. This is how the <code>Debug</code> derive works as well except that custom code is part of the standard library. Usually these derives are used to implement traits, but they can also be used for any number of other purposes.</p>

<p>We also see an attribute <code>#[structopt(name = "hurl")]</code> which is ignored by the rest of the compiler but is something that the <code>StructOpt</code> derive uses for customization. Doc comments are included as part of the struct definition to the custom derive and therefore <code>structopt</code> uses the doc comment on this struct as part of the help message which gets created as part of the code that is generated.</p>

<p>We then create several options for our application to accept at the command line by creating fields on our struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">11 </code><code class="w">    </code><code class="sd">/// Activate quiet mode.</code>
<code class="lineno">12 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">13 </code><code class="w">    </code><code class="sd">/// This overrides any verbose settings.</code>
<code class="lineno">14 </code><code class="w">    </code><code class="cp">#[structopt(short, long)]</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">quiet</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code>
<code class="lineno">17 </code><code class="w">    </code><code class="sd">/// Verbose mode (-v, -vv, -vvv, etc.).</code>
<code class="lineno">18 </code><code class="w">    </code><code class="cp">#[structopt(short, long, parse(from_occurrences))]</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">verbose</code>: <code class="kt">u8</code><code class="p">,</code><code class="w"></code>
<code class="lineno">20 </code>
<code class="lineno">21 </code><code class="w">    </code><code class="sd">/// Form mode.</code>
<code class="lineno">22 </code><code class="w">    </code><code class="cp">#[structopt(short, long)]</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">form</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">24 </code>
<code class="lineno">25 </code><code class="w">    </code><code class="sd">/// Basic authentication.</code>
<code class="lineno">26 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">27 </code><code class="w">    </code><code class="sd">/// A string of the form `username:password`. If only</code>
<code class="lineno">28 </code><code class="w">    </code><code class="sd">/// `username` is given then you will be prompted</code>
<code class="lineno">29 </code><code class="w">    </code><code class="sd">/// for a password. If you wish to use no password</code>
<code class="lineno">30 </code><code class="w">    </code><code class="sd">/// then use the form `username:`.</code>
<code class="lineno">31 </code><code class="w">    </code><code class="cp">#[structopt(short, long)]</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">auth</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">33 </code>
<code class="lineno">34 </code><code class="w">    </code><code class="sd">/// Bearer token authentication.</code>
<code class="lineno">35 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">36 </code><code class="w">    </code><code class="sd">/// A token which will be sent as "Bearaer &lt;token&gt;" in</code>
<code class="lineno">37 </code><code class="w">    </code><code class="sd">/// the authorization header.</code>
<code class="lineno">38 </code><code class="w">    </code><code class="cp">#[structopt(short, long)]</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">40 </code>
<code class="lineno">41 </code><code class="w">    </code><code class="sd">/// Default transport.</code>
<code class="lineno">42 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">43 </code><code class="w">    </code><code class="sd">/// If a URL is given without a transport, i.e example.com/foo</code>
<code class="lineno">44 </code><code class="w">    </code><code class="sd">/// http will be used as the transport by default. If this flag</code>
<code class="lineno">45 </code><code class="w">    </code><code class="sd">/// is set then https will be used instead.</code>
<code class="lineno">46 </code><code class="w">    </code><code class="cp">#[structopt(short, long)]</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">secure</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">48 </code>
<code class="lineno">49 </code><code class="w">    </code><code class="sd">/// The HTTP Method to use, one of: HEAD, GET, POST, PUT, PATCH, DE\</code>
<code class="lineno">50 </code><code class="n">LETE</code><code class="p">.</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="cp">#[structopt(subcommand)]</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">cmd</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">Method</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">53 </code>
<code class="lineno">54 </code><code class="w">    </code><code class="sd">/// The URL to issue a request to if a method subcommand is not spe\</code>
<code class="lineno">55 </code><code class="n">cified</code><code class="p">.</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">url</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
</pre></div>

</figure>

<p>The types of the variables determine what type of flag/option is created. For example, a field with type <code>bool</code> like <code>quiet</code> creates a flag which sets the field to true if it is present and is otherwise set to false. Each field has documentation in the help message created by the doc comments. The attributes on the fields are further used for customization. For example, <code>short, long</code> says that the field should be usable using a short form like <code>-q</code> for <code>quiet</code> and a long form <code>--quiet</code>.</p>

<p>The structopt docs explain exactly what each type implies but they are mostly what one would expect. An <code>Option</code> around a type signifies that argument is optional, whereas a non-optional field that is not a <code>bool</code> would be treated as a required positional argument. We use <code>parse(from_occurrences)</code> on the <code>verbose</code> field to allow the <code>u8</code> field to be inferred from the number of times the argument is passed. This is a common pattern to use for verbosity by command line tools.</p>

<p>The one special field you might notice is <code>cmd</code> which has a attribute of <code>subcommand</code>. We will get to this below, but basically this means that we need to define a <code>Method</code> type which also derives <code>StructOpt</code> which will be used to create a subprogram here. As this is wrapped in an <code>Option</code> this is not required.</p>

<p>Finally, the last piece of data that we accept is a list of parameters:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">56 </code><code class="w">    </code><code class="sd">/// The parameters for the request if a method subcommand is not sp\</code>
<code class="lineno">57 </code><code class="n">ecified</code><code class="p">.</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">59 </code><code class="w">    </code><code class="sd">/// There are seven types of parameters that can be added to a comm\</code>
<code class="lineno">60 </code><code class="n">and</code><code class="o">-</code><code class="n">line</code><code class="p">.</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="sd">/// Each type of parameter is distinguished by the unique separator\</code>
<code class="lineno">62 </code><code class="w"> </code><code class="n">between</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">    </code><code class="sd">/// the key and value.</code>
<code class="lineno">64 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">65 </code><code class="w">    </code><code class="sd">/// Header -- key:value</code>
<code class="lineno">66 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">67 </code><code class="w">    </code><code class="sd">///   e.g. X-API-TOKEN:abc123</code>
<code class="lineno">68 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">69 </code><code class="w">    </code><code class="sd">/// File upload -- key@filename</code>
<code class="lineno">70 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">71 </code><code class="w">    </code><code class="sd">///   this simulates a file upload via multipart/form-data and requ\</code>
<code class="lineno">72 </code><code class="n">ires</code><code class="w"> </code><code class="o">--</code><code class="n">form</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">74 </code><code class="w">    </code><code class="sd">/// Query parameter -- key==value</code>
<code class="lineno">75 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">76 </code><code class="w">    </code><code class="sd">///   e.g. foo==bar becomes example.com?foo=bar</code>
<code class="lineno">77 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">78 </code><code class="w">    </code><code class="sd">/// Data field -- key=value</code>
<code class="lineno">79 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">80 </code><code class="w">    </code><code class="sd">///   e.g. foo=bar becomes {"foo":"bar"} for JSON or form encoded</code>
<code class="lineno">81 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">82 </code><code class="w">    </code><code class="sd">/// Data field from file -- key=@filename</code>
<code class="lineno">83 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">84 </code><code class="w">    </code><code class="sd">///   e.g. foo=@bar.txt becomes {"foo":"the contents of bar.txt"} o\</code>
<code class="lineno">85 </code><code class="n">r</code><code class="w"> </code><code class="n">form</code><code class="w"> </code><code class="n">encoded</code><code class="w"></code>
<code class="lineno">86 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">87 </code><code class="w">    </code><code class="sd">/// Raw JSON data where the value should be parsed to JSON first --\</code>
<code class="lineno">88 </code><code class="w"> </code><code class="n">key</code>:<code class="o">=</code><code class="n">value</code><code class="w"></code>
<code class="lineno">89 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">90 </code><code class="w">    </code><code class="sd">///   e.g. foo:=[1,2,3] becomes {"foo":[1,2,3]}</code>
<code class="lineno">91 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">92 </code><code class="w">    </code><code class="sd">/// Raw JSON data from file -- key:=@filename</code>
<code class="lineno">93 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">94 </code><code class="w">    </code><code class="sd">///   e.g. foo:=@bar.json becomes {"foo":{"bar":"this is from bar.j\</code>
<code class="lineno">95 </code><code class="n">son</code><code class="s">"}}</code>
<code class="lineno">96 </code><code class="s">    #[structopt(parse(try_from_str = parse_param))]</code>
<code class="lineno">97 </code><code class="s">    pub parameters: Vec&lt;Parameter&gt;,</code>
<code class="lineno">98 </code><code class="s">}</code>
</pre></div>

</figure>

<p>This is mostly documentation, and that documentation should explain what is going on. The <code>Vec&lt;Parameter&gt;</code> type means that we accept multiple values of this type of input. As this is a custom type we also need to implement <code>parse_param</code> to work with the attribute that allows us to define a custom parsing function.</p>

<p>With our definition out of the way, most of the hard work of creating a nice command line interface is taken care of. We have a few pieces still left to take care of to handle some of the custom pieces of our app, but for most applications just defining the struct with the right field types can be all you need to do.</p>

<p>We need to add some methods to our <code>App</code>. There is no way to declaratively say that we want exactly one of <code>cmd</code> or <code>url</code> to exist. This is partially because of the way we define <code>Method</code> as we will see below and it is partially due to limitations in the custom derive. Therefore, we create a <code>validate</code> method to check this constraint after the parsing has completed and will allow us to error out in that case.</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 93 </code><code class="k">impl</code><code class="w"> </code><code class="n">App</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 94 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">validate</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 95 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">cmd</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">url</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 96 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">Error</code>::<code class="n">MissingUrlAndCommand</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">100 </code>
<code class="lineno">101 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">log_level</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">quiet</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">verbose</code><code class="w"> </code><code class="o">&lt;=</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">None</code><code class="p">;</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">105 </code>
<code class="lineno">106 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">verbose</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">107 </code><code class="w">            </code><code class="mi">1</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"error"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">108 </code><code class="w">            </code><code class="mi">2</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"warn"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">109 </code><code class="w">            </code><code class="mi">3</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"info"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">110 </code><code class="w">            </code><code class="mi">4</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"debug"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">111 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="s">"trace"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">112 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">113 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">114 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The other thing we add is a helper to turn the <code>quiet</code> and <code>verbose</code> settings into a string log level for use with our logging implementation.</p>

<p>Now we can turn to our data structure for the subcommand:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">116 </code><code class="cp">#[derive(StructOpt, Debug)]</code><code class="w"></code>
<code class="lineno">117 </code><code class="cp">#[structopt(rename_all = </code><code class="s">"screaming_snake_case"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">118 </code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code> <code class="nc">Method</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">    </code><code class="n">HEAD</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">120 </code><code class="w">    </code><code class="n">GET</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">121 </code><code class="w">    </code><code class="n">PUT</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">    </code><code class="n">POST</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">    </code><code class="n">PATCH</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">    </code><code class="n">DELETE</code><code class="p">(</code><code class="n">MethodData</code><code class="p">),</code><code class="w"></code>
<code class="lineno">125 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We create an <code>enum</code> because we want to use the name of the enum, which is an HTTP method, as the name of the subcommand. <code>StructOpt</code> works just as well with an enum as a struct, provided you follow the rules for what the variants can be. In our case, each variant has the same inner data which itself derives <code>StructOpt</code>. The one extra attribute we use here <code>rename_all = "screaming_snake_case"</code> is so that our program uses the form <code>hurl POST whatever.com</code> instead of <code>hurl post whatever.com</code>. This is a purely stylistic choice.</p>

<p>The inner data for each enum variant is a struct to contain the URL and the parameters:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">154 </code><code class="cp">#[derive(StructOpt, Debug)]</code><code class="w"></code>
<code class="lineno">155 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">MethodData</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">156 </code><code class="w">    </code><code class="sd">/// The URL to request.</code>
<code class="lineno">157 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">url</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">158 </code>
<code class="lineno">159 </code><code class="w">    </code><code class="sd">/// The headers, data, and query parameters to add to the request.</code>
</pre></div>

</figure>

<p>All of the doc comments on the <code>parameters</code> field in the top level <code>App</code> struct are repeated here in the code, but we omit them for brevity:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">191 </code><code class="w">    </code><code class="cp">#[structopt(parse(try_from_str = parse_param))]</code><code class="w"></code>
<code class="lineno">192 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">parameters</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">193 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Generally, the same thing repeated can be a sign of some missing abstraction or constant, but in this case the repeated documentation is about as good as we can do.</p>

<p>We also define one helper method on our <code>Method</code> enum to get the data out of each variant:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">127 </code><code class="k">impl</code><code class="w"> </code><code class="n">Method</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">data</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="kp">&amp;</code><code class="nc">MethodData</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">        </code><code class="k">use</code><code class="w"> </code><code class="n">Method</code>::<code class="o">*</code><code class="p">;</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">            </code><code class="n">HEAD</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">            </code><code class="n">GET</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">133 </code><code class="w">            </code><code class="n">PUT</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">134 </code><code class="w">            </code><code class="n">POST</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">            </code><code class="n">PATCH</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">            </code><code class="n">DELETE</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"></code>
<code class="lineno">137 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">138 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">139 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have been using the <code>Parameter</code> type in our definitions above, so it is now time to define it:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">195 </code><code class="cp">#[derive(Debug)]</code><code class="w"></code>
<code class="lineno">196 </code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code> <code class="nc">Parameter</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">197 </code><code class="w">    </code><code class="c1">// :</code>
<code class="lineno">198 </code><code class="w">    </code><code class="n">Header</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">value</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">199 </code><code class="w">    </code><code class="c1">// =</code>
<code class="lineno">200 </code><code class="w">    </code><code class="n">Data</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">value</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">201 </code><code class="w">    </code><code class="c1">// :=</code>
<code class="lineno">202 </code><code class="w">    </code><code class="n">RawJsonData</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">value</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">203 </code><code class="w">    </code><code class="c1">// ==</code>
<code class="lineno">204 </code><code class="w">    </code><code class="n">Query</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">value</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">205 </code><code class="w">    </code><code class="c1">// @</code>
<code class="lineno">206 </code><code class="w">    </code><code class="n">FormFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">207 </code><code class="w">    </code><code class="c1">// =@</code>
<code class="lineno">208 </code><code class="w">    </code><code class="n">DataFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">209 </code><code class="w">    </code><code class="c1">// :=@</code>
<code class="lineno">210 </code><code class="w">    </code><code class="n">RawJsonDataFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code>: <code class="nb">String</code> <code class="p">},</code><code class="w"></code>
<code class="lineno">211 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This enum is used to specify the data for the different types of parameters that accept. Each one has a particular use case and having the nice shorthand is quite helpful when mixing and matching.</p>

<p>Our final task in this module is to write our <code>parse_param</code> function which will take a string and maybe turn it into a <code>Parameter</code>. In order to make this task easier, we define a <code>Token</code> type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">258 </code><code class="cp">#[derive(Debug)]</code><code class="w"></code>
<code class="lineno">259 </code><code class="k">enum</code> <code class="nc">Token</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">260 </code><code class="w">    </code><code class="n">Text</code><code class="p">(</code><code class="o">&amp;</code><code class="na">'a</code><code class="w"> </code><code class="kt">str</code><code class="p">),</code><code class="w"></code>
<code class="lineno">261 </code><code class="w">    </code><code class="n">Escape</code><code class="p">(</code><code class="n">char</code><code class="p">),</code><code class="w"></code>
<code class="lineno">262 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have these special separator characters like <code>:</code> and <code>==</code>, but we need some notion of escaping to allow those to appear in keys and values. We further write a helper function to take string and parse it into a vector of these tokens:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">264 </code><code class="k">fn</code> <code class="nf">gather_escapes</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;</code><code class="p">(</code><code class="n">src</code>: <code class="kp">&amp;</code><code class="na">'a</code><code class="w"> </code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Token</code><code class="o">&lt;</code><code class="na">'a</code><code class="o">&gt;&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">265 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">tokens</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">266 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"></code>
<code class="lineno">267 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">end</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"></code>
<code class="lineno">268 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">chars</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">src</code><code class="p">.</code><code class="n">chars</code><code class="p">();</code><code class="w"></code>
<code class="lineno">269 </code><code class="w">    </code><code class="k">loop</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">270 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">chars</code><code class="p">.</code><code class="n">next</code><code class="p">();</code><code class="w"></code>
<code class="lineno">271 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">a</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">272 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="n">end</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">273 </code><code class="w">                </code><code class="n">tokens</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="o">&amp;</code><code class="n">src</code><code class="p">[</code><code class="n">start</code><code class="p">..</code><code class="n">end</code><code class="p">]));</code><code class="w"></code>
<code class="lineno">274 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">275 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">tokens</code><code class="p">;</code><code class="w"></code>
<code class="lineno">276 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">277 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">a</code><code class="p">.</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">278 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="sc">'\\'</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">279 </code><code class="w">            </code><code class="n">end</code><code class="w"> </code><code class="o">+=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">280 </code><code class="w">            </code><code class="k">continue</code><code class="p">;</code><code class="w"></code>
<code class="lineno">281 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">282 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">chars</code><code class="p">.</code><code class="n">next</code><code class="p">();</code><code class="w"></code>
<code class="lineno">283 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">284 </code><code class="w">            </code><code class="n">tokens</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="o">&amp;</code><code class="n">src</code><code class="p">[</code><code class="n">start</code><code class="p">..</code><code class="n">end</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">]));</code><code class="w"></code>
<code class="lineno">285 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">tokens</code><code class="p">;</code><code class="w"></code>
<code class="lineno">286 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">287 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">288 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">289 </code><code class="w">            </code><code class="sc">'\\'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'='</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'@'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">':'</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">290 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="n">end</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">291 </code><code class="w">                    </code><code class="n">tokens</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="o">&amp;</code><code class="n">src</code><code class="p">[</code><code class="n">start</code><code class="p">..</code><code class="n">end</code><code class="p">]));</code><code class="w"></code>
<code class="lineno">292 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">293 </code><code class="w">                </code><code class="n">tokens</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">Token</code>::<code class="n">Escape</code><code class="p">(</code><code class="n">c</code><code class="p">));</code><code class="w"></code>
<code class="lineno">294 </code><code class="w">                </code><code class="n">end</code><code class="w"> </code><code class="o">+=</code><code class="w"> </code><code class="mi">2</code><code class="p">;</code><code class="w"></code>
<code class="lineno">295 </code><code class="w">                </code><code class="n">start</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">end</code><code class="p">;</code><code class="w"></code>
<code class="lineno">296 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">297 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">end</code><code class="w"> </code><code class="o">+=</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"></code>
<code class="lineno">298 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">299 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">300 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is not the most exciting or elegant parsing code. We use a pair of indexes into the source string along with possibly some lookahead to tokenize the input. Basically this is looking for <code>\</code>, <code>=</code>, <code>@</code>, and <code>:</code> following a <code>\</code> character to indicate that this otherwise special character should be escaped and treated as a literal. Everything else gets turned into a piece of text.</p>

<p>Finally, we can write our <code>parse_param</code> function which gets a string from the command line and tries to turn it into a <code>Parameter</code> or an appropriate error:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">302 </code><code class="k">fn</code> <code class="nf">parse_param</code><code class="p">(</code><code class="n">src</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">303 </code><code class="w">    </code><code class="n">debug</code><code class="o">!</code><code class="p">(</code><code class="s">"Parsing: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">src</code><code class="p">);</code><code class="w"></code>
<code class="lineno">304 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">separators</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s">":=@"</code><code class="p">,</code><code class="w"> </code><code class="s">"=@"</code><code class="p">,</code><code class="w"> </code><code class="s">"=="</code><code class="p">,</code><code class="w"> </code><code class="s">":="</code><code class="p">,</code><code class="w"> </code><code class="s">"@"</code><code class="p">,</code><code class="w"> </code><code class="s">"="</code><code class="p">,</code><code class="w"> </code><code class="s">":"</code><code class="p">];</code><code class="w"></code>
<code class="lineno">305 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">tokens</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">gather_escapes</code><code class="p">(</code><code class="n">src</code><code class="p">);</code><code class="w"></code>
<code class="lineno">306 </code>
<code class="lineno">307 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">found</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Vec</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">308 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">idx</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"></code>
<code class="lineno">309 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code class="w"> </code><code class="n">token</code><code class="p">)</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">tokens</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">enumerate</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">310 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">token</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">311 </code><code class="w">            </code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">312 </code><code class="w">                </code><code class="k">for</code><code class="w"> </code><code class="n">sep</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">separators</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">313 </code><code class="w">                    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">n</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">find</code><code class="p">(</code><code class="n">sep</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">314 </code><code class="w">                        </code><code class="n">found</code><code class="p">.</code><code class="n">push</code><code class="p">((</code><code class="n">n</code><code class="p">,</code><code class="w"> </code><code class="n">sep</code><code class="p">));</code><code class="w"></code>
<code class="lineno">315 </code><code class="w">                    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">316 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">317 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">found</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">318 </code><code class="w">                    </code><code class="n">idx</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">i</code><code class="p">;</code><code class="w"></code>
<code class="lineno">319 </code><code class="w">                    </code><code class="k">break</code><code class="p">;</code><code class="w"></code>
<code class="lineno">320 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">321 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">322 </code><code class="w">            </code><code class="n">Token</code>::<code class="n">Escape</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="lineno">323 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">324 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">325 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">found</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">326 </code><code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">Error</code>::<code class="n">ParameterMissingSeparator</code><code class="p">(</code><code class="n">src</code><code class="p">.</code><code class="n">to_owned</code><code class="p">()));</code><code class="w"></code>
<code class="lineno">327 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">328 </code><code class="w">    </code><code class="n">found</code><code class="p">.</code><code class="n">sort_by</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">ai</code><code class="p">,</code><code class="w"> </code><code class="n">asep</code><code class="p">),</code><code class="w"> </code><code class="p">(</code><code class="n">bi</code><code class="p">,</code><code class="w"> </code><code class="n">bsep</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="n">ai</code><code class="p">.</code><code class="n">cmp</code><code class="p">(</code><code class="n">bi</code><code class="p">).</code><code class="n">then</code><code class="p">(</code><code class="n">bsep</code><code class="p">.</code><code class="n">len</code><code class="p">().</code><code class="n">c</code><code class="err">\</code><code class="w"></code>
<code class="lineno">329 </code><code class="n">mp</code><code class="p">(</code><code class="o">&amp;</code><code class="n">asep</code><code class="p">.</code><code class="n">len</code><code class="p">())));</code><code class="w"></code>
<code class="lineno">330 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">sep</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">found</code><code class="p">.</code><code class="n">first</code><code class="p">().</code><code class="n">unwrap</code><code class="p">().</code><code class="mi">1</code><code class="p">;</code><code class="w"></code>
<code class="lineno">331 </code><code class="w">    </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Found separator: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">sep</code><code class="p">);</code><code class="w"></code>
<code class="lineno">332 </code>
<code class="lineno">333 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">334 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">335 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code class="w"> </code><code class="n">token</code><code class="p">)</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">tokens</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">enumerate</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">336 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="n">idx</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">337 </code><code class="w">            </code><code class="k">match</code><code class="w"> </code><code class="n">token</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">338 </code><code class="w">                </code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">key</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="o">&amp;</code><code class="n">s</code><code class="p">),</code><code class="w"></code>
<code class="lineno">339 </code><code class="w">                </code><code class="n">Token</code>::<code class="n">Escape</code><code class="p">(</code><code class="n">c</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">340 </code><code class="w">                    </code><code class="n">key</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="sc">'\\'</code><code class="p">);</code><code class="w"></code>
<code class="lineno">341 </code><code class="w">                    </code><code class="n">key</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="o">*</code><code class="n">c</code><code class="p">);</code><code class="w"></code>
<code class="lineno">342 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">343 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">344 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="n">idx</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">345 </code><code class="w">            </code><code class="k">match</code><code class="w"> </code><code class="n">token</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">346 </code><code class="w">                </code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">value</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="o">&amp;</code><code class="n">s</code><code class="p">),</code><code class="w"></code>
<code class="lineno">347 </code><code class="w">                </code><code class="n">Token</code>::<code class="n">Escape</code><code class="p">(</code><code class="n">c</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">348 </code><code class="w">                    </code><code class="n">value</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="sc">'\\'</code><code class="p">);</code><code class="w"></code>
<code class="lineno">349 </code><code class="w">                    </code><code class="n">value</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="o">*</code><code class="n">c</code><code class="p">);</code><code class="w"></code>
<code class="lineno">350 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">351 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">352 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">353 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="n">Token</code>::<code class="n">Text</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">token</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">354 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">parts</code>: <code class="nb">Vec</code><code class="o">&lt;&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">splitn</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="n">sep</code><code class="p">).</code><code class="n">collect</code><code class="p">();</code><code class="w"></code>
<code class="lineno">355 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">k</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">first</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">356 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">v</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parts</code><code class="p">.</code><code class="n">last</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">357 </code><code class="w">                </code><code class="n">key</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="n">k</code><code class="p">);</code><code class="w"></code>
<code class="lineno">358 </code><code class="w">                </code><code class="n">value</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="n">v</code><code class="p">);</code><code class="w"></code>
<code class="lineno">359 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">360 </code><code class="w">                </code><code class="n">unreachable</code><code class="o">!</code><code class="p">();</code><code class="w"></code>
<code class="lineno">361 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">362 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">363 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">364 </code>
<code class="lineno">365 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">separator</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Separator</code>::<code class="n">try_from</code><code class="p">(</code><code class="o">*</code><code class="n">sep</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">366 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">separator</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">367 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">At</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">FormFile</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">368 </code><code class="w">                </code><code class="n">key</code><code class="p">,</code><code class="w"></code>
<code class="lineno">369 </code><code class="w">                </code><code class="n">filename</code>: <code class="nc">value</code><code class="p">,</code><code class="w"></code>
<code class="lineno">370 </code><code class="w">            </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">371 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">Equal</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">Data</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">372 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">Colon</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">Header</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">373 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">ColonEqual</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">RawJsonData</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">v</code><code class="err">\</code><code class="w"></code>
<code class="lineno">374 </code><code class="n">alue</code><code class="w"> </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">375 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">EqualEqual</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">Query</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="err">\</code><code class="w"></code>
<code class="lineno">376 </code><code class="p">),</code><code class="w"></code>
<code class="lineno">377 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">EqualAt</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">DataFile</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">378 </code><code class="w">                </code><code class="n">key</code><code class="p">,</code><code class="w"></code>
<code class="lineno">379 </code><code class="w">                </code><code class="n">filename</code>: <code class="nc">value</code><code class="p">,</code><code class="w"></code>
<code class="lineno">380 </code><code class="w">            </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">381 </code><code class="w">            </code><code class="n">Separator</code>::<code class="n">Snail</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Parameter</code>::<code class="n">RawJsonDataFile</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">382 </code><code class="w">                </code><code class="n">key</code><code class="p">,</code><code class="w"></code>
<code class="lineno">383 </code><code class="w">                </code><code class="n">filename</code>: <code class="nc">value</code><code class="p">,</code><code class="w"></code>
<code class="lineno">384 </code><code class="w">            </code><code class="p">}),</code><code class="w"></code>
<code class="lineno">385 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">386 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">387 </code><code class="w">        </code><code class="n">unreachable</code><code class="o">!</code><code class="p">();</code><code class="w"></code>
<code class="lineno">388 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">389 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use our <code>gather_escapes</code> function to tokenize the input. Then we loop over those tokens looking for separators. We are trying to find the earliest and longest separator as some of them have overlap. The <code>found</code> vector will contain all of the separators that match in the first text segment with an separator. We also store the index in the segment where this separator starts. If we have anything in that list we can stop looking for more, so we break. We error out if no separators are found as that is an erroneous state.</p>

<p>We sort by location and then length of the separator to match our desired condition. Then as we know the vector is not empty we can extract the separator for this parameter from the first element in the vector.</p>

<p>The next chunk of code is using the data we have stored so far to construct a key and value for the particular separator.</p>

<p>Finally, we use the text value of the separator to get a separator type which we then use to construct the appropriate <code>Parameter</code>. The code for going from a separator string to a <code>Separator</code> as well as the <code>Separator</code> enum definition is straightforward:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">230 </code><code class="cp">#[derive(Debug)]</code><code class="w"></code>
<code class="lineno">231 </code><code class="k">enum</code> <code class="nc">Separator</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">232 </code><code class="w">    </code><code class="n">Colon</code><code class="p">,</code><code class="w"></code>
<code class="lineno">233 </code><code class="w">    </code><code class="n">Equal</code><code class="p">,</code><code class="w"></code>
<code class="lineno">234 </code><code class="w">    </code><code class="n">At</code><code class="p">,</code><code class="w"></code>
<code class="lineno">235 </code><code class="w">    </code><code class="n">ColonEqual</code><code class="p">,</code><code class="w"></code>
<code class="lineno">236 </code><code class="w">    </code><code class="n">EqualEqual</code><code class="p">,</code><code class="w"></code>
<code class="lineno">237 </code><code class="w">    </code><code class="n">EqualAt</code><code class="p">,</code><code class="w"></code>
<code class="lineno">238 </code><code class="w">    </code><code class="n">Snail</code><code class="p">,</code><code class="w"></code>
<code class="lineno">239 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">240 </code>
<code class="lineno">241 </code><code class="k">impl</code><code class="w"> </code><code class="n">TryFrom</code><code class="o">&lt;&amp;</code><code class="kt">str</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Separator</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">242 </code><code class="w">    </code><code class="k">type</code> <code class="nc">Error</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">();</code><code class="w"></code>
<code class="lineno">243 </code>
<code class="lineno">244 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">try_from</code><code class="p">(</code><code class="n">value</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">Self</code><code class="p">,</code><code class="w"> </code><code class="n">Self</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">245 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">246 </code><code class="w">            </code><code class="s">":"</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">Colon</code><code class="p">),</code><code class="w"></code>
<code class="lineno">247 </code><code class="w">            </code><code class="s">"="</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">Equal</code><code class="p">),</code><code class="w"></code>
<code class="lineno">248 </code><code class="w">            </code><code class="s">"@"</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">At</code><code class="p">),</code><code class="w"></code>
<code class="lineno">249 </code><code class="w">            </code><code class="s">":="</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">ColonEqual</code><code class="p">),</code><code class="w"></code>
<code class="lineno">250 </code><code class="w">            </code><code class="s">"=="</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">EqualEqual</code><code class="p">),</code><code class="w"></code>
<code class="lineno">251 </code><code class="w">            </code><code class="s">"=@"</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">EqualAt</code><code class="p">),</code><code class="w"></code>
<code class="lineno">252 </code><code class="w">            </code><code class="s">":=@"</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">Separator</code>::<code class="n">Snail</code><code class="p">),</code><code class="w"></code>
<code class="lineno">253 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Err</code><code class="p">(()),</code><code class="w"></code>
<code class="lineno">254 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">255 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">256 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-the-client-module">The client module</h4>

<p>We need some mechanism for actually making HTTP requests based on all of this configuration we are building. The module that is responsible for this we call <code>client</code>, so let’s get started as usual with some imports in <code>src/client.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">app</code>::<code class="p">{</code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">Method</code><code class="p">,</code><code class="w"> </code><code class="n">Parameter</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="p">{</code><code class="n">Error</code><code class="p">,</code><code class="w"> </code><code class="n">HurlResult</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="k">use</code><code class="w"> </code><code class="n">log</code>::<code class="p">{</code><code class="n">info</code><code class="p">,</code><code class="w"> </code><code class="n">debug</code><code class="p">,</code><code class="w"> </code><code class="n">trace</code><code class="p">,</code><code class="w"> </code><code class="n">log_enabled</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="k">use</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">multipart</code>::<code class="n">Form</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="k">use</code><code class="w"> </code><code class="n">reqwest</code>::<code class="p">{</code><code class="n">Client</code><code class="p">,</code><code class="w"> </code><code class="n">RequestBuilder</code><code class="p">,</code><code class="w"> </code><code class="n">Response</code><code class="p">,</code><code class="w"> </code><code class="n">Url</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="k">use</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">Value</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">collections</code>::<code class="n">HashMap</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fs</code>::<code class="n">File</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">io</code>::<code class="n">BufReader</code><code class="p">;</code><code class="w"></code>
<code class="lineno">10 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">time</code>::<code class="n">Instant</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>A lot more imports than usual as there is quite a bit to take care of in this module. We are going to build up many small functions to which can be put together to make the different requests we are trying to make. Let’s first recall how we call the client module from main:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">22 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">cmd</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="k">ref</code><code class="w"> </code><code class="n">method</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform_method</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="n">resp</code><code class="p">)</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="nb">None</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">url</code><code class="p">.</code><code class="n">take</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">any</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">is_data</code><code class="p">());</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">method</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">POST</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">GET</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">            </code><code class="p">};</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">url</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">paramet</code><code class="err">\</code><code class="w"></code>
<code class="lineno">36 </code><code class="n">ers</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="n">resp</code><code class="p">)</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We see that there are two entry points, <code>perform_method</code> and <code>perform</code>. Let’s start with <code>perform_method</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">12 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">perform_method</code><code class="p">(</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">method</code>: <code class="kp">&amp;</code><code class="nc">Method</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">method_data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">method</code><code class="p">.</code><code class="n">data</code><code class="p">();</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="n">perform</code><code class="p">(</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">        </code><code class="n">app</code><code class="p">,</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">        </code><code class="n">method</code><code class="p">.</code><code class="n">into</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">method_data</code><code class="p">.</code><code class="n">url</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">method_data</code><code class="p">.</code><code class="n">parameters</code><code class="p">,</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="p">)</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is a simple helper function which takes our <code>Method</code> struct and gets the relevant data from it so that we can call the more general <code>perform</code> function. The only missing piece that we rely on is the <code>method.into()</code> call which converts our <code>Method</code> struct into the <code>reqwest::Method</code> type. We need to write the code for that conversion, which we will put into our <code>app</code> module alongside the definition of <code>Method</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">141 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;&amp;</code><code class="n">Method</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">142 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">m</code>: <code class="kp">&amp;</code><code class="nc">Method</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">reqwest</code>::<code class="n">Method</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">m</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">144 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">HEAD</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">HEAD</code><code class="p">,</code><code class="w"></code>
<code class="lineno">145 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">GET</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">GET</code><code class="p">,</code><code class="w"></code>
<code class="lineno">146 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">PUT</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">PUT</code><code class="p">,</code><code class="w"></code>
<code class="lineno">147 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">POST</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">POST</code><code class="p">,</code><code class="w"></code>
<code class="lineno">148 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">PATCH</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">PATCH</code><code class="p">,</code><code class="w"></code>
<code class="lineno">149 </code><code class="w">            </code><code class="n">Method</code>::<code class="n">DELETE</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">DELETE</code><code class="p">,</code><code class="w"></code>
<code class="lineno">150 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">151 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">152 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is a straightforward implementation of the <code>From</code> trait which as we have seen before gives us the reciprocal <code>Into</code> trait for free which we are using in our function call.</p>

<p>So we just need to implement the general <code>perform</code> function and we will be done:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">perform</code><code class="p">(</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">    </code><code class="n">method</code>: <code class="nc">reqwest</code>::<code class="n">Method</code><code class="p">,</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">    </code><code class="n">raw_url</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="n">parameters</code>: <code class="kp">&amp;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">30 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>The signature says that we take in the various configuration data and try to return a response. We chose to call this module <code>client</code> because that is the name of the type that reqwest uses for the object that can be used to make HTTP requests. Our first step is therefore to create a <code>Client</code> which we imported from reqwest, parse the <code>url</code> into a something useful, and then further validate our parameters based on whether or not it is a multipart request:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">31 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">client</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Client</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">raw_url</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">    </code><code class="n">debug</code><code class="o">!</code><code class="p">(</code><code class="s">"Parsed url: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"></code>
<code class="lineno">34 </code>
<code class="lineno">35 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">is_multipart</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">any</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">is_form_file</code><code class="p">());</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">is_multipart</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">        </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Making multipart request because form file was given"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">app</code><code class="p">.</code><code class="n">form</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">Err</code><code class="p">(</code><code class="n">Error</code>::<code class="n">NotFormButHasFormFile</code><code class="p">);</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We are using a helper here in the call to determine whether this is a multipart request, <code>p.is_form_file()</code> which we need to define on <code>Parameter</code>. We again go back to <code>app.rs</code> to define some helpers on <code>Parameter</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">213 </code><code class="k">impl</code><code class="w"> </code><code class="n">Parameter</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">214 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">is_form_file</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="kt">bool</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">215 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="o">*</code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">216 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">FormFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="p">..</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="kc">true</code><code class="p">,</code><code class="w"></code>
<code class="lineno">217 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"></code>
<code class="lineno">218 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">219 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">220 </code>
<code class="lineno">221 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">is_data</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="kt">bool</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">222 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="o">*</code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">223 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">Header</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="p">..</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"></code>
<code class="lineno">224 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">Query</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="p">..</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"></code>
<code class="lineno">225 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="kc">true</code><code class="p">,</code><code class="w"></code>
<code class="lineno">226 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">227 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">228 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Without these helpers these match statements would be quite messy written inline inside the closure and would leak quite a bit of the implementation details of <code>Parameter</code> which is not necessary.</p>

<p>Let’s finish up <code>perform</code> by building and sending the request:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">43 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">.</code><code class="n">request</code><code class="p">(</code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">    </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">handle_parameters</code><code class="p">(</code><code class="n">builder</code><code class="p">,</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">form</code><code class="p">,</code><code class="w"> </code><code class="n">is_multipart</code><code class="p">,</code><code class="w"> </code><code class="n">parame</code><code class="err">\</code><code class="w"></code>
<code class="lineno">45 </code><code class="n">ters</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">handle_auth</code><code class="p">(</code><code class="n">builder</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">auth</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">token</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">47 </code>
<code class="lineno">48 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">log_enabled</code><code class="o">!</code><code class="p">(</code><code class="n">log</code>::<code class="n">Level</code>::<code class="n">Info</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">start</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Instant</code>::<code class="n">now</code><code class="p">();</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">send</code><code class="p">().</code><code class="n">map_err</code><code class="p">(</code><code class="nb">From</code>::<code class="n">from</code><code class="p">);</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">elapsed</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">start</code><code class="p">.</code><code class="n">elapsed</code><code class="p">();</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">        </code><code class="n">info</code><code class="o">!</code><code class="p">(</code><code class="s">"Elapsed time: {:?}"</code><code class="p">,</code><code class="w"> </code><code class="n">elapsed</code><code class="p">);</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">        </code><code class="n">result</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">        </code><code class="n">builder</code><code class="p">.</code><code class="n">send</code><code class="p">().</code><code class="n">map_err</code><code class="p">(</code><code class="nb">From</code>::<code class="n">from</code><code class="p">)</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">57 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>Client</code> type has a request method which returns a builder given a HTTP method and a URL. We use some soon-to-be written helpers to modify the builder with our various configuration details. Finally, we send the request with <code>builder.send().map_err(From::from)</code>. However, we have two cases, one where logging is enabled at at least the <code>Info</code> level and when it is not. If we are logging, then we use the time facilities in the standard library to compute the time required to get the response back. If we are not logging, then we just send the request. The <code>map_err(From::from)</code> bit is so that we can turn the error possibly returned from reqwest into our custom error type. We will see how this is implemented when we get to the error module.</p>

<p>Our <code>perform</code> function is done, but we still have a few speculative helpers left to write before we can call this module quits. First, let’s parse the raw URL string we got into the <code>Url</code> type exposed by reqwest:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">149 </code><code class="k">fn</code> <code class="nf">parse</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">s</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Result</code><code class="o">&lt;</code><code class="n">Url</code><code class="p">,</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">UrlError</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">150 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="s">":/"</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">151 </code><code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="n">Url</code>::<code class="n">parse</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"http://localhost{}"</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">s</code><code class="p">[</code><code class="mi">1</code><code class="p">..]));</code><code class="w"></code>
<code class="lineno">152 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="s">":"</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">153 </code><code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="n">Url</code>::<code class="n">parse</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"http://localhost{}"</code><code class="p">,</code><code class="w"> </code><code class="n">s</code><code class="p">));</code><code class="w"></code>
<code class="lineno">154 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">155 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">Url</code>::<code class="n">parse</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">156 </code><code class="w">        </code><code class="nb">Ok</code><code class="p">(</code><code class="n">url</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Ok</code><code class="p">(</code><code class="n">url</code><code class="p">),</code><code class="w"></code>
<code class="lineno">157 </code><code class="w">        </code><code class="nb">Err</code><code class="p">(</code><code class="n">_e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">158 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">secure</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">159 </code><code class="w">                </code><code class="n">Url</code>::<code class="n">parse</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"https://{}"</code><code class="p">,</code><code class="w"> </code><code class="n">s</code><code class="p">))</code><code class="w"></code>
<code class="lineno">160 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">161 </code><code class="w">                </code><code class="n">Url</code>::<code class="n">parse</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"http://{}"</code><code class="p">,</code><code class="w"> </code><code class="n">s</code><code class="p">))</code><code class="w"></code>
<code class="lineno">162 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">163 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">164 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">165 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We provide two convenience ways to call localhost URLs. First, if you want to use the default port of 80 on localhost then you can specify the URL as <code>:/some_path</code> where <code>some_path</code> is optional. In that case we strip off the leading colon and interpolate the rest of the given URL into a string which explicitly mentions localhost.</p>

<p>The other case is if you put something after the color which is not a slash then that is interpreted to mean that you want to specify the localhost port along with your URL so we just use append the raw URL to localhost. In other words, if you want to make a request to say <code>localhost:8080</code> you can just use <code>:8080</code>. This is a nice little convenience for local development. In both cases we use the <code>Url::parse</code> method to do the heavy lifting.</p>

<p>If neither of these two scenarios applies, then we try to parse the given string directly. If that succeeds then we are good to go and just return that. Otherwise, we try to add a scheme to the given URL. The reqwest <code>Url::parse</code> function requires a scheme so just using <code>example.com</code> would fail to parse. The <code>App</code> struct has a <code>secure</code> flag for whether to use <code>https</code> by default, so we switch on that value to decide which scheme to try. We return the result from this call to <code>parse</code> directly as there isn’t much else to try if this also fails.</p>

<p>Let’s turn to handling the various different parameters we could add to the request. This function is long so at first glance it might be intimidating. However, taken step by step we will see the length is driven by the fact that we support seven different parameter types rather than any lurking complexity. Let’s start with the signature:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">75 </code><code class="k">fn</code> <code class="nf">handle_parameters</code><code class="p">(</code><code class="w"></code>
<code class="lineno">76 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code>: <code class="nc">RequestBuilder</code><code class="p">,</code><code class="w"></code>
<code class="lineno">77 </code><code class="w">    </code><code class="n">is_form</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">78 </code><code class="w">    </code><code class="n">is_multipart</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno">79 </code><code class="w">    </code><code class="n">parameters</code>: <code class="kp">&amp;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">80 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">RequestBuilder</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>We take a <code>RequestBuilder</code> and some parameter data and return a builder or an error. The <code>mut</code> in front of the <code>builder</code> argument just means to make the <code>builder</code> argument work like a mutable local variable. We do this because the methods on <code>RequestBuilder</code> consume the receiver, i.e. they take <code>self</code> as their first argument rather than <code>&amp;self</code> or <code>&amp;mut self</code>, and return a new <code>RequestBuilder</code>. We could have instead continually used <code>let</code> bindings to update the <code>builder</code> variable, but we will see that using this mutable approach reduces the noise a bit.</p>

<p>With that out of the way, try to walk through the rest of the function. First let’s setup some state to use as we loop over our parameters:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">81 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">data</code>: <code class="nc">HashMap</code><code class="o">&lt;&amp;</code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">Value</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HashMap</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno">82 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">multipart</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">is_multipart</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">83 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="n">Form</code>::<code class="n">new</code><code class="p">())</code><code class="w"></code>
<code class="lineno">84 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">85 </code><code class="w">        </code><code class="nb">None</code><code class="w"></code>
<code class="lineno">86 </code><code class="w">    </code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>We declare a <code>HashMap</code> from strings to JSON values which will be the container for the data that we will eventually add to the request. If the request is a multipart form based on the argument passed in to us, we create a <code>Form</code> object inside an <code>Option</code> for later use. This form object is provided by reqwest for exactly this purpose of adding each part of a multipart form to a request.</p>

<p>Now we can loop over our parameters, and use a big a match statement to handle each one individually:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 88 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">param</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 89 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">param</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 90 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">Header</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 91 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Assing header: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 92 </code><code class="w">                </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">header</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 93 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 94 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">Data</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 95 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding data: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 96 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="n">multipart</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">                    </code><code class="n">data</code><code class="p">.</code><code class="n">insert</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">Value</code>::<code class="nb">String</code><code class="p">(</code><code class="n">value</code><code class="p">.</code><code class="n">to_owned</code><code class="p">()));</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">                </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="w">                    </code><code class="n">multipart</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">multipart</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">m</code><code class="o">|</code><code class="w"> </code><code class="n">m</code><code class="p">.</code><code class="n">text</code><code class="p">(</code><code class="n">key</code><code class="p">.</code><code class="n">to_owned</code><code class="p">()</code><code class="err">\</code><code class="w"></code>
<code class="lineno">100 </code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">.</code><code class="n">to_owned</code><code class="p">()));</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">Query</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding query parameter: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno">105 </code><code class="w">                </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">query</code><code class="p">(</code><code class="o">&amp;</code><code class="p">[(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">)]);</code><code class="w"></code>
<code class="lineno">106 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">107 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">RawJsonData</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">108 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding JSON data: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno">109 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">v</code>: <code class="nc">Value</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">from_str</code><code class="p">(</code><code class="n">value</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">110 </code><code class="w">                </code><code class="n">data</code><code class="p">.</code><code class="n">insert</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">v</code><code class="p">);</code><code class="w"></code>
<code class="lineno">111 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">112 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">RawJsonDataFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">113 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding JSON data for key={} from file={}"</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="err">\</code><code class="w"></code>
<code class="lineno">114 </code><code class="w"> </code><code class="n">filename</code><code class="p">);</code><code class="w"></code>
<code class="lineno">115 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">File</code>::<code class="n">open</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">116 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">reader</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code>::<code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">);</code><code class="w"></code>
<code class="lineno">117 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">v</code>: <code class="nc">Value</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">from_reader</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">118 </code><code class="w">                </code><code class="n">data</code><code class="p">.</code><code class="n">insert</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">v</code><code class="p">);</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">120 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">DataFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">121 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding data from file={} for key={}"</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="p">,</code><code class="err">\</code><code class="w"></code>
<code class="lineno">122 </code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">                </code><code class="kd">let</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">std</code>::<code class="n">fs</code>::<code class="n">read_to_string</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">                </code><code class="n">data</code><code class="p">.</code><code class="n">insert</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">Value</code>::<code class="nb">String</code><code class="p">(</code><code class="n">value</code><code class="p">));</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">            </code><code class="n">Parameter</code>::<code class="n">FormFile</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">127 </code><code class="w">                </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding file={} with key={}"</code><code class="p">,</code><code class="w"> </code><code class="n">filename</code><code class="p">,</code><code class="w"> </code><code class="n">key</code><code class="p">);</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">                </code><code class="n">multipart</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">                    </code><code class="n">multipart</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">                        </code><code class="p">.</code><code class="n">unwrap</code><code class="p">()</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">                        </code><code class="p">.</code><code class="n">file</code><code class="p">(</code><code class="n">key</code><code class="p">.</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"> </code><code class="n">filename</code><code class="p">.</code><code class="n">to_owned</code><code class="p">())</code><code class="o">?</code><code class="p">,</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">                </code><code class="p">);</code><code class="w"></code>
<code class="lineno">133 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">134 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>Header</code> type is easy, we just call the <code>header</code> method to update our builder. The <code>Data</code> type is slightly harder as we insert the key and value into the <code>data</code> map if we are not building a multipart form, otherwise we use the methods on <code>Form</code> to add the key and value to the form. As our <code>multipart</code> variable is inside an <code>Option</code> we use <code>map</code> to operate on the <code>Form</code> type inside.</p>

<p>Adding query string elements is also easy given the <code>query</code> method on the builder. The <code>RawJsonData</code> type is likewise straightforward, we just have to use serde to parse the string into a <code>Value</code> before inserting into our data map.</p>

<p>The last three parameters all deal with files.</p>

<p>First, <code>RawJsonDataFile</code> parses the file into a JSON value using serde and inserts the result into our map. We use the nice facilities provided by the standard library to open a handle to a file and to build a buffered reader around that handle. We can then pass that reader directly to the <code>from_reader</code> function. This automatically handles all of the complexity of ensuring the file is available, incrementally reading it, ensuring it is closed even if something goes wrong, etc.</p>

<p>Second, <code>DataFile</code> reads a string from <code>filename</code> and inserts that string as a value directly in our data map. The <code>read_to_string</code> method is not what you want in many cases dealing with file I/O in Rust, but sometimes (like here), it is exactly what you need.</p>

<p>Lastly, we deal with <code>FormFile</code> which is quite simple thanks to the <code>file</code> function provided by the <code>Form</code> type. We call <code>unwrap</code> on <code>multipart</code> here because the existence of a <code>FormFile</code> parameter is equivalent to <code>is_multipart</code> being true so we know that in this branch of the match statement <code>multipart</code> must not be <code>None</code>.</p>

<p>Now that all of the parameters have been converted into more amenable data structures, we can add them to the builder:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">134 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">m</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">multipart</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">        </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">multipart</code><code class="p">(</code><code class="n">m</code><code class="p">);</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">137 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">data</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">138 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="n">is_form</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">139 </code><code class="w">                </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">form</code><code class="p">(</code><code class="o">&amp;</code><code class="n">data</code><code class="p">);</code><code class="w"></code>
<code class="lineno">140 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">141 </code><code class="w">                </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">json</code><code class="p">(</code><code class="o">&amp;</code><code class="n">data</code><code class="p">);</code><code class="w"></code>
<code class="lineno">142 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">144 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">145 </code>
<code class="lineno">146 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">builder</code><code class="p">)</code><code class="w"></code>
<code class="lineno">147 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If we are in the multipart form case then we use the <code>multipart</code> method, otherwise we either use the <code>form</code> or <code>json</code> methods depending on the <code>is_form</code> flag passed to us. We do the simply check to ensure that data is actually not empty before trying to serialize it as part of the request. Finally, if we have made it this far without returning an error then we know that we can successfully return our builder.</p>

<p>The last bit of information is dealing with authentication information. We have a helper which will also modify the builder to add the relevant data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">58 </code><code class="k">fn</code> <code class="nf">handle_auth</code><code class="p">(</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code>: <code class="nc">RequestBuilder</code><code class="p">,</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">    </code><code class="n">auth</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="n">token</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">62 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">RequestBuilder</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">auth_string</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">auth</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">username</code><code class="p">,</code><code class="w"> </code><code class="n">maybe_password</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">parse_auth</code><code class="p">(</code><code class="o">&amp;</code><code class="n">auth_string</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">65 </code><code class="w">        </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Parsed basic authentication. Username={}"</code><code class="p">,</code><code class="w"> </code><code class="n">username</code><code class="p">);</code><code class="w"></code>
<code class="lineno">66 </code><code class="w">        </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">basic_auth</code><code class="p">(</code><code class="n">username</code><code class="p">,</code><code class="w"> </code><code class="n">maybe_password</code><code class="p">);</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">bearer</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">token</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">        </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Parsed bearer authentication. Token={}"</code><code class="p">,</code><code class="w"> </code><code class="n">bearer</code><code class="p">);</code><code class="w"></code>
<code class="lineno">70 </code><code class="w">        </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">bearer_auth</code><code class="p">(</code><code class="n">bearer</code><code class="p">);</code><code class="w"></code>
<code class="lineno">71 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(</code><code class="n">builder</code><code class="p">)</code><code class="w"></code>
<code class="lineno">73 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If we do not have an auth string or a token then we just return the builder unchanged. Otherwise, we use the <code>basic_auth</code> or <code>bearer_auth</code> methods on the builder to add the particular pieces of auth information. Our basic auth path makes use of a helper to get the username and password:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">167 </code><code class="k">fn</code> <code class="nf">parse_auth</code><code class="p">(</code><code class="n">s</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">(</code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">168 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">idx</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">find</code><code class="p">(</code><code class="sc">':'</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">169 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">username</code><code class="p">,</code><code class="w"> </code><code class="n">password_with_colon</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">split_at</code><code class="p">(</code><code class="n">idx</code><code class="p">);</code><code class="w"></code>
<code class="lineno">170 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">password</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">password_with_colon</code><code class="p">.</code><code class="n">trim_start_matches</code><code class="p">(</code><code class="sc">':'</code><code class="p">);</code><code class="w"></code>
<code class="lineno">171 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">password</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">172 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">Ok</code><code class="p">((</code><code class="n">username</code><code class="p">.</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"> </code><code class="nb">None</code><code class="p">));</code><code class="w"></code>
<code class="lineno">173 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">174 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nb">Ok</code><code class="p">((</code><code class="n">username</code><code class="p">.</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">password</code><code class="p">.</code><code class="n">to_owned</code><code class="p">())));</code><code class="w"></code>
<code class="lineno">175 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">176 </code><code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">177 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">password</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">rpassword</code>::<code class="n">read_password_from_tty</code><code class="p">(</code><code class="nb">Some</code><code class="p">(</code><code class="s">"Password\</code>
<code class="lineno">178 </code><code class="s">: "</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">179 </code><code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nb">Ok</code><code class="p">((</code><code class="n">s</code><code class="p">.</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">password</code><code class="p">)));</code><code class="w"></code>
<code class="lineno">180 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">181 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We accept the forms <code>myUserName</code>, <code>myUserName:</code>, and <code>myUserName:myPassword</code> as valid basic auth strings. The first form without a colon assumes that you have input your username and want to type in your password. We use the extremely helpful <code>rpassword</code> crate which provides the <code>read_password_from_tty</code> method to ask the user to enter a password. This captures that value and returns it as a string without echoing the user input as you would expect.</p>

<p>The other two cases with colons mean that you are giving your password and we do not prompt the user to enter one. In the first case, <code>myUserName:</code>, we are saying that we explicitly want to provide no password.</p>

<h4 id="leanpub-auto-the-errors-module">The errors module</h4>

<p>We are almost done! We have been using the errors from this module throughout the code we have written so far. It might be tempting to write your code using <code>unwrap</code> and <code>panic!</code> everywhere at first rather than propagating errors when you are just in a prototyping stage. The next best thing to that is returning results but strings for errors when you know you will need errors but you want to delay creating structured errors.</p>

<p>Let me caution you against both those approaches. Creating a simple error enum along with a type alias for your particular result is a tiny amount of work. Let’s do that now:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fmt</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code><code class="k">pub</code><code class="w"> </code><code class="k">enum</code> <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="w">    </code><code class="n">ParameterMissingSeparator</code><code class="p">(</code><code class="nb">String</code><code class="p">),</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="w">    </code><code class="n">MissingUrlAndCommand</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="w">    </code><code class="n">NotFormButHasFormFile</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="n">ClientSerialization</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="n">ClientTimeout</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="n">ClientWithStatus</code><code class="p">(</code><code class="n">reqwest</code>::<code class="n">StatusCode</code><code class="p">),</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="n">ClientOther</code><code class="p">,</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="n">SerdeJson</code><code class="p">(</code><code class="n">serde_json</code>::<code class="n">error</code>::<code class="n">Category</code><code class="p">),</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">IO</code><code class="p">(</code><code class="n">std</code>::<code class="n">io</code>::<code class="n">ErrorKind</code><code class="p">),</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="n">UrlParseError</code><code class="p">(</code><code class="n">reqwest</code>::<code class="n">UrlError</code><code class="p">),</code><code class="w"></code>
<code class="lineno">14 </code><code class="p">}</code><code class="w"></code>
<code class="lineno">15 </code>
<code class="lineno">16 </code><code class="k">pub</code><code class="w"> </code><code class="k">type</code> <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">Result</code><code class="o">&lt;</code><code class="n">T</code><code class="p">,</code><code class="w"> </code><code class="n">Error</code><code class="o">&gt;</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We import <code>std::fmt</code> to make our <code>Display</code> implementation easier to write, but the real code here is just a simple enum and a type alias. You don’t have to know about all of these errors up front. We do here as we have a bit more foresight in a book with the rest of the code already written. In fact, most likely you will have only a couple simply variants at first. Then you will add some more which wrap errors from other libraries or the standard library. Then you will add more of your own as needed. But getting just something in place along with the type alias will make your future self much happier.</p>

<p>Let’s beef up our error type with a couple necessities. First, we implement <code>Display</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">18 </code><code class="k">impl</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Display</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">fmt</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">f</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Formatter</code><code class="o">&lt;</code><code class="na">'_</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">fmt</code>::<code class="nb">Result</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">ParameterMissingSeparator</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">                </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Missing separator when parsing parameter: {}\</code>
<code class="lineno">23 </code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">s</code><code class="p">)</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">MissingUrlAndCommand</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Must specify a ur\</code>
<code class="lineno">26 </code><code class="s">l or a command!"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">NotFormButHasFormFile</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">                </code><code class="n">f</code><code class="p">,</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">                </code><code class="s">"Cannot have a form file 'key@filename' unless --form o\</code>
<code class="lineno">30 </code><code class="s">ption is set"</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">            </code><code class="p">),</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">ClientSerialization</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Serializing the re\</code>
<code class="lineno">33 </code><code class="s">quest/response failed"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">ClientTimeout</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Timeout during request"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">ClientWithStatus</code><code class="p">(</code><code class="n">status</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Got status co\</code>
<code class="lineno">36 </code><code class="s">de: {}"</code><code class="p">,</code><code class="w"> </code><code class="n">status</code><code class="p">),</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">ClientOther</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Unknown client error"</code><code class="p">),</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">SerdeJson</code><code class="p">(</code><code class="n">c</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"JSON error: {:?}"</code><code class="p">,</code><code class="w"> </code><code class="n">c</code><code class="p">),</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">IO</code><code class="p">(</code><code class="n">k</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"IO Error: {:?}"</code><code class="p">,</code><code class="w"> </code><code class="n">k</code><code class="p">),</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">UrlParseError</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"URL Parsing Error: {}\</code>
<code class="lineno">41 </code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">44 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>For each variant we write something meaningful, nothing really fancy here. We then implement <code>Debug</code> directly to be the same as <code>Display</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">40 </code><code class="k">impl</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Debug</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">fmt</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">f</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="n">fmt</code>::<code class="n">Formatter</code><code class="o">&lt;</code><code class="na">'_</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">fmt</code>::<code class="nb">Result</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">        </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="bp">self</code><code class="p">)</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">44 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This approach could be debated, but this mainly serves the purpose of getting the nice error message in some contexts which do a debug print by default where we do not have control.</p>

<p>We also want to implement the <code>std::error::Error</code> trait for our <code>Error</code> type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">46 </code><code class="k">impl</code><code class="w"> </code><code class="n">std</code>::<code class="n">error</code>::<code class="n">Error</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">source</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;&amp;</code><code class="p">(</code><code class="n">dyn</code><code class="w"> </code><code class="n">std</code>::<code class="n">error</code>::<code class="n">Error</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nb">'static</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="bp">self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">UrlParseError</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="nb">None</code><code class="p">,</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">53 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The custom error type world in Rust has been all over the place since Rust 1.0, however the standard library as of around 1.30 started to incorporate much of the learnings from the community so that one can often do more with just the normal tools rather than pulling another crate. However, if you are interested the following crates provide some interesting features around errors: <em>error-chain</em>, <em>failure</em>, <em>context-attribute</em>, <em>err-derive</em>, <em>snafu</em>, <em>fehler</em>, <em>anyhow</em>, and <em>thiserror</em>.</p>

<p>The last piece of our error puzzle is to provide implementations of the <code>From</code> trait for errors from other libraries that we want to wrap in our custom enum. There are four of these that are relevant. First, <code>reqwest::Error</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">55 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">reqwest</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">56 </code><code class="w">    </code><code class="cp">#[inline]</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">err</code>: <code class="nc">reqwest</code>::<code class="n">Error</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">err</code><code class="p">.</code><code class="n">is_serialization</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">Error</code>::<code class="n">ClientSerialization</code><code class="p">;</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">err</code><code class="p">.</code><code class="n">is_timeout</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">Error</code>::<code class="n">ClientTimeout</code><code class="p">;</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">err</code><code class="p">.</code><code class="n">status</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">65 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">Error</code>::<code class="n">ClientWithStatus</code><code class="p">(</code><code class="n">s</code><code class="p">);</code><code class="w"></code>
<code class="lineno">66 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">        </code><code class="n">Error</code>::<code class="n">ClientOther</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">69 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Next up is <code>serde_json::error::Error</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">71 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">serde_json</code>::<code class="n">error</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">    </code><code class="cp">#[inline]</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">err</code>: <code class="nc">serde_json</code>::<code class="n">error</code>::<code class="n">Error</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">74 </code><code class="w">        </code><code class="n">Error</code>::<code class="n">SerdeJson</code><code class="p">(</code><code class="n">err</code><code class="p">.</code><code class="n">classify</code><code class="p">())</code><code class="w"></code>
<code class="lineno">75 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">76 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Third is <code>std::io::Error</code> for dealing with file system errors:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">78 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">std</code>::<code class="n">io</code>::<code class="n">Error</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">79 </code><code class="w">    </code><code class="cp">#[inline]</code><code class="w"></code>
<code class="lineno">80 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">err</code>: <code class="nc">std</code>::<code class="n">io</code>::<code class="n">Error</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">81 </code><code class="w">        </code><code class="n">Error</code>::<code class="n">IO</code><code class="p">(</code><code class="n">err</code><code class="p">.</code><code class="n">kind</code><code class="p">())</code><code class="w"></code>
<code class="lineno">82 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">83 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Finally, we wrap <code>reqwest::UrlError</code> which comes up in URL parsing:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">85 </code><code class="k">impl</code><code class="w"> </code><code class="nb">From</code><code class="o">&lt;</code><code class="n">reqwest</code>::<code class="n">UrlError</code><code class="o">&gt;</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">86 </code><code class="w">    </code><code class="cp">#[inline]</code><code class="w"></code>
<code class="lineno">87 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">from</code><code class="p">(</code><code class="n">err</code>: <code class="nc">reqwest</code>::<code class="n">UrlError</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Error</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">88 </code><code class="w">        </code><code class="n">Error</code>::<code class="n">UrlParseError</code><code class="p">(</code><code class="n">err</code><code class="p">)</code><code class="w"></code>
<code class="lineno">89 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">90 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<h3 id="leanpub-auto-recap">Recap</h3>

<p>Phew, that was an adventure. But we can now perform all of the requests as described in the basic set of features that we intended to support. The remainder of this chapter is adding a few add-on features to make this utility slightly more useful. However, we have a surprisingly rich set of features from a relatively small codebase. This is primarily enabled by relying on the rich ecosystem of crates available to us.</p>

<h3 id="leanpub-auto-adding-a-configuration-file">Adding a configuration file</h3>

<p>Our first extension will be to add a configuration file which we can use to set defaults across program executions. As we are writing Rust, let’s use TOML for the format of our configuration file. To get started, let’s bring in a few more dependencies to our <code>Cargo.toml</code> file:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">16 </code>dirs = "2.0"
<code class="lineno">17 </code>lazy_static = "1.4"
<code class="lineno">18 </code>toml = "0.5"
</pre></div>

</figure>

<p>The <code>dirs</code> crate is a helpful utility which can give us a path to a user’s home directory in a cross platform way. The <code>lazy_static</code> crate is to create static constants which are too complicated or impossible to create at compile time. Lastly, the <code>toml</code> crate is for reading/writing the TOML format.</p>

<h4 id="leanpub-auto-changes-to-main">Changes to main</h4>

<p>We are going to make most of our changes in new modules, so let’s add those at the top of our <code>main.rs</code> file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">7 </code><code class="k">mod</code> <code class="nn">config</code><code class="p">;</code><code class="w"></code>
<code class="lineno">8 </code><code class="k">mod</code> <code class="nn">directories</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then, let’s add one extra call to get the configuration data incorporated into our app by calling <code>process_config_file</code> on our app after we have parsed and validated the command line arguments:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">16 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">app</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code>::<code class="n">App</code>::<code class="n">from_args</code><code class="p">();</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">validate</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">process_config_file</code><code class="p">();</code><code class="w"></code>
</pre></div>

</figure>

<h4 id="leanpub-auto-adding-the-configuration-to-our-app">Adding the configuration to our app</h4>

<p>Moving over to <code>app.rs</code>, let’s bring in <code>PathBuf</code> for working with file system paths:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">path</code>::<code class="n">PathBuf</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s also bring in our <code>config</code> module so that we can reference types from it without needing the <code>crate</code> prefix everywhere:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">config</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>The location of the configuration file is something we want further be able to configure so we add a <code>config</code> field to the <code>App</code> struct which optionally takes a path to look for the file. The doc comment here explains what the file is and where we will look for it:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">51 </code><code class="w">    </code><code class="sd">/// Configuration file.</code>
<code class="lineno">52 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">53 </code><code class="w">    </code><code class="sd">/// A TOML file which is stored by default at HOME/.config/hurl/con\</code>
<code class="lineno">54 </code><code class="n">fig</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">    </code><code class="sd">/// where HOME is platform dependent.</code>
<code class="lineno">56 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">57 </code><code class="w">    </code><code class="sd">/// The file supports the following optional keys with the given ty\</code>
<code class="lineno">58 </code><code class="n">pes</code>:
<code class="lineno">59 </code>    <code class="sd">/// verbose: u8</code>
<code class="lineno">60 </code><code class="w">    </code><code class="sd">/// form: bool</code>
<code class="lineno">61 </code><code class="w">    </code><code class="sd">/// auth: string</code>
<code class="lineno">62 </code><code class="w">    </code><code class="sd">/// token: string</code>
<code class="lineno">63 </code><code class="w">    </code><code class="sd">/// secure: bool</code>
<code class="lineno">64 </code><code class="w">    </code><code class="sd">///</code>
<code class="lineno">65 </code><code class="w">    </code><code class="sd">/// Each option has the same meaning as the corresponding configura\</code>
<code class="lineno">66 </code><code class="n">tion</code><code class="w"></code>
<code class="lineno">67 </code><code class="w">    </code><code class="sd">/// option with the same name. The verbose setting is a number from\</code>
<code class="lineno">68 </code><code class="w"> </code><code class="mi">0</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">    </code><code class="sd">/// meaning no logging to 5 meaning maximal log output.</code>
<code class="lineno">70 </code><code class="w">    </code><code class="cp">#[structopt(short, long, env = </code><code class="s">"HURL_CONFIG"</code><code class="cp">, parse(from_os_str))]</code><code class="w"></code>
<code class="lineno">71 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">config</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">PathBuf</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
</pre></div>

</figure>

<p>The new structopt attribute here is <code>env = "HURL_CONFIG"</code> which allows the user to set the location of the configuration file via the <code>HURL_CONFIG</code> environment variable in addition to the ability to pass it as a command line argument. The fact that you can get that extra bit of configurability with just a few extra characters really shows the nicety of using structopt.</p>

<p>The <code>parse(from_os_str)</code> attribute to get the <code>PathBuf</code> is something that is builtin to structopt as this is a very common need.</p>

<p>Finally, let’s add the <code>process_config_file</code> method to our <code>App</code> struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">121 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">process_config_file</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config_path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code>::<code class="n">config_file</code><code class="p">(</code><code class="bp">self</code><code class="p">);</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config_opt</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code>::<code class="n">read_config_file</code><code class="p">(</code><code class="n">config_path</code><code class="p">);</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="k">mut</code><code class="w"> </code><code class="n">config</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config_opt</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">verbose</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">v</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code><code class="p">.</code><code class="n">verbose</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">127 </code><code class="w">                    </code><code class="bp">self</code><code class="p">.</code><code class="n">verbose</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">v</code><code class="p">;</code><code class="w"></code>
<code class="lineno">128 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="bp">self</code><code class="p">.</code><code class="n">form</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code><code class="p">.</code><code class="n">form</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">                    </code><code class="bp">self</code><code class="p">.</code><code class="n">form</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">;</code><code class="w"></code>
<code class="lineno">133 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">134 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="bp">self</code><code class="p">.</code><code class="n">secure</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">                </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code><code class="p">.</code><code class="n">secure</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">137 </code><code class="w">                    </code><code class="bp">self</code><code class="p">.</code><code class="n">secure</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">;</code><code class="w"></code>
<code class="lineno">138 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">139 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">140 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">auth</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">141 </code><code class="w">                </code><code class="bp">self</code><code class="p">.</code><code class="n">auth</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code><code class="p">.</code><code class="n">auth</code><code class="p">.</code><code class="n">take</code><code class="p">();</code><code class="w"></code>
<code class="lineno">142 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">143 </code><code class="w">            </code><code class="k">if</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="p">.</code><code class="n">is_none</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">144 </code><code class="w">                </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config</code><code class="p">.</code><code class="n">token</code><code class="p">.</code><code class="n">take</code><code class="p">();</code><code class="w"></code>
<code class="lineno">145 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">146 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">147 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use helper functions from the <code>config</code> module to get the path and read the file at that path if it exists. We then use the resulting data structure, if we were able to find and parse one, to update our app struct.</p>

<h4 id="leanpub-auto-the-config-module">The config module</h4>

<p>The module for finding and loading the configuration file is pretty small. We first import some things we will need:</p>

<figure class="code" dir="ltr">
  <figcaption>src/config.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">serde</code>::<code class="n">Deserialize</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fs</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">path</code>::<code class="n">PathBuf</code><code class="p">;</code><code class="w"></code>
<code class="lineno">4 </code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">app</code>::<code class="n">App</code><code class="p">;</code><code class="w"></code>
<code class="lineno">6 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">directories</code>::<code class="n">DIRECTORIES</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we declare a struct to hold the data that we support in the configuration file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/config.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 8 </code><code class="cp">#[derive(Debug, Deserialize)]</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Config</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">10 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">verbose</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">u8</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">form</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">bool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">auth</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">secure</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="kt">bool</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The use of <code>Deserialize</code> here is what allows the <code>toml</code> crate to be able to use the serde machineary to turn our file into an instance of this struct.</p>

<p>The first helper function we need is one which takes our <code>App</code> struct and returns a <code>PathBuf</code> to find a configuration file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/config.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">17 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">config_file</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">PathBuf</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">app</code><code class="p">.</code><code class="n">config</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">        </code><code class="p">.</code><code class="n">as_ref</code><code class="p">()</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">        </code><code class="p">.</code><code class="n">cloned</code><code class="p">()</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">        </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">config_path</code><code class="o">|</code><code class="w"> </code><code class="n">config_path</code><code class="p">.</code><code class="n">is_file</code><code class="p">())</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">        </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="n">DIRECTORIES</code><code class="p">.</code><code class="n">config</code><code class="p">().</code><code class="n">join</code><code class="p">(</code><code class="s">"config"</code><code class="p">))</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If the app has a valid file defined as its config field then we use that, otherwise we use the helper provided by the directories module to give us a path to our default config directory. By using <code>unwrap_or_else</code> we ensure that we always return some <code>PathBuf</code> from this function.</p>

<p>Now that we have a path, we can write our helper which attempts to read and parse that file into our <code>Config</code> struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/config.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">25 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">read_config_file</code><code class="p">(</code><code class="n">path</code>: <code class="nc">PathBuf</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;</code><code class="n">Config</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">    </code><code class="n">fs</code>::<code class="n">read_to_string</code><code class="p">(</code><code class="n">path</code><code class="p">).</code><code class="n">ok</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">content</code><code class="o">|</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config</code>: <code class="nc">Config</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">toml</code>::<code class="n">from_str</code><code class="p">(</code><code class="o">&amp;</code><code class="n">content</code><code class="p">).</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="n">config</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="p">})</code><code class="w"></code>
<code class="lineno">30 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We turn the <code>Result</code> returned by <code>read_to_string</code> into an <code>Option</code> using <code>ok()</code> which is a common idiom when you care about failure but not the specifics of the error. The error variant just gets turned into <code>None</code> so we can use <code>map</code> on that option to be able to operate only on the case when we know we have a string of data from a file. We then use the <code>toml</code> crate along with serde to turn that string into our expected data structure.</p>

<p>The use of <code>unwrap</code> here is for expedience. You could choose to handle that error and return <code>None</code> in that case as well, or return a specific error instead.</p>

<h4 id="leanpub-auto-the-directories-module">The directories module</h4>

<p>We turn now to the module responsible for doing the cross platform home directory lookup. We start with a couple familiar imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/directories.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="n">lazy_static</code>::<code class="n">lazy_static</code><code class="p">;</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">path</code>::<code class="p">{</code><code class="n">Path</code><code class="p">,</code><code class="w"> </code><code class="n">PathBuf</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>Note that the first import is bringing in the <code>lazy_static</code> macro from the <code>lazy_static</code> crate. This used to be accomplished with the <code>macro_use</code> attribute at the top level of the crate, but thankfully macros have become regular items.</p>

<p>We also want to include one import but only if you are building for MacOS. We can do this in Rust using the <code>cfg</code> attribute:</p>

<figure class="code" dir="ltr">
  <figcaption>src/directories.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="cp">#[cfg(target_os = </code><code class="s">"macos"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">5 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">env</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>This says roughly if the target operating system is MacOS then include the subsequent item when compiling, otherwise remove it. This is a much more sane system of conditional compilation, especially if you are used to C-style <code>#</code> defines.</p>

<p>We create a struct to hold the default path to our configuration file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/directories.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">7 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Directories</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">8 </code><code class="w">    </code><code class="n">config</code>: <code class="nc">PathBuf</code><code class="p">,</code><code class="w"></code>
<code class="lineno">9 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If one wanted to include other directories such as to store data output then this struct could have additional members. We do it this way to make that type of modification easier.</p>

<p>Let’s then add some methods to our <code>Directories</code> type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/directories.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">11 </code><code class="k">impl</code><code class="w"> </code><code class="n">Directories</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">new</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nb">Option</code><code class="o">&lt;</code><code class="n">Directories</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">        </code><code class="cp">#[cfg(target_os = </code><code class="s">"macos"</code><code class="cp">)]</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config_op</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">env</code>::<code class="n">var_os</code><code class="p">(</code><code class="s">"XDG_CONFIG_HOME"</code><code class="p">)</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">PathBuf</code>::<code class="n">from</code><code class="p">)</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">            </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">is_absolute</code><code class="p">())</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">            </code><code class="p">.</code><code class="n">or_else</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="n">dirs</code>::<code class="n">home_dir</code><code class="p">().</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">d</code><code class="o">|</code><code class="w"> </code><code class="n">d</code><code class="p">.</code><code class="n">join</code><code class="p">(</code><code class="s">".config"</code><code class="p">)));</code><code class="w"></code>
<code class="lineno">18 </code>
<code class="lineno">19 </code><code class="w">        </code><code class="cp">#[cfg(not(target_os = </code><code class="s">"macos"</code><code class="cp">))]</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config_op</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">dirs</code>::<code class="n">config_dir</code><code class="p">();</code><code class="w"></code>
<code class="lineno">21 </code>
<code class="lineno">22 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">config</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">config_op</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">d</code><code class="o">|</code><code class="w"> </code><code class="n">d</code><code class="p">.</code><code class="n">join</code><code class="p">(</code><code class="s">"hurl"</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">23 </code>
<code class="lineno">24 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="n">Directories</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">config</code><code class="w"> </code><code class="p">})</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">26 </code>
<code class="lineno">27 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">config</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="kp">&amp;</code><code class="nc">Path</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="o">&amp;</code><code class="bp">self</code><code class="p">.</code><code class="n">config</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">30 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>First, our <code>new</code> method returns a <code>Option</code> because we might not be able to find the directory we are looking for. As we discussed above, we are using the <code>cfg</code> attribute to do different things depending on if we are on MacOS or not. Here it looks like we define the variable <code>config_op</code> twice. However, depending on the target, it will only be defined once. The rest of the code can work with that value. The compiler checks that the types match in both cases so everything is safe regardless of which OS we are targeting.</p>

<p>The MacOS case is just trying to use a particular environment variable that is the recommended way of finding your home directory, if it is defined. Otherwise we fallback to the <code>dirs</code> crate. In other other case we just use the <code>dirs</code> crate directly.</p>

<p>After that we add <code>hurl</code> to the end of the path and stick that path inside the <code>Directories</code> struct that we return.</p>

<p>We also create a convenience method which turns the <code>PathBuf</code> into a <code>Path</code> by the magic of the <code>Deref</code> trait.</p>

<p>Finally we use <code>lazy_static</code> to expose a static reference to a newly constructed <code>Directories</code> struct:</p>

<figure class="code" dir="ltr">
  <figcaption>src/directories.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">32 </code><code class="n">lazy_static</code><code class="o">!</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">static</code><code class="w"> </code><code class="k">ref</code><code class="w"> </code><code class="n">DIRECTORIES</code>: <code class="nc">Directories</code><code class="w"> </code><code class="o">=</code><code class="w"></code>
<code class="lineno">34 </code><code class="w">        </code><code class="n">Directories</code>::<code class="n">new</code><code class="p">().</code><code class="n">expect</code><code class="p">(</code><code class="s">"Could not get home directory"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">35 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use <code>expect</code> here to crash if we cannot get a path to the home directory. This only occurs we literally cannot construct a path, it is not about whether the config directory exists or whether the config file exists. Without a home directory there is not much we can do when it comes to configuration files. This is a further opportunity to clean up as this case could be more gracefully handled and probably just ignored.</p>

<h3 id="leanpub-auto-adding-sessions">Adding sessions</h3>

<p>A common pattern that comes up when testing APIs on the command line is to make multiple requests that depend on one another. The most common dependency comes from authentication where we login as a user and then want to perform some actions on their behalf. A session is the common terminology for a set of activity between logging in and logging out. Therefore we will use this name for the concept of sharing state across requests.</p>

<p>As we said the primary use case for sessions is authentication but we might also want to always set a specific header. This is distinct from our configuration file as it is more specific to a particular group of requests and can also be modified by the response.</p>

<p>Like the configuration change, we will thread the session through the app starting in main and ending in a session module where most of the details are implemented.</p>

<h4 id="leanpub-auto-adding-the-session-to-main">Adding the session to main</h4>

<p>The easy bit is adding are declaration that there will be a session module:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 8 </code><code class="k">mod</code> <code class="nn">directories</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="k">mod</code> <code class="nn">errors</code><code class="p">;</code><code class="w"></code>
<code class="lineno">10 </code><code class="k">mod</code> <code class="nn">session</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then, inside our main function, after setting up logging, but before we match on the <code>cmd</code> argument, we will try to get a session:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">21 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">level</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">log_level</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">        </code><code class="n">std</code>::<code class="n">env</code>::<code class="n">set_var</code><code class="p">(</code><code class="s">"RUST_LOG"</code><code class="p">,</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"hurl={}"</code><code class="p">,</code><code class="w"> </code><code class="n">level</code><code class="p">));</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="n">pretty_env_logger</code>::<code class="n">init</code><code class="p">();</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">25 </code>
<code class="lineno">26 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="p">.</code><code class="n">session</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="p">.</code><code class="n">as_ref</code><code class="p">()</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">        </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="n">name</code><code class="o">|</code><code class="w"> </code><code class="n">session</code>::<code class="n">Session</code>::<code class="n">get_or_create</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">.</code><code class="n">clone</code><code class="p">(),</code><code class="err">\</code><code class="w"></code>
<code class="lineno">30 </code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">host</code><code class="p">()));</code><code class="w"></code>
<code class="lineno">31 </code>
<code class="lineno">32 </code><code class="w">    </code><code class="k">match</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">cmd</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>It may not be clear from this code due to type inference but the session variable here has type <code>Option&lt;Session&gt;</code>. We will have some type of <code>session</code> field on the app which is optional and if it exists then we will turn that into a <code>Session</code>.</p>

<p>We then move to <code>handle_response</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">50 </code><code class="k">fn</code> <code class="nf">handle_response</code><code class="p">(</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">app</code>::<code class="n">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">resp</code>: <code class="nc">reqwest</code>::<code class="n">Response</code><code class="p">,</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">    </code><code class="n">session</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">session</code>::<code class="n">Session</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">54 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>We add the <code>app</code> and <code>session</code> to this function as the response might update the session. Inside this function let’s take care of that update:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">93 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="o">!</code><code class="n">app</code><code class="p">.</code><code class="n">read_only</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">94 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">95 </code><code class="w">            </code><code class="n">s</code><code class="p">.</code><code class="n">update_with_response</code><code class="p">(</code><code class="o">&amp;</code><code class="n">resp</code><code class="p">);</code><code class="w"></code>
<code class="lineno">96 </code><code class="w">            </code><code class="n">s</code><code class="p">.</code><code class="n">save</code><code class="p">(</code><code class="n">app</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">97 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">98 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">99 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">(())</code><code class="w"></code>
</pre></div>

</figure>

<p>This is just after we have finished all of our output and are about to return. If the session is not read only and the session exists, then we update the session from the response and save the session.</p>

<p>We need to update the calls to <code>handle_response</code> and in the process we also want to update our calls to <code>perform_method</code> and <code>perform</code> to also take the session. First, let’s update the case where <code>cmd</code> is exists:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">32 </code><code class="w">        </code><code class="nb">Some</code><code class="p">(</code><code class="k">ref</code><code class="w"> </code><code class="n">method</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform_method</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">sessio</code><code class="err">\</code><code class="w"></code>
<code class="lineno">34 </code><code class="n">n</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">resp</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">)</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we can update the situation where <code>cmd</code> is None:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">36 </code><code class="w">        </code><code class="nb">None</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">url</code><code class="p">.</code><code class="n">take</code><code class="p">().</code><code class="n">unwrap</code><code class="p">();</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">().</code><code class="n">any</code><code class="p">(</code><code class="o">|</code><code class="n">p</code><code class="o">|</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="n">is_data</code><code class="p">());</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">method</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">has_data</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">40 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">POST</code><code class="w"></code>
<code class="lineno">41 </code><code class="w">            </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">                </code><code class="n">reqwest</code>::<code class="n">Method</code>::<code class="n">GET</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">            </code><code class="p">};</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">url</code><code class="err">\</code><code class="w"></code>
<code class="lineno">45 </code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">parameters</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">resp</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">)</code><code class="w"></code>
<code class="lineno">47 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We pass a mutable reference to the perform functions because we need the session to possibly fill in data in the request and we also will fill in the session with other data provided as part of the request as parameters. This will be more clear when we get to the client module, but for now this is just plumbing.</p>

<h4 id="leanpub-auto-supporting-sessions-in-the-app-module">Supporting sessions in the app module</h4>

<p>The app module is responsible for command line argument based configuration. Therefore our primary responsibility here is to add the fields to the <code>App</code> struct necessary for configuring the session. Let’s add those fields:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">44 </code><code class="w">    </code><code class="sd">/// Session name.</code>
<code class="lineno">45 </code><code class="w">    </code><code class="cp">#[structopt(long)]</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">session</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">47 </code>
<code class="lineno">48 </code><code class="w">    </code><code class="sd">/// Session storage location.</code>
<code class="lineno">49 </code><code class="w">    </code><code class="cp">#[structopt(long, parse(from_os_str))]</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">session_dir</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="n">PathBuf</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">51 </code>
<code class="lineno">52 </code><code class="w">    </code><code class="sd">/// If true then use the stored session to augment the request,</code>
<code class="lineno">53 </code><code class="w">    </code><code class="sd">/// but do not modify what is stored.</code>
<code class="lineno">54 </code><code class="w">    </code><code class="cp">#[structopt(long)]</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="n">read_only</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>session</code> field is a name to use for a particular session. Specifying the same name is how sessions get reused across requests. We also provide the ability to specify where the session data should be stored. By default we will put things in our configuration directory for convenience, but this gives the user an option to put it somewhere else. Finally, the <code>read_only</code> field determines whether the session should be modified by the request and response or if it should only be used to augment the request as it currently exists on disk.</p>

<p>While we are here, let’s add one helper method to the app struct which we will use when we try to store the session. First we bring in one useful helper from the session module:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">8 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">session</code>::<code class="n">make_safe_pathname</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we add the <code>host</code> method to the app:</p>

<figure class="code" dir="ltr">
  <figcaption>src/app.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">177 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">host</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">String</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">178 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">url</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="bp">self</code><code class="p">.</code><code class="n">url</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">179 </code><code class="w">            </code><code class="n">make_safe_pathname</code><code class="p">(</code><code class="n">url</code><code class="p">)</code><code class="w"></code>
<code class="lineno">180 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">cmd</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="bp">self</code><code class="p">.</code><code class="n">cmd</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">181 </code><code class="w">            </code><code class="n">make_safe_pathname</code><code class="p">(</code><code class="o">&amp;</code><code class="n">cmd</code><code class="p">.</code><code class="n">data</code><code class="p">().</code><code class="n">url</code><code class="p">)</code><code class="w"></code>
<code class="lineno">182 </code><code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">183 </code><code class="w">            </code><code class="n">unreachable</code><code class="o">!</code><code class="p">();</code><code class="w"></code>
<code class="lineno">184 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">185 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is a simple way to get some string representation of the URL we are making requests to. Sessions are unique based on this host value and the configured named.</p>

<h4 id="leanpub-auto-adding-sessions-to-the-client">Adding sessions to the client</h4>

<p>Recall that the client is responsible for actually making the network request. The session will be part of building up the request and as we saw is part of our perform methods. Therefore, let’s start with importing the session type:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">session</code>::<code class="n">Session</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Then we can add the session to <code>perform_method</code> as we saw before at the call site in <code>main.rs</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">13 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">perform_method</code><code class="p">(</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">method</code>: <code class="kp">&amp;</code><code class="nc">Method</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="n">session</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">Session</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">17 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>As this just delegates to <code>perform</code>, we can just pass the passed in session along directly:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">19 </code><code class="w">    </code><code class="n">perform</code><code class="p">(</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">        </code><code class="n">app</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="w">        </code><code class="n">method</code><code class="p">.</code><code class="n">into</code><code class="p">(),</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">        </code><code class="n">session</code><code class="p">,</code><code class="w"></code>
<code class="lineno">23 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">method_data</code><code class="p">.</code><code class="n">url</code><code class="p">,</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">method_data</code><code class="p">.</code><code class="n">parameters</code><code class="p">,</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">    </code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>Our <code>perform</code> method needs the signature updated to take the session:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">28 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">perform</code><code class="p">(</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">    </code><code class="n">method</code>: <code class="nc">reqwest</code>::<code class="n">Method</code><code class="p">,</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">    </code><code class="n">session</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">Session</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="n">raw_url</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"></code>
<code class="lineno">33 </code><code class="w">    </code><code class="n">parameters</code>: <code class="kp">&amp;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">34 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>We then need to modify our request builder from the session, and possible modify the session based on the other data available. We do this by creating a function called <code>handle_session</code> which takes the builder and all of the pertinent data and returns a new builder. We call this right after creating our builder:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">47 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">.</code><code class="n">request</code><code class="p">(</code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"></code>
<code class="lineno">48 </code><code class="w">    </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">handle_session</code><code class="p">(</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="n">builder</code><code class="p">,</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="n">session</code><code class="p">,</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">        </code><code class="n">parameters</code><code class="p">,</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">        </code><code class="o">!</code><code class="n">app</code><code class="p">.</code><code class="n">read_only</code><code class="p">,</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">auth</code><code class="p">,</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">        </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">token</code><code class="p">,</code><code class="w"></code>
<code class="lineno">55 </code><code class="w">    </code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>Let’s implement <code>handle_session</code> mostly by delegating to methods on the session:</p>

<figure class="code" dir="ltr">
  <figcaption>src/client.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 87 </code><code class="k">fn</code> <code class="nf">handle_session</code><code class="p">(</code><code class="w"></code>
<code class="lineno"> 88 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code>: <code class="nc">RequestBuilder</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 89 </code><code class="w">    </code><code class="n">session</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">Session</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 90 </code><code class="w">    </code><code class="n">parameters</code>: <code class="kp">&amp;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 91 </code><code class="w">    </code><code class="n">update_session</code>: <code class="kt">bool</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 92 </code><code class="w">    </code><code class="n">auth</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 93 </code><code class="w">    </code><code class="n">token</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno"> 94 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">RequestBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 95 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 96 </code><code class="w">        </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Adding session data to request"</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">        </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">add_to_request</code><code class="p">(</code><code class="n">builder</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">update_session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 99 </code><code class="w">            </code><code class="n">trace</code><code class="o">!</code><code class="p">(</code><code class="s">"Updating session with parameters from this request"</code><code class="err">\</code><code class="w"></code>
<code class="lineno">100 </code><code class="p">);</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">            </code><code class="n">s</code><code class="p">.</code><code class="n">update_with_parameters</code><code class="p">(</code><code class="n">parameters</code><code class="p">);</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">            </code><code class="n">s</code><code class="p">.</code><code class="n">update_auth</code><code class="p">(</code><code class="n">auth</code><code class="p">,</code><code class="w"> </code><code class="n">token</code><code class="p">);</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">104 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">105 </code><code class="w">    </code><code class="n">builder</code><code class="w"></code>
<code class="lineno">106 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>If we have a session, then we update the builder by adding the session data to the request. Furthermore, if we are not in read only mode which means we want to update the session, then we pass the parameters and authentication information to the session for updating.</p>

<h4 id="leanpub-auto-implementing-sessions">Implementing sessions</h4>

<p>Finally we get to the meat of building sessions. We have many small tasks to accomplish in the session module which when put together will do everything we need. Let’s start with a big stack of imports:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">app</code>::<code class="p">{</code><code class="n">App</code><code class="p">,</code><code class="w"> </code><code class="n">Parameter</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 2 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">directories</code>::<code class="n">DIRECTORIES</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 3 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="n">HurlResult</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 4 </code><code class="k">use</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">header</code>::<code class="n">COOKIE</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 5 </code><code class="k">use</code><code class="w"> </code><code class="n">reqwest</code>::<code class="n">RequestBuilder</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 6 </code><code class="k">use</code><code class="w"> </code><code class="n">serde</code>::<code class="p">{</code><code class="n">Deserialize</code><code class="p">,</code><code class="w"> </code><code class="n">Serialize</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">collections</code>::<code class="n">HashMap</code><code class="p">;</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">fs</code>::<code class="p">{</code><code class="n">create_dir_all</code><code class="p">,</code><code class="w"> </code><code class="n">File</code><code class="p">,</code><code class="w"> </code><code class="n">OpenOptions</code><code class="p">};</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">io</code>::<code class="p">{</code><code class="n">BufReader</code><code class="p">,</code><code class="w"> </code><code class="n">BufWriter</code><code class="p">};</code><code class="w"></code>
<code class="lineno">10 </code><code class="k">use</code><code class="w"> </code><code class="n">std</code>::<code class="n">path</code>::<code class="n">PathBuf</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>We will get to each of these as they come up, but let’s move on to defining the struct to contain the session data:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">12 </code><code class="cp">#[derive(Debug, Default, Serialize, Deserialize)]</code><code class="w"></code>
<code class="lineno">13 </code><code class="k">pub</code><code class="w"> </code><code class="k">struct</code> <code class="nc">Session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">path</code>: <code class="nc">PathBuf</code><code class="p">,</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="n">name</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">16 </code><code class="w">    </code><code class="n">host</code>: <code class="nb">String</code><code class="p">,</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">    </code><code class="n">auth</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">token</code>: <code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="n">headers</code>: <code class="nc">HashMap</code><code class="o">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">20 </code><code class="w">    </code><code class="n">cookies</code>: <code class="nb">Vec</code><code class="o">&lt;</code><code class="p">(</code><code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="nb">String</code><code class="p">)</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">21 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We derive <code>Serialize</code> and <code>Deserialize</code> because we are going to read and write this struct to a file. The <code>path</code>, <code>name</code>, and <code>host</code> are used uniquely describe the file system location for the session. The other fields: <code>auth</code>, <code>token</code>, <code>headers</code>, and <code>cookies</code> should be self-explanatory.</p>

<p>Most of our functionality will live as methods implemented on this struct, so let’s get started with <code>new</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">23 </code><code class="k">impl</code><code class="w"> </code><code class="n">Session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">24 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">new</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">name</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">host</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">25 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Session</code>::<code class="n">path</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">host</code><code class="p">);</code><code class="w"></code>
<code class="lineno">26 </code><code class="w">        </code><code class="n">Session</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">            </code><code class="n">path</code><code class="p">,</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">            </code><code class="n">name</code><code class="p">,</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">            </code><code class="n">host</code><code class="p">,</code><code class="w"></code>
<code class="lineno">30 </code><code class="w">            </code><code class="p">..</code><code class="nb">Default</code>::<code class="n">default</code><code class="p">()</code><code class="w"></code>
<code class="lineno">31 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Constructing a new session is accomplished by using a helper method to get a path and then storing the data we are given inside a new session struct and using default values for the rest. The syntax <code>..Default::default()</code> inside a struct literal is known as the struct update syntax. It means to use the values from a default constructed instance of <code>Session</code> to fill in any fields which are not provided above.</p>

<p>The <code>Default::default()</code> bit is not special, but as we derive <code>Default</code> on our struct it is just one way to create a full <code>Session</code> struct with default values. If <code>other_session</code> was a variable with type <code>Session</code>, then you could write <code>..other_session</code> to use the values from <code>other_session</code> to fill in the missing values. You can think of it as updating the struct named after the <code>..</code> with the values explicitly provided.</p>

<p>Before we get to <code>path</code>, let’s finish our construction methods by moving on to <code>load</code> which loads a <code>Session</code> from a file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">34 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">load</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">name</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">host</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="n">Self</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">path</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Session</code>::<code class="n">path</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="n">host</code><code class="p">);</code><code class="w"></code>
<code class="lineno">36 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">File</code>::<code class="n">open</code><code class="p">(</code><code class="n">path</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">37 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">reader</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufReader</code>::<code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">);</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">        </code><code class="n">serde_json</code>::<code class="n">from_reader</code><code class="p">(</code><code class="n">reader</code><code class="p">).</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">e</code><code class="p">.</code><code class="n">into</code><code class="p">())</code><code class="w"></code>
<code class="lineno">39 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use <code>path</code> again to get the path, then we do the standard sequence of opening a file, putting a reader around the file handle, and then using serde to deserialize a type from the data in the file. Here serde knows what to turn the data in the file into because of the return type of the function.</p>

<p>Finally, we can implement <code>get_or_create</code> which is the convenient method we used in <code>main</code> which puts together <code>load</code> and <code>new</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">40 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">get_or_create</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">name</code>: <code class="nb">String</code><code class="p">,</code><code class="w"> </code><code class="n">host</code>: <code class="nb">String</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Self</code><code class="err">\</code><code class="w"></code>
<code class="lineno">41 </code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">42 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">Session</code>::<code class="n">load</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">host</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">            </code><code class="nb">Ok</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">session</code><code class="p">,</code><code class="w"></code>
<code class="lineno">44 </code><code class="w">            </code><code class="nb">Err</code><code class="p">(</code><code class="n">_</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">Session</code>::<code class="n">new</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="n">host</code><code class="p">),</code><code class="w"></code>
<code class="lineno">45 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">46 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Now let’s see how we get a consistent path for storing the session file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">48 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">path</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">name</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">host</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">PathBuf</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">49 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">session_dir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Session</code>::<code class="n">dir</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">host</code><code class="p">);</code><code class="w"></code>
<code class="lineno">50 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">make_safe_pathname</code><code class="p">(</code><code class="n">name</code><code class="p">);</code><code class="w"></code>
<code class="lineno">51 </code><code class="w">        </code><code class="n">filename</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="s">".json"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">52 </code><code class="w">        </code><code class="n">session_dir</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">filename</code><code class="p">);</code><code class="w"></code>
<code class="lineno">53 </code><code class="w">        </code><code class="n">session_dir</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We use another helper to get the directory which we combine with the result of <code>make_safe_pathname</code> applied to the name of the session to get a full path to the file where we want to store the session.</p>

<p>The <code>dir</code> helper starts with getting a directory based on the app configuration or using a default, and then adds a path based on the host:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">56 </code><code class="w">    </code><code class="k">fn</code> <code class="nf">dir</code><code class="p">(</code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">,</code><code class="w"> </code><code class="n">host</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">PathBuf</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">57 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">session_dir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="w"></code>
<code class="lineno">58 </code><code class="w">            </code><code class="p">.</code><code class="n">session_dir</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">            </code><code class="p">.</code><code class="n">as_ref</code><code class="p">()</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">            </code><code class="p">.</code><code class="n">cloned</code><code class="p">()</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">            </code><code class="p">.</code><code class="n">filter</code><code class="p">(</code><code class="o">|</code><code class="n">session_dir</code><code class="o">|</code><code class="w"> </code><code class="n">session_dir</code><code class="p">.</code><code class="n">is_dir</code><code class="p">())</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">            </code><code class="p">.</code><code class="n">unwrap_or_else</code><code class="p">(</code><code class="o">||</code><code class="w"> </code><code class="n">DIRECTORIES</code><code class="p">.</code><code class="n">config</code><code class="p">().</code><code class="n">join</code><code class="p">(</code><code class="s">"sessions"</code><code class="p">));</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">        </code><code class="n">session_dir</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">make_safe_pathname</code><code class="p">(</code><code class="n">host</code><code class="p">));</code><code class="w"></code>
<code class="lineno">64 </code><code class="w">        </code><code class="n">session_dir</code><code class="w"></code>
<code class="lineno">65 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is how we combine the host and session name to get consistent session file.</p>

<p>The session needs to be able to save itself to disk, so we implement <code>save</code> on an instance of session:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">67 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">save</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">App</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">68 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">dir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Session</code>::<code class="n">dir</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="bp">self</code><code class="p">.</code><code class="n">host</code><code class="p">);</code><code class="w"></code>
<code class="lineno">69 </code><code class="w">        </code><code class="n">create_dir_all</code><code class="p">(</code><code class="n">dir</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">70 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">file</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">OpenOptions</code>::<code class="n">new</code><code class="p">()</code><code class="w"></code>
<code class="lineno">71 </code><code class="w">            </code><code class="p">.</code><code class="n">create</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"></code>
<code class="lineno">72 </code><code class="w">            </code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"></code>
<code class="lineno">73 </code><code class="w">            </code><code class="p">.</code><code class="n">truncate</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"></code>
<code class="lineno">74 </code><code class="w">            </code><code class="p">.</code><code class="n">open</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">.</code><code class="n">path</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">75 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">writer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">BufWriter</code>::<code class="n">new</code><code class="p">(</code><code class="n">file</code><code class="p">);</code><code class="w"></code>
<code class="lineno">76 </code><code class="w">        </code><code class="n">serde_json</code>::<code class="n">to_writer</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="bp">self</code><code class="p">).</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">e</code><code class="o">|</code><code class="w"> </code><code class="n">e</code><code class="p">.</code><code class="n">into</code><code class="p">())</code><code class="w"></code>
<code class="lineno">77 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We start by ensuring the directory where we want to store the file exists. The function <code>create_all_dir</code> is effectively <code>mkdir -p</code> which creates all intermediate directories as needed. We then open the file at our specified path and serialize our data structure to disk as JSON. We use the <code>OpenOptions</code> builder to specify exactly how we want the file opened. We want the file on disk to exactly represent the current struct we are trying to write in both cases where the file does and does not exist. We need <code>create</code> for the does not exist case, and we need <code>truncate</code> to properly handle all cases when the file does exist.</p>

<p>That takes care of all of the functionality of reading/writing the session to disk. We turn now to how we actually use the session to modify the request and how we modify the session from the request and response.</p>

<p>First let’s deal with updating the session from the request parameters:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">79 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">update_with_parameters</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">parameters</code>: <code class="kp">&amp;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="n">Parameter</code><code class="err">\</code><code class="w"></code>
<code class="lineno">80 </code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">81 </code><code class="w">        </code><code class="k">for</code><code class="w"> </code><code class="n">parameter</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">parameters</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">82 </code><code class="w">            </code><code class="k">match</code><code class="w"> </code><code class="n">parameter</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">83 </code><code class="w">                </code><code class="n">Parameter</code>::<code class="n">Header</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="w"> </code><code class="p">}</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">84 </code><code class="w">                    </code><code class="kd">let</code><code class="w"> </code><code class="n">lower_key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">key</code><code class="p">.</code><code class="n">to_ascii_lowercase</code><code class="p">();</code><code class="w"></code>
<code class="lineno">85 </code><code class="w">                    </code><code class="k">if</code><code class="w"> </code><code class="n">lower_key</code><code class="p">.</code><code class="n">starts_with</code><code class="p">(</code><code class="s">"content-"</code><code class="p">)</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="n">lower_key</code><code class="p">.</code><code class="n">s</code><code class="err">\</code><code class="w"></code>
<code class="lineno">86 </code><code class="n">tarts_with</code><code class="p">(</code><code class="s">"if-"</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">87 </code><code class="w">                        </code><code class="k">continue</code><code class="p">;</code><code class="w"></code>
<code class="lineno">88 </code><code class="w">                    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">89 </code><code class="w">                    </code><code class="bp">self</code><code class="p">.</code><code class="n">headers</code><code class="p">.</code><code class="n">insert</code><code class="p">(</code><code class="n">key</code><code class="p">.</code><code class="n">clone</code><code class="p">(),</code><code class="w"> </code><code class="n">value</code><code class="p">.</code><code class="n">clone</code><code class="p">());</code><code class="w"></code>
<code class="lineno">90 </code><code class="w">                </code><code class="p">}</code><code class="w"></code>
<code class="lineno">91 </code><code class="w">                </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="p">{}</code><code class="w"></code>
<code class="lineno">92 </code><code class="w">            </code><code class="p">}</code><code class="w"></code>
<code class="lineno">93 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">94 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have chosen to only support headers as a parameter that we store in the session so that is the only parameter type that we care about. We store the headers in the <code>headers</code> field on the session, but we exclude a few keys as persisting them across request is almost certainly not what you want to do.</p>

<p>Next we update the session with auth data if it is available:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 94 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">update_auth</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">auth</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">,</code><code class="w"> </code><code class="n">token</code>: <code class="kp">&amp;</code><code class="nb">Option</code><code class="err">\</code><code class="w"></code>
<code class="lineno"> 95 </code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 96 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">auth</code><code class="p">.</code><code class="n">is_some</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 97 </code><code class="w">            </code><code class="bp">self</code><code class="p">.</code><code class="n">auth</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">auth</code><code class="p">.</code><code class="n">clone</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 98 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno"> 99 </code>
<code class="lineno">100 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">token</code><code class="p">.</code><code class="n">is_some</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">101 </code><code class="w">            </code><code class="bp">self</code><code class="p">.</code><code class="n">token</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">token</code><code class="p">.</code><code class="n">clone</code><code class="p">();</code><code class="w"></code>
<code class="lineno">102 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">103 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>We have two remaining tasks. One is to add the session to the request. The other is to update the session from the response. Let’s first update the request with the session:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">104 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">add_to_request</code><code class="p">(</code><code class="o">&amp;</code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code>: <code class="nc">RequestBuilder</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">Reques</code><code class="err">\</code><code class="w"></code>
<code class="lineno">105 </code><code class="n">tBuilder</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">106 </code><code class="w">        </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">)</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="bp">self</code><code class="p">.</code><code class="n">headers</code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">107 </code><code class="w">            </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">header</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">);</code><code class="w"></code>
<code class="lineno">108 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">109 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">cookies</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="bp">self</code><code class="w"></code>
<code class="lineno">110 </code><code class="w">            </code><code class="p">.</code><code class="n">cookies</code><code class="w"></code>
<code class="lineno">111 </code><code class="w">            </code><code class="p">.</code><code class="n">iter</code><code class="p">()</code><code class="w"></code>
<code class="lineno">112 </code><code class="w">            </code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">|</code><code class="p">(</code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">)</code><code class="o">|</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"{}={}"</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="p">,</code><code class="w"> </code><code class="n">value</code><code class="p">))</code><code class="w"></code>
<code class="lineno">113 </code><code class="w">            </code><code class="p">.</code><code class="n">collect</code>::<code class="o">&lt;</code><code class="nb">Vec</code><code class="o">&lt;</code><code class="nb">String</code><code class="o">&gt;&gt;</code><code class="p">()</code><code class="w"></code>
<code class="lineno">114 </code><code class="w">            </code><code class="p">.</code><code class="n">join</code><code class="p">(</code><code class="s">"; "</code><code class="p">);</code><code class="w"></code>
<code class="lineno">115 </code><code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="n">cookies</code><code class="p">.</code><code class="n">is_empty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">116 </code><code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="n">builder</code><code class="p">;</code><code class="w"></code>
<code class="lineno">117 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">118 </code><code class="w">        </code><code class="n">builder</code><code class="p">.</code><code class="n">header</code><code class="p">(</code><code class="n">COOKIE</code><code class="p">,</code><code class="w"> </code><code class="n">cookies</code><code class="p">)</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>IF we have headers, we add them to the request. Further, if we have cookies, we turn them into the expected format for the cookie header and add that to the request. The format of the cookie header is given by the HTTP specification and the key for the cookie header is provided by reqwest as the constant <code>COOKIE</code>.</p>

<p>The only part of the response that we want to absorb into the session is the cookies, so let’s write the function for updating the session accordingly:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">120 </code><code class="w">    </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">update_with_response</code><code class="p">(</code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="bp">self</code><code class="p">,</code><code class="w"> </code><code class="n">resp</code>: <code class="kp">&amp;</code><code class="nc">reqwest</code>::<code class="n">Response</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">121 </code><code class="w">        </code><code class="k">for</code><code class="w"> </code><code class="n">cookie</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">resp</code><code class="p">.</code><code class="n">cookies</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">            </code><code class="bp">self</code><code class="p">.</code><code class="n">cookies</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">                </code><code class="p">.</code><code class="n">push</code><code class="p">((</code><code class="n">cookie</code><code class="p">.</code><code class="n">name</code><code class="p">().</code><code class="n">to_owned</code><code class="p">(),</code><code class="w"> </code><code class="n">cookie</code><code class="p">.</code><code class="n">value</code><code class="p">().</code><code class="n">to_owne</code><code class="err">\</code><code class="w"></code>
<code class="lineno">124 </code><code class="n">d</code><code class="p">()));</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">127 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Lastly, we have used the helper <code>make_safe_pathname</code> in a few places, but we still have to write it:</p>

<figure class="code" dir="ltr">
  <figcaption>src/session.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">128 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">make_safe_pathname</code><code class="p">(</code><code class="n">s</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nb">String</code> <code class="p">{</code><code class="w"></code>
<code class="lineno">129 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">buf</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">String</code>::<code class="n">with_capacity</code><code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="n">len</code><code class="p">());</code><code class="w"></code>
<code class="lineno">130 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">s</code><code class="p">.</code><code class="n">chars</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">131 </code><code class="w">        </code><code class="k">match</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">132 </code><code class="w">            </code><code class="sc">'a'</code><code class="p">..</code><code class="o">=</code><code class="sc">'z'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'A'</code><code class="p">..</code><code class="o">=</code><code class="sc">'Z'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'0'</code><code class="p">..</code><code class="o">=</code><code class="sc">'9'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'_'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">'-'</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="sc">' '</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">buf</code><code class="p">.</code><code class="err">\</code><code class="w"></code>
<code class="lineno">133 </code><code class="n">push</code><code class="p">(</code><code class="n">c</code><code class="p">),</code><code class="w"></code>
<code class="lineno">134 </code><code class="w">            </code><code class="n">_</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">buf</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="sc">'_'</code><code class="p">),</code><code class="w"></code>
<code class="lineno">135 </code><code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="lineno">136 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">137 </code><code class="w">    </code><code class="n">buf</code><code class="w"></code>
<code class="lineno">138 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>This is one choice for turning a string into something that is safe for storing on the file system. You can choose your own scheme if you want, but this demonstrates one approach that works.</p>

<h4 id="leanpub-auto-session-recap">Session recap</h4>

<p>We can now execute the following requests</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code>$ hurl --session foo POST example.com X-API-TOKEN:abc123 <code class="nv">info</code><code class="o">=</code>fuzz
<code class="lineno">2 </code>$ hurl --session foo example.com/info
</pre></div>

</figure>

<p>and the second request will include the <code>X-API_TOKEN:abc123</code> header. This is a really nice feature that you either realize you’ve always wanted or will some day.</p>

<h3 id="leanpub-auto-syntax-highlighting">Syntax highlighting</h3>

<p>One final feature to add a bit of polish to our little application: syntax highlighting. We are going to implement this in a way that is not completely general to save on space, but all the ideas are still here. Moreover, as most syntax highlighting is designed around programming languages, we will have to do some custom work to support highlighting our output.</p>

<p>Let’s start with adding one more dependency to our manifest:</p>

<figure class="code" dir="ltr">
  <figcaption>Cargo.toml</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">19 </code>syntect = "3.2"
</pre></div>

</figure>

<h4 id="leanpub-auto-adding-highlighting-to-main">Adding highlighting to main</h4>

<p>We start by importing some types related to highlighting and declare a <code>syntax</code> module which will encapsulate our custom syntax:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">14 </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">highlighting</code>::<code class="n">Theme</code><code class="p">;</code><code class="w"></code>
<code class="lineno">15 </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">parsing</code>::<code class="n">SyntaxSet</code><code class="p">;</code><code class="w"></code>
<code class="lineno">16 </code>
<code class="lineno">17 </code><code class="k">mod</code> <code class="nn">syntax</code><code class="p">;</code><code class="w"></code>
</pre></div>

</figure>

<p>Early on in our main function, we are going to build a syntax set and a theme:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">26 </code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="kd">let</code><code class="w"> </code><code class="nb">Some</code><code class="p">(</code><code class="n">level</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="p">.</code><code class="n">log_level</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">27 </code><code class="w">        </code><code class="n">std</code>::<code class="n">env</code>::<code class="n">set_var</code><code class="p">(</code><code class="s">"RUST_LOG"</code><code class="p">,</code><code class="w"> </code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"hurl={}"</code><code class="p">,</code><code class="w"> </code><code class="n">level</code><code class="p">));</code><code class="w"></code>
<code class="lineno">28 </code><code class="w">        </code><code class="n">pretty_env_logger</code>::<code class="n">init</code><code class="p">();</code><code class="w"></code>
<code class="lineno">29 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">30 </code>
<code class="lineno">31 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="p">(</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">ts</code><code class="p">)</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">syntax</code>::<code class="n">build</code><code class="p">()</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">32 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">theme</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="o">&amp;</code><code class="n">ts</code><code class="p">.</code><code class="n">themes</code><code class="p">[</code><code class="s">"Solarized (dark)"</code><code class="p">];</code><code class="w"></code>
<code class="lineno">33 </code>
<code class="lineno">34 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">app</code><code class="w"></code>
<code class="lineno">35 </code><code class="w">        </code><code class="p">.</code><code class="n">session</code><code class="w"></code>
</pre></div>

</figure>

<p>A <code>SyntaxSet</code> is exactly what it sounds like, it is a set of grammatical syntaxes which can be highlighted. You can think about it as a way to go from raw text to structured text. A theme is a description of what colors to apply based on the annotations in that structured text.</p>

<p>Our syntax module will expose a build function that takes care of this, but it exposes both a set of syntaxes as well as a set of themes. To get one theme we have to ask for one particular theme from the theme set. Here we cheat a bit and hard code one that is included by default by the <code>syntect</code> crate. This is one opportunity for an extension by making this configurable.</p>

<p>The response is what we want to highlight, so we add our syntax set and theme to <code>handle_response</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">58 </code><code class="k">fn</code> <code class="nf">handle_response</code><code class="p">(</code><code class="w"></code>
<code class="lineno">59 </code><code class="w">    </code><code class="n">app</code>: <code class="kp">&amp;</code><code class="nc">app</code>::<code class="n">App</code><code class="p">,</code><code class="w"></code>
<code class="lineno">60 </code><code class="w">    </code><code class="n">ss</code>: <code class="kp">&amp;</code><code class="nc">SyntaxSet</code><code class="p">,</code><code class="w"></code>
<code class="lineno">61 </code><code class="w">    </code><code class="n">theme</code>: <code class="kp">&amp;</code><code class="nc">Theme</code><code class="p">,</code><code class="w"></code>
<code class="lineno">62 </code><code class="w">    </code><code class="k">mut</code><code class="w"> </code><code class="n">resp</code>: <code class="nc">reqwest</code>::<code class="n">Response</code><code class="p">,</code><code class="w"></code>
<code class="lineno">63 </code><code class="w">    </code><code class="n">session</code>: <code class="kp">&amp;</code><code class="nc">mut</code><code class="w"> </code><code class="nb">Option</code><code class="o">&lt;</code><code class="n">session</code>::<code class="n">Session</code><code class="o">&gt;</code><code class="p">,</code><code class="w"></code>
<code class="lineno">64 </code><code class="p">)</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">()</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
</pre></div>

</figure>

<p>Instead of calling <code>println!</code>, we are going to call <code>highlight_string</code> which will still print the string but with colors:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">88 </code><code class="w">    </code><code class="n">s</code><code class="p">.</code><code class="n">push_str</code><code class="p">(</code><code class="o">&amp;</code><code class="p">(</code><code class="o">&amp;</code><code class="n">headers</code><code class="p">[..]).</code><code class="n">join</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">));</code><code class="w"></code>
<code class="lineno">89 </code><code class="w">    </code><code class="n">highlight_string</code><code class="p">(</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code><code class="p">,</code><code class="w"> </code><code class="s">"HTTP"</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">s</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>We need to add a call to <code>println!("")</code> to add a newline between the header content and the body:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">91 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">""</code><code class="p">);</code><code class="w"></code>
<code class="lineno">92 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">result_json</code>: <code class="nc">serde_json</code>::<code class="nb">Result</code><code class="o">&lt;</code><code class="n">OrderedJson</code><code class="o">&gt;</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">from</code><code class="err">\</code><code class="w"></code>
<code class="lineno">93 </code><code class="n">_str</code><code class="p">(</code><code class="o">&amp;</code><code class="n">result</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>If we managed to parse the body as JSON then we replace to print call again with <code>highlight_string</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">95 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">result_str</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">serde_json</code>::<code class="n">to_string_pretty</code><code class="p">(</code><code class="o">&amp;</code><code class="n">result_value</code><code class="err">\</code><code class="w"></code>
<code class="lineno">96 </code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">97 </code><code class="w">            </code><code class="n">highlight_string</code><code class="p">(</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code><code class="p">,</code><code class="w"> </code><code class="s">"JSON"</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">result_str</code><code class="p">);</code><code class="w"></code>
</pre></div>

</figure>

<p>We need to pass the syntax set and theme to <code>handle_response</code> in the case we have a <code>cmd</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">41 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform_method</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">sessio</code><code class="err">\</code><code class="w"></code>
<code class="lineno">42 </code><code class="n">n</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">43 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code><code class="p">,</code><code class="w"> </code><code class="n">resp</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>and in the case where we do not have a <code>cmd</code>:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">52 </code><code class="w">            </code><code class="kd">let</code><code class="w"> </code><code class="n">resp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code>::<code class="n">perform</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="n">method</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">url</code><code class="err">\</code><code class="w"></code>
<code class="lineno">53 </code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">app</code><code class="p">.</code><code class="n">parameters</code><code class="p">)</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">54 </code><code class="w">            </code><code class="n">handle_response</code><code class="p">(</code><code class="o">&amp;</code><code class="n">app</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code><code class="p">,</code><code class="w"> </code><code class="n">resp</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="k">mut</code><code class="w"> </code><code class="n">session</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>Finally, we can implement the real highlighting:</p>

<figure class="code" dir="ltr">
  <figcaption>src/main.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">113 </code><code class="k">fn</code> <code class="nf">highlight_string</code><code class="p">(</code><code class="n">ss</code>: <code class="kp">&amp;</code><code class="nc">SyntaxSet</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code>: <code class="kp">&amp;</code><code class="nc">Theme</code><code class="p">,</code><code class="w"> </code><code class="n">syntax</code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">,</code><code class="w"> </code><code class="n">string</code><code class="err">\</code><code class="w"></code>
<code class="lineno">114 </code>: <code class="kp">&amp;</code><code class="kt">str</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">115 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">easy</code>::<code class="n">HighlightLines</code><code class="p">;</code><code class="w"></code>
<code class="lineno">116 </code><code class="w">    </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">util</code>::<code class="p">{</code><code class="n">as_24_bit_terminal_escaped</code><code class="p">,</code><code class="w"> </code><code class="n">LinesWithEndings</code><code class="p">};</code><code class="w"></code>
<code class="lineno">117 </code>
<code class="lineno">118 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">syn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ss</code><code class="w"></code>
<code class="lineno">119 </code><code class="w">        </code><code class="p">.</code><code class="n">find_syntax_by_name</code><code class="p">(</code><code class="n">syntax</code><code class="p">)</code><code class="w"></code>
<code class="lineno">120 </code><code class="w">        </code><code class="p">.</code><code class="n">expect</code><code class="p">(</code><code class="o">&amp;</code><code class="n">format</code><code class="o">!</code><code class="p">(</code><code class="s">"{} syntax should exist"</code><code class="p">,</code><code class="w"> </code><code class="n">syntax</code><code class="p">));</code><code class="w"></code>
<code class="lineno">121 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">h</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HighlightLines</code>::<code class="n">new</code><code class="p">(</code><code class="n">syn</code><code class="p">,</code><code class="w"> </code><code class="n">theme</code><code class="p">);</code><code class="w"></code>
<code class="lineno">122 </code><code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="n">line</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="n">LinesWithEndings</code>::<code class="n">from</code><code class="p">(</code><code class="n">string</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno">123 </code><code class="w">        </code><code class="kd">let</code><code class="w"> </code><code class="n">regions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">h</code><code class="p">.</code><code class="n">highlight</code><code class="p">(</code><code class="n">line</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="n">ss</code><code class="p">);</code><code class="w"></code>
<code class="lineno">124 </code><code class="w">        </code><code class="n">print</code><code class="o">!</code><code class="p">(</code><code class="s">"{}"</code><code class="p">,</code><code class="w"> </code><code class="n">as_24_bit_terminal_escaped</code><code class="p">(</code><code class="o">&amp;</code><code class="n">regions</code><code class="p">[..],</code><code class="w"> </code><code class="kc">false</code><code class="p">));</code><code class="w"></code>
<code class="lineno">125 </code><code class="w">    </code><code class="p">}</code><code class="w"></code>
<code class="lineno">126 </code><code class="w">    </code><code class="n">println</code><code class="o">!</code><code class="p">(</code><code class="s">"</code><code class="se">\x1b</code><code class="s">[0m"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">127 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The <code>syntect</code> crate has a really nice set of features because it provides an incredible amount of intricate customizations and details for syntax highlighting, but it also provides some easy convenience methods when you don’t need to get too deep into the details.</p>

<p>We name our two syntaxes <code>"JSON"</code> and <code>"HTTP"</code> and pass those as the <code>syntax</code> argument to this function so that we can easily look up the right syntax from our syntax set.</p>

<p>We use this syntax and theme to construct a <code>HighlightLines</code> object which is used to generate text in colored regions for printing. The <code>as_24_bit_terminal_escaped</code> method is a nice utility for turning those colored regions into escape sequences for use in terminal output. The <code>LinesWithEndings</code> will add newlines if they don’t exist so that we know that we can use <code>print!</code> instead of <code>println!</code> and still will get newlines at the end of our lines.</p>

<p>Finally, we print out the terminal reset character which ends all highlighting and puts us back in to normal shell mode so that we don’t leak our highlighting onto later shell commands.</p>

<h4 id="leanpub-auto-supporting-syntax-highlighting-errors">Supporting syntax highlighting errors</h4>

<p>We want to gracefully handle failing to load syntax definitions, so let’s add a variant to our error enum to represent this failure:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">12 </code><code class="w">    </code><code class="n">IO</code><code class="p">(</code><code class="n">std</code>::<code class="n">io</code>::<code class="n">ErrorKind</code><code class="p">),</code><code class="w"></code>
<code class="lineno">13 </code><code class="w">    </code><code class="n">UrlParseError</code><code class="p">(</code><code class="n">reqwest</code>::<code class="n">UrlError</code><code class="p">),</code><code class="w"></code>
<code class="lineno">14 </code><code class="w">    </code><code class="n">SyntaxLoadError</code><code class="p">(</code><code class="o">&amp;</code><code class="nb">'static</code><code class="w"> </code><code class="kt">str</code><code class="p">),</code><code class="w"></code>
<code class="lineno">15 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>The only other thing we need to do is add support for printing this error:</p>

<figure class="code" dir="ltr">
  <figcaption>src/errors.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">36 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">UrlParseError</code><code class="p">(</code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"URL Parsing Error: {}\</code>
<code class="lineno">37 </code><code class="s">"</code><code class="p">,</code><code class="w"> </code><code class="n">e</code><code class="p">),</code><code class="w"></code>
<code class="lineno">38 </code><code class="w">            </code><code class="n">Error</code>::<code class="n">SyntaxLoadError</code><code class="p">(</code><code class="n">typ</code><code class="p">)</code><code class="w"> </code><code class="o">=&gt;</code><code class="w"> </code><code class="n">write</code><code class="o">!</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code class="w"> </code><code class="s">"Error loading syn\</code>
<code class="lineno">39 </code><code class="s">tax for {}"</code><code class="p">,</code><code class="w"> </code><code class="n">typ</code><code class="p">),</code><code class="w"></code>
</pre></div>

</figure>

<p>Luckily, if you somehow forgot to do that the compiler would give you an error because the match statement in the <code>Debug</code> implementation would no longer be exhaustive.</p>

<h4 id="leanpub-auto-the-syntax-module">The syntax module</h4>

<p>We have one purpose in this module, to load syntax and theme sets. Let’s add the relevant imports to this new <code>src/syntax.rs</code> file:</p>

<figure class="code" dir="ltr">
  <figcaption>src/syntax.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">use</code><code class="w"> </code><code class="k">crate</code>::<code class="n">errors</code>::<code class="p">{</code><code class="n">Error</code><code class="p">,</code><code class="w"> </code><code class="n">HurlResult</code><code class="p">};</code><code class="w"></code>
<code class="lineno">2 </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">highlighting</code>::<code class="n">ThemeSet</code><code class="p">;</code><code class="w"></code>
<code class="lineno">3 </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">parsing</code>::<code class="n">syntax_definition</code>::<code class="n">SyntaxDefinition</code><code class="p">;</code><code class="w"></code>
<code class="lineno">4 </code><code class="k">use</code><code class="w"> </code><code class="n">syntect</code>::<code class="n">parsing</code>::<code class="p">{</code><code class="n">SyntaxSet</code><code class="p">,</code><code class="w"> </code><code class="n">SyntaxSetBuilder</code><code class="p">};</code><code class="w"></code>
</pre></div>

</figure>

<p>We expose one public function, <code>build</code>, which returns a syntax set and a theme set:</p>

<figure class="code" dir="ltr">
  <figcaption>src/syntax.rs</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 6 </code><code class="k">pub</code><code class="w"> </code><code class="k">fn</code> <code class="nf">build</code><code class="p">()</code><code class="w"> </code>-&gt; <code class="nc">HurlResult</code><code class="o">&lt;</code><code class="p">(</code><code class="n">SyntaxSet</code><code class="p">,</code><code class="w"> </code><code class="n">ThemeSet</code><code class="p">)</code><code class="o">&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="lineno"> 7 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="k">mut</code><code class="w"> </code><code class="n">builder</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">SyntaxSetBuilder</code>::<code class="n">new</code><code class="p">();</code><code class="w"></code>
<code class="lineno"> 8 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">http_syntax_def</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">include_str</code><code class="o">!</code><code class="p">(</code><code class="s">"../HTTP.sublime-syntax"</code><code class="p">);</code><code class="w"></code>
<code class="lineno"> 9 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">def</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">SyntaxDefinition</code>::<code class="n">load_from_str</code><code class="p">(</code><code class="n">http_syntax_def</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">,</code><code class="w"> </code><code class="n">No</code><code class="err">\</code><code class="w"></code>
<code class="lineno">10 </code><code class="n">ne</code><code class="p">)</code><code class="w"></code>
<code class="lineno">11 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">_</code><code class="o">|</code><code class="w"> </code><code class="n">Error</code>::<code class="n">SyntaxLoadError</code><code class="p">(</code><code class="s">"HTTP"</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">12 </code><code class="w">    </code><code class="n">builder</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">def</code><code class="p">);</code><code class="w"></code>
<code class="lineno">13 </code>
<code class="lineno">14 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">json_syntax_def</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">include_str</code><code class="o">!</code><code class="p">(</code><code class="s">"../JSON.sublime-syntax"</code><code class="p">);</code><code class="w"></code>
<code class="lineno">15 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">json_def</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">SyntaxDefinition</code>::<code class="n">load_from_str</code><code class="p">(</code><code class="n">json_syntax_def</code><code class="p">,</code><code class="w"> </code><code class="n">tru</code><code class="err">\</code><code class="w"></code>
<code class="lineno">16 </code><code class="n">e</code><code class="p">,</code><code class="w"> </code><code class="nb">None</code><code class="p">)</code><code class="w"></code>
<code class="lineno">17 </code><code class="w">        </code><code class="p">.</code><code class="n">map_err</code><code class="p">(</code><code class="o">|</code><code class="n">_</code><code class="o">|</code><code class="w"> </code><code class="n">Error</code>::<code class="n">SyntaxLoadError</code><code class="p">(</code><code class="s">"JSON"</code><code class="p">))</code><code class="o">?</code><code class="p">;</code><code class="w"></code>
<code class="lineno">18 </code><code class="w">    </code><code class="n">builder</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">json_def</code><code class="p">);</code><code class="w"></code>
<code class="lineno">19 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">ss</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">builder</code><code class="p">.</code><code class="n">build</code><code class="p">();</code><code class="w"></code>
<code class="lineno">20 </code>
<code class="lineno">21 </code><code class="w">    </code><code class="kd">let</code><code class="w"> </code><code class="n">ts</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ThemeSet</code>::<code class="n">load_defaults</code><code class="p">();</code><code class="w"></code>
<code class="lineno">22 </code><code class="w">    </code><code class="nb">Ok</code><code class="p">((</code><code class="n">ss</code><code class="p">,</code><code class="w"> </code><code class="n">ts</code><code class="p">))</code><code class="w"></code>
<code class="lineno">23 </code><code class="p">}</code><code class="w"></code>
</pre></div>

</figure>

<p>Syntect uses a builder pattern for constructing a syntax set. We first create the HTTP syntax and then the JSON syntax.  For the theme we just use the provided <code>load_defaults</code> method to get a decent set of themes to return.</p>

<p>The code to construct each syntax definition is the same except for the path to the file which is brought in via <code>include_str!</code>. The path used here is relative to the file in which this macro exists. As we are inside the <code>src</code> directory, this implies that <code>../HTTP.sublime-syntax</code> is therefore located in the same directory as our <code>Cargo.toml</code> file.</p>

<p>The <code>include_str!</code> macro is extremely handy. This reads a file at compile time and includes the bytes directly in the binary as a <code>&amp;'static str</code>. This allows you to have the benefit of keeping data separate in a file, without the cost of having to read it at runtime. Obviously this makes your binary bigger, but this is such a great tool when you want to make that trade-off.</p>

<p>The two syntax definition files are in the sublime syntax format which is what Syntect uses. This format is a YAML file which describes how to assign predefined highlight attributes to pieces of text based on regular expressions. The HTTP syntax we define does some highlighting of the version, status, and headers:</p>

<figure class="code" dir="ltr">
  <figcaption>HTTP.sublime-syntax</figcaption>
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="nt">%YAML</code> <code class="m">1.2</code>
<code class="lineno"> 2 </code><code class="nn">---</code>
<code class="lineno"> 3 </code><code class="l l-Scalar l-Scalar-Plain">name</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">HTTP</code>
<code class="lineno"> 4 </code><code class="l l-Scalar l-Scalar-Plain">file_extensions</code><code class="p p-Indicator">:</code>
<code class="lineno"> 5 </code>  <code class="p p-Indicator">-</code> <code class="l l-Scalar l-Scalar-Plain">http</code>
<code class="lineno"> 6 </code><code class="l l-Scalar l-Scalar-Plain">scope</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">source.http</code>
<code class="lineno"> 7 </code><code class="l l-Scalar l-Scalar-Plain">contexts</code><code class="p p-Indicator">:</code>
<code class="lineno"> 8 </code>  <code class="l l-Scalar l-Scalar-Plain">main</code><code class="p p-Indicator">:</code>
<code class="lineno"> 9 </code>    <code class="p p-Indicator">-</code> <code class="l l-Scalar l-Scalar-Plain">match</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">([A-Z]+)( +)([^ ]+)( +)(HTTP)(/)(\d+\.\d+)</code>
<code class="lineno">10 </code>      <code class="l l-Scalar l-Scalar-Plain">captures</code><code class="p p-Indicator">:</code>
<code class="lineno">11 </code>        <code class="l l-Scalar l-Scalar-Plain">1</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">function.name.http</code>
<code class="lineno">12 </code>        <code class="l l-Scalar l-Scalar-Plain">2</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">13 </code>        <code class="l l-Scalar l-Scalar-Plain">3</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">entity.name.section.http</code>
<code class="lineno">14 </code>        <code class="l l-Scalar l-Scalar-Plain">4</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">15 </code>        <code class="l l-Scalar l-Scalar-Plain">5</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.http</code>
<code class="lineno">16 </code>        <code class="l l-Scalar l-Scalar-Plain">6</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.operator.http</code>
<code class="lineno">17 </code>        <code class="l l-Scalar l-Scalar-Plain">7</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">constant.numeric.integer.decimal.http</code>
<code class="lineno">18 </code>    <code class="p p-Indicator">-</code> <code class="l l-Scalar l-Scalar-Plain">match</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">(HTTP)(/)(\d+\.\d+)( +)(\d{3})( +)(.+)</code>
<code class="lineno">19 </code>      <code class="l l-Scalar l-Scalar-Plain">captures</code><code class="p p-Indicator">:</code>
<code class="lineno">20 </code>        <code class="l l-Scalar l-Scalar-Plain">1</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.http</code>
<code class="lineno">21 </code>        <code class="l l-Scalar l-Scalar-Plain">2</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.operator.http</code>
<code class="lineno">22 </code>        <code class="l l-Scalar l-Scalar-Plain">3</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">constant.language.http</code>
<code class="lineno">23 </code>        <code class="l l-Scalar l-Scalar-Plain">4</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">24 </code>        <code class="l l-Scalar l-Scalar-Plain">5</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">constant.numeric.integer.decimal.http</code>
<code class="lineno">25 </code>        <code class="l l-Scalar l-Scalar-Plain">6</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">26 </code>        <code class="l l-Scalar l-Scalar-Plain">7</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.symbol.http</code>
<code class="lineno">27 </code>    <code class="p p-Indicator">-</code> <code class="l l-Scalar l-Scalar-Plain">match</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">(.*?)( *)(:)( *)(.+)</code>
<code class="lineno">28 </code>      <code class="l l-Scalar l-Scalar-Plain">captures</code><code class="p p-Indicator">:</code>
<code class="lineno">29 </code>        <code class="l l-Scalar l-Scalar-Plain">1</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">function.name.http</code>
<code class="lineno">30 </code>        <code class="l l-Scalar l-Scalar-Plain">2</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">31 </code>        <code class="l l-Scalar l-Scalar-Plain">3</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">keyword.operator.http</code>
<code class="lineno">32 </code>        <code class="l l-Scalar l-Scalar-Plain">4</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
<code class="lineno">33 </code>        <code class="l l-Scalar l-Scalar-Plain">5</code><code class="p p-Indicator">:</code> <code class="l l-Scalar l-Scalar-Plain">string.quoted.double.http</code>
</pre></div>

</figure>

<p>This syntax is completely custom for this application and could easily be extended or changed based on what you might rather see.</p>

<p>The JSON syntax is similar but much longer. You can find various packages as part of the Sublime editor repo. For example, a good JSON syntax can be found here:</p>

<blockquote>
  <p>https://github.com/sublimehq/Packages/blob/v3186/JavaScript/JSON.sublime-syntax</p>
</blockquote>

<h3 id="leanpub-auto-summary-2">Summary</h3>

<p>We built a fraction of the features of <code>cURL</code> but we added some nice things on top like syntax highlighting and sessions. Although there is quite a bit of code that we had to write, we still only wrote a tiny fraction compared to the amount of work that is done for us by the great libraries that we built on top of.</p>

<p>The ecosystem of crates has matured to the point that you can probably find a solid library to accomplish most of the mundane tasks. The fun part is putting them all together to build interesting, useful, and new experiences.</p>



</div></body></html>